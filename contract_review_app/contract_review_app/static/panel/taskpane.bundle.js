(function(){"use strict";var ie=typeof document<"u"?document.currentScript:null;const oe="",ce="1.4",V="cai-comment-on-analyze";function gt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",oe),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",ce),localStorage.getItem(V)===null&&localStorage.setItem(V,"1")}catch{}}gt();function q(){try{return localStorage.getItem("api_key")||oe}catch{return oe}}function $e(n){try{localStorage.setItem("api_key",n)}catch{}}function j(){try{return localStorage.getItem("schema_version")||ce}catch{return ce}}function J(n){try{localStorage.setItem("schema_version",n)}catch{}}function mt(){try{const n=localStorage.getItem(V);return n===null?(localStorage.setItem(V,"1"),!0):n!=="0"}catch{return!0}}function pt(n){try{localStorage.setItem(V,n?"1":"0")}catch{}}const N=typeof globalThis<"u"?globalThis:window;N.CAI=N.CAI||{},N.CAI.Store=N.CAI.Store||{},N.CAI.Store.setApiKey=$e,N.CAI.Store.setSchemaVersion=J,N.CAI.Store.get=()=>({apiKey:q(),schemaVersion:j()}),N.CAI.Store.DEFAULT_BASE=N.CAI.Store.DEFAULT_BASE||"https://127.0.0.1:9443";const $=window;$.__cai_pending_fetches=$.__cai_pending_fetches||new Set,$.__cai_pending_timers=$.__cai_pending_timers||new Set;const Y=$.__cai_pending_fetches,x=$.__cai_pending_timers,H={count:0};function yt(){H.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:H.count}}))}function vt(){H.count=Math.max(0,H.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:H.count>0,count:H.count}}))}async function Q(n){try{return yt(),await n()}finally{vt()}}function _t(n){Y.add(n)}function bt(n){Y.delete(n)}function wt(n){x.add(n)}function At(n){x.delete(n)}function Ne(n){Y.forEach(r=>{try{r.abort(n)}catch{}}),Y.clear(),x.forEach(r=>{try{clearTimeout(r),clearInterval(r)}catch{}}),x.clear();try{document.querySelectorAll(".progress").forEach(r=>{r.style.display="none"})}catch{}}function Et(){if($.__pendingUnloadReg)return;$.__pendingUnloadReg=!0;const n=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),r=()=>{n&&Ne("pagehide/unload"),$.__wasUnloaded=!0};window.addEventListener("pagehide",r),window.addEventListener("unload",r),window.addEventListener("beforeunload",r),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Ne("visibilitychange")})}function It(){return!!$.__wasUnloaded}function St(){$.__wasUnloaded=!1}let le=null;async function Fe(n={}){if(!le){const r=(n.backend||"").replace(/\/+$/,""),l=r?`${r}/health`:"/health",u=new AbortController,f=n.timeoutMs??9e3,e=setTimeout(()=>u.abort("timeout"),f);le=fetch(l,{signal:u.signal}).then(async t=>{clearTimeout(e);const a=await t.json().catch(()=>({}));return{ok:t.ok,json:a,resp:t}})}return le}var Pe={};const ue=(()=>{if(typeof process<"u"&&(Pe!=null&&!0))return"production";try{if(typeof localStorage<"u")return localStorage.getItem("NODE_ENV")||""}catch{}return"development"})()==="production";function fe(n,r){try{const l=document.getElementById("console");if(!l)return;l.textContent=n,l.setAttribute("data-level",r),setTimeout(()=>{l.textContent="",l.removeAttribute("data-level")},3e3)}catch{}}function K(n,r){fe(n,"ok");try{ue?console.log("[OK]",n):console.log("[OK]",n,r)}catch{}}function Be(n,r){fe(n,"error");try{ue?console.error("[ERR]",n):console.error("[ERR]",n,r)}catch{}}function D(n,r){fe(n,"warn");try{ue?console.warn("[WARN]",n):console.warn("[WARN]",n,r)}catch{}}const ze=(()=>{try{return localStorage.getItem("cai_dev")==="1"?!0:new URLSearchParams(globalThis.location?.search||"").get("debug")==="1"}catch{return!1}})();function kt(n,r,l){ze?console.error(n,r,l):console.error(n,r)}function We(n){if(Array.isArray(n))return n.filter(Boolean);const r=n?.analysis?.findings??n?.findings??n?.issues??[];return Array.isArray(r)?r.filter(Boolean):[]}window.parseFindings=We;function Tt(n){const r=n.headers,l=n.json||{},u=l.llm||l;return{cid:r.get("x-cid"),xcache:r.get("x-cache"),latencyMs:r.get("x-latency-ms"),schema:r.get("x-schema-version"),provider:r.get("x-provider")||u.provider||l.provider||null,model:r.get("x-model")||u.model||l.model||null,llm_mode:r.get("x-llm-mode")||u.mode||l.mode||null,usage:r.get("x-usage-total"),status:n.status!=null?String(n.status):null}}function de(n){const r=(l,u)=>{const f=document.getElementById(l);f&&(f.textContent=u&&u.length?u:"—")};r("status",n.status),r("cid",n.cid),r("xcache",n.xcache),r("latency",n.latencyMs),r("schema",n.schema),r("provider",n.provider),r("model",n.model),r("mode",n.llm_mode),r("usage",n.usage)}async function Ct(){const n=new URL(ie&&ie.tagName.toUpperCase()==="SCRIPT"&&ie.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const l=await(await fetch(n)).text(),u=new TextEncoder().encode(l),f=await crypto.subtle.digest("SHA-256",u),e=Array.from(new Uint8Array(f)).slice(0,4).map(t=>t.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${e} ${n}`)}catch{console.log(`[selftest] api-client.js fail ${n}`)}}const Ue="https://127.0.0.1:9443";function Mt(){try{return(localStorage.getItem("backendUrl")||Ue).replace(/\/+$/,"")}catch{return Ue}}const he=9e3,Dt=60,Lt=9e4,Rt=1,Ot=3e3;async function ge(n,r,l){return Q(async()=>{const u=Mt()+n,f={"Content-Type":"application/json"},e=j()||"1.4";f["x-schema-version"]=e;const t=q();t&&(f["x-api-key"]=t);const a={...r||{},schema:e},i=JSON.stringify(a),o=new TextEncoder().encode(i).length;let s=l,c=Rt,d=Ot;if(n==="/api/analyze"){if(s==null){const g=he+Dt*(o/1024);s=Math.max(he,Math.min(Lt,Math.floor(g)))}try{for(const g of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const m=localStorage.getItem(g);if(m){const y=parseInt(m,10);if(Number.isFinite(y)){s=y;break}}}}catch{}try{const g=localStorage.getItem("cai.retry.analyze.count");g&&(c=parseInt(g,10))}catch{}try{const g=localStorage.getItem("cai.retry.analyze.backoff.ms");g&&(d=parseInt(g,10))}catch{}try{const g=new URLSearchParams(location.search),m=g.get("ta");m&&(s=parseInt(m,10));const y=g.get("rac");y&&(c=parseInt(y,10));const v=g.get("rb");v&&(d=parseInt(v,10))}catch{}}s=s??he;async function h(g){const m=new AbortController;m.__key=n;const y=setTimeout(()=>m.abort(`timeout ${s}ms`),s);_t(m),wt(y);try{const v=await fetch(u,{method:"POST",headers:f,body:i,credentials:"include",signal:m.signal}),p=await v.json().catch(()=>({}));if(v.status===422){console.warn("[analyze] 422",p.detail);const _=Array.isArray(p?.detail)?p.detail.map(b=>b.msg).join("; "):p?.detail;try{D(`Validation error: ${_}`)}catch{}}return n==="/api/analyze"&&(v.status===504||v.status>=500)&&g<c?(await new Promise(_=>setTimeout(_,d)),h(g+1)):{resp:v,json:p}}catch(v){if(n==="/api/analyze"&&v?.name==="AbortError"){const p=m.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${p}`),g<c&&String(p).startsWith("timeout"))return await new Promise(_=>setTimeout(_,d)),h(g+1);throw new DOMException(p,"AbortError")}kt(`[NET] ${n} failed`,v,{body:a});try{const p=ze?String(v):"Analysis failed, please try again";D(p)}catch{}throw v}finally{clearTimeout(y),At(y),bt(m)}}return h(0)})}window.postJson=ge;async function $t(n={}){const r={text:n?.text??n?.content,mode:n?.mode??"live"},{resp:l,json:u}=await ge("/api/analyze",r),f=Tt({headers:l.headers,json:u,status:l.status});try{de(f)}catch{}try{const e=window;e.__last||(e.__last={}),e.__last.analyze={status:l.status,req:{path:"/api/analyze",method:"POST",body:r},json:u}}catch{}return{ok:l.ok,json:u,resp:l,meta:f}}async function Nt(n,r){return ge("/api/panel/redlines",{before_text:n,after_text:r})}const Ft={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function P(n){return n?n.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function ee(n){const r=(n||"").toLowerCase();return r==="high"?3:r==="medium"?2:1}function je(n){const r=new Map;let l=0,u=0;for(const e of n||[]){const t=P(e.snippet||""),a=typeof e.start=="number"?e.start:void 0,i=typeof e.end=="number"?e.end:a!==void 0?a+t.length:void 0;if(typeof a!="number"||typeof i!="number"||i<=a||i-a>1e4){l++;continue}const o=`${e.rule_id||""}|${a}|${i}|${t}`,s=r.get(o);!s||ee(e.severity)>ee(s.severity)?r.set(o,{...e,snippet:t,start:a,end:i}):u++}const f=Array.from(r.values());return console.log("panel:annotate",`dedupe dropped ${l} invalid, ${u} duplicates`),f}async function te(n,r,l){const u=n?.context,f=(r??"").trim();if(!f)return{items:[]};if(f.length<=240)try{const o=n.search(f,l);return o?.load?.("items"),await u?.sync?.(),o}catch{return{items:[]}}const e=f.slice(0,120);let t;try{t=n.search(e,l),t?.load?.("items"),await u?.sync?.()}catch{return{items:[]}}const a=[],i=f.slice(0,240);for(const o of t?.items||[]){let s=o;try{s=o.paragraphs?.getFirst?.()||o,s?.load?.("text"),await u?.sync?.()}catch{}const c=s?.text||"";if(c.includes(i))try{const g=s.search(i,l);g?.load?.("items"),await u?.sync?.(),g?.items?.length&&a.push(...g.items);continue}catch{}const d=i.split(/\s+/).filter(g=>g.length>3).slice(0,5);let h=!0;for(const g of d)if(!c.includes(g)){h=!1;break}h&&a.push(s)}return{items:a}}async function G(n,r){const l=n.context,u={matchCase:!1,matchWholeWord:!1},f=async i=>await te(n,i,u);let t=(await f(r||""))?.items||[];if(!t.length){const i=P(r||"");t=(await f(i))?.items||[]}t.sort((i,o)=>{const s=i.start??0,c=o.start??0;if(s!==c)return s-c;const d=i.end??s,h=o.end??c;return d-h});const a=[];for(const i of t){const o=i.start??0,s=i.end??o,c=a[a.length-1];if(c&&o<(c.end??o)){const d=(c.end??0)-(c.start??0);s-o>d&&(a[a.length-1]=i);continue}a.push(i)}for(const i of a)try{l.trackedObjects?.add?.(i)}catch{}return a}async function me(n,r){try{if(!Office.context.requirements.isSetSupported("WordApi","1.4"))return!1}catch{return!1}const l=n.context;try{const f=l?.document;if(f?.comments?.add)return f.comments.add(n,r),await l?.sync?.(),{ok:!0}}catch(f){if(f?.code==="NotImplemented")return!1}try{return n.insertComment(r),await l?.sync?.(),{ok:!0}}catch(f){lastErr=f}try{await l?.sync?.();const f=l?.document;if(f?.comments?.add)return f.comments.add(n,r),await l?.sync?.(),{ok:!0}}catch(f){lastErr=f}const u=globalThis;return console.warn("safeInsertComment failed",lastErr),u.logRichError?.(lastErr,"insertComment"),u.notifyWarn?.("Failed to insert comment"),{ok:!1,err:lastErr}}async function pe(n,r){const l=n.context;try{n.load?.("parentContentControl"),await l?.sync?.()}catch{}try{const u=n.parentContentControl;if(u&&u.tag==="cai-note")return{ok:!1}}catch{}try{const u=n.insertContentControl();u.tag="cai-note",u.title="ContractAI Note";try{u.color="yellow"}catch{}return u.insertText(`CAI: ${r}`,Word.InsertLocation.end),await l?.sync?.(),{ok:!0}}catch(u){return console.warn("fallbackAnnotateWithContentControl failed",u),{ok:!1}}}function Pt(n,r,l){if(!n||!r)return 0;let u=-1,f=0;for(;(u=n.indexOf(r,u+1))!==-1&&u<(l??n.length);)f++;return f}function Bt(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const B="[CAI]";function zt(n){if(!n.rule_id||!n.snippet)return console.warn("buildLegalComment: missing required fields",n),"";const r=[n.rule_id];if(n.advice&&r.push(n.advice),n.law_refs?.length&&r.push(n.law_refs.join("; ")),n.norm_quote&&r.push(`"${n.norm_quote}"`),n.clause_url||n.clause_id){const l=n.clause_id?`Clause ${n.clause_id}`:"Clause";n.clause_url?r.push(`${l}: ${n.clause_url}`):r.push(l)}return`${B} ${r.join(`
`)}`}const ye=200;function ve(n){const r=P(globalThis.__lastAnalyzed||""),l=Array.isArray(n)?n:[],u=je(l),f=u.slice().sort((o,s)=>(o.start??Number.POSITIVE_INFINITY)-(s.start??Number.POSITIVE_INFINITY)),e=[];let t=-1,a=0;for(const o of f){if(!o||!o.rule_id||!o.snippet||typeof o.start!="number"){a++;continue}const s=o.snippet,c=o.start,d=typeof o.end=="number"?o.end:c+s.length;if(c<t){a++;continue}const h=P(s),g=Pt(r,h,c);if(e.push({raw:s,norm:h,occIdx:g,msg:zt(o),rule_id:o.rule_id,code:o.code,normalized_fallback:P(o.normalized_snippet||"")}),t=d,e.length>=ye)break}const i=globalThis;return a&&i.notifyWarn?.(`Skipped ${a} overlaps/invalid`),u.length>ye&&i.notifyWarn?.(`Truncated to first ${ye} findings`),i.notifyOk?.(`Will insert: ${e.length}`),e}async function He(n){const r=ve(n);return r.length?await globalThis.Word?.run?.(async u=>{const f=u.document.body,e=[];let t=0;for(const a of r){let i=await G(f,a.raw),o=i[Math.min(a.occIdx,i.length-1)]||null;if(!o&&a.normalized_fallback&&a.normalized_fallback!==a.norm&&(i=await G(f,a.normalized_fallback),o=i[Math.min(a.occIdx,i.length-1)]||null),o){o.load?.(["start","end"]),await u.sync();const s=o.start??0,c=o.end??s;if(e.some(h=>Math.max(h.start,s)<Math.min(h.end,c))){console.warn("[annotate] overlapping range",{rid:a.rule_id,start:s,end:c});continue}let d=!1;if(Bt())try{o.select(),d=!0}catch{}else a.msg&&((await me(o,a.msg)).ok?d=!0:d=(await pe(o,a.msg.replace(B,"").trim())).ok);d&&(e.push({start:s,end:c}),t++)}else console.warn("[annotate] no match for snippet",{rid:a.rule_id,snippet:a.raw.slice(0,120)});await u.sync()}return t}).catch(u=>(globalThis.logRichError?.(u,"annotate"),console.warn("annotate run fail",u?.code,u?.message,u?.debugInfo),0)):0}async function Wt(n,r,l){if(!n||!n.trim())return;const u=globalThis;if(!u.Word?.run){await u.navigator?.clipboard?.writeText(n).catch(()=>{}),u.alert?.("Draft copied to clipboard (Office not ready). Paste it into the document.");return}if(u.Office?.context?.document?.mode&&u.Office.context.document.mode!=="edit")throw u.alert?.("Document is read-only."),new Error("Document mode is not editable");await u.Word.run(async f=>{const e=f.document;let t=null;const a=e.trackRevisions;try{const h=u.__findings||[],g=u.__findingIdx,m=h&&typeof g=="number"?h[g]:null,y=e.body;if(t=(m?.snippet?await G(y,m.snippet):[])[0]||null,!t){const p=e.getSelection();p.load("isEmpty"),await f.sync(),t=p.isEmpty?e.body.getRange("End"):p}}catch{const h=e.getSelection();h.load("isEmpty"),await f.sync(),t=h.isEmpty?e.body.getRange("End"):h}e.trackRevisions=!0;const i=t.insertText(n,u.Word.InsertLocation.replace),o=[`${B} Suggested clause – ${r}`],s=(l||"").split(/\r?\n/).slice(0,2).join(" "),c=u.__findings||[],d=u.__findingIdx;if(s)o.push(s);else{const h=c&&typeof d=="number"?c[d]:null,g=h?.rule_id||h?.title||"";g&&o.push(g)}o.push("schema 1.4 | model gpt-4o-mini | provider azure");try{e.comments.add(i,o.join(`
`))}catch{}await f.sync(),e.trackRevisions=a,await f.sync()}).catch(f=>{throw globalThis.logRichError?.(f,"insertDraft"),console.warn("insertDraftText error",f?.code,f?.message,f?.debugInfo),f})}function Ut(){const n=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),r=globalThis.Word||{},l=n&&!!r?.Revision,u=n&&!!r?.SearchOptions,f=n&&!!r?.ContentControl,t=globalThis.localStorage?.getItem?.("cai.force.comments")==="1";return{revisions:l,comments:t||n,search:u,contentControls:f,commentsReason:t?"dev override":n?"WordApi 1.4":"WordApi < 1.4"}}function Ke(){const n=Ut();try{console.log("support matrix",{comments:n.comments,reason:n.commentsReason})}catch{}return n}async function jt(n){const r=[];try{await Ct()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(s=>{document.getElementById(s)||r.push(`missingID:${s}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||r.push("req1.4:0");const l=Ke(),u={revisions:l.revisions?1:0,comments:l.comments?1:0,search:l.search?1:0,contentControls:l.contentControls?1:0};let f=!1;try{f=(await Fe({backend:n})).ok,f||r.push("health")}catch{r.push("health:timeout")}const e="build-20250915-174338",t=Office?.context?.host||"Word",a=r.length===0,i=a?`Startup OK | build=${e} | host=${t} | req=1.4 | features=${JSON.stringify(u)} | backend=${n}`:`Startup FAIL: ${r.join("; ")}`;console.log(i);const o=document.getElementById("startupBadge");return o&&(o.textContent=a?"OK":"FAIL",o.setAttribute("data-status",a?"ok":"fail")),{ok:a,missing:r,features:u}}function Ht(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var _e={exports:{}},Ve;function Kt(){return Ve||(Ve=1,(function(n){var r=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},l=-1,u=1,f=0;r.Diff=function(e,t){return[e,t]},r.prototype.diff_main=function(e,t,a,i){typeof i>"u"&&(this.Diff_Timeout<=0?i=Number.MAX_VALUE:i=new Date().getTime()+this.Diff_Timeout*1e3);var o=i;if(e==null||t==null)throw new Error("Null input. (diff_main)");if(e==t)return e?[new r.Diff(f,e)]:[];typeof a>"u"&&(a=!0);var s=a,c=this.diff_commonPrefix(e,t),d=e.substring(0,c);e=e.substring(c),t=t.substring(c),c=this.diff_commonSuffix(e,t);var h=e.substring(e.length-c);e=e.substring(0,e.length-c),t=t.substring(0,t.length-c);var g=this.diff_compute_(e,t,s,o);return d&&g.unshift(new r.Diff(f,d)),h&&g.push(new r.Diff(f,h)),this.diff_cleanupMerge(g),g},r.prototype.diff_compute_=function(e,t,a,i){var o;if(!e)return[new r.Diff(u,t)];if(!t)return[new r.Diff(l,e)];var s=e.length>t.length?e:t,c=e.length>t.length?t:e,d=s.indexOf(c);if(d!=-1)return o=[new r.Diff(u,s.substring(0,d)),new r.Diff(f,c),new r.Diff(u,s.substring(d+c.length))],e.length>t.length&&(o[0][0]=o[2][0]=l),o;if(c.length==1)return[new r.Diff(l,e),new r.Diff(u,t)];var h=this.diff_halfMatch_(e,t);if(h){var g=h[0],m=h[1],y=h[2],v=h[3],p=h[4],_=this.diff_main(g,y,a,i),b=this.diff_main(m,v,a,i);return _.concat([new r.Diff(f,p)],b)}return a&&e.length>100&&t.length>100?this.diff_lineMode_(e,t,i):this.diff_bisect_(e,t,i)},r.prototype.diff_lineMode_=function(e,t,a){var i=this.diff_linesToChars_(e,t);e=i.chars1,t=i.chars2;var o=i.lineArray,s=this.diff_main(e,t,!1,a);this.diff_charsToLines_(s,o),this.diff_cleanupSemantic(s),s.push(new r.Diff(f,""));for(var c=0,d=0,h=0,g="",m="";c<s.length;){switch(s[c][0]){case u:h++,m+=s[c][1];break;case l:d++,g+=s[c][1];break;case f:if(d>=1&&h>=1){s.splice(c-d-h,d+h),c=c-d-h;for(var y=this.diff_main(g,m,!1,a),v=y.length-1;v>=0;v--)s.splice(c,0,y[v]);c=c+y.length}h=0,d=0,g="",m="";break}c++}return s.pop(),s},r.prototype.diff_bisect_=function(e,t,a){for(var i=e.length,o=t.length,s=Math.ceil((i+o)/2),c=s,d=2*s,h=new Array(d),g=new Array(d),m=0;m<d;m++)h[m]=-1,g[m]=-1;h[c+1]=0,g[c+1]=0;for(var y=i-o,v=y%2!=0,p=0,_=0,b=0,A=0,E=0;E<s&&!(new Date().getTime()>a);E++){for(var I=-E+p;I<=E-_;I+=2){var S=c+I,T;I==-E||I!=E&&h[S-1]<h[S+1]?T=h[S+1]:T=h[S-1]+1;for(var L=T-I;T<i&&L<o&&e.charAt(T)==t.charAt(L);)T++,L++;if(h[S]=T,T>i)_+=2;else if(L>o)p+=2;else if(v){var M=c+y-I;if(M>=0&&M<d&&g[M]!=-1){var C=i-g[M];if(T>=C)return this.diff_bisectSplit_(e,t,T,L,a)}}}for(var R=-E+b;R<=E-A;R+=2){var M=c+R,C;R==-E||R!=E&&g[M-1]<g[M+1]?C=g[M+1]:C=g[M-1]+1;for(var F=C-R;C<i&&F<o&&e.charAt(i-C-1)==t.charAt(o-F-1);)C++,F++;if(g[M]=C,C>i)A+=2;else if(F>o)b+=2;else if(!v){var S=c+y-R;if(S>=0&&S<d&&h[S]!=-1){var T=h[S],L=c+T-S;if(C=i-C,T>=C)return this.diff_bisectSplit_(e,t,T,L,a)}}}}return[new r.Diff(l,e),new r.Diff(u,t)]},r.prototype.diff_bisectSplit_=function(e,t,a,i,o){var s=e.substring(0,a),c=t.substring(0,i),d=e.substring(a),h=t.substring(i),g=this.diff_main(s,c,!1,o),m=this.diff_main(d,h,!1,o);return g.concat(m)},r.prototype.diff_linesToChars_=function(e,t){var a=[],i={};a[0]="";function o(h){for(var g="",m=0,y=-1,v=a.length;y<h.length-1;){y=h.indexOf(`
`,m),y==-1&&(y=h.length-1);var p=h.substring(m,y+1);(i.hasOwnProperty?i.hasOwnProperty(p):i[p]!==void 0)?g+=String.fromCharCode(i[p]):(v==s&&(p=h.substring(m),y=h.length),g+=String.fromCharCode(v),i[p]=v,a[v++]=p),m=y+1}return g}var s=4e4,c=o(e);s=65535;var d=o(t);return{chars1:c,chars2:d,lineArray:a}},r.prototype.diff_charsToLines_=function(e,t){for(var a=0;a<e.length;a++){for(var i=e[a][1],o=[],s=0;s<i.length;s++)o[s]=t[i.charCodeAt(s)];e[a][1]=o.join("")}},r.prototype.diff_commonPrefix=function(e,t){if(!e||!t||e.charAt(0)!=t.charAt(0))return 0;for(var a=0,i=Math.min(e.length,t.length),o=i,s=0;a<o;)e.substring(s,o)==t.substring(s,o)?(a=o,s=a):i=o,o=Math.floor((i-a)/2+a);return o},r.prototype.diff_commonSuffix=function(e,t){if(!e||!t||e.charAt(e.length-1)!=t.charAt(t.length-1))return 0;for(var a=0,i=Math.min(e.length,t.length),o=i,s=0;a<o;)e.substring(e.length-o,e.length-s)==t.substring(t.length-o,t.length-s)?(a=o,s=a):i=o,o=Math.floor((i-a)/2+a);return o},r.prototype.diff_commonOverlap_=function(e,t){var a=e.length,i=t.length;if(a==0||i==0)return 0;a>i?e=e.substring(a-i):a<i&&(t=t.substring(0,a));var o=Math.min(a,i);if(e==t)return o;for(var s=0,c=1;;){var d=e.substring(o-c),h=t.indexOf(d);if(h==-1)return s;c+=h,(h==0||e.substring(o-c)==t.substring(0,c))&&(s=c,c++)}},r.prototype.diff_halfMatch_=function(e,t){if(this.Diff_Timeout<=0)return null;var a=e.length>t.length?e:t,i=e.length>t.length?t:e;if(a.length<4||i.length*2<a.length)return null;var o=this;function s(_,b,A){for(var E=_.substring(A,A+Math.floor(_.length/4)),I=-1,S="",T,L,M,C;(I=b.indexOf(E,I+1))!=-1;){var R=o.diff_commonPrefix(_.substring(A),b.substring(I)),F=o.diff_commonSuffix(_.substring(0,A),b.substring(0,I));S.length<F+R&&(S=b.substring(I-F,I)+b.substring(I,I+R),T=_.substring(0,A-F),L=_.substring(A+R),M=b.substring(0,I-F),C=b.substring(I+R))}return S.length*2>=_.length?[T,L,M,C,S]:null}var c=s(a,i,Math.ceil(a.length/4)),d=s(a,i,Math.ceil(a.length/2)),h;if(!c&&!d)return null;d?c?h=c[4].length>d[4].length?c:d:h=d:h=c;var g,m,y,v;e.length>t.length?(g=h[0],m=h[1],y=h[2],v=h[3]):(y=h[0],v=h[1],g=h[2],m=h[3]);var p=h[4];return[g,m,y,v,p]},r.prototype.diff_cleanupSemantic=function(e){for(var t=!1,a=[],i=0,o=null,s=0,c=0,d=0,h=0,g=0;s<e.length;)e[s][0]==f?(a[i++]=s,c=h,d=g,h=0,g=0,o=e[s][1]):(e[s][0]==u?h+=e[s][1].length:g+=e[s][1].length,o&&o.length<=Math.max(c,d)&&o.length<=Math.max(h,g)&&(e.splice(a[i-1],0,new r.Diff(l,o)),e[a[i-1]+1][0]=u,i--,i--,s=i>0?a[i-1]:-1,c=0,d=0,h=0,g=0,o=null,t=!0)),s++;for(t&&this.diff_cleanupMerge(e),this.diff_cleanupSemanticLossless(e),s=1;s<e.length;){if(e[s-1][0]==l&&e[s][0]==u){var m=e[s-1][1],y=e[s][1],v=this.diff_commonOverlap_(m,y),p=this.diff_commonOverlap_(y,m);v>=p?(v>=m.length/2||v>=y.length/2)&&(e.splice(s,0,new r.Diff(f,y.substring(0,v))),e[s-1][1]=m.substring(0,m.length-v),e[s+1][1]=y.substring(v),s++):(p>=m.length/2||p>=y.length/2)&&(e.splice(s,0,new r.Diff(f,m.substring(0,p))),e[s-1][0]=u,e[s-1][1]=y.substring(0,y.length-p),e[s+1][0]=l,e[s+1][1]=m.substring(p),s++),s++}s++}},r.prototype.diff_cleanupSemanticLossless=function(e){function t(p,_){if(!p||!_)return 6;var b=p.charAt(p.length-1),A=_.charAt(0),E=b.match(r.nonAlphaNumericRegex_),I=A.match(r.nonAlphaNumericRegex_),S=E&&b.match(r.whitespaceRegex_),T=I&&A.match(r.whitespaceRegex_),L=S&&b.match(r.linebreakRegex_),M=T&&A.match(r.linebreakRegex_),C=L&&p.match(r.blanklineEndRegex_),R=M&&_.match(r.blanklineStartRegex_);return C||R?5:L||M?4:E&&!S&&T?3:S||T?2:E||I?1:0}for(var a=1;a<e.length-1;){if(e[a-1][0]==f&&e[a+1][0]==f){var i=e[a-1][1],o=e[a][1],s=e[a+1][1],c=this.diff_commonSuffix(i,o);if(c){var d=o.substring(o.length-c);i=i.substring(0,i.length-c),o=d+o.substring(0,o.length-c),s=d+s}for(var h=i,g=o,m=s,y=t(i,o)+t(o,s);o.charAt(0)===s.charAt(0);){i+=o.charAt(0),o=o.substring(1)+s.charAt(0),s=s.substring(1);var v=t(i,o)+t(o,s);v>=y&&(y=v,h=i,g=o,m=s)}e[a-1][1]!=h&&(h?e[a-1][1]=h:(e.splice(a-1,1),a--),e[a][1]=g,m?e[a+1][1]=m:(e.splice(a+1,1),a--))}a++}},r.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,r.whitespaceRegex_=/\s/,r.linebreakRegex_=/[\r\n]/,r.blanklineEndRegex_=/\n\r?\n$/,r.blanklineStartRegex_=/^\r?\n\r?\n/,r.prototype.diff_cleanupEfficiency=function(e){for(var t=!1,a=[],i=0,o=null,s=0,c=!1,d=!1,h=!1,g=!1;s<e.length;)e[s][0]==f?(e[s][1].length<this.Diff_EditCost&&(h||g)?(a[i++]=s,c=h,d=g,o=e[s][1]):(i=0,o=null),h=g=!1):(e[s][0]==l?g=!0:h=!0,o&&(c&&d&&h&&g||o.length<this.Diff_EditCost/2&&c+d+h+g==3)&&(e.splice(a[i-1],0,new r.Diff(l,o)),e[a[i-1]+1][0]=u,i--,o=null,c&&d?(h=g=!0,i=0):(i--,s=i>0?a[i-1]:-1,h=g=!1),t=!0)),s++;t&&this.diff_cleanupMerge(e)},r.prototype.diff_cleanupMerge=function(e){e.push(new r.Diff(f,""));for(var t=0,a=0,i=0,o="",s="",c;t<e.length;)switch(e[t][0]){case u:i++,s+=e[t][1],t++;break;case l:a++,o+=e[t][1],t++;break;case f:a+i>1?(a!==0&&i!==0&&(c=this.diff_commonPrefix(s,o),c!==0&&(t-a-i>0&&e[t-a-i-1][0]==f?e[t-a-i-1][1]+=s.substring(0,c):(e.splice(0,0,new r.Diff(f,s.substring(0,c))),t++),s=s.substring(c),o=o.substring(c)),c=this.diff_commonSuffix(s,o),c!==0&&(e[t][1]=s.substring(s.length-c)+e[t][1],s=s.substring(0,s.length-c),o=o.substring(0,o.length-c))),t-=a+i,e.splice(t,a+i),o.length&&(e.splice(t,0,new r.Diff(l,o)),t++),s.length&&(e.splice(t,0,new r.Diff(u,s)),t++),t++):t!==0&&e[t-1][0]==f?(e[t-1][1]+=e[t][1],e.splice(t,1)):t++,i=0,a=0,o="",s="";break}e[e.length-1][1]===""&&e.pop();var d=!1;for(t=1;t<e.length-1;)e[t-1][0]==f&&e[t+1][0]==f&&(e[t][1].substring(e[t][1].length-e[t-1][1].length)==e[t-1][1]?(e[t][1]=e[t-1][1]+e[t][1].substring(0,e[t][1].length-e[t-1][1].length),e[t+1][1]=e[t-1][1]+e[t+1][1],e.splice(t-1,1),d=!0):e[t][1].substring(0,e[t+1][1].length)==e[t+1][1]&&(e[t-1][1]+=e[t+1][1],e[t][1]=e[t][1].substring(e[t+1][1].length)+e[t+1][1],e.splice(t+1,1),d=!0)),t++;d&&this.diff_cleanupMerge(e)},r.prototype.diff_xIndex=function(e,t){var a=0,i=0,o=0,s=0,c;for(c=0;c<e.length&&(e[c][0]!==u&&(a+=e[c][1].length),e[c][0]!==l&&(i+=e[c][1].length),!(a>t));c++)o=a,s=i;return e.length!=c&&e[c][0]===l?s:s+(t-o)},r.prototype.diff_prettyHtml=function(e){for(var t=[],a=/&/g,i=/</g,o=/>/g,s=/\n/g,c=0;c<e.length;c++){var d=e[c][0],h=e[c][1],g=h.replace(a,"&amp;").replace(i,"&lt;").replace(o,"&gt;").replace(s,"&para;<br>");switch(d){case u:t[c]='<ins style="background:#e6ffe6;">'+g+"</ins>";break;case l:t[c]='<del style="background:#ffe6e6;">'+g+"</del>";break;case f:t[c]="<span>"+g+"</span>";break}}return t.join("")},r.prototype.diff_text1=function(e){for(var t=[],a=0;a<e.length;a++)e[a][0]!==u&&(t[a]=e[a][1]);return t.join("")},r.prototype.diff_text2=function(e){for(var t=[],a=0;a<e.length;a++)e[a][0]!==l&&(t[a]=e[a][1]);return t.join("")},r.prototype.diff_levenshtein=function(e){for(var t=0,a=0,i=0,o=0;o<e.length;o++){var s=e[o][0],c=e[o][1];switch(s){case u:a+=c.length;break;case l:i+=c.length;break;case f:t+=Math.max(a,i),a=0,i=0;break}}return t+=Math.max(a,i),t},r.prototype.diff_toDelta=function(e){for(var t=[],a=0;a<e.length;a++)switch(e[a][0]){case u:t[a]="+"+encodeURI(e[a][1]);break;case l:t[a]="-"+e[a][1].length;break;case f:t[a]="="+e[a][1].length;break}return t.join("	").replace(/%20/g," ")},r.prototype.diff_fromDelta=function(e,t){for(var a=[],i=0,o=0,s=t.split(/\t/g),c=0;c<s.length;c++){var d=s[c].substring(1);switch(s[c].charAt(0)){case"+":try{a[i++]=new r.Diff(u,decodeURI(d))}catch{throw new Error("Illegal escape in diff_fromDelta: "+d)}break;case"-":case"=":var h=parseInt(d,10);if(isNaN(h)||h<0)throw new Error("Invalid number in diff_fromDelta: "+d);var g=e.substring(o,o+=h);s[c].charAt(0)=="="?a[i++]=new r.Diff(f,g):a[i++]=new r.Diff(l,g);break;default:if(s[c])throw new Error("Invalid diff operation in diff_fromDelta: "+s[c])}}if(o!=e.length)throw new Error("Delta length ("+o+") does not equal source text length ("+e.length+").");return a},r.prototype.match_main=function(e,t,a){if(e==null||t==null||a==null)throw new Error("Null input. (match_main)");return a=Math.max(0,Math.min(a,e.length)),e==t?0:e.length?e.substring(a,a+t.length)==t?a:this.match_bitap_(e,t,a):-1},r.prototype.match_bitap_=function(e,t,a){if(t.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var i=this.match_alphabet_(t),o=this;function s(T,L){var M=T/t.length,C=Math.abs(a-L);return o.Match_Distance?M+C/o.Match_Distance:C?1:M}var c=this.Match_Threshold,d=e.indexOf(t,a);d!=-1&&(c=Math.min(s(0,d),c),d=e.lastIndexOf(t,a+t.length),d!=-1&&(c=Math.min(s(0,d),c)));var h=1<<t.length-1;d=-1;for(var g,m,y=t.length+e.length,v,p=0;p<t.length;p++){for(g=0,m=y;g<m;)s(p,a+m)<=c?g=m:y=m,m=Math.floor((y-g)/2+g);y=m;var _=Math.max(1,a-m+1),b=Math.min(a+m,e.length)+t.length,A=Array(b+2);A[b+1]=(1<<p)-1;for(var E=b;E>=_;E--){var I=i[e.charAt(E-1)];if(p===0?A[E]=(A[E+1]<<1|1)&I:A[E]=(A[E+1]<<1|1)&I|((v[E+1]|v[E])<<1|1)|v[E+1],A[E]&h){var S=s(p,E-1);if(S<=c)if(c=S,d=E-1,d>a)_=Math.max(1,2*a-d);else break}}if(s(p+1,a)>c)break;v=A}return d},r.prototype.match_alphabet_=function(e){for(var t={},a=0;a<e.length;a++)t[e.charAt(a)]=0;for(var a=0;a<e.length;a++)t[e.charAt(a)]|=1<<e.length-a-1;return t},r.prototype.patch_addContext_=function(e,t){if(t.length!=0){if(e.start2===null)throw Error("patch not initialized");for(var a=t.substring(e.start2,e.start2+e.length1),i=0;t.indexOf(a)!=t.lastIndexOf(a)&&a.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)i+=this.Patch_Margin,a=t.substring(e.start2-i,e.start2+e.length1+i);i+=this.Patch_Margin;var o=t.substring(e.start2-i,e.start2);o&&e.diffs.unshift(new r.Diff(f,o));var s=t.substring(e.start2+e.length1,e.start2+e.length1+i);s&&e.diffs.push(new r.Diff(f,s)),e.start1-=o.length,e.start2-=o.length,e.length1+=o.length+s.length,e.length2+=o.length+s.length}},r.prototype.patch_make=function(e,t,a){var i,o;if(typeof e=="string"&&typeof t=="string"&&typeof a>"u")i=e,o=this.diff_main(i,t,!0),o.length>2&&(this.diff_cleanupSemantic(o),this.diff_cleanupEfficiency(o));else if(e&&typeof e=="object"&&typeof t>"u"&&typeof a>"u")o=e,i=this.diff_text1(o);else if(typeof e=="string"&&t&&typeof t=="object"&&typeof a>"u")i=e,o=t;else if(typeof e=="string"&&typeof t=="string"&&a&&typeof a=="object")i=e,o=a;else throw new Error("Unknown call format to patch_make.");if(o.length===0)return[];for(var s=[],c=new r.patch_obj,d=0,h=0,g=0,m=i,y=i,v=0;v<o.length;v++){var p=o[v][0],_=o[v][1];switch(!d&&p!==f&&(c.start1=h,c.start2=g),p){case u:c.diffs[d++]=o[v],c.length2+=_.length,y=y.substring(0,g)+_+y.substring(g);break;case l:c.length1+=_.length,c.diffs[d++]=o[v],y=y.substring(0,g)+y.substring(g+_.length);break;case f:_.length<=2*this.Patch_Margin&&d&&o.length!=v+1?(c.diffs[d++]=o[v],c.length1+=_.length,c.length2+=_.length):_.length>=2*this.Patch_Margin&&d&&(this.patch_addContext_(c,m),s.push(c),c=new r.patch_obj,d=0,m=y,h=g);break}p!==u&&(h+=_.length),p!==l&&(g+=_.length)}return d&&(this.patch_addContext_(c,m),s.push(c)),s},r.prototype.patch_deepCopy=function(e){for(var t=[],a=0;a<e.length;a++){var i=e[a],o=new r.patch_obj;o.diffs=[];for(var s=0;s<i.diffs.length;s++)o.diffs[s]=new r.Diff(i.diffs[s][0],i.diffs[s][1]);o.start1=i.start1,o.start2=i.start2,o.length1=i.length1,o.length2=i.length2,t[a]=o}return t},r.prototype.patch_apply=function(e,t){if(e.length==0)return[t,[]];e=this.patch_deepCopy(e);var a=this.patch_addPadding(e);t=a+t+a,this.patch_splitMax(e);for(var i=0,o=[],s=0;s<e.length;s++){var c=e[s].start2+i,d=this.diff_text1(e[s].diffs),h,g=-1;if(d.length>this.Match_MaxBits?(h=this.match_main(t,d.substring(0,this.Match_MaxBits),c),h!=-1&&(g=this.match_main(t,d.substring(d.length-this.Match_MaxBits),c+d.length-this.Match_MaxBits),(g==-1||h>=g)&&(h=-1))):h=this.match_main(t,d,c),h==-1)o[s]=!1,i-=e[s].length2-e[s].length1;else{o[s]=!0,i=h-c;var m;if(g==-1?m=t.substring(h,h+d.length):m=t.substring(h,g+this.Match_MaxBits),d==m)t=t.substring(0,h)+this.diff_text2(e[s].diffs)+t.substring(h+d.length);else{var y=this.diff_main(d,m,!1);if(d.length>this.Match_MaxBits&&this.diff_levenshtein(y)/d.length>this.Patch_DeleteThreshold)o[s]=!1;else{this.diff_cleanupSemanticLossless(y);for(var v=0,p,_=0;_<e[s].diffs.length;_++){var b=e[s].diffs[_];b[0]!==f&&(p=this.diff_xIndex(y,v)),b[0]===u?t=t.substring(0,h+p)+b[1]+t.substring(h+p):b[0]===l&&(t=t.substring(0,h+p)+t.substring(h+this.diff_xIndex(y,v+b[1].length))),b[0]!==l&&(v+=b[1].length)}}}}}return t=t.substring(a.length,t.length-a.length),[t,o]},r.prototype.patch_addPadding=function(e){for(var t=this.Patch_Margin,a="",i=1;i<=t;i++)a+=String.fromCharCode(i);for(var i=0;i<e.length;i++)e[i].start1+=t,e[i].start2+=t;var o=e[0],s=o.diffs;if(s.length==0||s[0][0]!=f)s.unshift(new r.Diff(f,a)),o.start1-=t,o.start2-=t,o.length1+=t,o.length2+=t;else if(t>s[0][1].length){var c=t-s[0][1].length;s[0][1]=a.substring(s[0][1].length)+s[0][1],o.start1-=c,o.start2-=c,o.length1+=c,o.length2+=c}if(o=e[e.length-1],s=o.diffs,s.length==0||s[s.length-1][0]!=f)s.push(new r.Diff(f,a)),o.length1+=t,o.length2+=t;else if(t>s[s.length-1][1].length){var c=t-s[s.length-1][1].length;s[s.length-1][1]+=a.substring(0,c),o.length1+=c,o.length2+=c}return a},r.prototype.patch_splitMax=function(e){for(var t=this.Match_MaxBits,a=0;a<e.length;a++)if(!(e[a].length1<=t)){var i=e[a];e.splice(a--,1);for(var o=i.start1,s=i.start2,c="";i.diffs.length!==0;){var d=new r.patch_obj,h=!0;for(d.start1=o-c.length,d.start2=s-c.length,c!==""&&(d.length1=d.length2=c.length,d.diffs.push(new r.Diff(f,c)));i.diffs.length!==0&&d.length1<t-this.Patch_Margin;){var g=i.diffs[0][0],m=i.diffs[0][1];g===u?(d.length2+=m.length,s+=m.length,d.diffs.push(i.diffs.shift()),h=!1):g===l&&d.diffs.length==1&&d.diffs[0][0]==f&&m.length>2*t?(d.length1+=m.length,o+=m.length,h=!1,d.diffs.push(new r.Diff(g,m)),i.diffs.shift()):(m=m.substring(0,t-d.length1-this.Patch_Margin),d.length1+=m.length,o+=m.length,g===f?(d.length2+=m.length,s+=m.length):h=!1,d.diffs.push(new r.Diff(g,m)),m==i.diffs[0][1]?i.diffs.shift():i.diffs[0][1]=i.diffs[0][1].substring(m.length))}c=this.diff_text2(d.diffs),c=c.substring(c.length-this.Patch_Margin);var y=this.diff_text1(i.diffs).substring(0,this.Patch_Margin);y!==""&&(d.length1+=y.length,d.length2+=y.length,d.diffs.length!==0&&d.diffs[d.diffs.length-1][0]===f?d.diffs[d.diffs.length-1][1]+=y:d.diffs.push(new r.Diff(f,y))),h||e.splice(++a,0,d)}}},r.prototype.patch_toText=function(e){for(var t=[],a=0;a<e.length;a++)t[a]=e[a];return t.join("")},r.prototype.patch_fromText=function(e){var t=[];if(!e)return t;for(var a=e.split(`
`),i=0,o=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;i<a.length;){var s=a[i].match(o);if(!s)throw new Error("Invalid patch string: "+a[i]);var c=new r.patch_obj;for(t.push(c),c.start1=parseInt(s[1],10),s[2]===""?(c.start1--,c.length1=1):s[2]=="0"?c.length1=0:(c.start1--,c.length1=parseInt(s[2],10)),c.start2=parseInt(s[3],10),s[4]===""?(c.start2--,c.length2=1):s[4]=="0"?c.length2=0:(c.start2--,c.length2=parseInt(s[4],10)),i++;i<a.length;){var d=a[i].charAt(0);try{var h=decodeURI(a[i].substring(1))}catch{throw new Error("Illegal escape in patch_fromText: "+h)}if(d=="-")c.diffs.push(new r.Diff(l,h));else if(d=="+")c.diffs.push(new r.Diff(u,h));else if(d==" ")c.diffs.push(new r.Diff(f,h));else{if(d=="@")break;if(d!=="")throw new Error('Invalid patch mode "'+d+'" in: '+h)}i++}}return t},r.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},r.patch_obj.prototype.toString=function(){var e,t;this.length1===0?e=this.start1+",0":this.length1==1?e=this.start1+1:e=this.start1+1+","+this.length1,this.length2===0?t=this.start2+",0":this.length2==1?t=this.start2+1:t=this.start2+1+","+this.length2;for(var a=["@@ -"+e+" +"+t+` @@
`],i,o=0;o<this.diffs.length;o++){switch(this.diffs[o][0]){case u:i="+";break;case l:i="-";break;case f:i=" ";break}a[o+1]=i+encodeURI(this.diffs[o][1])+`
`}return a.join("").replace(/%20/g," ")},n.exports=r,n.exports.diff_match_patch=r,n.exports.DIFF_DELETE=l,n.exports.DIFF_INSERT=u,n.exports.DIFF_EQUAL=f})(_e)),_e.exports}var Vt=Kt();const qt=Ht(Vt);async function be(){return await Word.run(async n=>{const r=n.document.body;return r.load("text"),await n.sync(),(r.text||"").trim()})}async function Jt(){return await Word.run(async n=>{const r=n.document.getSelection();return r.load("text"),await n.sync(),(r.text||"").trim()})}var qe={};const we=globalThis,Ae=we.OfficeExtension,Je="build-20250915-174338";console.log("ContractAI build",Je);let Ye=null,Qe="1",Ge="1";try{Ye=localStorage.getItem("cai_timeout_ms:analyze"),Qe=localStorage.getItem("cai_abort_on_hidden")||"1",Ge=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:Ye,abort_on_hidden:Qe,abort_on_navigation:Ge}),!Je.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const n=document.createElement("div");n.textContent="FATAL: stale bundle",n.style.padding="12px",n.style.color="#f66",document.body.innerHTML="",document.body.appendChild(n),document.querySelectorAll("button").forEach(r=>{r.disabled=!0})}catch{}});const Xe=(()=>{const n=we.ENV_MODE||(typeof process<"u"?qe?.ENV_MODE:void 0);return n?n==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();Ae&&Ae.config&&(Xe==="dev"||we.__ENABLE_EXTENDED_LOGS__)&&(Ae.config.extendedErrorLogging=!0);function X(n,r="Word"){try{const l=n&&n.debugInfo||{};console.error(`[${r}] RichApi error`,{code:n.code,message:n.message,errorLocation:l.errorLocation,statements:l.statements,traceMessages:l.traceMessages,inner:l.innerError})}catch{}}function ne(n){return(We(n)||[]).filter(l=>l&&l.rule_id&&l.snippet).map(l=>({...l,clause_type:l.clause_type||"Unknown"})).filter(l=>l.clause_type)}const k=globalThis;k.parseFindings=k.parseFindings||ne,k.applyMetaToBadges=k.applyMetaToBadges||de,k.getApiKeyFromStore=k.getApiKeyFromStore||q,k.getSchemaFromStore=k.getSchemaFromStore||j,k.logRichError=k.logRichError||X,k.getWholeDocText=k.getWholeDocText||be,k.getSelectionText=k.getSelectionText||Jt;const Ze=k.__appliedRangeHashes||new Set;k.__appliedRangeHashes=Ze;let Ee="live";const z={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let re="",xe=!1,Ie=!1;const Yt=Ft.required_ids||[];function w(n){const r=document.getElementById(n);if(!r)throw new Error(`missing element #${n}`);return r}function Se(n,r){const l=w("status-chip"),u=(n??j())||"—",f=(r??re)||"—";l.textContent=`schema: ${u} | cid: ${f}`}function et(){const n=w("anchorsBadge"),r=globalThis.__anchorsSkipped||0;n.style.display=r>0?"":"none"}k.updateAnchorBadge=k.updateAnchorBadge||et;function Qt(){if(xe)return;O("#btnAnalyze",yn);const n=w("btnAnalyze");n.disabled=!1,xe=!0,console.log("[PANEL] analyze enabled")}function tt(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://127.0.0.1:9443").replace(/\/+$/,"")}catch{return"https://127.0.0.1:9443"}}function Gt(){const r=w("backendUrl").value.trim();if(r)try{localStorage.setItem("backend.url",r),localStorage.setItem("backendUrl",r)}catch{}location.reload()}function ke(){let n=q(),r=j();const l=w("hdrWarn"),u=globalThis?.location?.hostname??"",f=u==="localhost"||u==="127.0.0.1";if(f&&(n||(n="local-test-key-123",$e(n)),!r)){const e=globalThis?.SCHEMA_VERSION||typeof process<"u"&&qe?.SCHEMA_VERSION||"1.4";r=String(e),J(r)}return!n&&!r&&!f?l.style.display="":l.style.display="none",(!n||!r)&&console.warn("missing headers",{apiKey:!!n,schema:!!r}),!0}function U(n,r){const l=document.querySelector(`[data-role="${r}"]`);return l||w(n)}function Te(){const r=w("selectRiskThreshold").value.toLowerCase();return r==="low"||r==="medium"||r==="high"?r:"medium"}function nt(){const n=mt();try{const r=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();return r.checked=n,!!r.checked}catch{return n}}function Xt(n){pt(n)}function Ce(n,r){const l=ee(r);return(n||[]).filter(u=>u&&u.rule_id&&u.snippet).map(u=>({...u,clause_type:u.clause_type||"Unknown"})).filter(u=>ee(u.severity)>=l)}k.annotateFindingsIntoWord=k.annotateFindingsIntoWord||He;async function Zt(){try{await Word.run(async n=>{const r=n.document.body,l=n.document.comments,u=typeof r.search=="function"?r.search(B,{matchCase:!1}):null;if(l&&typeof l.load=="function"&&l.load("items"),u&&typeof u.load=="function"&&u.load("items"),await n.sync(),l?.items)for(const f of l.items)try{(f.text||"").startsWith(B)&&f.delete()}catch{}if(u?.items&&u.items.length)for(const f of u.items)try{f.insertText("",Word.InsertLocation.replace)}catch{}try{r.font.highlightColor="NoColor"}catch{}await n.sync()}),K("Annotations cleared")}catch(n){X(n,"annotate"),D("Failed to clear annotations")}}function xt(n,r){const l=new qt,u=i=>i.match(/\S+|\s+/g)||[],{chars1:f,chars2:e,tokenArray:t}=en(u(n),u(r));let a=l.diff_main(f,e);return l.diff_cleanupSemantic(a),a.map(([i,o])=>[i,o.split("").map(s=>t[s.charCodeAt(0)]).join("")])}function en(n,r){const l=[],u=new Map,f=a=>u.has(a)?String.fromCharCode(u.get(a)):(l.push(a),u.set(a,l.length-1),String.fromCharCode(l.length-1)),e=n.map(f).join(""),t=r.map(f).join("");return{chars1:e,chars2:t,tokenArray:l}}async function rt(n){return Q(async()=>{let r=(n||[]).filter(f=>typeof f.start=="number"&&typeof f.end=="number"&&f.end>f.start).sort((f,e)=>f.start-e.start),l=-1;if(r=r.filter(f=>f.start<l?!1:(l=f.end,!0)),!r.length)return;const u=window.__lastAnalyzed||"";await Word.run(async f=>{const e=f.document.body;f.document.trackRevisions=!0;const t={matchCase:!1,matchWholeWord:!1},a=(i,o)=>{const s=i?.items||[];return s.length&&s[Math.min(Math.max(o,0),s.length-1)]||null};for(const i of r){const o=`${i.start}:${i.end}:${i.replacement}`;if(Ze.has(o))continue;const s=u.slice(i.start,i.end),c=(()=>{let h=-1,g=0;for(;(h=u.indexOf(s,h+1))!==-1&&h<i.start;)g++;return g})();let d=null;if(i.context_before||i.context_after){const h=`${i.context_before||""}${s}${i.context_after||""}`,g=await te(e,h,t),m=a(g,c);if(m){const y=s.slice(0,240),v=s.slice(-240),p=m.search(y,t),_=m.search(v,t);p&&typeof p.load=="function"&&p.load("items"),_&&typeof _.load=="function"&&_.load("items"),await f.sync();const b=a(p,0),A=a(_,0);b&&A&&typeof b.expandTo=="function"?d=b.expandTo(A):d=b}}if(!d){const h=await te(e,s,t);d=a(h,c)}if(!d){const h=(()=>{const g=s.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(m=>m.length>=12);return g.length?g.sort((m,y)=>y.length-m.length)[0].slice(0,64):null})();if(h){const g=await te(e,h,t);d=a(g,0)}}if(d){const h=xt(s,i.replacement);let g=d.getRange("Start");for(const[v,p]of h)if(p)if(v===0){const b=g.getRange("After").search(p,t);b&&typeof b.load=="function"&&b.load("items"),await f.sync();const A=a(b,0);A&&(g=A.getRange("After"))}else if(v===-1){const b=g.getRange("After").search(p,t);b&&typeof b.load=="function"&&b.load("items"),await f.sync();const A=a(b,0);A&&(A.insertText("","Replace"),g=A.getRange("After"))}else v===1&&(g=g.insertText(p,"Before").getRange("After"));const m=`${B} ${i.rationale||i.source||"AI edit"}`;(await me(d,m)).ok||await pe(d,m.replace(B,"").trim())}else console.warn("[applyOpsTracked] match not found",{snippet:s,occIdx:c});await f.sync()}})})}k.applyOpsTracked=k.applyOpsTracked||rt;function at(n,r){if(r.__highlight){try{r.__highlight.font.highlightColor="NoColor"}catch{}n.trackedObjects.remove(r.__highlight),r.__highlight=null}}async function st(){const n=window;n.__highlight&&await Word.run(async r=>{at(r,n),await r.sync()})}async function Me(n){await Word.run(async r=>{const l=window;at(r,l);const u=r.document.body;let f=await G(u,n.raw),e=f[Math.min(n.occIdx,f.length-1)]||null;if(!e&&n.normalized_fallback&&n.normalized_fallback!==n.norm&&(f=await G(u,n.normalized_fallback),e=f[Math.min(n.occIdx,f.length-1)]||null),e){l.__highlight=e,r.trackedObjects.add(e);try{e.select()}catch{}try{e.font.highlightColor="#ffff00"}catch{}}await r.sync()})}let De=!1;async function it(n){if(De)return;De=!0;const r=window.__findings||[];if(!r.length){De=!1;return}const l=w("btnPrevIssue"),u=w("btnNextIssue");l.disabled=!0,u.disabled=!0;const f=window;f.__findingIdx=(f.__findingIdx??0)+n,f.__findingIdx<0&&(f.__findingIdx=r.length-1),f.__findingIdx>=r.length&&(f.__findingIdx=0);const e=w("findingsList"),t=Array.from(e.querySelectorAll("li"));t.forEach((i,o)=>{i.classList.toggle("active",o===f.__findingIdx)});const a=t[f.__findingIdx];a&&a.scrollIntoView({block:"nearest"});try{await Me(r[f.__findingIdx])}catch{}}function tn(n){const r=window.__findings||[];if(!r.length)return;const l=r.findIndex(t=>t.rule_id===n||t.code===n);if(l<0)return;window.__findingIdx=l;const u=w("findingsList"),f=Array.from(u.querySelectorAll("li"));f.forEach((t,a)=>{t.classList.toggle("active",a===l)});const e=f[l];e&&e.scrollIntoView({block:"nearest"});try{Me(r[l])}catch{}}async function nn(){await it(-1)}async function rn(){await it(1)}function ae(n){st().catch(()=>{});const r=n?.summary?.clause_type||n?.meta?.clause_type||n?.doc_type||"—",l=Array.isArray(n?.findings)?n.findings:[],u=Array.isArray(n?.recommendations)?n.recommendations:[],f=Te(),e=Ce(l,f),t=e.length,a=l.length-t,i=(g,m)=>{w(g).textContent=m};i("clauseTypeOut",String(r)),i("resFindingsCount",String(l.length)),i("visibleHiddenOut",`${t} / ${a}`);const o=w("findingsBlock"),s=w("findingsList");s.innerHTML="",e.forEach((g,m)=>{const y=document.createElement("li"),v=g?.title||g?.finding?.title||g?.rule_id||"Issue",p=g?.snippet||g?.evidence?.text||"";y.textContent=p?`${v}: ${p}`:String(v),y.addEventListener("click",()=>{Array.from(s.querySelectorAll("li")).forEach((A,E)=>{A.classList.toggle("active",E===m)}),window.__findingIdx=m,Me(g).catch(()=>{})});const _=Array.isArray(g.links)?g.links.filter(b=>b?.type==="conflict"&&b?.targetFindingId):[];if(_.length){const b=document.createElement("div");b.textContent=`Conflicts: ${_.length} `,_.forEach((A,E)=>{const I=document.createElement("a");I.href="#",I.textContent="Jump to",I.addEventListener("click",S=>{S.preventDefault(),tn(A.targetFindingId)}),b.appendChild(I),E<_.length-1&&b.append(" ")}),y.appendChild(b)}s.appendChild(y)}),o.style.display=e.length?"":"none";const c=document.getElementById("recommendationsBlock"),d=document.getElementById("recommendationsList");if(d){d.innerHTML="";for(const g of u){const m=document.createElement("li");m.textContent=g?.text||g?.advice||g?.message||"Recommendation",d.appendChild(m)}}c&&(c.style.display=u.length?"":"none"),w("resultsBlock").style.removeProperty("display")}function se(n){const r=U("resClauseType","clause-type");r.textContent=n?.clause_type||"—";const l=ne(n);window.__findings=l,window.__findingIdx=0;const u=U("findingsList","findings");u&&(u.innerHTML="",l.forEach(s=>{const c=document.createElement("li");c.textContent=typeof s=="string"?s:JSON.stringify(s),u.appendChild(c)}));const f=w("findingsBlock");f.style.display=l.length?"":"none";const e=Array.isArray(n?.recommendations)?n.recommendations:[],t=U("recommendationsList","recommendations");t&&(t.innerHTML="",e.forEach(s=>{const c=document.createElement("li");c.textContent=typeof s=="string"?s:JSON.stringify(s),t.appendChild(c)}));const a=w("recommendationsBlock");a.style.display=e.length?"":"none";const i=U("resFindingsCount","findings-count");i.textContent=String(l.length);const o=U("rawJson","raw-json");o.textContent=JSON.stringify(n??{},null,2)}function an(n){const r=window.__findings||[],l=ne(n),u=je([...r,...l]);return{...n||{},findings:u}}function sn(){const n=U("toggleRaw","toggle-raw-json"),r=U("rawJson","raw-json");r.style.display="none",n.addEventListener("click",()=>{r.style.display=r.style.display==="none"?"block":"none"})}function ot(n){const r=w("connBadge");r.textContent=`Conn: ${n===null?"—":n?"✓":"×"}`}function Le(n){const r=w("officeBadge");r.textContent=`Office: ${n??"—"}`}async function on(){await Word.run(async n=>{const r=["Heading 1","Heading 2","Heading 3"];for(let l=0;l<r.length;l++){const u=n.document.body.paragraphs.getByStyle(r[l]);u.load("items"),await n.sync();for(const f of u.items)try{f.listFormat.removeNumbers(),f.listFormat.applyNumberedDefault(),f.listItem&&(f.listItem.level=l);const e=36*(l+1);f.paragraphFormat.leftIndent=e,f.paragraphFormat.firstLineIndent=-36,f.paragraphFormat.lineSpacing=240}catch(e){console.warn("fixNumbering",e)}}await n.sync()}).catch(n=>X(n,"fixNumbering"))}function W(n){return document.querySelector(n)}function cn(){return(W(z.original)?.value||"").trim()}async function ln(){let n=cn();if(n.length>=20)return n;try{if(n=(await globalThis.getSelectionText()||"").trim(),n.length>=20){const r=W(z.original);if(r){r.value=n;try{r.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return n}}catch{}return D("Please paste the original clause (min 20 chars) or select text in the document."),null}function un(){try{return globalThis.detectContractType?.()||"unknown"}catch{return"unknown"}}function fn(){try{const n=window.__findings||[];return Array.isArray(n)?n:[]}catch{return[]}}function dn(){try{return window.getSelectionOffsets?.()||null}catch{return null}}async function hn(n){const r=await ln();if(!r)return;const l={mode:n,clause_id:re||void 0,text:r,context:{law:"UK",language:"en-GB",contractType:un()},findings:fn().slice(0,10),selection:dn()};let u;try{u=await fetch("/api/gpt/draft",{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":q()||"","X-Schema-Version":"1.4"},body:JSON.stringify(l)})}catch(i){console.warn("Draft error",i),D("Draft error");return}if(!u.ok){const i=await u.text();console.warn(`Draft failed: ${u.status} ${i}`);return}const f=await u.json(),e=(f?.draft_text||"").toString(),t=W(z.proposed),a=window;if(a.__last=a.__last||{},a.__last["gpt-draft"]={json:f},t){t.id||(t.id="draftText"),t.name||(t.name="proposed"),t.dataset.role="proposed-text",t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),K("Draft ready");try{await Wt(e,Ee,f?.meta?.rationale)}catch{}Z(e)}else D("Proposed textarea not found"),Z("")}async function gn(){const n=W(z.original),r=await be(),l=P(r||"");if(n){n.value=l;try{n.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const u=w("originalText");if(u!==n){u.value=l;try{u.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=l,window.toast?.("Whole doc loaded")}async function mn(n){return Q(()=>hn(Ee==="friendly"?"friendly":"strict"))}async function ct(){try{const n=j(),{resp:r,json:l,ok:u}=await Fe({backend:tt()}),f=r.headers.get("x-schema-version")||l?.schema||null;if(f&&(J(f),f!==n&&console.log(`schema: ${f} (synced)`)),ot(u),u){console.log("[PANEL] health ok"),Qt(),Se(f,null);try{de({cid:null,xcache:null,latencyMs:null,schema:f||null,provider:l?.provider||null,model:l?.model||null,llm_mode:null,usage:null,status:l?.status||null})}catch{}K(`Health: ${l?.status||"ok"}${f?` (schema ${f})`:""}`)}else D("Health failed")}catch(n){ot(!1),D("Health failed"),console.error(n)}}async function pn(){const n=w("originalText");let r=P(n.value||"");if(!r){const l=w("btnAnalyze");l.disabled=!0;try{r=P(await globalThis.getWholeDocText()),n.value=r||""}catch{r=""}finally{l.disabled=!1}}return r?(window.__lastAnalyzed=r,r):(D("Document is empty"),null)}async function yn(){if(Ie){console.log("[PANEL] analyze in progress - ignoring click");return}for(const n of Y)if(n.__key==="/api/analyze"){console.log("[PANEL] pending /api/analyze fetch - ignoring click");return}Ie=!0;try{if(!await pn())return;await vn()}finally{Ie=!1}}async function vn(){return Q(async()=>{const n=w("btnAnalyze"),r=w("busyBar");n.disabled=!0,r.style.display="";try{Z("");const l=window.__lastAnalyzed;if(!l){Be("В документе нет текста");return}ke();const{resp:u,json:f}=await $t({text:l,mode:Ee});if(!u.ok)throw new Error(`HTTP ${u.status}`);const e=u.headers.get("x-schema-version");e&&J(e),f?.schema&&J(f.schema),re=u.headers.get("x-cid")||"",Se(null,re),se(f),ae(f);try{localStorage.setItem("last_analysis_json",JSON.stringify(f))}catch{}try{const t=globalThis.parseFindings(f),a=Te(),i=Ce(t,a),o=ve(i);window.__findings=o,window.__findingIdx=0;const s=w("findingsList"),c=document.createDocumentFragment();o.forEach((d,h)=>{const g=document.createElement("li");g.textContent=`${d.rule_id}: ${d.raw}`,h===0&&g.classList.add("active"),c.appendChild(g)}),s.innerHTML="",s.appendChild(c),nt()&&i.length&&await He(i)}catch(t){console.warn("auto-annotate after analyze failed",t)}w("results").dispatchEvent(new CustomEvent("ca.results",{detail:f})),K("Analyze OK")}catch(l){let u="";if(l?.name==="AbortError"){const f=l?.message||"";if(f.startsWith("timeout")){const e=parseInt(f.replace(/[^0-9]/g,""),10)||0;u=`(timeout ${Math.round(e/1e3)} s)`}else f==="pagehide/unload"?u="(aborted by pagehide)":u="(aborted)"}else typeof l?.message=="string"&&(l.message.includes("HTTP 504")?u="(HTTP 504)":l.message.includes("HTTP 413")?u="(payload too large 413)":l.message.includes("HTTP 401")?u="(unauthorized 401)":l.message.includes("HTTP 403")?u="(forbidden 403)":l.message.includes("HTTP 422")&&(u="(schema mismatch 422)"));D(`Analyze failed ${u}`.trim()),console.error(l)}finally{n.disabled=!1,r.style.display="none"}})}async function _n(){return Q(async()=>{await st(),ke();const n=window.__docId,r=await be();window.__lastAnalyzed=r;const l=n?{document_id:n,rules:{}}:{text:r,rules:{}},{json:u}=await postJSON("/api/qa-recheck",l);if(w("results").dispatchEvent(new CustomEvent("ca.qa",{detail:u})),!u?.error){const e=window.__findings||[],t=window.__findingIdx??0,a=p=>p?.code||p?.rule_id||`${p?.rule_id}|${p?.raw||p?.snippet||""}`,i=e[t]?a(e[t]):null,o=ne(u),s=Te(),c=Ce(o,s),d=ve(c),h=new Map;d.forEach(p=>{const _=a(p);_&&!h.has(_)&&h.set(_,p)});const g=Array.from(h.values());window.__findings=g;let m=0;if(i){const p=g.findIndex(_=>a(_)===i);p>=0&&(m=p)}m>=g.length&&(m=0),window.__findingIdx=m;const y=w("findingsList"),v=document.createDocumentFragment();g.forEach((p,_)=>{const b=document.createElement("li");b.textContent=`${p.rule_id}: ${p.raw}`,_===m&&b.classList.add("active"),v.appendChild(b)}),y.innerHTML="",y.appendChild(v),K("QA recheck OK")}else{const e=u?.error||u?.message||"unknown";Be(`QA recheck failed: ${e}`)}})}function O(n,r){const l=document.querySelector(n);l&&(l.addEventListener("click",u=>{u.preventDefault(),r()}),l.classList.remove("js-disable-while-busy"),l.removeAttribute("disabled"))}async function bn(){try{const n=window.__lastAnalyzed||"",r=(W(z.proposed)?.value||"").trim();if(!r){D("No draft to diff");return}const l=await Nt(n,r),u=l?.json?.html||l?.json?.diff_html||l?.json?.redlines||"",f=w("diffOutput"),e=w("diffContainer");f.innerHTML=u||"",e.style.display=u?"block":"none"}catch(n){D("Diff failed"),console.error(n)}}async function wn(){try{const n=window.__last||{},r=n["gpt-draft"]?.json?.ops||n.suggest?.json?.ops||[];if(!r.length){D("No ops to apply");return}await rt(r),K("Applied ops")}catch(n){D("Insert failed"),console.error(n)}}async function An(){try{const r=(W(z.proposed)?.value||"").trim();if(!r){window.toast?.("Nothing to accept");return}const l=(w("cid").textContent||"").trim(),u=(()=>{try{return(localStorage.getItem("backendUrl")||"https://127.0.0.1:9443").replace(/\/+$/,"")}catch{return"https://127.0.0.1:9443"}})(),f=l&&l!=="—"?`${u}/api/trace/${l}`:"AI draft";await Word.run(async e=>{const t=e.document.getSelection();e.document.trackRevisions=!0,t.insertText(r,Word.InsertLocation.replace),(await me(t,`${B} ${f}`)).ok||await pe(t,f),await e.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(n){window.toast?.("Accept failed"),X(n,"insertDraft"),console.error(n)}}async function En(){try{const n=W(z.proposed);n&&(n.value="",n.dispatchEvent(new Event("input",{bubbles:!0})),Z("")),await Word.run(async r=>{const u=r.document.getSelection().revisions;u.load("items"),await r.sync(),(u.items||[]).forEach(f=>{try{f.reject()}catch{}}),await r.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(n){window.toast?.("Reject failed"),X(n,"insertDraft"),console.error(n)}}function lt(){if(console.log("[PANEL] wireUI start"),globalThis.__CAI_TESTING__){console.log("[PANEL] wireUI skipped (__CAI_TESTING__)");return}const n=Yt.filter(c=>{try{return w(c),!1}catch{return!0}});if(n.length){console.error("[PANEL] wireUI missing IDs:",n);const c=`FATAL: panel template mismatch (missing: ${n.join(", ")}). Check build pipeline.`;try{const d=document.createElement?document.createElement("div"):null;d&&(d.textContent=c,d.style.padding="12px",d.style.color="#f66",document.body.innerHTML="",document.body.appendChild(d))}catch{}console.error(c);return}const r=w("loading-book");window.addEventListener("cai:busy",c=>{!!c?.detail?.busy?r.classList.remove("hidden"):r.classList.add("hidden")});const l=Ke(),u=(c,d)=>{const h=w(c);if(h.disabled=!0,h.title=d?`Not supported: ${d}`:"Not supported",d)try{console.log(`disabled ${c}: ${d}`)}catch{}};O("#btnUseWholeDoc",gn);const f=w("btnUseWholeDoc");if(f.disabled=!1,O("#btnFixNumbering",on),Xe==="dev")O("#btnTest",ct);else{const c=w("btnTest");c.style.display="none"}O("#btnQARecheck",_n);const e=w("btnSuggestEdit"),t=W(z.original),a=()=>{e.disabled=!(t&&t.value.trim())};t?.addEventListener("input",a);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const c=await globalThis.getSelectionText();if(c&&t){t.value=c;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}a(),e.addEventListener("click",mn),O("#btnApplyTracked",wn),O("#btnAcceptAll",An),O("#btnRejectAll",En),O("#btnPrevIssue",nn),O("#btnNextIssue",rn),O("#btnPreviewDiff",bn),O("#btnClearAnnots",Zt),O("#btnSave",Gt);const i=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();i.checked=nt(),i.addEventListener("change",()=>Xt(!!i.checked));const o=w("btnAnnotate");o.addEventListener("click",async()=>{if(!o.disabled){o.disabled=!0;try{const c=window.__last?.analyze?.json||{},d=globalThis.parseFindings(c);try{await globalThis.annotateFindingsIntoWord(d)}catch(h){const g=h?.code||h?.name||"";g==="SearchStringInvalidOrTooLong"||g==="InvalidOrTooLong"||g==="InvalidArgument"?(globalThis.toast2?.("Search failed (long text), skipping some anchors","warn"),console.warn("[annotate run] search error",g)):console.warn("[annotate run] error",h)}}finally{o.disabled=!1}}}),o.classList.remove("js-disable-while-busy"),o.removeAttribute("disabled"),w("results").addEventListener("ca.qa",c=>{const d=c?.detail;try{if(!d||d.error){se(d||{}),ae(d||{});return}const h=an(d);se(h),ae(h)}catch(h){console.warn("ca.qa handler failed",h),se(d||{}),ae(d||{})}}),Z(""),sn(),console.log("Panel UI wired [OK]");const s=w("btnAnalyze");if(s.disabled=!0,ke(),Se(),et(),l.revisions||(u("btnApplyTracked","revisions"),u("btnAcceptAll","revisions"),u("btnRejectAll","revisions")),l.comments||(u("btnAnnotate","comments"),u("btnAcceptAll",l.commentsReason),D("Comments API not available in this Word build")),l.search||(u("btnPrevIssue","search"),u("btnNextIssue","search"),u("btnQARecheck","search")),l.contentControls||u("btnAnnotate","contentControls"),!l.revisions||!l.comments||!l.search||!l.contentControls)try{Le("Word ⚠")}catch{}}k.wireUI=k.wireUI||lt;function Z(n){const r=!!n.trim(),l=w("btnApplyTracked"),u=w("btnAcceptAll"),f=w("btnRejectAll"),e=w("btnPreviewDiff"),t=w("draftPane"),a=w("draftText");a.value=n,t.style.display=r?"":"none",l.disabled=!r,u.disabled=!r,f.disabled=!r,e.disabled=!r}async function In(n){console.log("[PANEL] bootstrap start"),It()&&(console.log("reopen clean OK"),St()),lt(),Et();try{await jt(tt())}catch{}try{await ct()}catch{}try{Le(`${n?.host||Office.context?.host||"Word"} ✓`)}catch{Le(null)}}let Re=!1,ut=!1,ft,dt=!1,ht=0;function Oe(){if(dt){console.log(`bootstrap invoked x${ht+1}`);return}Re&&ut&&(dt=!0,ht++,console.log("bootstrap invoked x1"),In(ft))}globalThis.__CAI_TESTING__||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Re=!0,Oe()}):(Re=!0,Oe()),Office.onReady(n=>{ut=!0,ft=n,Oe()}))})();
