(function(){"use strict";var V=typeof document<"u"?document.currentScript:null;const Y="",J="1.4",O="cai-comment-on-analyze";function zt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",Y),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",J),localStorage.getItem(O)===null&&localStorage.setItem(O,"1")}catch{}}zt();function W(){try{return localStorage.getItem("api_key")||Y}catch{return Y}}function rt(t){try{localStorage.setItem("api_key",t)}catch{}}function k(){try{return localStorage.getItem("schema_version")||J}catch{return J}}function $(t){try{localStorage.setItem("schema_version",t)}catch{}}function Mt(){try{const t=localStorage.getItem(O);return t===null?(localStorage.setItem(O,"1"),!0):t!=="0"}catch{return!0}}function Nt(t){try{localStorage.setItem(O,t?"1":"0")}catch{}}const A=typeof globalThis<"u"?globalThis:window;A.CAI=A.CAI||{},A.CAI.Store=A.CAI.Store||{},A.CAI.Store.setApiKey=rt,A.CAI.Store.setSchemaVersion=$,A.CAI.Store.get=()=>({apiKey:W(),schemaVersion:k()}),A.CAI.Store.DEFAULT_BASE=A.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const w=window;w.__cai_pending_fetches=w.__cai_pending_fetches||new Set,w.__cai_pending_timers=w.__cai_pending_timers||new Set;const F=w.__cai_pending_fetches,U=w.__cai_pending_timers,C={count:0};function Dt(){C.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:C.count}}))}function Wt(){C.count=Math.max(0,C.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:C.count>0,count:C.count}}))}async function R(t){try{return Dt(),await t()}finally{Wt()}}function Ft(t){F.add(t)}function Ut(t){F.delete(t)}function jt(t){U.add(t)}function Pt(t){U.delete(t)}function lt(t){F.forEach(e=>{try{e.abort(t)}catch{}}),F.clear(),U.forEach(e=>{try{clearTimeout(e),clearInterval(e)}catch{}}),U.clear();try{document.querySelectorAll(".progress").forEach(e=>{e.style.display="none"})}catch{}}function Ht(){if(w.__pendingUnloadReg)return;w.__pendingUnloadReg=!0;const t=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),e=()=>{t&&lt("pagehide/unload"),w.__wasUnloaded=!0};window.addEventListener("pagehide",e),window.addEventListener("unload",e),window.addEventListener("beforeunload",e),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&lt("visibilitychange")})}function dt(){return!!w.__wasUnloaded}function Kt(){w.__wasUnloaded=!1}let Q=null;async function ut(t={}){if(!Q){const e=(t.backend||"").replace(/\/+$/,""),n=e?`${e}/health`:"/health",o=new AbortController,s=t.timeoutMs??9e3,a=setTimeout(()=>o.abort("timeout"),s);Q=fetch(n,{signal:o.signal}).then(async d=>{clearTimeout(a);const i=await d.json().catch(()=>({}));return{ok:d.ok,json:i,resp:d}})}return Q}function B(t){try{console.log("[OK]",t)}catch{}}function ft(t){try{console.error("[ERR]",t)}catch{}}function b(t){try{console.warn("[WARN]",t)}catch{}}function mt(t){const e=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(e)?e.filter(Boolean):[]}window.parseFindings=mt;function qt(t){const e=t.headers,n=t.json||{},o=n.llm||n;return{cid:e.get("x-cid"),xcache:e.get("x-cache"),latencyMs:e.get("x-latency-ms"),schema:e.get("x-schema-version"),provider:e.get("x-provider")||o.provider||n.provider||null,model:e.get("x-model")||o.model||n.model||null,llm_mode:e.get("x-llm-mode")||o.mode||n.mode||null,usage:e.get("x-usage-total"),status:t.status!=null?String(t.status):null}}function Z(t){const e=(n,o)=>{const s=document.getElementById(n);s&&(s.textContent=o&&o.length?o:"—")};e("status",t.status),e("cid",t.cid),e("xcache",t.xcache),e("latency",t.latencyMs),e("schema",t.schema),e("provider",t.provider),e("model",t.model),e("mode",t.llm_mode),e("usage",t.usage)}async function Vt(){const t=new URL(V&&V.tagName.toUpperCase()==="SCRIPT"&&V.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const n=await(await fetch(t)).text(),o=new TextEncoder().encode(n),s=await crypto.subtle.digest("SHA-256",o),a=Array.from(new Uint8Array(s)).slice(0,4).map(d=>d.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${a} ${t}`)}catch{console.log(`[selftest] api-client.js fail ${t}`)}}const gt="https://localhost:9443";function Yt(){try{return(localStorage.getItem("backendUrl")||gt).replace(/\/+$/,"")}catch{return gt}}const G=9e3,Jt=60,Qt=9e4,Zt=1,Gt=3e3;async function z(t,e,n){return R(async()=>{const o=Yt()+t,s={"Content-Type":"application/json"},a=k()||"1.4";s["x-schema-version"]=a;const d=W();d&&(s["x-api-key"]=d);const i={...e||{},schema:a},c=JSON.stringify(i),r=new TextEncoder().encode(c).length;let l=n,f=Zt,u=Gt;if(t==="/api/analyze"){if(l==null){const m=G+Jt*(r/1024);l=Math.max(G,Math.min(Qt,Math.floor(m)))}try{for(const m of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const h=localStorage.getItem(m);if(h){const E=parseInt(h,10);if(Number.isFinite(E)){l=E;break}}}}catch{}try{const m=localStorage.getItem("cai.retry.analyze.count");m&&(f=parseInt(m,10))}catch{}try{const m=localStorage.getItem("cai.retry.analyze.backoff.ms");m&&(u=parseInt(m,10))}catch{}try{const m=new URLSearchParams(location.search),h=m.get("ta");h&&(l=parseInt(h,10));const E=m.get("rac");E&&(f=parseInt(E,10));const p=m.get("rb");p&&(u=parseInt(p,10))}catch{}}l=l??G;async function g(m){const h=new AbortController,E=setTimeout(()=>h.abort(`timeout ${l}ms`),l);Ft(h),jt(E);try{const p=await fetch(o,{method:"POST",headers:s,body:c,credentials:"include",signal:h.signal}),I=await p.json().catch(()=>({}));if(p.status===422){console.warn("[analyze] 422",I.detail);const D=Array.isArray(I?.detail)?I.detail.map(ze=>ze.msg).join("; "):I?.detail;try{b(`Validation error: ${D}`)}catch{}}return t==="/api/analyze"&&(p.status===504||p.status>=500)&&m<f?(await new Promise(D=>setTimeout(D,u)),g(m+1)):{resp:p,json:I}}catch(p){if(t==="/api/analyze"&&p?.name==="AbortError"){const I=h.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${I}`),m<f&&String(I).startsWith("timeout"))return await new Promise(D=>setTimeout(D,u)),g(m+1);throw new DOMException(I,"AbortError")}throw p}finally{clearTimeout(E),Pt(E),Ut(h)}}return g(0)})}window.postJson=z;async function Xt(t={}){const e={text:t?.text??t?.content,mode:t?.mode??"live"},{resp:n,json:o}=await z("/api/analyze",e),s=qt({headers:n.headers,json:o,status:n.status});try{Z(s)}catch{}try{const a=window;a.__last||(a.__last={}),a.__last.analyze={status:n.status,req:{path:"/api/analyze",method:"POST",body:e},json:o}}catch{}return{ok:n.ok,json:o,resp:n,meta:s}}async function te(t,e){return z("/api/panel/redlines",{before_text:t,after_text:e})}const ee={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function v(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function j(t){const e=(t||"").toLowerCase();return e==="high"?3:e==="medium"?2:1}function ne(t){const e=new Map;let n=0,o=0;for(const a of t||[]){const d=v(a.snippet||""),i=typeof a.start=="number"?a.start:void 0,c=typeof a.end=="number"?a.end:i!==void 0?i+d.length:void 0;if(typeof i!="number"||typeof c!="number"||c<=i||c-i>1e4){n++;continue}const r=`${a.rule_id||""}|${i}|${c}|${d}`,l=e.get(r);!l||j(a.severity)>j(l.severity)?e.set(r,{...a,snippet:d,start:i,end:c}):o++}const s=Array.from(e.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),s}function P(t,e,n){const o={items:[],load:()=>{}};if(!e)return o;let s=e;s.length>200&&(s=s.slice(0,100).trim(),s.length>200&&(s=s.slice(0,120)));try{return t.search(s,n)}catch(a){const d=a?.code||a?.name||"";if(d==="SearchStringInvalidOrTooLong"||d==="InvalidArgument"){try{console.warn("[WARN] safeBodySearch",d);const i=globalThis;i.toast2?.("Some anchors skipped: long text","warn"),i.__anchorsSkipped=(i.__anchorsSkipped||0)+1,i.updateAnchorBadge?.()}catch{}return o}throw a}}async function M(t,e){const n=t.context,o={matchCase:!1,matchWholeWord:!1},s=c=>{const r=P(t,c,o);return r&&typeof r.load=="function"&&r.load("items"),r},a=s(e||"");await n.sync();let d=a?.items||[];if(!d.length){const c=v(e||""),r=s(c);await n.sync(),d=r?.items||[]}d.sort((c,r)=>{const l=c.start??0,f=r.start??0;if(l!==f)return l-f;const u=c.end??l,g=r.end??f;return u-g});const i=[];for(const c of d){const r=c.start??0,l=c.end??r,f=i[i.length-1];if(f&&r<(f.end??r)){const u=(f.end??0)-(f.start??0);l-r>u&&(i[i.length-1]=c);continue}i.push(c)}for(const c of i)try{n.trackedObjects?.add?.(c)}catch{}return i}function oe(t,e,n){if(!t||!e)return 0;let o=-1,s=0;for(;(o=t.indexOf(e,o+1))!==-1&&o<(n??t.length);)s++;return s}function se(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const N="[CAI]";function ae(t){if(!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const e=[t.rule_id];return t.advice&&e.push(t.advice),t.law_refs?.length&&e.push(t.law_refs.join("; ")),`${N} ${e.join(`
`)}`}const X=200;function yt(t){const e=v(globalThis.__lastAnalyzed||""),n=Array.isArray(t)?t:[],o=ne(n),s=o.slice().sort((r,l)=>(r.start??Number.POSITIVE_INFINITY)-(l.start??Number.POSITIVE_INFINITY)),a=[];let d=-1,i=0;for(const r of s){if(!r||!r.rule_id||!r.snippet||typeof r.start!="number"){i++;continue}const l=r.snippet,f=r.start,u=typeof r.end=="number"?r.end:f+l.length;if(f<d){i++;continue}const g=v(l),m=oe(e,g,f);if(a.push({raw:l,norm:g,occIdx:m,msg:ae(r),rule_id:r.rule_id,normalized_fallback:v(r.normalized_snippet||"")}),d=u,a.length>=X)break}const c=globalThis;return i&&c.notifyWarn?.(`Skipped ${i} overlaps/invalid`),o.length>X&&c.notifyWarn?.(`Truncated to first ${X} findings`),c.notifyOk?.(`Will insert: ${a.length}`),a}async function ht(t){const e=yt(t);return e.length?await globalThis.Word?.run?.(async o=>{const s=o.document.body,a=[];let d=0;for(const i of e){let c=await M(s,i.raw),r=c[Math.min(i.occIdx,c.length-1)]||null;if(!r&&i.normalized_fallback&&i.normalized_fallback!==i.norm&&(c=await M(s,i.normalized_fallback),r=c[Math.min(i.occIdx,c.length-1)]||null),r){r.load?.(["start","end"]),await o.sync();const l=r.start??0,f=r.end??l;if(a.some(u=>Math.max(u.start,l)<Math.min(u.end,f))){console.warn("[annotate] overlapping range",{rid:i.rule_id,start:l,end:f});continue}if(se())try{r.select()}catch{}else i.msg&&r.insertComment(i.msg);a.push({start:l,end:f}),d++}else console.warn("[annotate] no match for snippet",{rid:i.rule_id,snippet:i.raw.slice(0,120)});await o.sync()}return d}).catch(o=>(globalThis.logRichError?.(o,"annotate"),console.warn("annotate run fail",o?.code,o?.message,o?.debugInfo),0)):0}async function ce(t,e,n){if(!t||!t.trim())return;const o=globalThis;if(!o.Word?.run){await o.navigator?.clipboard?.writeText(t).catch(()=>{}),o.alert?.("Draft copied to clipboard (Office not ready). Paste it into the document.");return}if(o.Office?.context?.document?.mode&&o.Office.context.document.mode!=="edit")throw o.alert?.("Document is read-only."),new Error("Document mode is not editable");await o.Word.run(async s=>{const a=s.document;let d=null;try{const u=o.__findings||[],g=o.__findingIdx,m=u&&typeof g=="number"?u[g]:null,h=a.body;if(d=(m?.snippet?await M(h,m.snippet):[])[0]||null,!d){const p=a.getSelection();p.load("isEmpty"),await s.sync(),d=p.isEmpty?a.body.getRange("End"):p}}catch{const u=a.getSelection();u.load("isEmpty"),await s.sync(),d=u.isEmpty?a.body.getRange("End"):u}const i=d.insertText(t,o.Word.InsertLocation.replace),c=[`${N} Suggested clause – ${e}`],r=(n||"").split(/\r?\n/).slice(0,2).join(" "),l=o.__findings||[],f=o.__findingIdx;if(r)c.push(r);else{const u=l&&typeof f=="number"?l[f]:null,g=u?.rule_id||u?.title||"";g&&c.push(g)}c.push("schema 1.4 | model gpt-4o-mini | provider azure");try{a.comments.add(i,c.join(`
`))}catch{}await s.sync()}).catch(s=>{throw globalThis.logRichError?.(s,"insertDraft"),console.warn("insertDraftText error",s?.code,s?.message,s?.debugInfo),s})}function ie(){const t=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),e=globalThis.Word||{},n=t&&!!e?.Revision,o=t&&!!e?.SearchOptions,s=t&&!!e?.ContentControl,d=globalThis.localStorage?.getItem?.("cai.force.comments")==="1";let i=!1,c="unsupported";return d?(i=!0,c="dev override"):e?.Comment?(i=!0,c="Word.Comment available"):t?(i=!0,c="WordApi 1.4"):(i=!1,c="Word.Comment missing"),{revisions:n,comments:i,search:o,contentControls:s,commentsReason:c}}function pt(){const t=ie();try{console.log("support matrix",{comments:t.comments,reason:t.commentsReason})}catch{}return t}async function re(t){const e=[];try{await Vt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(l=>{document.getElementById(l)||e.push(`missingID:${l}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||e.push("req1.4:0");const n=pt(),o={revisions:n.revisions?1:0,comments:n.comments?1:0,search:n.search?1:0,contentControls:n.contentControls?1:0};let s=!1;try{s=(await ut({backend:t})).ok,s||e.push("health")}catch{e.push("health:timeout")}const a="__BUILD_TS__",d=Office?.context?.host||"Word",i=e.length===0,c=i?`Startup OK | build=${a} | host=${d} | req=1.4 | features=${JSON.stringify(o)} | backend=${t}`:`Startup FAIL: ${e.join("; ")}`;console.log(c);const r=document.getElementById("startupBadge");return r&&(r.textContent=i?"OK":"FAIL",r.setAttribute("data-status",i?"ok":"fail")),{ok:i,missing:e,features:o}}async function tt(){return await Word.run(async t=>{const e=t.document.body;return e.load("text"),await t.sync(),(e.text||"").trim()})}async function le(){return await Word.run(async t=>{const e=t.document.getSelection();return e.load("text"),await t.sync(),(e.text||"").trim()})}var bt={};const et=globalThis,nt=et.OfficeExtension,_t="build-20250912-195756";console.log("ContractAI build",_t);let wt=null,Et="1",At="1";try{wt=localStorage.getItem("cai_timeout_ms:analyze"),Et=localStorage.getItem("cai_abort_on_hidden")||"1",At=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:wt,abort_on_hidden:Et,abort_on_navigation:At}),!_t.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const t=document.createElement("div");t.textContent="FATAL: stale bundle",t.style.padding="12px",t.style.color="#f66",document.body.innerHTML="",document.body.appendChild(t),document.querySelectorAll("button").forEach(e=>{e.disabled=!0})}catch{}});const It=(()=>{const t=et.ENV_MODE||(typeof process<"u"?bt?.ENV_MODE:void 0);return t?t==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();nt&&nt.config&&(It==="dev"||et.__ENABLE_EXTENDED_LOGS__)&&(nt.config.extendedErrorLogging=!0);function H(t,e="Word"){try{const n=t&&t.debugInfo||{};console.error(`[${e}] RichApi error`,{code:t.code,message:t.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function vt(t){return(mt(t)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const y=globalThis;y.parseFindings=y.parseFindings||vt,y.applyMetaToBadges=y.applyMetaToBadges||Z,y.getApiKeyFromStore=y.getApiKeyFromStore||W,y.getSchemaFromStore=y.getSchemaFromStore||k,y.logRichError=y.logRichError||H,y.getWholeDocText=y.getWholeDocText||tt,y.getSelectionText=y.getSelectionText||le;const de={live:"friendly",friendly:"friendly",doctor:"strict"};let ot="live";const S={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let K="",St=!1;const ue=ee.required_ids||[];function st(t,e){const n=document.getElementById("status-chip");if(!n)return;const o=(t??k())||"—",s=(e??K)||"—";n.textContent=`schema: ${o} | cid: ${s}`}function Tt(){const t=document.getElementById("anchorsBadge");if(!t)return;const e=globalThis.__anchorsSkipped||0;t.style.display=e>0?"":"none"}y.updateAnchorBadge=y.updateAnchorBadge||Tt;function fe(){if(St)return;_("#btnAnalyze",Te);const t=document.getElementById("btnAnalyze");t&&(t.disabled=!1),St=!0,console.log("[PANEL] analyze enabled")}function xt(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function me(){const e=document.getElementById("backendUrl")?.value?.trim();if(e)try{localStorage.setItem("backend.url",e),localStorage.setItem("backendUrl",e)}catch{}location.reload()}function at(){try{let t=W(),e=k();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",s=o==="localhost"||o==="127.0.0.1";if(s&&(t||(t="local-test-key-123",rt(t)),!e)){const a=globalThis?.SCHEMA_VERSION||typeof process<"u"&&bt?.SCHEMA_VERSION||"1.4";e=String(a),$(e)}n&&(!t&&!e&&!s?n.style.display="":n.style.display="none"),(!t||!e)&&console.warn("missing headers",{apiKey:!!t,schema:!!e})}catch{}return!0}function T(t,e){return document.querySelector(`[data-role="${e}"]`)||document.getElementById(t)}function kt(){const e=document.getElementById("selectRiskThreshold")?.value?.toLowerCase();return e==="low"||e==="medium"||e==="high"?e:"medium"}function ct(){const t=Mt();try{const e=globalThis.document,n=e?.getElementById("cai-comment-on-analyze")||e?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=t),n?!!n.checked:t}catch{return t}}function ge(t){Nt(t)}function Ct(t,e){const n=j(e);return(t||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>j(o.severity)>=n)}y.annotateFindingsIntoWord=y.annotateFindingsIntoWord||ht;async function ye(){try{await Word.run(async t=>{const e=t.document.body,n=t.document.comments;n.load("items"),await t.sync();for(const o of n.items)try{(o.text||"").startsWith(N)&&o.delete()}catch{}try{e.font.highlightColor="NoColor"}catch{}await t.sync()}),B("Annotations cleared")}catch(t){H(t,"annotate"),b("Failed to clear annotations")}}async function Bt(t){return R(async()=>{let e=(t||[]).filter(s=>typeof s.start=="number"&&typeof s.end=="number"&&s.end>s.start).sort((s,a)=>s.start-a.start),n=-1;if(e=e.filter(s=>s.start<n?!1:(n=s.end,!0)),!e.length)return;const o=window.__lastAnalyzed||"";await Word.run(async s=>{const a=s.document.body;s.document.trackRevisions=!0;const d={matchCase:!1,matchWholeWord:!1},i=(c,r)=>{const l=c?.items||[];return l.length&&l[Math.min(Math.max(r,0),l.length-1)]||null};for(const c of e){const r=o.slice(c.start,c.end),l=(()=>{let u=-1,g=0;for(;(u=o.indexOf(r,u+1))!==-1&&u<c.start;)g++;return g})();let f=null;if(c.context_before||c.context_after){const u=`${c.context_before||""}${r}${c.context_after||""}`,g=P(a,u,d);g.load("items"),await s.sync();const m=i(g,l);if(m){const h=m.search(r,d);h.load("items"),await s.sync(),f=i(h,0)}}if(!f){const u=P(a,r,d);u.load("items"),await s.sync(),f=i(u,l)}if(!f){const u=(()=>{const g=r.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(m=>m.length>=12);return g.length?g.sort((m,h)=>h.length-m.length)[0].slice(0,64):null})();if(u){const g=P(a,u,d);g.load("items"),await s.sync(),f=i(g,0)}}if(f){f.insertText(c.replacement,"Replace");const u=`${N} ${c.rationale||c.source||"AI edit"}`;try{f.insertComment(u)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:r,occIdx:l});await s.sync()}})})}y.applyOpsTracked=y.applyOpsTracked||Bt;async function he(t){await Word.run(async e=>{const n=e.document.body;let o=await M(n,t.raw),s=o[Math.min(t.occIdx,o.length-1)]||null;if(!s&&t.normalized_fallback&&t.normalized_fallback!==t.norm&&(o=await M(n,t.normalized_fallback),s=o[Math.min(t.occIdx,o.length-1)]||null),s)try{s.select()}catch{}await e.sync()})}async function Lt(t){const e=window.__findings||[];if(!e.length)return;const n=window;n.__findingIdx=(n.__findingIdx??0)+t,n.__findingIdx<0&&(n.__findingIdx=e.length-1),n.__findingIdx>=e.length&&(n.__findingIdx=0);const o=document.getElementById("findingsList");if(o){const s=Array.from(o.querySelectorAll("li"));s.forEach((d,i)=>{d.classList.toggle("active",i===n.__findingIdx)});const a=s[n.__findingIdx];a&&a.scrollIntoView({block:"nearest"})}try{await he(e[n.__findingIdx])}catch{}}function pe(){Lt(-1)}function be(){Lt(1)}function _e(t){const e=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",n=Array.isArray(t?.findings)?t.findings:[],o=Array.isArray(t?.recommendations)?t.recommendations:[],s=kt(),d=Ct(n,s).length,i=n.length-d,c=(u,g)=>{const m=document.getElementById(u);m&&(m.textContent=g)};c("clauseTypeOut",String(e)),c("resFindingsCount",String(n.length)),c("visibleHiddenOut",`${d} / ${i}`);const r=document.getElementById("findingsList");if(r){r.innerHTML="";for(const u of n){const g=document.createElement("li"),m=u?.title||u?.finding?.title||u?.rule_id||"Issue",h=u?.snippet||u?.evidence?.text||"";g.textContent=h?`${m}: ${h}`:String(m),r.appendChild(g)}}const l=document.getElementById("recsList");if(l){l.innerHTML="";for(const u of o){const g=document.createElement("li");g.textContent=u?.text||u?.advice||u?.message||"Recommendation",l.appendChild(g)}}const f=document.getElementById("resultsBlock");f&&f.style.removeProperty("display")}function we(t){const e=T("resClauseType","clause-type");e&&(e.textContent=t?.clause_type||"—");const n=vt(t);window.__findings=n,window.__findingIdx=0;const o=T("findingsList","findings");o&&(o.innerHTML="",n.forEach(c=>{const r=document.createElement("li");r.textContent=typeof c=="string"?c:JSON.stringify(c),o.appendChild(r)}));const s=Array.isArray(t?.recommendations)?t.recommendations:[],a=T("recoList","recommendations");a&&(a.innerHTML="",s.forEach(c=>{const r=document.createElement("li");r.textContent=typeof c=="string"?c:JSON.stringify(c),a.appendChild(r)}));const d=T("resFindingsCount","findings-count");d&&(d.textContent=String(n.length));const i=T("rawJson","raw-json");i&&(i.textContent=JSON.stringify(t??{},null,2))}function Ee(){const t=T("toggleRaw","toggle-raw-json"),e=T("rawJson","raw-json");t&&e&&(e.style.display="none",t.addEventListener("click",()=>{e.style.display=e.style.display==="none"?"block":"none"}))}function Ot(t){const e=document.getElementById("connBadge");e&&(e.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`)}function it(t){const e=document.getElementById("officeBadge");e&&(e.textContent=`Office: ${t??"—"}`)}function x(t){return document.querySelector(t)}async function Ae(){const t=x(S.original),e=(t?.value||"").trim();if(e)return e;const n=await globalThis.getSelectionText();if(n&&t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return n.trim()}async function Ie(){const t=x(S.original),e=await tt(),n=v(e||"");if(t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const o=document.getElementById("originalText");if(o&&o!==t){o.value=n;try{o.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function ve(t){return R(async()=>{let e;try{e=await Ae()}catch{b("Select some text or paste into 'Original clause'");return}if(!e){b("Select some text or paste into 'Original clause'");return}try{const n=x(S.proposed),o=de[ot]||"friendly",{json:s}=await z("/api/gpt-draft",{cid:K,clause:e,mode:o}),a=(s?.proposed_text??s?.text??"").toString(),d=window;if(d.__last=d.__last||{},d.__last["gpt-draft"]={json:s},n){n.id||(n.id="draftText"),n.name||(n.name="proposed"),n.dataset.role="proposed-text",n.value=a,n.dispatchEvent(new Event("input",{bubbles:!0})),B("Draft ready");try{await ce(a,ot,s?.meta?.rationale)}catch{}L(a)}else b("Proposed textarea not found"),L("")}catch(n){b("Draft error"),console.error(n),L("")}})}async function $t(){try{const t=k(),{resp:e,json:n,ok:o}=await ut({backend:xt()}),s=e.headers.get("x-schema-version")||n?.schema||null;if(s&&($(s),s!==t&&console.log(`schema: ${s} (synced)`)),Ot(o),o){console.log("[PANEL] health ok"),fe(),st(s,null);try{Z({cid:null,xcache:null,latencyMs:null,schema:s||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}B(`Health: ${n?.status||"ok"}${s?` (schema ${s})`:""}`)}else b("Health failed")}catch(t){Ot(!1),b("Health failed"),console.error(t)}}async function Se(){const t=document.getElementById("originalText");let e=v(t?.value||"");if(!e){const n=document.getElementById("btnAnalyze");n&&(n.disabled=!0);try{e=v(await globalThis.getWholeDocText()),t&&(t.value=e||"")}catch{e=""}finally{n&&(n.disabled=!1)}}return e?(window.__lastAnalyzed=e,e):(b("Document is empty"),null)}async function Te(){await Se()&&await xe()}async function xe(){return R(async()=>{const t=document.getElementById("btnAnalyze"),e=document.getElementById("busyBar");t&&(t.disabled=!0),e&&(e.style.display="");try{L("");const n=window.__lastAnalyzed;if(!n){ft("В документе нет текста");return}at();const{resp:o,json:s}=await Xt({text:n,mode:ot});if(!o.ok)throw new Error(`HTTP ${o.status}`);const a=o.headers.get("x-schema-version");a&&$(a),s?.schema&&$(s.schema),K=o.headers.get("x-cid")||"",st(null,K),we(s),_e(s);try{localStorage.setItem("last_analysis_json",JSON.stringify(s))}catch{}try{const d=globalThis.parseFindings(s),i=kt(),c=Ct(d,i),r=yt(c);window.__findings=r;const l=document.getElementById("findingsList");l&&(l.innerHTML="",r.forEach(f=>{const u=document.createElement("li");u.textContent=f.rule_id||f.raw.slice(0,64),l.appendChild(u)})),ct()&&c.length&&await ht(c)}catch(d){console.warn("auto-annotate after analyze failed",d)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:s})),B("Analyze OK")}catch(n){let o="";if(n?.name==="AbortError"){const s=n?.message||"";if(s.startsWith("timeout")){const a=parseInt(s.replace(/[^0-9]/g,""),10)||0;o=`(timeout ${Math.round(a/1e3)} s)`}else s==="pagehide/unload"?o="(aborted by pagehide)":o="(aborted)"}else typeof n?.message=="string"&&(n.message.includes("HTTP 504")?o="(HTTP 504)":n.message.includes("HTTP 413")?o="(payload too large 413)":n.message.includes("HTTP 401")?o="(unauthorized 401)":n.message.includes("HTTP 403")?o="(forbidden 403)":n.message.includes("HTTP 422")&&(o="(schema mismatch 422)"));b(`Analyze failed ${o}`.trim()),console.error(n)}finally{t&&(t.disabled=!1),e&&(e.style.display="none")}})}async function ke(){return R(async()=>{at();const t=await tt(),{json:e}=await z("/api/qa-recheck",{text:t,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:e})),!e?.error)B("QA recheck OK");else{const o=e?.error||e?.message||"unknown";ft(`QA recheck failed: ${o}`)}})}function _(t,e){const n=document.querySelector(t);n&&(n.addEventListener("click",o=>{o.preventDefault(),e()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function Ce(){try{const t=window.__lastAnalyzed||"",e=(x(S.proposed)?.value||"").trim();if(!e){b("No draft to diff");return}const n=await te(t,e),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",s=document.getElementById("diffOutput"),a=document.getElementById("diffContainer");s&&a&&(s.innerHTML=o||"",a.style.display=o?"block":"none")}catch(t){b("Diff failed"),console.error(t)}}async function Be(){try{const t=window.__last||{},e=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!e.length){b("No ops to apply");return}await Bt(e),B("Applied ops")}catch(t){b("Insert failed"),console.error(t)}}async function Le(){try{const e=(x(S.proposed)?.value||"").trim();if(!e){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),s=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async a=>{const d=a.document.getSelection();a.document.trackRevisions=!0,d.insertText(e,Word.InsertLocation.replace);try{d.insertComment(`${N} ${s}`)}catch{}await a.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),H(t,"insertDraft"),console.error(t)}}async function Oe(){try{const t=x(S.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),L("")),await Word.run(async e=>{const o=e.document.getSelection().revisions;o.load("items"),await e.sync(),(o.items||[]).forEach(s=>{try{s.reject()}catch{}}),await e.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),H(t,"insertDraft"),console.error(t)}}function Rt(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const l=ue.filter(f=>!document.getElementById(f));if(l.length){console.error("[PANEL] wireUI missing IDs:",l);const f=`FATAL: panel template mismatch (missing: ${l.join(", ")}). Check build pipeline.`;try{const u=document.createElement?document.createElement("div"):null;u&&(u.textContent=f,u.style.padding="12px",u.style.color="#f66",document.body.innerHTML="",document.body.appendChild(u))}catch{}console.error(f);return}}const t=document.getElementById("loading-book");window.addEventListener("cai:busy",l=>{if(!t)return;!!l?.detail?.busy?t.classList.remove("hidden"):t.classList.add("hidden")});const e=pt(),n=(l,f)=>{const u=document.getElementById(l);if(u&&(u.disabled=!0,u.title=f?`Not supported: ${f}`:"Not supported"),f)try{console.log(`disabled ${l}: ${f}`)}catch{}};_("#btnUseWholeDoc",Ie);const o=document.getElementById("btnUseWholeDoc");if(o&&(o.disabled=!1),It==="dev")_("#btnTest",$t);else{const l=document.getElementById("btnTest");l&&(l.style.display="none")}_("#btnQARecheck",ke);const s=document.getElementById("btnSuggestEdit"),a=x(S.original),d=()=>{s&&(s.disabled=!(a&&a.value.trim()))};a?.addEventListener("input",d);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const l=await globalThis.getSelectionText();if(l&&a){a.value=l;try{a.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}d(),s?.addEventListener("click",ve),_("#btnApplyTracked",Be),_("#btnAcceptAll",Le),_("#btnRejectAll",Oe),_("#btnPrevIssue",pe),_("#btnNextIssue",be),_("#btnPreviewDiff",Ce),_("#btnClearAnnots",ye),_("#btnSave",me);const i=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");i?(i.checked=ct(),i.addEventListener("change",()=>ge(!!i.checked))):ct();const c=document.getElementById("btnAnnotate");c&&(c.addEventListener("click",async()=>{if(!c.disabled){c.disabled=!0;try{const l=window.__last?.analyze?.json||{},f=globalThis.parseFindings(l);await globalThis.annotateFindingsIntoWord(f)}finally{c.disabled=!1}}}),c.classList.remove("js-disable-while-busy"),c.removeAttribute("disabled")),L(""),Ee(),console.log("Panel UI wired");const r=document.getElementById("btnAnalyze");if(r&&(r.disabled=!0),at(),st(),Tt(),e.revisions||(n("btnApplyTracked","revisions"),n("btnAcceptAll","revisions"),n("btnRejectAll","revisions")),e.comments||n("btnAcceptAll",e.commentsReason),e.search||(n("btnPrevIssue","search"),n("btnNextIssue","search"),n("btnQARecheck","search")),e.contentControls||n("btnAnnotate","contentControls"),!e.revisions||!e.comments||!e.search||!e.contentControls)try{it("Word ⚠")}catch{}}y.wireUI=y.wireUI||Rt;function L(t){const e=!!t.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),s=document.getElementById("btnRejectAll"),a=document.getElementById("btnPreviewDiff"),d=document.getElementById("draftPane"),i=document.getElementById("draftText");i&&(i.value=t),d&&(d.style.display=e?"":"none"),n&&(n.disabled=!e),o&&(o.disabled=!e),s&&(s.disabled=!e),a&&(a.disabled=!e)}async function $e(t){console.log("[PANEL] bootstrap start"),dt()&&(console.log("reopen clean OK"),Kt()),Rt(),Ht();try{await re(xt())}catch{}try{await $t()}catch{}try{it(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{it(null)}}let q=0;function Re(t){if(dt()&&(q=0),q>0){console.log(`bootstrap invoked x${q+1}`);return}q++,console.log("bootstrap invoked x1"),$e(t)}if(!globalThis.__CAI_TESTING__){const t=()=>Office.onReady(e=>Re(e));document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}})();
