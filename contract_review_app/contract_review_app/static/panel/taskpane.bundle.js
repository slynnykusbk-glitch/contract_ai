(function(){"use strict";var oe=typeof document<"u"?document.currentScript:null;const le="",ce="1.4",V="cai-comment-on-analyze";function ht(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",le),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",ce),localStorage.getItem(V)===null&&localStorage.setItem(V,"1")}catch{}}ht();function q(){try{return localStorage.getItem("api_key")||le}catch{return le}}function Oe(r){try{localStorage.setItem("api_key",r)}catch{}}function U(){try{return localStorage.getItem("schema_version")||ce}catch{return ce}}function J(r){try{localStorage.setItem("schema_version",r)}catch{}}function gt(){try{const r=localStorage.getItem(V);return r===null?(localStorage.setItem(V,"1"),!0):r!=="0"}catch{return!0}}function mt(r){try{localStorage.setItem(V,r?"1":"0")}catch{}}const N=typeof globalThis<"u"?globalThis:window;N.CAI=N.CAI||{},N.CAI.Store=N.CAI.Store||{},N.CAI.Store.setApiKey=Oe,N.CAI.Store.setSchemaVersion=J,N.CAI.Store.get=()=>({apiKey:q(),schemaVersion:U()}),N.CAI.Store.DEFAULT_BASE=N.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const $=window;$.__cai_pending_fetches=$.__cai_pending_fetches||new Set,$.__cai_pending_timers=$.__cai_pending_timers||new Set;const Y=$.__cai_pending_fetches,x=$.__cai_pending_timers,j={count:0};function pt(){j.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:j.count}}))}function yt(){j.count=Math.max(0,j.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:j.count>0,count:j.count}}))}async function Q(r){try{return pt(),await r()}finally{yt()}}function vt(r){Y.add(r)}function _t(r){Y.delete(r)}function bt(r){x.add(r)}function wt(r){x.delete(r)}function $e(r){Y.forEach(n=>{try{n.abort(r)}catch{}}),Y.clear(),x.forEach(n=>{try{clearTimeout(n),clearInterval(n)}catch{}}),x.clear();try{document.querySelectorAll(".progress").forEach(n=>{n.style.display="none"})}catch{}}function At(){if($.__pendingUnloadReg)return;$.__pendingUnloadReg=!0;const r=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),n=()=>{r&&$e("pagehide/unload"),$.__wasUnloaded=!0};window.addEventListener("pagehide",n),window.addEventListener("unload",n),window.addEventListener("beforeunload",n),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&$e("visibilitychange")})}function Et(){return!!$.__wasUnloaded}function It(){$.__wasUnloaded=!1}let ue=null;async function Ne(r={}){if(!ue){const n=(r.backend||"").replace(/\/+$/,""),c=n?`${n}/health`:"/health",u=new AbortController,f=r.timeoutMs??9e3,e=setTimeout(()=>u.abort("timeout"),f);ue=fetch(c,{signal:u.signal}).then(async t=>{clearTimeout(e);const a=await t.json().catch(()=>({}));return{ok:t.ok,json:a,resp:t}})}return ue}var Fe={};const fe=(()=>{if(typeof process<"u"&&(Fe!=null&&!0))return"production";try{if(typeof localStorage<"u")return localStorage.getItem("NODE_ENV")||""}catch{}return"development"})()==="production";function de(r,n){try{const c=document.getElementById("console");if(!c)return;c.textContent=r,c.setAttribute("data-level",n),setTimeout(()=>{c.textContent="",c.removeAttribute("data-level")},3e3)}catch{}}function H(r,n){de(r,"ok");try{fe?console.log("[OK]",r):console.log("[OK]",r,n)}catch{}}function Be(r,n){de(r,"error");try{fe?console.error("[ERR]",r):console.error("[ERR]",r,n)}catch{}}function L(r,n){de(r,"warn");try{fe?console.warn("[WARN]",r):console.warn("[WARN]",r,n)}catch{}}const Pe=(()=>{try{return localStorage.getItem("cai_dev")==="1"?!0:new URLSearchParams(globalThis.location?.search||"").get("debug")==="1"}catch{return!1}})();function St(r,n,c){Pe?console.error(r,n,c):console.error(r,n)}function ze(r){if(Array.isArray(r))return r.filter(Boolean);const n=r?.analysis?.findings??r?.findings??r?.issues??[];return Array.isArray(n)?n.filter(Boolean):[]}window.parseFindings=ze;function Tt(r){const n=r.headers,c=r.json||{},u=c.llm||c;return{cid:n.get("x-cid"),xcache:n.get("x-cache"),latencyMs:n.get("x-latency-ms"),schema:n.get("x-schema-version"),provider:n.get("x-provider")||u.provider||c.provider||null,model:n.get("x-model")||u.model||c.model||null,llm_mode:n.get("x-llm-mode")||u.mode||c.mode||null,usage:n.get("x-usage-total"),status:r.status!=null?String(r.status):null}}function he(r){const n=(c,u)=>{const f=document.getElementById(c);f&&(f.textContent=u&&u.length?u:"—")};n("status",r.status),n("cid",r.cid),n("xcache",r.xcache),n("latency",r.latencyMs),n("schema",r.schema),n("provider",r.provider),n("model",r.model),n("mode",r.llm_mode),n("usage",r.usage)}async function kt(){const r=new URL(oe&&oe.tagName.toUpperCase()==="SCRIPT"&&oe.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const c=await(await fetch(r)).text(),u=new TextEncoder().encode(c),f=await crypto.subtle.digest("SHA-256",u),e=Array.from(new Uint8Array(f)).slice(0,4).map(t=>t.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${e} ${r}`)}catch{console.log(`[selftest] api-client.js fail ${r}`)}}const We="https://localhost:9443";function Ct(){try{return(localStorage.getItem("backendUrl")||We).replace(/\/+$/,"")}catch{return We}}const ge=9e3,Mt=60,Dt=9e4,Lt=1,Rt=3e3;async function me(r,n,c){return Q(async()=>{const u=Ct()+r,f={"Content-Type":"application/json"},e=U()||"1.4";f["x-schema-version"]=e;const t=q();t&&(f["x-api-key"]=t);const a={...n||{},schema:e},i=JSON.stringify(a),o=new TextEncoder().encode(i).length;let s=c,l=Lt,d=Rt;if(r==="/api/analyze"){if(s==null){const g=ge+Mt*(o/1024);s=Math.max(ge,Math.min(Dt,Math.floor(g)))}try{for(const g of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const m=localStorage.getItem(g);if(m){const y=parseInt(m,10);if(Number.isFinite(y)){s=y;break}}}}catch{}try{const g=localStorage.getItem("cai.retry.analyze.count");g&&(l=parseInt(g,10))}catch{}try{const g=localStorage.getItem("cai.retry.analyze.backoff.ms");g&&(d=parseInt(g,10))}catch{}try{const g=new URLSearchParams(location.search),m=g.get("ta");m&&(s=parseInt(m,10));const y=g.get("rac");y&&(l=parseInt(y,10));const v=g.get("rb");v&&(d=parseInt(v,10))}catch{}}s=s??ge;async function h(g){const m=new AbortController;m.__key=r;const y=setTimeout(()=>m.abort(`timeout ${s}ms`),s);vt(m),bt(y);try{const v=await fetch(u,{method:"POST",headers:f,body:i,credentials:"include",signal:m.signal}),p=await v.json().catch(()=>({}));if(v.status===422){console.warn("[analyze] 422",p.detail);const _=Array.isArray(p?.detail)?p.detail.map(b=>b.msg).join("; "):p?.detail;try{L(`Validation error: ${_}`)}catch{}}return r==="/api/analyze"&&(v.status===504||v.status>=500)&&g<l?(await new Promise(_=>setTimeout(_,d)),h(g+1)):{resp:v,json:p}}catch(v){if(r==="/api/analyze"&&v?.name==="AbortError"){const p=m.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${p}`),g<l&&String(p).startsWith("timeout"))return await new Promise(_=>setTimeout(_,d)),h(g+1);throw new DOMException(p,"AbortError")}St(`[NET] ${r} failed`,v,{body:a});try{const p=Pe?String(v):"Analysis failed, please try again";L(p)}catch{}throw v}finally{clearTimeout(y),wt(y),_t(m)}}return h(0)})}window.postJson=me;async function Ot(r={}){const n={text:r?.text??r?.content,mode:r?.mode??"live"},{resp:c,json:u}=await me("/api/analyze",n),f=Tt({headers:c.headers,json:u,status:c.status});try{he(f)}catch{}try{const e=window;e.__last||(e.__last={}),e.__last.analyze={status:c.status,req:{path:"/api/analyze",method:"POST",body:n},json:u}}catch{}return{ok:c.ok,json:u,resp:c,meta:f}}async function $t(r,n){return me("/api/panel/redlines",{before_text:r,after_text:n})}const Nt={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function B(r){return r?r.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function ee(r){const n=(r||"").toLowerCase();return n==="high"?3:n==="medium"?2:1}function Ue(r){const n=new Map;let c=0,u=0;for(const e of r||[]){const t=B(e.snippet||""),a=typeof e.start=="number"?e.start:void 0,i=typeof e.end=="number"?e.end:a!==void 0?a+t.length:void 0;if(typeof a!="number"||typeof i!="number"||i<=a||i-a>1e4){c++;continue}const o=`${e.rule_id||""}|${a}|${i}|${t}`,s=n.get(o);!s||ee(e.severity)>ee(s.severity)?n.set(o,{...e,snippet:t,start:a,end:i}):u++}const f=Array.from(n.values());return console.log("panel:annotate",`dedupe dropped ${c} invalid, ${u} duplicates`),f}async function te(r,n,c){const u=r?.context,f=(n??"").trim();if(!f)return{items:[]};if(f.length<=240)try{const o=r.search(f,c);return o?.load?.("items"),await u?.sync?.(),o}catch{return{items:[]}}const e=f.slice(0,120);let t;try{t=r.search(e,c),t?.load?.("items"),await u?.sync?.()}catch{return{items:[]}}const a=[],i=f.slice(0,240);for(const o of t?.items||[]){let s=o;try{s=o.paragraphs?.getFirst?.()||o,s?.load?.("text"),await u?.sync?.()}catch{}const l=s?.text||"";if(l.includes(i))try{const g=s.search(i,c);g?.load?.("items"),await u?.sync?.(),g?.items?.length&&a.push(...g.items);continue}catch{}const d=i.split(/\s+/).filter(g=>g.length>3).slice(0,5);let h=!0;for(const g of d)if(!l.includes(g)){h=!1;break}h&&a.push(s)}return{items:a}}async function G(r,n){const c=r.context,u={matchCase:!1,matchWholeWord:!1},f=async i=>await te(r,i,u);let t=(await f(n||""))?.items||[];if(!t.length){const i=B(n||"");t=(await f(i))?.items||[]}t.sort((i,o)=>{const s=i.start??0,l=o.start??0;if(s!==l)return s-l;const d=i.end??s,h=o.end??l;return d-h});const a=[];for(const i of t){const o=i.start??0,s=i.end??o,l=a[a.length-1];if(l&&o<(l.end??o)){const d=(l.end??0)-(l.start??0);s-o>d&&(a[a.length-1]=i);continue}a.push(i)}for(const i of a)try{c.trackedObjects?.add?.(i)}catch{}return a}async function ne(r,n){try{if(!Office.context.requirements.isSetSupported("WordApi","1.4"))return!1}catch{return!1}const c=r.context;try{const u=c?.document;if(u?.comments?.add)return u.comments.add(r,n),await c?.sync?.(),!0}catch(u){if(u?.code==="NotImplemented")return!1}try{return r.insertComment(n),await c?.sync?.(),!0}catch(u){if(u?.code==="NotImplemented")return!1;throw u}}function Ft(r,n,c){if(!r||!n)return 0;let u=-1,f=0;for(;(u=r.indexOf(n,u+1))!==-1&&u<(c??r.length);)f++;return f}function Bt(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const K="[CAI]";function Pt(r){if(!r.rule_id||!r.snippet)return console.warn("buildLegalComment: missing required fields",r),"";const n=[r.rule_id];if(r.advice&&n.push(r.advice),r.law_refs?.length&&n.push(r.law_refs.join("; ")),r.norm_quote&&n.push(`"${r.norm_quote}"`),r.clause_url||r.clause_id){const c=r.clause_id?`Clause ${r.clause_id}`:"Clause";r.clause_url?n.push(`${c}: ${r.clause_url}`):n.push(c)}return`${K} ${n.join(`
`)}`}const pe=200;function ye(r){const n=B(globalThis.__lastAnalyzed||""),c=Array.isArray(r)?r:[],u=Ue(c),f=u.slice().sort((o,s)=>(o.start??Number.POSITIVE_INFINITY)-(s.start??Number.POSITIVE_INFINITY)),e=[];let t=-1,a=0;for(const o of f){if(!o||!o.rule_id||!o.snippet||typeof o.start!="number"){a++;continue}const s=o.snippet,l=o.start,d=typeof o.end=="number"?o.end:l+s.length;if(l<t){a++;continue}const h=B(s),g=Ft(n,h,l);if(e.push({raw:s,norm:h,occIdx:g,msg:Pt(o),rule_id:o.rule_id,code:o.code,normalized_fallback:B(o.normalized_snippet||"")}),t=d,e.length>=pe)break}const i=globalThis;return a&&i.notifyWarn?.(`Skipped ${a} overlaps/invalid`),u.length>pe&&i.notifyWarn?.(`Truncated to first ${pe} findings`),i.notifyOk?.(`Will insert: ${e.length}`),e}async function je(r){const n=ye(r);return n.length?await globalThis.Word?.run?.(async u=>{const f=u.document.body,e=[];let t=0;for(const a of n){let i=await G(f,a.raw),o=i[Math.min(a.occIdx,i.length-1)]||null;if(!o&&a.normalized_fallback&&a.normalized_fallback!==a.norm&&(i=await G(f,a.normalized_fallback),o=i[Math.min(a.occIdx,i.length-1)]||null),o){o.load?.(["start","end"]),await u.sync();const s=o.start??0,l=o.end??s;if(e.some(d=>Math.max(d.start,s)<Math.min(d.end,l))){console.warn("[annotate] overlapping range",{rid:a.rule_id,start:s,end:l});continue}if(Bt())try{o.select()}catch{}else if(a.msg&&!await ne(o,a.msg))continue;e.push({start:s,end:l}),t++}else console.warn("[annotate] no match for snippet",{rid:a.rule_id,snippet:a.raw.slice(0,120)});await u.sync()}return t}).catch(u=>(globalThis.logRichError?.(u,"annotate"),console.warn("annotate run fail",u?.code,u?.message,u?.debugInfo),0)):0}async function zt(r,n,c){if(!r||!r.trim())return;const u=globalThis;if(!u.Word?.run){await u.navigator?.clipboard?.writeText(r).catch(()=>{}),u.alert?.("Draft copied to clipboard (Office not ready). Paste it into the document.");return}if(u.Office?.context?.document?.mode&&u.Office.context.document.mode!=="edit")throw u.alert?.("Document is read-only."),new Error("Document mode is not editable");await u.Word.run(async f=>{const e=f.document;let t=null;const a=e.trackRevisions;try{const h=u.__findings||[],g=u.__findingIdx,m=h&&typeof g=="number"?h[g]:null,y=e.body;if(t=(m?.snippet?await G(y,m.snippet):[])[0]||null,!t){const p=e.getSelection();p.load("isEmpty"),await f.sync(),t=p.isEmpty?e.body.getRange("End"):p}}catch{const h=e.getSelection();h.load("isEmpty"),await f.sync(),t=h.isEmpty?e.body.getRange("End"):h}e.trackRevisions=!0;const i=t.insertText(r,u.Word.InsertLocation.replace),o=[`${K} Suggested clause – ${n}`],s=(c||"").split(/\r?\n/).slice(0,2).join(" "),l=u.__findings||[],d=u.__findingIdx;if(s)o.push(s);else{const h=l&&typeof d=="number"?l[d]:null,g=h?.rule_id||h?.title||"";g&&o.push(g)}o.push("schema 1.4 | model gpt-4o-mini | provider azure");try{await ne(i,o.join(`
`))}catch{}await f.sync(),e.trackRevisions=a,await f.sync()}).catch(f=>{throw globalThis.logRichError?.(f,"insertDraft"),console.warn("insertDraftText error",f?.code,f?.message,f?.debugInfo),f})}function Wt(){const r=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),n=globalThis.Word||{},c=r&&!!n?.Revision,u=r&&!!n?.SearchOptions,f=r&&!!n?.ContentControl,t=globalThis.localStorage?.getItem?.("cai.force.comments")==="1";let a=!1,i="unsupported";return t?(a=!0,i="dev override"):n?.Comment?(a=!0,i="Word.Comment available"):r?(a=!0,i="WordApi 1.4"):(a=!1,i="Word.Comment missing"),{revisions:c,comments:a,search:u,contentControls:f,commentsReason:i}}function He(){const r=Wt();try{console.log("support matrix",{comments:r.comments,reason:r.commentsReason})}catch{}return r}async function Ut(r){const n=[];try{await kt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(s=>{document.getElementById(s)||n.push(`missingID:${s}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||n.push("req1.4:0");const c=He(),u={revisions:c.revisions?1:0,comments:c.comments?1:0,search:c.search?1:0,contentControls:c.contentControls?1:0};let f=!1;try{f=(await Ne({backend:r})).ok,f||n.push("health")}catch{n.push("health:timeout")}const e="__BUILD_TS__",t=Office?.context?.host||"Word",a=n.length===0,i=a?`Startup OK | build=${e} | host=${t} | req=1.4 | features=${JSON.stringify(u)} | backend=${r}`:`Startup FAIL: ${n.join("; ")}`;console.log(i);const o=document.getElementById("startupBadge");return o&&(o.textContent=a?"OK":"FAIL",o.setAttribute("data-status",a?"ok":"fail")),{ok:a,missing:n,features:u}}function jt(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var ve={exports:{}},Ke;function Ht(){return Ke||(Ke=1,(function(r){var n=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},c=-1,u=1,f=0;n.Diff=function(e,t){return[e,t]},n.prototype.diff_main=function(e,t,a,i){typeof i>"u"&&(this.Diff_Timeout<=0?i=Number.MAX_VALUE:i=new Date().getTime()+this.Diff_Timeout*1e3);var o=i;if(e==null||t==null)throw new Error("Null input. (diff_main)");if(e==t)return e?[new n.Diff(f,e)]:[];typeof a>"u"&&(a=!0);var s=a,l=this.diff_commonPrefix(e,t),d=e.substring(0,l);e=e.substring(l),t=t.substring(l),l=this.diff_commonSuffix(e,t);var h=e.substring(e.length-l);e=e.substring(0,e.length-l),t=t.substring(0,t.length-l);var g=this.diff_compute_(e,t,s,o);return d&&g.unshift(new n.Diff(f,d)),h&&g.push(new n.Diff(f,h)),this.diff_cleanupMerge(g),g},n.prototype.diff_compute_=function(e,t,a,i){var o;if(!e)return[new n.Diff(u,t)];if(!t)return[new n.Diff(c,e)];var s=e.length>t.length?e:t,l=e.length>t.length?t:e,d=s.indexOf(l);if(d!=-1)return o=[new n.Diff(u,s.substring(0,d)),new n.Diff(f,l),new n.Diff(u,s.substring(d+l.length))],e.length>t.length&&(o[0][0]=o[2][0]=c),o;if(l.length==1)return[new n.Diff(c,e),new n.Diff(u,t)];var h=this.diff_halfMatch_(e,t);if(h){var g=h[0],m=h[1],y=h[2],v=h[3],p=h[4],_=this.diff_main(g,y,a,i),b=this.diff_main(m,v,a,i);return _.concat([new n.Diff(f,p)],b)}return a&&e.length>100&&t.length>100?this.diff_lineMode_(e,t,i):this.diff_bisect_(e,t,i)},n.prototype.diff_lineMode_=function(e,t,a){var i=this.diff_linesToChars_(e,t);e=i.chars1,t=i.chars2;var o=i.lineArray,s=this.diff_main(e,t,!1,a);this.diff_charsToLines_(s,o),this.diff_cleanupSemantic(s),s.push(new n.Diff(f,""));for(var l=0,d=0,h=0,g="",m="";l<s.length;){switch(s[l][0]){case u:h++,m+=s[l][1];break;case c:d++,g+=s[l][1];break;case f:if(d>=1&&h>=1){s.splice(l-d-h,d+h),l=l-d-h;for(var y=this.diff_main(g,m,!1,a),v=y.length-1;v>=0;v--)s.splice(l,0,y[v]);l=l+y.length}h=0,d=0,g="",m="";break}l++}return s.pop(),s},n.prototype.diff_bisect_=function(e,t,a){for(var i=e.length,o=t.length,s=Math.ceil((i+o)/2),l=s,d=2*s,h=new Array(d),g=new Array(d),m=0;m<d;m++)h[m]=-1,g[m]=-1;h[l+1]=0,g[l+1]=0;for(var y=i-o,v=y%2!=0,p=0,_=0,b=0,A=0,E=0;E<s&&!(new Date().getTime()>a);E++){for(var I=-E+p;I<=E-_;I+=2){var S=l+I,k;I==-E||I!=E&&h[S-1]<h[S+1]?k=h[S+1]:k=h[S-1]+1;for(var D=k-I;k<i&&D<o&&e.charAt(k)==t.charAt(D);)k++,D++;if(h[S]=k,k>i)_+=2;else if(D>o)p+=2;else if(v){var M=l+y-I;if(M>=0&&M<d&&g[M]!=-1){var C=i-g[M];if(k>=C)return this.diff_bisectSplit_(e,t,k,D,a)}}}for(var R=-E+b;R<=E-A;R+=2){var M=l+R,C;R==-E||R!=E&&g[M-1]<g[M+1]?C=g[M+1]:C=g[M-1]+1;for(var F=C-R;C<i&&F<o&&e.charAt(i-C-1)==t.charAt(o-F-1);)C++,F++;if(g[M]=C,C>i)A+=2;else if(F>o)b+=2;else if(!v){var S=l+y-R;if(S>=0&&S<d&&h[S]!=-1){var k=h[S],D=l+k-S;if(C=i-C,k>=C)return this.diff_bisectSplit_(e,t,k,D,a)}}}}return[new n.Diff(c,e),new n.Diff(u,t)]},n.prototype.diff_bisectSplit_=function(e,t,a,i,o){var s=e.substring(0,a),l=t.substring(0,i),d=e.substring(a),h=t.substring(i),g=this.diff_main(s,l,!1,o),m=this.diff_main(d,h,!1,o);return g.concat(m)},n.prototype.diff_linesToChars_=function(e,t){var a=[],i={};a[0]="";function o(h){for(var g="",m=0,y=-1,v=a.length;y<h.length-1;){y=h.indexOf(`
`,m),y==-1&&(y=h.length-1);var p=h.substring(m,y+1);(i.hasOwnProperty?i.hasOwnProperty(p):i[p]!==void 0)?g+=String.fromCharCode(i[p]):(v==s&&(p=h.substring(m),y=h.length),g+=String.fromCharCode(v),i[p]=v,a[v++]=p),m=y+1}return g}var s=4e4,l=o(e);s=65535;var d=o(t);return{chars1:l,chars2:d,lineArray:a}},n.prototype.diff_charsToLines_=function(e,t){for(var a=0;a<e.length;a++){for(var i=e[a][1],o=[],s=0;s<i.length;s++)o[s]=t[i.charCodeAt(s)];e[a][1]=o.join("")}},n.prototype.diff_commonPrefix=function(e,t){if(!e||!t||e.charAt(0)!=t.charAt(0))return 0;for(var a=0,i=Math.min(e.length,t.length),o=i,s=0;a<o;)e.substring(s,o)==t.substring(s,o)?(a=o,s=a):i=o,o=Math.floor((i-a)/2+a);return o},n.prototype.diff_commonSuffix=function(e,t){if(!e||!t||e.charAt(e.length-1)!=t.charAt(t.length-1))return 0;for(var a=0,i=Math.min(e.length,t.length),o=i,s=0;a<o;)e.substring(e.length-o,e.length-s)==t.substring(t.length-o,t.length-s)?(a=o,s=a):i=o,o=Math.floor((i-a)/2+a);return o},n.prototype.diff_commonOverlap_=function(e,t){var a=e.length,i=t.length;if(a==0||i==0)return 0;a>i?e=e.substring(a-i):a<i&&(t=t.substring(0,a));var o=Math.min(a,i);if(e==t)return o;for(var s=0,l=1;;){var d=e.substring(o-l),h=t.indexOf(d);if(h==-1)return s;l+=h,(h==0||e.substring(o-l)==t.substring(0,l))&&(s=l,l++)}},n.prototype.diff_halfMatch_=function(e,t){if(this.Diff_Timeout<=0)return null;var a=e.length>t.length?e:t,i=e.length>t.length?t:e;if(a.length<4||i.length*2<a.length)return null;var o=this;function s(_,b,A){for(var E=_.substring(A,A+Math.floor(_.length/4)),I=-1,S="",k,D,M,C;(I=b.indexOf(E,I+1))!=-1;){var R=o.diff_commonPrefix(_.substring(A),b.substring(I)),F=o.diff_commonSuffix(_.substring(0,A),b.substring(0,I));S.length<F+R&&(S=b.substring(I-F,I)+b.substring(I,I+R),k=_.substring(0,A-F),D=_.substring(A+R),M=b.substring(0,I-F),C=b.substring(I+R))}return S.length*2>=_.length?[k,D,M,C,S]:null}var l=s(a,i,Math.ceil(a.length/4)),d=s(a,i,Math.ceil(a.length/2)),h;if(!l&&!d)return null;d?l?h=l[4].length>d[4].length?l:d:h=d:h=l;var g,m,y,v;e.length>t.length?(g=h[0],m=h[1],y=h[2],v=h[3]):(y=h[0],v=h[1],g=h[2],m=h[3]);var p=h[4];return[g,m,y,v,p]},n.prototype.diff_cleanupSemantic=function(e){for(var t=!1,a=[],i=0,o=null,s=0,l=0,d=0,h=0,g=0;s<e.length;)e[s][0]==f?(a[i++]=s,l=h,d=g,h=0,g=0,o=e[s][1]):(e[s][0]==u?h+=e[s][1].length:g+=e[s][1].length,o&&o.length<=Math.max(l,d)&&o.length<=Math.max(h,g)&&(e.splice(a[i-1],0,new n.Diff(c,o)),e[a[i-1]+1][0]=u,i--,i--,s=i>0?a[i-1]:-1,l=0,d=0,h=0,g=0,o=null,t=!0)),s++;for(t&&this.diff_cleanupMerge(e),this.diff_cleanupSemanticLossless(e),s=1;s<e.length;){if(e[s-1][0]==c&&e[s][0]==u){var m=e[s-1][1],y=e[s][1],v=this.diff_commonOverlap_(m,y),p=this.diff_commonOverlap_(y,m);v>=p?(v>=m.length/2||v>=y.length/2)&&(e.splice(s,0,new n.Diff(f,y.substring(0,v))),e[s-1][1]=m.substring(0,m.length-v),e[s+1][1]=y.substring(v),s++):(p>=m.length/2||p>=y.length/2)&&(e.splice(s,0,new n.Diff(f,m.substring(0,p))),e[s-1][0]=u,e[s-1][1]=y.substring(0,y.length-p),e[s+1][0]=c,e[s+1][1]=m.substring(p),s++),s++}s++}},n.prototype.diff_cleanupSemanticLossless=function(e){function t(p,_){if(!p||!_)return 6;var b=p.charAt(p.length-1),A=_.charAt(0),E=b.match(n.nonAlphaNumericRegex_),I=A.match(n.nonAlphaNumericRegex_),S=E&&b.match(n.whitespaceRegex_),k=I&&A.match(n.whitespaceRegex_),D=S&&b.match(n.linebreakRegex_),M=k&&A.match(n.linebreakRegex_),C=D&&p.match(n.blanklineEndRegex_),R=M&&_.match(n.blanklineStartRegex_);return C||R?5:D||M?4:E&&!S&&k?3:S||k?2:E||I?1:0}for(var a=1;a<e.length-1;){if(e[a-1][0]==f&&e[a+1][0]==f){var i=e[a-1][1],o=e[a][1],s=e[a+1][1],l=this.diff_commonSuffix(i,o);if(l){var d=o.substring(o.length-l);i=i.substring(0,i.length-l),o=d+o.substring(0,o.length-l),s=d+s}for(var h=i,g=o,m=s,y=t(i,o)+t(o,s);o.charAt(0)===s.charAt(0);){i+=o.charAt(0),o=o.substring(1)+s.charAt(0),s=s.substring(1);var v=t(i,o)+t(o,s);v>=y&&(y=v,h=i,g=o,m=s)}e[a-1][1]!=h&&(h?e[a-1][1]=h:(e.splice(a-1,1),a--),e[a][1]=g,m?e[a+1][1]=m:(e.splice(a+1,1),a--))}a++}},n.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,n.whitespaceRegex_=/\s/,n.linebreakRegex_=/[\r\n]/,n.blanklineEndRegex_=/\n\r?\n$/,n.blanklineStartRegex_=/^\r?\n\r?\n/,n.prototype.diff_cleanupEfficiency=function(e){for(var t=!1,a=[],i=0,o=null,s=0,l=!1,d=!1,h=!1,g=!1;s<e.length;)e[s][0]==f?(e[s][1].length<this.Diff_EditCost&&(h||g)?(a[i++]=s,l=h,d=g,o=e[s][1]):(i=0,o=null),h=g=!1):(e[s][0]==c?g=!0:h=!0,o&&(l&&d&&h&&g||o.length<this.Diff_EditCost/2&&l+d+h+g==3)&&(e.splice(a[i-1],0,new n.Diff(c,o)),e[a[i-1]+1][0]=u,i--,o=null,l&&d?(h=g=!0,i=0):(i--,s=i>0?a[i-1]:-1,h=g=!1),t=!0)),s++;t&&this.diff_cleanupMerge(e)},n.prototype.diff_cleanupMerge=function(e){e.push(new n.Diff(f,""));for(var t=0,a=0,i=0,o="",s="",l;t<e.length;)switch(e[t][0]){case u:i++,s+=e[t][1],t++;break;case c:a++,o+=e[t][1],t++;break;case f:a+i>1?(a!==0&&i!==0&&(l=this.diff_commonPrefix(s,o),l!==0&&(t-a-i>0&&e[t-a-i-1][0]==f?e[t-a-i-1][1]+=s.substring(0,l):(e.splice(0,0,new n.Diff(f,s.substring(0,l))),t++),s=s.substring(l),o=o.substring(l)),l=this.diff_commonSuffix(s,o),l!==0&&(e[t][1]=s.substring(s.length-l)+e[t][1],s=s.substring(0,s.length-l),o=o.substring(0,o.length-l))),t-=a+i,e.splice(t,a+i),o.length&&(e.splice(t,0,new n.Diff(c,o)),t++),s.length&&(e.splice(t,0,new n.Diff(u,s)),t++),t++):t!==0&&e[t-1][0]==f?(e[t-1][1]+=e[t][1],e.splice(t,1)):t++,i=0,a=0,o="",s="";break}e[e.length-1][1]===""&&e.pop();var d=!1;for(t=1;t<e.length-1;)e[t-1][0]==f&&e[t+1][0]==f&&(e[t][1].substring(e[t][1].length-e[t-1][1].length)==e[t-1][1]?(e[t][1]=e[t-1][1]+e[t][1].substring(0,e[t][1].length-e[t-1][1].length),e[t+1][1]=e[t-1][1]+e[t+1][1],e.splice(t-1,1),d=!0):e[t][1].substring(0,e[t+1][1].length)==e[t+1][1]&&(e[t-1][1]+=e[t+1][1],e[t][1]=e[t][1].substring(e[t+1][1].length)+e[t+1][1],e.splice(t+1,1),d=!0)),t++;d&&this.diff_cleanupMerge(e)},n.prototype.diff_xIndex=function(e,t){var a=0,i=0,o=0,s=0,l;for(l=0;l<e.length&&(e[l][0]!==u&&(a+=e[l][1].length),e[l][0]!==c&&(i+=e[l][1].length),!(a>t));l++)o=a,s=i;return e.length!=l&&e[l][0]===c?s:s+(t-o)},n.prototype.diff_prettyHtml=function(e){for(var t=[],a=/&/g,i=/</g,o=/>/g,s=/\n/g,l=0;l<e.length;l++){var d=e[l][0],h=e[l][1],g=h.replace(a,"&amp;").replace(i,"&lt;").replace(o,"&gt;").replace(s,"&para;<br>");switch(d){case u:t[l]='<ins style="background:#e6ffe6;">'+g+"</ins>";break;case c:t[l]='<del style="background:#ffe6e6;">'+g+"</del>";break;case f:t[l]="<span>"+g+"</span>";break}}return t.join("")},n.prototype.diff_text1=function(e){for(var t=[],a=0;a<e.length;a++)e[a][0]!==u&&(t[a]=e[a][1]);return t.join("")},n.prototype.diff_text2=function(e){for(var t=[],a=0;a<e.length;a++)e[a][0]!==c&&(t[a]=e[a][1]);return t.join("")},n.prototype.diff_levenshtein=function(e){for(var t=0,a=0,i=0,o=0;o<e.length;o++){var s=e[o][0],l=e[o][1];switch(s){case u:a+=l.length;break;case c:i+=l.length;break;case f:t+=Math.max(a,i),a=0,i=0;break}}return t+=Math.max(a,i),t},n.prototype.diff_toDelta=function(e){for(var t=[],a=0;a<e.length;a++)switch(e[a][0]){case u:t[a]="+"+encodeURI(e[a][1]);break;case c:t[a]="-"+e[a][1].length;break;case f:t[a]="="+e[a][1].length;break}return t.join("	").replace(/%20/g," ")},n.prototype.diff_fromDelta=function(e,t){for(var a=[],i=0,o=0,s=t.split(/\t/g),l=0;l<s.length;l++){var d=s[l].substring(1);switch(s[l].charAt(0)){case"+":try{a[i++]=new n.Diff(u,decodeURI(d))}catch{throw new Error("Illegal escape in diff_fromDelta: "+d)}break;case"-":case"=":var h=parseInt(d,10);if(isNaN(h)||h<0)throw new Error("Invalid number in diff_fromDelta: "+d);var g=e.substring(o,o+=h);s[l].charAt(0)=="="?a[i++]=new n.Diff(f,g):a[i++]=new n.Diff(c,g);break;default:if(s[l])throw new Error("Invalid diff operation in diff_fromDelta: "+s[l])}}if(o!=e.length)throw new Error("Delta length ("+o+") does not equal source text length ("+e.length+").");return a},n.prototype.match_main=function(e,t,a){if(e==null||t==null||a==null)throw new Error("Null input. (match_main)");return a=Math.max(0,Math.min(a,e.length)),e==t?0:e.length?e.substring(a,a+t.length)==t?a:this.match_bitap_(e,t,a):-1},n.prototype.match_bitap_=function(e,t,a){if(t.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var i=this.match_alphabet_(t),o=this;function s(k,D){var M=k/t.length,C=Math.abs(a-D);return o.Match_Distance?M+C/o.Match_Distance:C?1:M}var l=this.Match_Threshold,d=e.indexOf(t,a);d!=-1&&(l=Math.min(s(0,d),l),d=e.lastIndexOf(t,a+t.length),d!=-1&&(l=Math.min(s(0,d),l)));var h=1<<t.length-1;d=-1;for(var g,m,y=t.length+e.length,v,p=0;p<t.length;p++){for(g=0,m=y;g<m;)s(p,a+m)<=l?g=m:y=m,m=Math.floor((y-g)/2+g);y=m;var _=Math.max(1,a-m+1),b=Math.min(a+m,e.length)+t.length,A=Array(b+2);A[b+1]=(1<<p)-1;for(var E=b;E>=_;E--){var I=i[e.charAt(E-1)];if(p===0?A[E]=(A[E+1]<<1|1)&I:A[E]=(A[E+1]<<1|1)&I|((v[E+1]|v[E])<<1|1)|v[E+1],A[E]&h){var S=s(p,E-1);if(S<=l)if(l=S,d=E-1,d>a)_=Math.max(1,2*a-d);else break}}if(s(p+1,a)>l)break;v=A}return d},n.prototype.match_alphabet_=function(e){for(var t={},a=0;a<e.length;a++)t[e.charAt(a)]=0;for(var a=0;a<e.length;a++)t[e.charAt(a)]|=1<<e.length-a-1;return t},n.prototype.patch_addContext_=function(e,t){if(t.length!=0){if(e.start2===null)throw Error("patch not initialized");for(var a=t.substring(e.start2,e.start2+e.length1),i=0;t.indexOf(a)!=t.lastIndexOf(a)&&a.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)i+=this.Patch_Margin,a=t.substring(e.start2-i,e.start2+e.length1+i);i+=this.Patch_Margin;var o=t.substring(e.start2-i,e.start2);o&&e.diffs.unshift(new n.Diff(f,o));var s=t.substring(e.start2+e.length1,e.start2+e.length1+i);s&&e.diffs.push(new n.Diff(f,s)),e.start1-=o.length,e.start2-=o.length,e.length1+=o.length+s.length,e.length2+=o.length+s.length}},n.prototype.patch_make=function(e,t,a){var i,o;if(typeof e=="string"&&typeof t=="string"&&typeof a>"u")i=e,o=this.diff_main(i,t,!0),o.length>2&&(this.diff_cleanupSemantic(o),this.diff_cleanupEfficiency(o));else if(e&&typeof e=="object"&&typeof t>"u"&&typeof a>"u")o=e,i=this.diff_text1(o);else if(typeof e=="string"&&t&&typeof t=="object"&&typeof a>"u")i=e,o=t;else if(typeof e=="string"&&typeof t=="string"&&a&&typeof a=="object")i=e,o=a;else throw new Error("Unknown call format to patch_make.");if(o.length===0)return[];for(var s=[],l=new n.patch_obj,d=0,h=0,g=0,m=i,y=i,v=0;v<o.length;v++){var p=o[v][0],_=o[v][1];switch(!d&&p!==f&&(l.start1=h,l.start2=g),p){case u:l.diffs[d++]=o[v],l.length2+=_.length,y=y.substring(0,g)+_+y.substring(g);break;case c:l.length1+=_.length,l.diffs[d++]=o[v],y=y.substring(0,g)+y.substring(g+_.length);break;case f:_.length<=2*this.Patch_Margin&&d&&o.length!=v+1?(l.diffs[d++]=o[v],l.length1+=_.length,l.length2+=_.length):_.length>=2*this.Patch_Margin&&d&&(this.patch_addContext_(l,m),s.push(l),l=new n.patch_obj,d=0,m=y,h=g);break}p!==u&&(h+=_.length),p!==c&&(g+=_.length)}return d&&(this.patch_addContext_(l,m),s.push(l)),s},n.prototype.patch_deepCopy=function(e){for(var t=[],a=0;a<e.length;a++){var i=e[a],o=new n.patch_obj;o.diffs=[];for(var s=0;s<i.diffs.length;s++)o.diffs[s]=new n.Diff(i.diffs[s][0],i.diffs[s][1]);o.start1=i.start1,o.start2=i.start2,o.length1=i.length1,o.length2=i.length2,t[a]=o}return t},n.prototype.patch_apply=function(e,t){if(e.length==0)return[t,[]];e=this.patch_deepCopy(e);var a=this.patch_addPadding(e);t=a+t+a,this.patch_splitMax(e);for(var i=0,o=[],s=0;s<e.length;s++){var l=e[s].start2+i,d=this.diff_text1(e[s].diffs),h,g=-1;if(d.length>this.Match_MaxBits?(h=this.match_main(t,d.substring(0,this.Match_MaxBits),l),h!=-1&&(g=this.match_main(t,d.substring(d.length-this.Match_MaxBits),l+d.length-this.Match_MaxBits),(g==-1||h>=g)&&(h=-1))):h=this.match_main(t,d,l),h==-1)o[s]=!1,i-=e[s].length2-e[s].length1;else{o[s]=!0,i=h-l;var m;if(g==-1?m=t.substring(h,h+d.length):m=t.substring(h,g+this.Match_MaxBits),d==m)t=t.substring(0,h)+this.diff_text2(e[s].diffs)+t.substring(h+d.length);else{var y=this.diff_main(d,m,!1);if(d.length>this.Match_MaxBits&&this.diff_levenshtein(y)/d.length>this.Patch_DeleteThreshold)o[s]=!1;else{this.diff_cleanupSemanticLossless(y);for(var v=0,p,_=0;_<e[s].diffs.length;_++){var b=e[s].diffs[_];b[0]!==f&&(p=this.diff_xIndex(y,v)),b[0]===u?t=t.substring(0,h+p)+b[1]+t.substring(h+p):b[0]===c&&(t=t.substring(0,h+p)+t.substring(h+this.diff_xIndex(y,v+b[1].length))),b[0]!==c&&(v+=b[1].length)}}}}}return t=t.substring(a.length,t.length-a.length),[t,o]},n.prototype.patch_addPadding=function(e){for(var t=this.Patch_Margin,a="",i=1;i<=t;i++)a+=String.fromCharCode(i);for(var i=0;i<e.length;i++)e[i].start1+=t,e[i].start2+=t;var o=e[0],s=o.diffs;if(s.length==0||s[0][0]!=f)s.unshift(new n.Diff(f,a)),o.start1-=t,o.start2-=t,o.length1+=t,o.length2+=t;else if(t>s[0][1].length){var l=t-s[0][1].length;s[0][1]=a.substring(s[0][1].length)+s[0][1],o.start1-=l,o.start2-=l,o.length1+=l,o.length2+=l}if(o=e[e.length-1],s=o.diffs,s.length==0||s[s.length-1][0]!=f)s.push(new n.Diff(f,a)),o.length1+=t,o.length2+=t;else if(t>s[s.length-1][1].length){var l=t-s[s.length-1][1].length;s[s.length-1][1]+=a.substring(0,l),o.length1+=l,o.length2+=l}return a},n.prototype.patch_splitMax=function(e){for(var t=this.Match_MaxBits,a=0;a<e.length;a++)if(!(e[a].length1<=t)){var i=e[a];e.splice(a--,1);for(var o=i.start1,s=i.start2,l="";i.diffs.length!==0;){var d=new n.patch_obj,h=!0;for(d.start1=o-l.length,d.start2=s-l.length,l!==""&&(d.length1=d.length2=l.length,d.diffs.push(new n.Diff(f,l)));i.diffs.length!==0&&d.length1<t-this.Patch_Margin;){var g=i.diffs[0][0],m=i.diffs[0][1];g===u?(d.length2+=m.length,s+=m.length,d.diffs.push(i.diffs.shift()),h=!1):g===c&&d.diffs.length==1&&d.diffs[0][0]==f&&m.length>2*t?(d.length1+=m.length,o+=m.length,h=!1,d.diffs.push(new n.Diff(g,m)),i.diffs.shift()):(m=m.substring(0,t-d.length1-this.Patch_Margin),d.length1+=m.length,o+=m.length,g===f?(d.length2+=m.length,s+=m.length):h=!1,d.diffs.push(new n.Diff(g,m)),m==i.diffs[0][1]?i.diffs.shift():i.diffs[0][1]=i.diffs[0][1].substring(m.length))}l=this.diff_text2(d.diffs),l=l.substring(l.length-this.Patch_Margin);var y=this.diff_text1(i.diffs).substring(0,this.Patch_Margin);y!==""&&(d.length1+=y.length,d.length2+=y.length,d.diffs.length!==0&&d.diffs[d.diffs.length-1][0]===f?d.diffs[d.diffs.length-1][1]+=y:d.diffs.push(new n.Diff(f,y))),h||e.splice(++a,0,d)}}},n.prototype.patch_toText=function(e){for(var t=[],a=0;a<e.length;a++)t[a]=e[a];return t.join("")},n.prototype.patch_fromText=function(e){var t=[];if(!e)return t;for(var a=e.split(`
`),i=0,o=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;i<a.length;){var s=a[i].match(o);if(!s)throw new Error("Invalid patch string: "+a[i]);var l=new n.patch_obj;for(t.push(l),l.start1=parseInt(s[1],10),s[2]===""?(l.start1--,l.length1=1):s[2]=="0"?l.length1=0:(l.start1--,l.length1=parseInt(s[2],10)),l.start2=parseInt(s[3],10),s[4]===""?(l.start2--,l.length2=1):s[4]=="0"?l.length2=0:(l.start2--,l.length2=parseInt(s[4],10)),i++;i<a.length;){var d=a[i].charAt(0);try{var h=decodeURI(a[i].substring(1))}catch{throw new Error("Illegal escape in patch_fromText: "+h)}if(d=="-")l.diffs.push(new n.Diff(c,h));else if(d=="+")l.diffs.push(new n.Diff(u,h));else if(d==" ")l.diffs.push(new n.Diff(f,h));else{if(d=="@")break;if(d!=="")throw new Error('Invalid patch mode "'+d+'" in: '+h)}i++}}return t},n.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},n.patch_obj.prototype.toString=function(){var e,t;this.length1===0?e=this.start1+",0":this.length1==1?e=this.start1+1:e=this.start1+1+","+this.length1,this.length2===0?t=this.start2+",0":this.length2==1?t=this.start2+1:t=this.start2+1+","+this.length2;for(var a=["@@ -"+e+" +"+t+` @@
`],i,o=0;o<this.diffs.length;o++){switch(this.diffs[o][0]){case u:i="+";break;case c:i="-";break;case f:i=" ";break}a[o+1]=i+encodeURI(this.diffs[o][1])+`
`}return a.join("").replace(/%20/g," ")},r.exports=n,r.exports.diff_match_patch=n,r.exports.DIFF_DELETE=c,r.exports.DIFF_INSERT=u,r.exports.DIFF_EQUAL=f})(ve)),ve.exports}var Kt=Ht();const Vt=jt(Kt);async function _e(){return await Word.run(async r=>{const n=r.document.body;return n.load("text"),await r.sync(),(n.text||"").trim()})}async function qt(){return await Word.run(async r=>{const n=r.document.getSelection();return n.load("text"),await r.sync(),(n.text||"").trim()})}var Ve={};const be=globalThis,we=be.OfficeExtension,qe="build-20250912-195756";console.log("ContractAI build",qe);let Je=null,Ye="1",Qe="1";try{Je=localStorage.getItem("cai_timeout_ms:analyze"),Ye=localStorage.getItem("cai_abort_on_hidden")||"1",Qe=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:Je,abort_on_hidden:Ye,abort_on_navigation:Qe}),!qe.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const r=document.createElement("div");r.textContent="FATAL: stale bundle",r.style.padding="12px",r.style.color="#f66",document.body.innerHTML="",document.body.appendChild(r),document.querySelectorAll("button").forEach(n=>{n.disabled=!0})}catch{}});const Ge=(()=>{const r=be.ENV_MODE||(typeof process<"u"?Ve?.ENV_MODE:void 0);return r?r==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();we&&we.config&&(Ge==="dev"||be.__ENABLE_EXTENDED_LOGS__)&&(we.config.extendedErrorLogging=!0);function X(r,n="Word"){try{const c=r&&r.debugInfo||{};console.error(`[${n}] RichApi error`,{code:r.code,message:r.message,errorLocation:c.errorLocation,statements:c.statements,traceMessages:c.traceMessages,inner:c.innerError})}catch{}}function re(r){return(ze(r)||[]).filter(c=>c&&c.rule_id&&c.snippet).map(c=>({...c,clause_type:c.clause_type||"Unknown"})).filter(c=>c.clause_type)}const T=globalThis;T.parseFindings=T.parseFindings||re,T.applyMetaToBadges=T.applyMetaToBadges||he,T.getApiKeyFromStore=T.getApiKeyFromStore||q,T.getSchemaFromStore=T.getSchemaFromStore||U,T.logRichError=T.logRichError||X,T.getWholeDocText=T.getWholeDocText||_e,T.getSelectionText=T.getSelectionText||qt;const Xe=T.__appliedRangeHashes||new Set;T.__appliedRangeHashes=Xe;let Ae="live";const P={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let ae="",Ze=!1,Ee=!1;const Jt=Nt.required_ids||[];function w(r){const n=document.getElementById(r);if(!n)throw new Error(`missing element #${r}`);return n}function Ie(r,n){const c=w("status-chip"),u=(r??U())||"—",f=(n??ae)||"—";c.textContent=`schema: ${u} | cid: ${f}`}function xe(){const r=w("anchorsBadge"),n=globalThis.__anchorsSkipped||0;r.style.display=n>0?"":"none"}T.updateAnchorBadge=T.updateAnchorBadge||xe;function Yt(){if(Ze)return;O("#btnAnalyze",pn);const r=w("btnAnalyze");r.disabled=!1,Ze=!0,console.log("[PANEL] analyze enabled")}function et(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function Qt(){const n=w("backendUrl").value.trim();if(n)try{localStorage.setItem("backend.url",n),localStorage.setItem("backendUrl",n)}catch{}location.reload()}function Se(){let r=q(),n=U();const c=w("hdrWarn"),u=globalThis?.location?.hostname??"",f=u==="localhost"||u==="127.0.0.1";if(f&&(r||(r="local-test-key-123",Oe(r)),!n)){const e=globalThis?.SCHEMA_VERSION||typeof process<"u"&&Ve?.SCHEMA_VERSION||"1.4";n=String(e),J(n)}return!r&&!n&&!f?c.style.display="":c.style.display="none",(!r||!n)&&console.warn("missing headers",{apiKey:!!r,schema:!!n}),!0}function W(r,n){const c=document.querySelector(`[data-role="${n}"]`);return c||w(r)}function Te(){const n=w("selectRiskThreshold").value.toLowerCase();return n==="low"||n==="medium"||n==="high"?n:"medium"}function tt(){const r=gt();try{const n=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();return n.checked=r,!!n.checked}catch{return r}}function Gt(r){mt(r)}function ke(r,n){const c=ee(n);return(r||[]).filter(u=>u&&u.rule_id&&u.snippet).map(u=>({...u,clause_type:u.clause_type||"Unknown"})).filter(u=>ee(u.severity)>=c)}T.annotateFindingsIntoWord=T.annotateFindingsIntoWord||je;async function Xt(){try{await Word.run(async r=>{const n=r.document.body,c=r.document.comments,u=typeof n.search=="function"?n.search(K,{matchCase:!1}):null;if(c&&typeof c.load=="function"&&c.load("items"),u&&typeof u.load=="function"&&u.load("items"),await r.sync(),c?.items)for(const f of c.items)try{(f.text||"").startsWith(K)&&f.delete()}catch{}if(u?.items&&u.items.length)for(const f of u.items)try{f.insertText("",Word.InsertLocation.replace)}catch{}try{n.font.highlightColor="NoColor"}catch{}await r.sync()}),H("Annotations cleared")}catch(r){X(r,"annotate"),L("Failed to clear annotations")}}function Zt(r,n){const c=new Vt,u=i=>i.match(/\S+|\s+/g)||[],{chars1:f,chars2:e,tokenArray:t}=xt(u(r),u(n));let a=c.diff_main(f,e);return c.diff_cleanupSemantic(a),a.map(([i,o])=>[i,o.split("").map(s=>t[s.charCodeAt(0)]).join("")])}function xt(r,n){const c=[],u=new Map,f=a=>u.has(a)?String.fromCharCode(u.get(a)):(c.push(a),u.set(a,c.length-1),String.fromCharCode(c.length-1)),e=r.map(f).join(""),t=n.map(f).join("");return{chars1:e,chars2:t,tokenArray:c}}async function nt(r){return Q(async()=>{let n=(r||[]).filter(f=>typeof f.start=="number"&&typeof f.end=="number"&&f.end>f.start).sort((f,e)=>f.start-e.start),c=-1;if(n=n.filter(f=>f.start<c?!1:(c=f.end,!0)),!n.length)return;const u=window.__lastAnalyzed||"";await Word.run(async f=>{const e=f.document.body;f.document.trackRevisions=!0;const t={matchCase:!1,matchWholeWord:!1},a=(i,o)=>{const s=i?.items||[];return s.length&&s[Math.min(Math.max(o,0),s.length-1)]||null};for(const i of n){const o=`${i.start}:${i.end}:${i.replacement}`;if(Xe.has(o))continue;const s=u.slice(i.start,i.end),l=(()=>{let h=-1,g=0;for(;(h=u.indexOf(s,h+1))!==-1&&h<i.start;)g++;return g})();let d=null;if(i.context_before||i.context_after){const h=`${i.context_before||""}${s}${i.context_after||""}`,g=await te(e,h,t),m=a(g,l);if(m){const y=s.slice(0,240),v=s.slice(-240),p=m.search(y,t),_=m.search(v,t);p&&typeof p.load=="function"&&p.load("items"),_&&typeof _.load=="function"&&_.load("items"),await f.sync();const b=a(p,0),A=a(_,0);b&&A&&typeof b.expandTo=="function"?d=b.expandTo(A):d=b}}if(!d){const h=await te(e,s,t);d=a(h,l)}if(!d){const h=(()=>{const g=s.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(m=>m.length>=12);return g.length?g.sort((m,y)=>y.length-m.length)[0].slice(0,64):null})();if(h){const g=await te(e,h,t);d=a(g,0)}}if(d){const h=Zt(s,i.replacement);let g=d.getRange("Start");for(const[v,p]of h)if(p)if(v===0){const b=g.getRange("After").search(p,t);b&&typeof b.load=="function"&&b.load("items"),await f.sync();const A=a(b,0);A&&(g=A.getRange("After"))}else if(v===-1){const b=g.getRange("After").search(p,t);b&&typeof b.load=="function"&&b.load("items"),await f.sync();const A=a(b,0);A&&(A.insertText("","Replace"),g=A.getRange("After"))}else v===1&&(g=g.insertText(p,"Before").getRange("After"));const m=`${K} ${i.rationale||i.source||"AI edit"}`,y=await ne(d,m)}else console.warn("[applyOpsTracked] match not found",{snippet:s,occIdx:l});await f.sync()}})})}T.applyOpsTracked=T.applyOpsTracked||nt;function rt(r,n){if(n.__highlight){try{n.__highlight.font.highlightColor="NoColor"}catch{}r.trackedObjects.remove(n.__highlight),n.__highlight=null}}async function at(){const r=window;r.__highlight&&await Word.run(async n=>{rt(n,r),await n.sync()})}async function Ce(r){await Word.run(async n=>{const c=window;rt(n,c);const u=n.document.body;let f=await G(u,r.raw),e=f[Math.min(r.occIdx,f.length-1)]||null;if(!e&&r.normalized_fallback&&r.normalized_fallback!==r.norm&&(f=await G(u,r.normalized_fallback),e=f[Math.min(r.occIdx,f.length-1)]||null),e){c.__highlight=e,n.trackedObjects.add(e);try{e.select()}catch{}try{e.font.highlightColor="#ffff00"}catch{}}await n.sync()})}let Me=!1;async function st(r){if(Me)return;Me=!0;const n=window.__findings||[];if(!n.length){Me=!1;return}const c=w("btnPrevIssue"),u=w("btnNextIssue");c.disabled=!0,u.disabled=!0;const f=window;f.__findingIdx=(f.__findingIdx??0)+r,f.__findingIdx<0&&(f.__findingIdx=n.length-1),f.__findingIdx>=n.length&&(f.__findingIdx=0);const e=w("findingsList"),t=Array.from(e.querySelectorAll("li"));t.forEach((i,o)=>{i.classList.toggle("active",o===f.__findingIdx)});const a=t[f.__findingIdx];a&&a.scrollIntoView({block:"nearest"});try{await Ce(n[f.__findingIdx])}catch{}}function en(r){const n=window.__findings||[];if(!n.length)return;const c=n.findIndex(t=>t.rule_id===r||t.code===r);if(c<0)return;window.__findingIdx=c;const u=w("findingsList"),f=Array.from(u.querySelectorAll("li"));f.forEach((t,a)=>{t.classList.toggle("active",a===c)});const e=f[c];e&&e.scrollIntoView({block:"nearest"});try{Ce(n[c])}catch{}}async function tn(){await st(-1)}async function nn(){await st(1)}function se(r){at().catch(()=>{});const n=r?.summary?.clause_type||r?.meta?.clause_type||r?.doc_type||"—",c=Array.isArray(r?.findings)?r.findings:[],u=Array.isArray(r?.recommendations)?r.recommendations:[],f=Te(),e=ke(c,f),t=e.length,a=c.length-t,i=(g,m)=>{w(g).textContent=m};i("clauseTypeOut",String(n)),i("resFindingsCount",String(c.length)),i("visibleHiddenOut",`${t} / ${a}`);const o=w("findingsBlock"),s=w("findingsList");s.innerHTML="",e.forEach((g,m)=>{const y=document.createElement("li"),v=g?.title||g?.finding?.title||g?.rule_id||"Issue",p=g?.snippet||g?.evidence?.text||"";y.textContent=p?`${v}: ${p}`:String(v),y.addEventListener("click",()=>{Array.from(s.querySelectorAll("li")).forEach((A,E)=>{A.classList.toggle("active",E===m)}),window.__findingIdx=m,Ce(g).catch(()=>{})});const _=Array.isArray(g.links)?g.links.filter(b=>b?.type==="conflict"&&b?.targetFindingId):[];if(_.length){const b=document.createElement("div");b.textContent=`Conflicts: ${_.length} `,_.forEach((A,E)=>{const I=document.createElement("a");I.href="#",I.textContent="Jump to",I.addEventListener("click",S=>{S.preventDefault(),en(A.targetFindingId)}),b.appendChild(I),E<_.length-1&&b.append(" ")}),y.appendChild(b)}s.appendChild(y)}),o.style.display=e.length?"":"none";const l=document.getElementById("recommendationsBlock"),d=document.getElementById("recommendationsList");if(d){d.innerHTML="";for(const g of u){const m=document.createElement("li");m.textContent=g?.text||g?.advice||g?.message||"Recommendation",d.appendChild(m)}}l&&(l.style.display=u.length?"":"none"),w("resultsBlock").style.removeProperty("display")}function ie(r){const n=W("resClauseType","clause-type");n.textContent=r?.clause_type||"—";const c=re(r);window.__findings=c,window.__findingIdx=0;const u=W("findingsList","findings");u&&(u.innerHTML="",c.forEach(s=>{const l=document.createElement("li");l.textContent=typeof s=="string"?s:JSON.stringify(s),u.appendChild(l)}));const f=w("findingsBlock");f.style.display=c.length?"":"none";const e=Array.isArray(r?.recommendations)?r.recommendations:[],t=W("recommendationsList","recommendations");t&&(t.innerHTML="",e.forEach(s=>{const l=document.createElement("li");l.textContent=typeof s=="string"?s:JSON.stringify(s),t.appendChild(l)}));const a=w("recommendationsBlock");a.style.display=e.length?"":"none";const i=W("resFindingsCount","findings-count");i.textContent=String(c.length);const o=W("rawJson","raw-json");o.textContent=JSON.stringify(r??{},null,2)}function rn(r){const n=window.__findings||[],c=re(r),u=Ue([...n,...c]);return{...r||{},findings:u}}function an(){const r=W("toggleRaw","toggle-raw-json"),n=W("rawJson","raw-json");n.style.display="none",r.addEventListener("click",()=>{n.style.display=n.style.display==="none"?"block":"none"})}function it(r){const n=w("connBadge");n.textContent=`Conn: ${r===null?"—":r?"✓":"×"}`}function De(r){const n=w("officeBadge");n.textContent=`Office: ${r??"—"}`}async function sn(){await Word.run(async r=>{const n=["Heading 1","Heading 2","Heading 3"];for(let c=0;c<n.length;c++){const u=r.document.body.paragraphs.getByStyle(n[c]);u.load("items"),await r.sync();for(const f of u.items)try{f.listFormat.removeNumbers(),f.listFormat.applyNumberedDefault(),f.listItem&&(f.listItem.level=c);const e=36*(c+1);f.paragraphFormat.leftIndent=e,f.paragraphFormat.firstLineIndent=-36,f.paragraphFormat.lineSpacing=240}catch(e){console.warn("fixNumbering",e)}}await r.sync()}).catch(r=>X(r,"fixNumbering"))}function z(r){return document.querySelector(r)}function on(){return(z(P.original)?.value||"").trim()}async function ln(){let r=on();if(r.length>=20)return r;try{if(r=(await globalThis.getSelectionText()||"").trim(),r.length>=20){const n=z(P.original);if(n){n.value=r;try{n.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return r}}catch{}return L("Please paste the original clause (min 20 chars) or select text in the document."),null}function cn(){try{return globalThis.detectContractType?.()||"unknown"}catch{return"unknown"}}function un(){try{const r=window.__findings||[];return Array.isArray(r)?r:[]}catch{return[]}}function fn(){try{return window.getSelectionOffsets?.()||null}catch{return null}}async function dn(r){const n=await ln();if(!n)return;const c={mode:r,clause_id:ae||void 0,text:n,context:{law:"UK",language:"en-GB",contractType:cn()},findings:un().slice(0,10),selection:fn()};let u;try{u=await fetch("/api/gpt/draft",{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":q()||"","X-Schema-Version":"1.4"},body:JSON.stringify(c)})}catch(i){console.warn("Draft error",i),L("Draft error");return}if(!u.ok){const i=await u.text();console.warn(`Draft failed: ${u.status} ${i}`);return}const f=await u.json(),e=(f?.draft_text||"").toString(),t=z(P.proposed),a=window;if(a.__last=a.__last||{},a.__last["gpt-draft"]={json:f},t){t.id||(t.id="draftText"),t.name||(t.name="proposed"),t.dataset.role="proposed-text",t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),H("Draft ready");try{await zt(e,Ae,f?.meta?.rationale)}catch{}Z(e)}else L("Proposed textarea not found"),Z("")}async function hn(){const r=z(P.original),n=await _e(),c=B(n||"");if(r){r.value=c;try{r.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const u=w("originalText");if(u!==r){u.value=c;try{u.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=c,window.toast?.("Whole doc loaded")}async function gn(r){return Q(()=>dn(Ae==="friendly"?"friendly":"strict"))}async function ot(){try{const r=U(),{resp:n,json:c,ok:u}=await Ne({backend:et()}),f=n.headers.get("x-schema-version")||c?.schema||null;if(f&&(J(f),f!==r&&console.log(`schema: ${f} (synced)`)),it(u),u){console.log("[PANEL] health ok"),Yt(),Ie(f,null);try{he({cid:null,xcache:null,latencyMs:null,schema:f||null,provider:c?.provider||null,model:c?.model||null,llm_mode:null,usage:null,status:c?.status||null})}catch{}H(`Health: ${c?.status||"ok"}${f?` (schema ${f})`:""}`)}else L("Health failed")}catch(r){it(!1),L("Health failed"),console.error(r)}}async function mn(){const r=w("originalText");let n=B(r.value||"");if(!n){const c=w("btnAnalyze");c.disabled=!0;try{n=B(await globalThis.getWholeDocText()),r.value=n||""}catch{n=""}finally{c.disabled=!1}}return n?(window.__lastAnalyzed=n,n):(L("Document is empty"),null)}async function pn(){if(Ee){console.log("[PANEL] analyze in progress - ignoring click");return}for(const r of Y)if(r.__key==="/api/analyze"){console.log("[PANEL] pending /api/analyze fetch - ignoring click");return}Ee=!0;try{if(!await mn())return;await yn()}finally{Ee=!1}}async function yn(){return Q(async()=>{const r=w("btnAnalyze"),n=w("busyBar");r.disabled=!0,n.style.display="";try{Z("");const c=window.__lastAnalyzed;if(!c){Be("В документе нет текста");return}Se();const{resp:u,json:f}=await Ot({text:c,mode:Ae});if(!u.ok)throw new Error(`HTTP ${u.status}`);const e=u.headers.get("x-schema-version");e&&J(e),f?.schema&&J(f.schema),ae=u.headers.get("x-cid")||"",Ie(null,ae),ie(f),se(f);try{localStorage.setItem("last_analysis_json",JSON.stringify(f))}catch{}try{const t=globalThis.parseFindings(f),a=Te(),i=ke(t,a),o=ye(i);window.__findings=o,window.__findingIdx=0;const s=w("findingsList"),l=document.createDocumentFragment();o.forEach((d,h)=>{const g=document.createElement("li");g.textContent=`${d.rule_id}: ${d.raw}`,h===0&&g.classList.add("active"),l.appendChild(g)}),s.innerHTML="",s.appendChild(l),tt()&&i.length&&await je(i)}catch(t){console.warn("auto-annotate after analyze failed",t)}w("results").dispatchEvent(new CustomEvent("ca.results",{detail:f})),H("Analyze OK")}catch(c){let u="";if(c?.name==="AbortError"){const f=c?.message||"";if(f.startsWith("timeout")){const e=parseInt(f.replace(/[^0-9]/g,""),10)||0;u=`(timeout ${Math.round(e/1e3)} s)`}else f==="pagehide/unload"?u="(aborted by pagehide)":u="(aborted)"}else typeof c?.message=="string"&&(c.message.includes("HTTP 504")?u="(HTTP 504)":c.message.includes("HTTP 413")?u="(payload too large 413)":c.message.includes("HTTP 401")?u="(unauthorized 401)":c.message.includes("HTTP 403")?u="(forbidden 403)":c.message.includes("HTTP 422")&&(u="(schema mismatch 422)"));L(`Analyze failed ${u}`.trim()),console.error(c)}finally{r.disabled=!1,n.style.display="none"}})}async function vn(){return Q(async()=>{await at(),Se();const r=window.__docId,n=await _e();window.__lastAnalyzed=n;const c=r?{document_id:r,rules:{}}:{text:n,rules:{}},{json:u}=await postJSON("/api/qa-recheck",c);if(w("results").dispatchEvent(new CustomEvent("ca.qa",{detail:u})),!u?.error){const e=window.__findings||[],t=window.__findingIdx??0,a=p=>p?.code||p?.rule_id||`${p?.rule_id}|${p?.raw||p?.snippet||""}`,i=e[t]?a(e[t]):null,o=re(u),s=Te(),l=ke(o,s),d=ye(l),h=new Map;d.forEach(p=>{const _=a(p);_&&!h.has(_)&&h.set(_,p)});const g=Array.from(h.values());window.__findings=g;let m=0;if(i){const p=g.findIndex(_=>a(_)===i);p>=0&&(m=p)}m>=g.length&&(m=0),window.__findingIdx=m;const y=w("findingsList"),v=document.createDocumentFragment();g.forEach((p,_)=>{const b=document.createElement("li");b.textContent=`${p.rule_id}: ${p.raw}`,_===m&&b.classList.add("active"),v.appendChild(b)}),y.innerHTML="",y.appendChild(v),H("QA recheck OK")}else{const e=u?.error||u?.message||"unknown";Be(`QA recheck failed: ${e}`)}})}function O(r,n){const c=document.querySelector(r);c&&(c.addEventListener("click",u=>{u.preventDefault(),n()}),c.classList.remove("js-disable-while-busy"),c.removeAttribute("disabled"))}async function _n(){try{const r=window.__lastAnalyzed||"",n=(z(P.proposed)?.value||"").trim();if(!n){L("No draft to diff");return}const c=await $t(r,n),u=c?.json?.html||c?.json?.diff_html||c?.json?.redlines||"",f=w("diffOutput"),e=w("diffContainer");f.innerHTML=u||"",e.style.display=u?"block":"none"}catch(r){L("Diff failed"),console.error(r)}}async function bn(){try{const r=window.__last||{},n=r["gpt-draft"]?.json?.ops||r.suggest?.json?.ops||[];if(!n.length){L("No ops to apply");return}await nt(n),H("Applied ops")}catch(r){L("Insert failed"),console.error(r)}}async function wn(){try{const n=(z(P.proposed)?.value||"").trim();if(!n){window.toast?.("Nothing to accept");return}const c=(w("cid").textContent||"").trim(),u=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),f=c&&c!=="—"?`${u}/api/trace/${c}`:"AI draft";await Word.run(async e=>{const t=e.document.getSelection();e.document.trackRevisions=!0,t.insertText(n,Word.InsertLocation.replace);const a=await ne(t,`${K} ${f}`);await e.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(r){window.toast?.("Accept failed"),X(r,"insertDraft"),console.error(r)}}async function An(){try{const r=z(P.proposed);r&&(r.value="",r.dispatchEvent(new Event("input",{bubbles:!0})),Z("")),await Word.run(async n=>{const u=n.document.getSelection().revisions;u.load("items"),await n.sync(),(u.items||[]).forEach(f=>{try{f.reject()}catch{}}),await n.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(r){window.toast?.("Reject failed"),X(r,"insertDraft"),console.error(r)}}function lt(){if(console.log("[PANEL] wireUI start"),globalThis.__CAI_TESTING__){console.log("[PANEL] wireUI skipped (__CAI_TESTING__)");return}const r=Jt.filter(l=>{try{return w(l),!1}catch{return!0}});if(r.length){console.error("[PANEL] wireUI missing IDs:",r);const l=`FATAL: panel template mismatch (missing: ${r.join(", ")}). Check build pipeline.`;try{const d=document.createElement?document.createElement("div"):null;d&&(d.textContent=l,d.style.padding="12px",d.style.color="#f66",document.body.innerHTML="",document.body.appendChild(d))}catch{}console.error(l);return}const n=w("loading-book");window.addEventListener("cai:busy",l=>{!!l?.detail?.busy?n.classList.remove("hidden"):n.classList.add("hidden")});const c=He(),u=(l,d)=>{const h=w(l);if(h.disabled=!0,h.title=d?`Not supported: ${d}`:"Not supported",d)try{console.log(`disabled ${l}: ${d}`)}catch{}};O("#btnUseWholeDoc",hn);const f=w("btnUseWholeDoc");if(f.disabled=!1,O("#btnFixNumbering",sn),Ge==="dev")O("#btnTest",ot);else{const l=w("btnTest");l.style.display="none"}O("#btnQARecheck",vn);const e=w("btnSuggestEdit"),t=z(P.original),a=()=>{e.disabled=!(t&&t.value.trim())};t?.addEventListener("input",a);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const l=await globalThis.getSelectionText();if(l&&t){t.value=l;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}a(),e.addEventListener("click",gn),O("#btnApplyTracked",bn),O("#btnAcceptAll",wn),O("#btnRejectAll",An),O("#btnPrevIssue",tn),O("#btnNextIssue",nn),O("#btnPreviewDiff",_n),O("#btnClearAnnots",Xt),O("#btnSave",Qt);const i=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();i.checked=tt(),i.addEventListener("change",()=>Gt(!!i.checked));const o=w("btnAnnotate");o.addEventListener("click",async()=>{if(!o.disabled){o.disabled=!0;try{const l=window.__last?.analyze?.json||{},d=globalThis.parseFindings(l);try{await globalThis.annotateFindingsIntoWord(d)}catch(h){const g=h?.code||h?.name||"";g==="SearchStringInvalidOrTooLong"||g==="InvalidOrTooLong"||g==="InvalidArgument"?(globalThis.toast2?.("Search failed (long text), skipping some anchors","warn"),console.warn("[annotate run] search error",g)):console.warn("[annotate run] error",h)}}finally{o.disabled=!1}}}),o.classList.remove("js-disable-while-busy"),o.removeAttribute("disabled"),w("results").addEventListener("ca.qa",l=>{const d=l?.detail;try{if(!d||d.error){ie(d||{}),se(d||{});return}const h=rn(d);ie(h),se(h)}catch(h){console.warn("ca.qa handler failed",h),ie(d||{}),se(d||{})}}),Z(""),an(),console.log("Panel UI wired [OK]");const s=w("btnAnalyze");if(s.disabled=!0,Se(),Ie(),xe(),c.revisions||(u("btnApplyTracked","revisions"),u("btnAcceptAll","revisions"),u("btnRejectAll","revisions")),c.comments||u("btnAcceptAll",c.commentsReason),c.search||(u("btnPrevIssue","search"),u("btnNextIssue","search"),u("btnQARecheck","search")),c.contentControls||u("btnAnnotate","contentControls"),!c.revisions||!c.comments||!c.search||!c.contentControls)try{De("Word ⚠")}catch{}}T.wireUI=T.wireUI||lt;function Z(r){const n=!!r.trim(),c=w("btnApplyTracked"),u=w("btnAcceptAll"),f=w("btnRejectAll"),e=w("btnPreviewDiff"),t=w("draftPane"),a=w("draftText");a.value=r,t.style.display=n?"":"none",c.disabled=!n,u.disabled=!n,f.disabled=!n,e.disabled=!n}async function En(r){console.log("[PANEL] bootstrap start"),Et()&&(console.log("reopen clean OK"),It()),lt(),At();try{await Ut(et())}catch{}try{await ot()}catch{}try{De(`${r?.host||Office.context?.host||"Word"} ✓`)}catch{De(null)}}let Le=!1,ct=!1,ut,ft=!1,dt=0;function Re(){if(ft){console.log(`bootstrap invoked x${dt+1}`);return}Le&&ct&&(ft=!0,dt++,console.log("bootstrap invoked x1"),En(ut))}globalThis.__CAI_TESTING__||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Le=!0,Re()}):(Le=!0,Re()),Office.onReady(r=>{ct=!0,ut=r,Re()}))})();
