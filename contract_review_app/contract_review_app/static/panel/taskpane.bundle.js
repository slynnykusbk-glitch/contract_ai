(function(){"use strict";var de=typeof document<"u"?document.currentScript:null;const he="",ge="1.4",Y="cai-comment-on-analyze";function Rt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",he),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",ge),localStorage.getItem(Y)===null&&localStorage.setItem(Y,"1")}catch{}}Rt();function J(){try{return localStorage.getItem("api_key")||he}catch{return he}}function je(e){try{localStorage.setItem("api_key",e)}catch{}}function K(){try{return localStorage.getItem("schema_version")||ge}catch{return ge}}function Q(e){try{localStorage.setItem("schema_version",e)}catch{}}function Nt(){try{const e=localStorage.getItem(Y);return e===null?(localStorage.setItem(Y,"1"),!0):e!=="0"}catch{return!0}}function Ot(e){try{localStorage.setItem(Y,e?"1":"0")}catch{}}const F=typeof globalThis<"u"?globalThis:window;F.CAI=F.CAI||{},F.CAI.Store=F.CAI.Store||{},F.CAI.Store.setApiKey=je,F.CAI.Store.setSchemaVersion=Q,F.CAI.Store.get=()=>({apiKey:J(),schemaVersion:K()}),F.CAI.Store.DEFAULT_BASE=F.CAI.Store.DEFAULT_BASE||"https://127.0.0.1:9443";const O=window;O.__cai_pending_fetches=O.__cai_pending_fetches||new Set,O.__cai_pending_timers=O.__cai_pending_timers||new Set;const Z=O.__cai_pending_fetches,ne=O.__cai_pending_timers,V={count:0};function Ft(){V.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:V.count}}))}function $t(){V.count=Math.max(0,V.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:V.count>0,count:V.count}}))}async function G(e){try{return Ft(),await e()}finally{$t()}}function Bt(e){Z.add(e)}function zt(e){Z.delete(e)}function Pt(e){ne.add(e)}function Wt(e){ne.delete(e)}function xe(e){Z.forEach(n=>{try{n.abort(e)}catch{}}),Z.clear(),ne.forEach(n=>{try{clearTimeout(n),clearInterval(n)}catch{}}),ne.clear();try{document.querySelectorAll(".progress").forEach(n=>{n.style.display="none"})}catch{}}function Ht(){if(O.__pendingUnloadReg)return;O.__pendingUnloadReg=!0;const e=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),n=()=>{e&&xe("pagehide/unload"),O.__wasUnloaded=!0};window.addEventListener("pagehide",n),window.addEventListener("unload",n),window.addEventListener("beforeunload",n),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&xe("visibilitychange")})}function Ut(){return!!O.__wasUnloaded}function jt(){O.__wasUnloaded=!1}let me=null;async function Ke(e={}){if(!me){const n=(e.backend||"").replace(/\/+$/,""),c=n?`${n}/health`:"/health",f=new AbortController,u=e.timeoutMs??9e3,t=setTimeout(()=>f.abort("timeout"),u);me=fetch(c,{signal:f.signal}).then(async r=>{clearTimeout(t);const o=await r.json().catch(()=>({}));return{ok:r.ok,json:o,resp:r}})}return me}var Ve={};const pe=(()=>{if(typeof process<"u"&&(Ve!=null&&!0))return"production";try{if(typeof localStorage<"u")return localStorage.getItem("NODE_ENV")||""}catch{}return"development"})()==="production";function ye(e,n){try{const c=document.getElementById("console");if(!c)return;c.textContent=e,c.setAttribute("data-level",n),setTimeout(()=>{c.textContent="",c.removeAttribute("data-level")},3e3)}catch{}}function q(e,n){ye(e,"ok");try{pe?console.log("[OK]",e):console.log("[OK]",e,n)}catch{}}function qe(e,n){ye(e,"error");try{pe?console.error("[ERR]",e):console.error("[ERR]",e,n)}catch{}}function L(e,n){ye(e,"warn");try{pe?console.warn("[WARN]",e):console.warn("[WARN]",e,n)}catch{}}const Ye=(()=>{try{return localStorage.getItem("cai_dev")==="1"?!0:new URLSearchParams(globalThis.location?.search||"").get("debug")==="1"}catch{return!1}})();function xt(e,n,c){Ye?console.error(e,n,c):console.error(e,n)}function Je(e){if(Array.isArray(e))return e.filter(Boolean);const n=e?.analysis?.findings??e?.findings??e?.issues??[];return Array.isArray(n)?n.filter(Boolean):[]}window.parseFindings=Je;function Kt(e){const n=e.headers,c=e.json||{},f=c.llm||c;return{cid:n.get("x-cid"),xcache:n.get("x-cache"),latencyMs:n.get("x-latency-ms"),schema:n.get("x-schema-version"),provider:n.get("x-provider")||f.provider||c.provider||null,model:n.get("x-model")||f.model||c.model||null,llm_mode:n.get("x-llm-mode")||f.mode||c.mode||null,usage:n.get("x-usage-total"),status:e.status!=null?String(e.status):null}}function be(e){const n=(c,f)=>{const u=document.getElementById(c);u&&(u.textContent=f&&f.length?f:"—")};n("status",e.status),n("cid",e.cid),n("xcache",e.xcache),n("latency",e.latencyMs),n("schema",e.schema),n("provider",e.provider),n("model",e.model),n("mode",e.llm_mode),n("usage",e.usage)}async function Vt(){const e=new URL(de&&de.tagName.toUpperCase()==="SCRIPT"&&de.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const c=await(await fetch(e)).text(),f=new TextEncoder().encode(c),u=await crypto.subtle.digest("SHA-256",f),t=Array.from(new Uint8Array(u)).slice(0,4).map(r=>r.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${t} ${e}`)}catch{console.log(`[selftest] api-client.js fail ${e}`)}}const Qe="https://127.0.0.1:9443";function qt(){try{return(localStorage.getItem("backendUrl")||Qe).replace(/\/+$/,"")}catch{return Qe}}const _e=9e3,Yt=60,Jt=9e4,Qt=1,Zt=3e3;async function ve(e,n,c){return G(async()=>{const f=qt()+e,u={"Content-Type":"application/json"},t=K()||"1.4";u["x-schema-version"]=t;const r=J();r&&(u["x-api-key"]=r);const o={...n||{},schema:t},i=JSON.stringify(o),l=new TextEncoder().encode(i).length;let a=c,s=Qt,d=Zt;if(e==="/api/analyze"){if(a==null){const g=_e+Yt*(l/1024);a=Math.max(_e,Math.min(Jt,Math.floor(g)))}try{for(const g of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const m=localStorage.getItem(g);if(m){const p=parseInt(m,10);if(Number.isFinite(p)){a=p;break}}}}catch{}try{const g=localStorage.getItem("cai.retry.analyze.count");g&&(s=parseInt(g,10))}catch{}try{const g=localStorage.getItem("cai.retry.analyze.backoff.ms");g&&(d=parseInt(g,10))}catch{}try{const g=new URLSearchParams(location.search),m=g.get("ta");m&&(a=parseInt(m,10));const p=g.get("rac");p&&(s=parseInt(p,10));const y=g.get("rb");y&&(d=parseInt(y,10))}catch{}}a=a??_e;async function h(g){const m=new AbortController;m.__key=e;const p=setTimeout(()=>m.abort(`timeout ${a}ms`),a);Bt(m),Pt(p);try{const y=await fetch(f,{method:"POST",headers:u,body:i,credentials:"include",signal:m.signal}),b=await y.json().catch(()=>({}));if(y.status===422){console.warn("[analyze] 422",b.detail);const _=Array.isArray(b?.detail)?b.detail.map(v=>v.msg).join("; "):b?.detail;try{L(`Validation error: ${_}`)}catch{}}return e==="/api/analyze"&&(y.status===504||y.status>=500)&&g<s?(await new Promise(_=>setTimeout(_,d)),h(g+1)):{resp:y,json:b}}catch(y){if(e==="/api/analyze"&&y?.name==="AbortError"){const b=m.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${b}`),g<s&&String(b).startsWith("timeout"))return await new Promise(_=>setTimeout(_,d)),h(g+1);throw new DOMException(b,"AbortError")}xt(`[NET] ${e} failed`,y,{body:o});try{const b=Ye?String(y):"Analysis failed, please try again";L(b)}catch{}throw y}finally{clearTimeout(p),Wt(p),zt(m)}}return h(0)})}window.postJson=ve;async function Gt(e={}){const n={text:e?.text??e?.content,mode:e?.mode??"live",risk:e?.risk??"medium"},{resp:c,json:f}=await ve("/api/analyze",n),u=Kt({headers:c.headers,json:f,status:c.status});try{be(u)}catch{}try{const t=window;t.__last||(t.__last={}),t.__last.analyze={status:c.status,req:{path:"/api/analyze",method:"POST",body:n},json:f}}catch{}return{ok:c.ok,json:f,resp:c,meta:u}}async function Xt(e,n){return ve("/api/panel/redlines",{before_text:e,after_text:n})}function we(e){return typeof e=="number"&&Number.isFinite(e)?e:void 0}function re(e){return(Je(e)||[]).filter(c=>c&&c.rule_id&&c.snippet).map(c=>({...c,start:we(c.start),end:we(c.end),nth:we(c.nth),clause_type:c.clause_type||"Unknown"})).filter(c=>c.clause_type)}const en={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]},Ze=["low","medium","high","critical"];function ae(e){return e?e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function tn(e){if(typeof e!="string")return null;const n=e.trim().toLowerCase();return n==="low"||n==="medium"||n==="high"||n==="critical"?n:null}function oe(e){const n=tn(e);return n?Ze.indexOf(n):Ze.indexOf("medium")}function Ge(e){const n=new Map;let c=0,f=0;for(const t of e||[]){const r=ae(t.snippet||""),o=typeof t.start=="number"?t.start:void 0,i=typeof t.end=="number"?t.end:o!==void 0?o+r.length:void 0;if(typeof o!="number"||typeof i!="number"||i<=o||i-o>1e4){c++;continue}const l=`${t.rule_id||""}|${o}|${i}|${r}`,a=n.get(l);!a||oe(t.severity)>oe(a.severity)?n.set(l,{...t,snippet:r,start:o,end:i}):f++}const u=Array.from(n.values());return console.log("panel:annotate",`dedupe dropped ${c} invalid, ${f} duplicates`),u}const nn=new Set(["​","‌","‍","‎","‏","⁠","⁡","⁢","⁣","⁤","\uFEFF"]),rn=new Set([" "," "]),Xe={"‐":"-","‑":"-","‒":"-","–":"-","—":"-","―":"-","−":"-"},et={"“":'"',"”":'"',"„":'"',"‟":'"',"«":'"',"»":'"',"″":'"',"‶":'"'},tt={"‘":"'","’":"'","‚":"'","‛":"'","′":"'","‵":"'"};function an(e){return nn.has(e)}function on(e){return Xe[e]?Xe[e]:et[e]?et[e]:tt[e]?tt[e]:rn.has(e)?" ":e}function sn(e){const{text:n,map:c}=e;let f=0,u=n.length;for(;f<u&&/\s/.test(n[f]);)f++;for(;u>f&&/\s/.test(n[u-1]);)u--;return f===0&&u===n.length?e:{text:n.slice(f,u),map:c.slice(f,u)}}function Ae(e){const n=typeof e=="string"?e.normalize("NFC"):"";if(!n)return{text:"",map:[]};const c=[],f=[];let u=!1;for(let o=0;o<n.length;){const i=n.codePointAt(o);let l=String.fromCodePoint(i);const a=l.length;if(l==="\r"){f.push(o),c.push(`
`),o+=a,o<n.length&&n[o]===`
`&&(o+=1),u=!1;continue}if(l===`
`){f.push(o),c.push(`
`),o+=a,u=!1;continue}if(an(l)){o+=a;continue}if(l=on(l),l==="	"&&(l=" "),l===" "){if(u){o+=a;continue}u=!0}else u=!1;c.push(l),f.push(o),o+=a}const r={text:c.join("").normalize("NFC"),map:f};return sn(r)}function H(e){return e?Ae(e).text:""}async function U(e,n,c){const f=e?.context,u=(n??"").trim();if(!u)return{items:[]};if(u.length<=240)try{const l=e.search(u,c);return l?.load?.("items"),await f?.sync?.(),l}catch{return{items:[]}}const t=u.slice(0,120);let r;try{r=e.search(t,c),r?.load?.("items"),await f?.sync?.()}catch{return{items:[]}}const o=[],i=u.slice(0,240);for(const l of r?.items||[]){let a=l;try{a=l.paragraphs?.getFirst?.()||l,a?.load?.("text"),await f?.sync?.()}catch{}const s=a?.text||"";if(s.includes(i))try{const g=a.search(i,c);g?.load?.("items"),await f?.sync?.(),g?.items?.length&&o.push(...g.items);continue}catch{}const d=i.split(/\s+/).filter(g=>g.length>3).slice(0,5);let h=!0;for(const g of d)if(!s.includes(g)){h=!1;break}h&&o.push(a)}return{items:o}}function nt(e){return e?Ae(String(e)).text:""}function rt(e){if(!e)return null;const c=H(String(e)).replace(/[^\p{L}\p{N} ]/gu," ").split(" ").map(t=>t.trim()).filter(Boolean);if(!c.length)return null;const f=c.sort((t,r)=>r.length-t.length),u=f.find(t=>t.length>=8)||f[0];return u?u.slice(0,64):null}async function ie(e,n,c){const f=e.context,u={matchCase:!1,matchWholeWord:!1},t=async s=>await U(e,s,u),r=n||"";let i=(await t(r))?.items||[];if(!i.length){const s=H(r).trim();s&&(i=(await t(s))?.items||[])}i.sort((s,d)=>{const h=s.start??0,g=d.start??0;if(h!==g)return h-g;const m=s.end??h,p=d.end??g;return m-p});const l=[];for(const s of i){const d=s.start??0,h=s.end??d,g=l[l.length-1];if(g&&d<(g.end??d)){const m=(g.end??0)-(g.start??0);h-d>m&&(l[l.length-1]=s);continue}l.push(s)}const a=c?.nth;if(typeof a=="number"&&Number.isFinite(a)&&a>=0&&l.length){const s=Math.min(Math.floor(a),l.length-1),d=l[s];if(d){const h=[d,...l.slice(0,s),...l.slice(s+1)];l.length=0,l.push(...h)}}for(const s of l)try{f.trackedObjects?.add?.(s)}catch{}return l}async function Ee(e,n,c,f){if(!e||!n)return null;const u=typeof c=="number"&&Number.isFinite(c)&&c>=0?Math.floor(c):0,t=f||{matchCase:!1,matchWholeWord:!1};let o=(await U(e,n,t))?.items||[];if(!o.length){const l=H(n).trim();l&&l!==n&&(o=(await U(e,l,t))?.items||[])}if(!o.length||u>=o.length)return null;const i=o[u]??null;if(!i)return null;try{e.context?.trackedObjects?.add?.(i)}catch{}return i}function se(e,n,c){if(!n)return;const f=nt(n);f&&(c&&f===c||e.add(f))}function cn(e,n){if(n)try{e.context?.trackedObjects?.add?.(n)}catch{}}async function ln(e){if(!e?.body||!e.snippet)return null;const{body:n,snippet:c}=e,f=e.searchOptions||{matchCase:!1,matchWholeWord:!1},u=typeof e.nth=="number"&&Number.isFinite(e.nth)&&e.nth>=0?Math.floor(e.nth):0,t=s=>{try{e.onMethod?.(s)}catch{}};if(globalThis?.__cfg_anchorOffsets!==0&&typeof e.start=="number"&&Number.isFinite(e.start)&&e.start>=0){const s=Math.floor(e.start),d=typeof e.end=="number"&&Number.isFinite(e.end)&&e.end>=e.start?Math.floor(e.end):s+nt(c).length,h=Math.max(1,d-s),g=new Set;c&&g.add(c),se(g,c);for(const y of e.normalizedCandidates||[])se(g,y);let m=null,p=Number.POSITIVE_INFINITY;for(const y of g){if(!y)continue;const _=(await U(n,y,f))?.items||[];for(const v of _){const E=typeof v.start=="number"?v.start:0,A=Math.abs(E-s);if(A<p&&(p=A,m=v,A===0))break}if(p===0)break}if(m&&p<=Math.max(5,h))return cn(n,m),t("offset"),m}let i=await Ee(n,c,u,f);if(i)return t("nth"),i;const l=new Set;se(l,c,c);for(const s of e.normalizedCandidates||[])se(l,s,c);for(const s of l)if(i=await Ee(n,s,u,f),i)return t("normalized"),i;const a=e.token??rt(c);if(a){const s=await Ee(n,a,0,f);if(s)return t("token"),s}return null}async function Ce(e,n){try{if(!Office.context.requirements.isSetSupported("WordApi","1.4"))return!1}catch{return!1}const c=e.context;try{const u=c?.document;if(u?.comments?.add)return u.comments.add(e,n),await c?.sync?.(),{ok:!0}}catch(u){if(u?.code==="NotImplemented")return!1}try{return e.insertComment(n),await c?.sync?.(),{ok:!0}}catch(u){lastErr=u}try{await c?.sync?.();const u=c?.document;if(u?.comments?.add)return u.comments.add(e,n),await c?.sync?.(),{ok:!0}}catch(u){lastErr=u}const f=globalThis;return console.warn("safeInsertComment failed",lastErr),f.logRichError?.(lastErr,"insertComment"),f.notifyWarn?.("Failed to insert comment"),{ok:!1,err:lastErr}}async function ce(e,n){const c=e.context;try{e.load?.("parentContentControl"),await c?.sync?.()}catch{}try{const f=e.parentContentControl;if(f&&f.tag==="cai-note")return{ok:!1}}catch{}try{const f=e.insertContentControl();f.tag="cai-note",f.title="ContractAI Note";try{f.color="yellow"}catch{}return f.insertText(`CAI: ${n}`,Word.InsertLocation.end),await c?.sync?.(),{ok:!0}}catch(f){return console.warn("fallbackAnnotateWithContentControl failed",f),{ok:!1}}}function fn(e,n,c){if(!e||!n)return 0;let f=-1,u=0;for(;(f=e.indexOf(n,f+1))!==-1&&f<(c??e.length);)u++;return u}const at=new Map;function un(e){let n=at.get(e);return n||(n=Ae(e),at.set(e,n)),n}function dn(e,n,c){if(!e||!n||typeof c!="number"||!Number.isFinite(c)||c<0)return null;const f=H(n).trim();if(!f)return null;const{text:u,map:t}=un(e);if(!u)return null;const r=Math.floor(c);let o=t.length;for(let a=0;a<t.length;a++)if(t[a]>=r){o=a;break}let i=0,l=0;for(;;){const a=u.indexOf(f,l);if(a===-1||a>=o)break;i++,l=a+Math.max(f.length,1)}return i}function ot(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const $="[CAI]";function hn(e){if(!e.rule_id||!e.snippet)return console.warn("buildLegalComment: missing required fields",e),"";const n=[e.rule_id];if(e.advice&&n.push(e.advice),e.law_refs?.length&&n.push(e.law_refs.join("; ")),e.norm_quote&&n.push(`"${e.norm_quote}"`),e.clause_url||e.clause_id){const c=e.clause_id?`Clause ${e.clause_id}`:"Clause";e.clause_url?n.push(`${c}: ${e.clause_url}`):n.push(c)}return`${$} ${n.join(`
`)}`}const ke=200;function Se(e){const n=String(globalThis.__lastAnalyzed||""),c=H(n).trim(),f=Array.isArray(e)?e:[],u=Ge(f),t=u.slice().sort((a,s)=>(a.start??Number.POSITIVE_INFINITY)-(s.start??Number.POSITIVE_INFINITY)),r=[];let o=-1,i=0;for(const a of t){if(!a||!a.rule_id||!a.snippet||typeof a.start!="number"){i++;continue}const s=a.snippet,d=a.start,h=typeof a.end=="number"?a.end:d+s.length;if(d<o){i++;continue}const g=H(s).trim(),m=typeof a.nth=="number"?a.nth:dn(n,s,d),p=typeof m=="number"&&m>=0?Math.floor(m):void 0,y=typeof p=="number"?p:fn(c,g,d);if(r.push({raw:s,norm:g,occIdx:y,msg:hn(a),rule_id:a.rule_id,code:a.code,normalized_fallback:H(a.normalized_snippet||"").trim(),start:d,end:h,nth:p}),o=h,r.length>=ke)break}const l=globalThis;return i&&l.notifyWarn?.(`Skipped ${i} overlaps/invalid`),u.length>ke&&l.notifyWarn?.(`Truncated to first ${ke} findings`),l.notifyOk?.(`Will insert: ${r.length}`),r}async function it(e){const n=Se(e);return n.length?await globalThis.Word?.run?.(async f=>{const u=f.document.body,t={matchCase:!1,matchWholeWord:!1},r=[];let o=0;for(const i of n){const l=typeof i.nth=="number"?i.nth:i.occIdx;let a=null,s;if(typeof l=="number"&&Number.isFinite(l)&&l>=0){const d=[i.normalized_fallback&&i.normalized_fallback!==i.raw?i.normalized_fallback:null,i.norm&&i.norm!==i.raw?i.norm:null];try{a=await ln({body:u,snippet:i.raw,start:i.start,end:i.end,nth:l,searchOptions:t,normalizedCandidates:d,token:rt(i.raw),onMethod:h=>{s=h}})}catch(h){console.warn("anchorByOffsets failed",h)}}if(!a){const h=(await ie(u,i.raw,{nth:typeof l=="number"?l:void 0}))[0]||null;h&&(a=h,s||(s="nth"))}if(a){a.load?.(["start","end"]),await f.sync();const d=a.start??0,h=a.end??d;if(r.some(m=>Math.max(m.start,d)<Math.min(m.end,h))){console.warn("[annotate] overlapping range",{rid:i.rule_id,start:d,end:h});continue}let g=!1;if(ot())try{a.select(),g=!0}catch{}else i.msg&&((await Ce(a,i.msg)).ok?g=!0:(g=(await ce(a,i.msg.replace($,"").trim())).ok,g&&(s="cc")));g&&(r.push({start:d,end:h}),o++,s&&console.log("[annotate] anchor",{rid:i.rule_id,anchor_method:s}))}else if(console.warn("[annotate] no match for snippet",{rid:i.rule_id,snippet:i.raw.slice(0,120)}),!ot())try{const d=u.getRange?.("End")??null;d&&(await ce(d,i.msg.replace($,"").trim())).ok&&(o++,console.log("[annotate] anchor",{rid:i.rule_id,anchor_method:"cc"}))}catch(d){console.warn("[annotate] cc fallback failed",d)}await f.sync()}return o}).catch(f=>(globalThis.logRichError?.(f,"annotate"),console.warn("annotate run fail",f?.code,f?.message,f?.debugInfo),0)):0}async function gn(e,n,c){if(!e||!e.trim())return;const f=globalThis;if(!f.Word?.run){await f.navigator?.clipboard?.writeText(e).catch(()=>{}),f.alert?.("Draft copied to clipboard (Office not ready). Paste it into the document.");return}if(f.Office?.context?.document?.mode&&f.Office.context.document.mode!=="edit")throw f.alert?.("Document is read-only."),new Error("Document mode is not editable");await f.Word.run(async u=>{const t=u.document;let r=null;const o=t.trackRevisions;try{const h=f.__findings||[],g=f.__findingIdx,m=h&&typeof g=="number"?h[g]:null,p=t.body;if(r=(m?.snippet?await ie(p,m.snippet):[])[0]||null,!r){const b=t.getSelection();b.load("isEmpty"),await u.sync(),r=b.isEmpty?t.body.getRange("End"):b}}catch{const h=t.getSelection();h.load("isEmpty"),await u.sync(),r=h.isEmpty?t.body.getRange("End"):h}t.trackRevisions=!0;const i=r.insertText(e,f.Word.InsertLocation.replace),l=[`${$} Suggested clause – ${n}`],a=(c||"").split(/\r?\n/).slice(0,2).join(" "),s=f.__findings||[],d=f.__findingIdx;if(a)l.push(a);else{const h=s&&typeof d=="number"?s[d]:null,g=h?.rule_id||h?.title||"";g&&l.push(g)}l.push("schema 1.4 | model gpt-4o-mini | provider azure");try{t.comments.add(i,l.join(`
`))}catch{}await u.sync(),t.trackRevisions=o,await u.sync()}).catch(u=>{throw globalThis.logRichError?.(u,"insertDraft"),console.warn("insertDraftText error",u?.code,u?.message,u?.debugInfo),u})}function mn(){const e=globalThis,n=!!e.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),c=e.Word||{},f=!!c?.Comment,u=(()=>{try{const a=e.localStorage?.getItem?.("cai.force.comments");if(!a)return!1;const s=String(a).trim().toLowerCase();return s!=="0"&&s!=="false"&&s!=="no"}catch{return!1}})(),t=!!(n||u||f),r=u?"forced by cai.force.comments":n?"WordApi 1.4":f?"Word.Comment":"WordApi < 1.4",o=!!(n&&c?.Revision),i=!!(n&&c?.SearchOptions),l=!!(n&&c?.ContentControl);return{revisions:o,comments:t,search:i,contentControls:l,commentsReason:r}}function st(){const e=mn();try{console.log("support matrix",e)}catch{}return e}async function pn(e){const n=[];try{await Vt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(a=>{document.getElementById(a)||n.push(`missingID:${a}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||n.push("req1.4:0");const c=st(),f={revisions:c.revisions?1:0,comments:c.comments?1:0,search:c.search?1:0,contentControls:c.contentControls?1:0};let u=!1;try{u=(await Ke({backend:e})).ok,u||n.push("health")}catch{n.push("health:timeout")}const t="build-20250921-085759",r=Office?.context?.host||"Word",o=n.length===0,i=o?`Startup OK | build=${t} | host=${r} | req=1.4 | features=${JSON.stringify(f)} | backend=${e}`:`Startup FAIL: ${n.join("; ")}`;console.log(i);const l=document.getElementById("startupBadge");return l&&(l.textContent=o?"OK":"FAIL",l.setAttribute("data-status",o?"ok":"fail")),{ok:o,missing:n,features:f}}function yn(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ie={exports:{}},ct;function bn(){return ct||(ct=1,(function(e){var n=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},c=-1,f=1,u=0;n.Diff=function(t,r){return[t,r]},n.prototype.diff_main=function(t,r,o,i){typeof i>"u"&&(this.Diff_Timeout<=0?i=Number.MAX_VALUE:i=new Date().getTime()+this.Diff_Timeout*1e3);var l=i;if(t==null||r==null)throw new Error("Null input. (diff_main)");if(t==r)return t?[new n.Diff(u,t)]:[];typeof o>"u"&&(o=!0);var a=o,s=this.diff_commonPrefix(t,r),d=t.substring(0,s);t=t.substring(s),r=r.substring(s),s=this.diff_commonSuffix(t,r);var h=t.substring(t.length-s);t=t.substring(0,t.length-s),r=r.substring(0,r.length-s);var g=this.diff_compute_(t,r,a,l);return d&&g.unshift(new n.Diff(u,d)),h&&g.push(new n.Diff(u,h)),this.diff_cleanupMerge(g),g},n.prototype.diff_compute_=function(t,r,o,i){var l;if(!t)return[new n.Diff(f,r)];if(!r)return[new n.Diff(c,t)];var a=t.length>r.length?t:r,s=t.length>r.length?r:t,d=a.indexOf(s);if(d!=-1)return l=[new n.Diff(f,a.substring(0,d)),new n.Diff(u,s),new n.Diff(f,a.substring(d+s.length))],t.length>r.length&&(l[0][0]=l[2][0]=c),l;if(s.length==1)return[new n.Diff(c,t),new n.Diff(f,r)];var h=this.diff_halfMatch_(t,r);if(h){var g=h[0],m=h[1],p=h[2],y=h[3],b=h[4],_=this.diff_main(g,p,o,i),v=this.diff_main(m,y,o,i);return _.concat([new n.Diff(u,b)],v)}return o&&t.length>100&&r.length>100?this.diff_lineMode_(t,r,i):this.diff_bisect_(t,r,i)},n.prototype.diff_lineMode_=function(t,r,o){var i=this.diff_linesToChars_(t,r);t=i.chars1,r=i.chars2;var l=i.lineArray,a=this.diff_main(t,r,!1,o);this.diff_charsToLines_(a,l),this.diff_cleanupSemantic(a),a.push(new n.Diff(u,""));for(var s=0,d=0,h=0,g="",m="";s<a.length;){switch(a[s][0]){case f:h++,m+=a[s][1];break;case c:d++,g+=a[s][1];break;case u:if(d>=1&&h>=1){a.splice(s-d-h,d+h),s=s-d-h;for(var p=this.diff_main(g,m,!1,o),y=p.length-1;y>=0;y--)a.splice(s,0,p[y]);s=s+p.length}h=0,d=0,g="",m="";break}s++}return a.pop(),a},n.prototype.diff_bisect_=function(t,r,o){for(var i=t.length,l=r.length,a=Math.ceil((i+l)/2),s=a,d=2*a,h=new Array(d),g=new Array(d),m=0;m<d;m++)h[m]=-1,g[m]=-1;h[s+1]=0,g[s+1]=0;for(var p=i-l,y=p%2!=0,b=0,_=0,v=0,E=0,A=0;A<a&&!(new Date().getTime()>o);A++){for(var C=-A+b;C<=A-_;C+=2){var S=s+C,k;C==-A||C!=A&&h[S-1]<h[S+1]?k=h[S+1]:k=h[S-1]+1;for(var D=k-C;k<i&&D<l&&t.charAt(k)==r.charAt(D);)k++,D++;if(h[S]=k,k>i)_+=2;else if(D>l)b+=2;else if(y){var M=s+p-C;if(M>=0&&M<d&&g[M]!=-1){var T=i-g[M];if(k>=T)return this.diff_bisectSplit_(t,r,k,D,o)}}}for(var R=-A+v;R<=A-E;R+=2){var M=s+R,T;R==-A||R!=A&&g[M-1]<g[M+1]?T=g[M+1]:T=g[M-1]+1;for(var B=T-R;T<i&&B<l&&t.charAt(i-T-1)==r.charAt(l-B-1);)T++,B++;if(g[M]=T,T>i)E+=2;else if(B>l)v+=2;else if(!y){var S=s+p-R;if(S>=0&&S<d&&h[S]!=-1){var k=h[S],D=s+k-S;if(T=i-T,k>=T)return this.diff_bisectSplit_(t,r,k,D,o)}}}}return[new n.Diff(c,t),new n.Diff(f,r)]},n.prototype.diff_bisectSplit_=function(t,r,o,i,l){var a=t.substring(0,o),s=r.substring(0,i),d=t.substring(o),h=r.substring(i),g=this.diff_main(a,s,!1,l),m=this.diff_main(d,h,!1,l);return g.concat(m)},n.prototype.diff_linesToChars_=function(t,r){var o=[],i={};o[0]="";function l(h){for(var g="",m=0,p=-1,y=o.length;p<h.length-1;){p=h.indexOf(`
`,m),p==-1&&(p=h.length-1);var b=h.substring(m,p+1);(i.hasOwnProperty?i.hasOwnProperty(b):i[b]!==void 0)?g+=String.fromCharCode(i[b]):(y==a&&(b=h.substring(m),p=h.length),g+=String.fromCharCode(y),i[b]=y,o[y++]=b),m=p+1}return g}var a=4e4,s=l(t);a=65535;var d=l(r);return{chars1:s,chars2:d,lineArray:o}},n.prototype.diff_charsToLines_=function(t,r){for(var o=0;o<t.length;o++){for(var i=t[o][1],l=[],a=0;a<i.length;a++)l[a]=r[i.charCodeAt(a)];t[o][1]=l.join("")}},n.prototype.diff_commonPrefix=function(t,r){if(!t||!r||t.charAt(0)!=r.charAt(0))return 0;for(var o=0,i=Math.min(t.length,r.length),l=i,a=0;o<l;)t.substring(a,l)==r.substring(a,l)?(o=l,a=o):i=l,l=Math.floor((i-o)/2+o);return l},n.prototype.diff_commonSuffix=function(t,r){if(!t||!r||t.charAt(t.length-1)!=r.charAt(r.length-1))return 0;for(var o=0,i=Math.min(t.length,r.length),l=i,a=0;o<l;)t.substring(t.length-l,t.length-a)==r.substring(r.length-l,r.length-a)?(o=l,a=o):i=l,l=Math.floor((i-o)/2+o);return l},n.prototype.diff_commonOverlap_=function(t,r){var o=t.length,i=r.length;if(o==0||i==0)return 0;o>i?t=t.substring(o-i):o<i&&(r=r.substring(0,o));var l=Math.min(o,i);if(t==r)return l;for(var a=0,s=1;;){var d=t.substring(l-s),h=r.indexOf(d);if(h==-1)return a;s+=h,(h==0||t.substring(l-s)==r.substring(0,s))&&(a=s,s++)}},n.prototype.diff_halfMatch_=function(t,r){if(this.Diff_Timeout<=0)return null;var o=t.length>r.length?t:r,i=t.length>r.length?r:t;if(o.length<4||i.length*2<o.length)return null;var l=this;function a(_,v,E){for(var A=_.substring(E,E+Math.floor(_.length/4)),C=-1,S="",k,D,M,T;(C=v.indexOf(A,C+1))!=-1;){var R=l.diff_commonPrefix(_.substring(E),v.substring(C)),B=l.diff_commonSuffix(_.substring(0,E),v.substring(0,C));S.length<B+R&&(S=v.substring(C-B,C)+v.substring(C,C+R),k=_.substring(0,E-B),D=_.substring(E+R),M=v.substring(0,C-B),T=v.substring(C+R))}return S.length*2>=_.length?[k,D,M,T,S]:null}var s=a(o,i,Math.ceil(o.length/4)),d=a(o,i,Math.ceil(o.length/2)),h;if(!s&&!d)return null;d?s?h=s[4].length>d[4].length?s:d:h=d:h=s;var g,m,p,y;t.length>r.length?(g=h[0],m=h[1],p=h[2],y=h[3]):(p=h[0],y=h[1],g=h[2],m=h[3]);var b=h[4];return[g,m,p,y,b]},n.prototype.diff_cleanupSemantic=function(t){for(var r=!1,o=[],i=0,l=null,a=0,s=0,d=0,h=0,g=0;a<t.length;)t[a][0]==u?(o[i++]=a,s=h,d=g,h=0,g=0,l=t[a][1]):(t[a][0]==f?h+=t[a][1].length:g+=t[a][1].length,l&&l.length<=Math.max(s,d)&&l.length<=Math.max(h,g)&&(t.splice(o[i-1],0,new n.Diff(c,l)),t[o[i-1]+1][0]=f,i--,i--,a=i>0?o[i-1]:-1,s=0,d=0,h=0,g=0,l=null,r=!0)),a++;for(r&&this.diff_cleanupMerge(t),this.diff_cleanupSemanticLossless(t),a=1;a<t.length;){if(t[a-1][0]==c&&t[a][0]==f){var m=t[a-1][1],p=t[a][1],y=this.diff_commonOverlap_(m,p),b=this.diff_commonOverlap_(p,m);y>=b?(y>=m.length/2||y>=p.length/2)&&(t.splice(a,0,new n.Diff(u,p.substring(0,y))),t[a-1][1]=m.substring(0,m.length-y),t[a+1][1]=p.substring(y),a++):(b>=m.length/2||b>=p.length/2)&&(t.splice(a,0,new n.Diff(u,m.substring(0,b))),t[a-1][0]=f,t[a-1][1]=p.substring(0,p.length-b),t[a+1][0]=c,t[a+1][1]=m.substring(b),a++),a++}a++}},n.prototype.diff_cleanupSemanticLossless=function(t){function r(b,_){if(!b||!_)return 6;var v=b.charAt(b.length-1),E=_.charAt(0),A=v.match(n.nonAlphaNumericRegex_),C=E.match(n.nonAlphaNumericRegex_),S=A&&v.match(n.whitespaceRegex_),k=C&&E.match(n.whitespaceRegex_),D=S&&v.match(n.linebreakRegex_),M=k&&E.match(n.linebreakRegex_),T=D&&b.match(n.blanklineEndRegex_),R=M&&_.match(n.blanklineStartRegex_);return T||R?5:D||M?4:A&&!S&&k?3:S||k?2:A||C?1:0}for(var o=1;o<t.length-1;){if(t[o-1][0]==u&&t[o+1][0]==u){var i=t[o-1][1],l=t[o][1],a=t[o+1][1],s=this.diff_commonSuffix(i,l);if(s){var d=l.substring(l.length-s);i=i.substring(0,i.length-s),l=d+l.substring(0,l.length-s),a=d+a}for(var h=i,g=l,m=a,p=r(i,l)+r(l,a);l.charAt(0)===a.charAt(0);){i+=l.charAt(0),l=l.substring(1)+a.charAt(0),a=a.substring(1);var y=r(i,l)+r(l,a);y>=p&&(p=y,h=i,g=l,m=a)}t[o-1][1]!=h&&(h?t[o-1][1]=h:(t.splice(o-1,1),o--),t[o][1]=g,m?t[o+1][1]=m:(t.splice(o+1,1),o--))}o++}},n.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,n.whitespaceRegex_=/\s/,n.linebreakRegex_=/[\r\n]/,n.blanklineEndRegex_=/\n\r?\n$/,n.blanklineStartRegex_=/^\r?\n\r?\n/,n.prototype.diff_cleanupEfficiency=function(t){for(var r=!1,o=[],i=0,l=null,a=0,s=!1,d=!1,h=!1,g=!1;a<t.length;)t[a][0]==u?(t[a][1].length<this.Diff_EditCost&&(h||g)?(o[i++]=a,s=h,d=g,l=t[a][1]):(i=0,l=null),h=g=!1):(t[a][0]==c?g=!0:h=!0,l&&(s&&d&&h&&g||l.length<this.Diff_EditCost/2&&s+d+h+g==3)&&(t.splice(o[i-1],0,new n.Diff(c,l)),t[o[i-1]+1][0]=f,i--,l=null,s&&d?(h=g=!0,i=0):(i--,a=i>0?o[i-1]:-1,h=g=!1),r=!0)),a++;r&&this.diff_cleanupMerge(t)},n.prototype.diff_cleanupMerge=function(t){t.push(new n.Diff(u,""));for(var r=0,o=0,i=0,l="",a="",s;r<t.length;)switch(t[r][0]){case f:i++,a+=t[r][1],r++;break;case c:o++,l+=t[r][1],r++;break;case u:o+i>1?(o!==0&&i!==0&&(s=this.diff_commonPrefix(a,l),s!==0&&(r-o-i>0&&t[r-o-i-1][0]==u?t[r-o-i-1][1]+=a.substring(0,s):(t.splice(0,0,new n.Diff(u,a.substring(0,s))),r++),a=a.substring(s),l=l.substring(s)),s=this.diff_commonSuffix(a,l),s!==0&&(t[r][1]=a.substring(a.length-s)+t[r][1],a=a.substring(0,a.length-s),l=l.substring(0,l.length-s))),r-=o+i,t.splice(r,o+i),l.length&&(t.splice(r,0,new n.Diff(c,l)),r++),a.length&&(t.splice(r,0,new n.Diff(f,a)),r++),r++):r!==0&&t[r-1][0]==u?(t[r-1][1]+=t[r][1],t.splice(r,1)):r++,i=0,o=0,l="",a="";break}t[t.length-1][1]===""&&t.pop();var d=!1;for(r=1;r<t.length-1;)t[r-1][0]==u&&t[r+1][0]==u&&(t[r][1].substring(t[r][1].length-t[r-1][1].length)==t[r-1][1]?(t[r][1]=t[r-1][1]+t[r][1].substring(0,t[r][1].length-t[r-1][1].length),t[r+1][1]=t[r-1][1]+t[r+1][1],t.splice(r-1,1),d=!0):t[r][1].substring(0,t[r+1][1].length)==t[r+1][1]&&(t[r-1][1]+=t[r+1][1],t[r][1]=t[r][1].substring(t[r+1][1].length)+t[r+1][1],t.splice(r+1,1),d=!0)),r++;d&&this.diff_cleanupMerge(t)},n.prototype.diff_xIndex=function(t,r){var o=0,i=0,l=0,a=0,s;for(s=0;s<t.length&&(t[s][0]!==f&&(o+=t[s][1].length),t[s][0]!==c&&(i+=t[s][1].length),!(o>r));s++)l=o,a=i;return t.length!=s&&t[s][0]===c?a:a+(r-l)},n.prototype.diff_prettyHtml=function(t){for(var r=[],o=/&/g,i=/</g,l=/>/g,a=/\n/g,s=0;s<t.length;s++){var d=t[s][0],h=t[s][1],g=h.replace(o,"&amp;").replace(i,"&lt;").replace(l,"&gt;").replace(a,"&para;<br>");switch(d){case f:r[s]='<ins style="background:#e6ffe6;">'+g+"</ins>";break;case c:r[s]='<del style="background:#ffe6e6;">'+g+"</del>";break;case u:r[s]="<span>"+g+"</span>";break}}return r.join("")},n.prototype.diff_text1=function(t){for(var r=[],o=0;o<t.length;o++)t[o][0]!==f&&(r[o]=t[o][1]);return r.join("")},n.prototype.diff_text2=function(t){for(var r=[],o=0;o<t.length;o++)t[o][0]!==c&&(r[o]=t[o][1]);return r.join("")},n.prototype.diff_levenshtein=function(t){for(var r=0,o=0,i=0,l=0;l<t.length;l++){var a=t[l][0],s=t[l][1];switch(a){case f:o+=s.length;break;case c:i+=s.length;break;case u:r+=Math.max(o,i),o=0,i=0;break}}return r+=Math.max(o,i),r},n.prototype.diff_toDelta=function(t){for(var r=[],o=0;o<t.length;o++)switch(t[o][0]){case f:r[o]="+"+encodeURI(t[o][1]);break;case c:r[o]="-"+t[o][1].length;break;case u:r[o]="="+t[o][1].length;break}return r.join("	").replace(/%20/g," ")},n.prototype.diff_fromDelta=function(t,r){for(var o=[],i=0,l=0,a=r.split(/\t/g),s=0;s<a.length;s++){var d=a[s].substring(1);switch(a[s].charAt(0)){case"+":try{o[i++]=new n.Diff(f,decodeURI(d))}catch{throw new Error("Illegal escape in diff_fromDelta: "+d)}break;case"-":case"=":var h=parseInt(d,10);if(isNaN(h)||h<0)throw new Error("Invalid number in diff_fromDelta: "+d);var g=t.substring(l,l+=h);a[s].charAt(0)=="="?o[i++]=new n.Diff(u,g):o[i++]=new n.Diff(c,g);break;default:if(a[s])throw new Error("Invalid diff operation in diff_fromDelta: "+a[s])}}if(l!=t.length)throw new Error("Delta length ("+l+") does not equal source text length ("+t.length+").");return o},n.prototype.match_main=function(t,r,o){if(t==null||r==null||o==null)throw new Error("Null input. (match_main)");return o=Math.max(0,Math.min(o,t.length)),t==r?0:t.length?t.substring(o,o+r.length)==r?o:this.match_bitap_(t,r,o):-1},n.prototype.match_bitap_=function(t,r,o){if(r.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var i=this.match_alphabet_(r),l=this;function a(k,D){var M=k/r.length,T=Math.abs(o-D);return l.Match_Distance?M+T/l.Match_Distance:T?1:M}var s=this.Match_Threshold,d=t.indexOf(r,o);d!=-1&&(s=Math.min(a(0,d),s),d=t.lastIndexOf(r,o+r.length),d!=-1&&(s=Math.min(a(0,d),s)));var h=1<<r.length-1;d=-1;for(var g,m,p=r.length+t.length,y,b=0;b<r.length;b++){for(g=0,m=p;g<m;)a(b,o+m)<=s?g=m:p=m,m=Math.floor((p-g)/2+g);p=m;var _=Math.max(1,o-m+1),v=Math.min(o+m,t.length)+r.length,E=Array(v+2);E[v+1]=(1<<b)-1;for(var A=v;A>=_;A--){var C=i[t.charAt(A-1)];if(b===0?E[A]=(E[A+1]<<1|1)&C:E[A]=(E[A+1]<<1|1)&C|((y[A+1]|y[A])<<1|1)|y[A+1],E[A]&h){var S=a(b,A-1);if(S<=s)if(s=S,d=A-1,d>o)_=Math.max(1,2*o-d);else break}}if(a(b+1,o)>s)break;y=E}return d},n.prototype.match_alphabet_=function(t){for(var r={},o=0;o<t.length;o++)r[t.charAt(o)]=0;for(var o=0;o<t.length;o++)r[t.charAt(o)]|=1<<t.length-o-1;return r},n.prototype.patch_addContext_=function(t,r){if(r.length!=0){if(t.start2===null)throw Error("patch not initialized");for(var o=r.substring(t.start2,t.start2+t.length1),i=0;r.indexOf(o)!=r.lastIndexOf(o)&&o.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)i+=this.Patch_Margin,o=r.substring(t.start2-i,t.start2+t.length1+i);i+=this.Patch_Margin;var l=r.substring(t.start2-i,t.start2);l&&t.diffs.unshift(new n.Diff(u,l));var a=r.substring(t.start2+t.length1,t.start2+t.length1+i);a&&t.diffs.push(new n.Diff(u,a)),t.start1-=l.length,t.start2-=l.length,t.length1+=l.length+a.length,t.length2+=l.length+a.length}},n.prototype.patch_make=function(t,r,o){var i,l;if(typeof t=="string"&&typeof r=="string"&&typeof o>"u")i=t,l=this.diff_main(i,r,!0),l.length>2&&(this.diff_cleanupSemantic(l),this.diff_cleanupEfficiency(l));else if(t&&typeof t=="object"&&typeof r>"u"&&typeof o>"u")l=t,i=this.diff_text1(l);else if(typeof t=="string"&&r&&typeof r=="object"&&typeof o>"u")i=t,l=r;else if(typeof t=="string"&&typeof r=="string"&&o&&typeof o=="object")i=t,l=o;else throw new Error("Unknown call format to patch_make.");if(l.length===0)return[];for(var a=[],s=new n.patch_obj,d=0,h=0,g=0,m=i,p=i,y=0;y<l.length;y++){var b=l[y][0],_=l[y][1];switch(!d&&b!==u&&(s.start1=h,s.start2=g),b){case f:s.diffs[d++]=l[y],s.length2+=_.length,p=p.substring(0,g)+_+p.substring(g);break;case c:s.length1+=_.length,s.diffs[d++]=l[y],p=p.substring(0,g)+p.substring(g+_.length);break;case u:_.length<=2*this.Patch_Margin&&d&&l.length!=y+1?(s.diffs[d++]=l[y],s.length1+=_.length,s.length2+=_.length):_.length>=2*this.Patch_Margin&&d&&(this.patch_addContext_(s,m),a.push(s),s=new n.patch_obj,d=0,m=p,h=g);break}b!==f&&(h+=_.length),b!==c&&(g+=_.length)}return d&&(this.patch_addContext_(s,m),a.push(s)),a},n.prototype.patch_deepCopy=function(t){for(var r=[],o=0;o<t.length;o++){var i=t[o],l=new n.patch_obj;l.diffs=[];for(var a=0;a<i.diffs.length;a++)l.diffs[a]=new n.Diff(i.diffs[a][0],i.diffs[a][1]);l.start1=i.start1,l.start2=i.start2,l.length1=i.length1,l.length2=i.length2,r[o]=l}return r},n.prototype.patch_apply=function(t,r){if(t.length==0)return[r,[]];t=this.patch_deepCopy(t);var o=this.patch_addPadding(t);r=o+r+o,this.patch_splitMax(t);for(var i=0,l=[],a=0;a<t.length;a++){var s=t[a].start2+i,d=this.diff_text1(t[a].diffs),h,g=-1;if(d.length>this.Match_MaxBits?(h=this.match_main(r,d.substring(0,this.Match_MaxBits),s),h!=-1&&(g=this.match_main(r,d.substring(d.length-this.Match_MaxBits),s+d.length-this.Match_MaxBits),(g==-1||h>=g)&&(h=-1))):h=this.match_main(r,d,s),h==-1)l[a]=!1,i-=t[a].length2-t[a].length1;else{l[a]=!0,i=h-s;var m;if(g==-1?m=r.substring(h,h+d.length):m=r.substring(h,g+this.Match_MaxBits),d==m)r=r.substring(0,h)+this.diff_text2(t[a].diffs)+r.substring(h+d.length);else{var p=this.diff_main(d,m,!1);if(d.length>this.Match_MaxBits&&this.diff_levenshtein(p)/d.length>this.Patch_DeleteThreshold)l[a]=!1;else{this.diff_cleanupSemanticLossless(p);for(var y=0,b,_=0;_<t[a].diffs.length;_++){var v=t[a].diffs[_];v[0]!==u&&(b=this.diff_xIndex(p,y)),v[0]===f?r=r.substring(0,h+b)+v[1]+r.substring(h+b):v[0]===c&&(r=r.substring(0,h+b)+r.substring(h+this.diff_xIndex(p,y+v[1].length))),v[0]!==c&&(y+=v[1].length)}}}}}return r=r.substring(o.length,r.length-o.length),[r,l]},n.prototype.patch_addPadding=function(t){for(var r=this.Patch_Margin,o="",i=1;i<=r;i++)o+=String.fromCharCode(i);for(var i=0;i<t.length;i++)t[i].start1+=r,t[i].start2+=r;var l=t[0],a=l.diffs;if(a.length==0||a[0][0]!=u)a.unshift(new n.Diff(u,o)),l.start1-=r,l.start2-=r,l.length1+=r,l.length2+=r;else if(r>a[0][1].length){var s=r-a[0][1].length;a[0][1]=o.substring(a[0][1].length)+a[0][1],l.start1-=s,l.start2-=s,l.length1+=s,l.length2+=s}if(l=t[t.length-1],a=l.diffs,a.length==0||a[a.length-1][0]!=u)a.push(new n.Diff(u,o)),l.length1+=r,l.length2+=r;else if(r>a[a.length-1][1].length){var s=r-a[a.length-1][1].length;a[a.length-1][1]+=o.substring(0,s),l.length1+=s,l.length2+=s}return o},n.prototype.patch_splitMax=function(t){for(var r=this.Match_MaxBits,o=0;o<t.length;o++)if(!(t[o].length1<=r)){var i=t[o];t.splice(o--,1);for(var l=i.start1,a=i.start2,s="";i.diffs.length!==0;){var d=new n.patch_obj,h=!0;for(d.start1=l-s.length,d.start2=a-s.length,s!==""&&(d.length1=d.length2=s.length,d.diffs.push(new n.Diff(u,s)));i.diffs.length!==0&&d.length1<r-this.Patch_Margin;){var g=i.diffs[0][0],m=i.diffs[0][1];g===f?(d.length2+=m.length,a+=m.length,d.diffs.push(i.diffs.shift()),h=!1):g===c&&d.diffs.length==1&&d.diffs[0][0]==u&&m.length>2*r?(d.length1+=m.length,l+=m.length,h=!1,d.diffs.push(new n.Diff(g,m)),i.diffs.shift()):(m=m.substring(0,r-d.length1-this.Patch_Margin),d.length1+=m.length,l+=m.length,g===u?(d.length2+=m.length,a+=m.length):h=!1,d.diffs.push(new n.Diff(g,m)),m==i.diffs[0][1]?i.diffs.shift():i.diffs[0][1]=i.diffs[0][1].substring(m.length))}s=this.diff_text2(d.diffs),s=s.substring(s.length-this.Patch_Margin);var p=this.diff_text1(i.diffs).substring(0,this.Patch_Margin);p!==""&&(d.length1+=p.length,d.length2+=p.length,d.diffs.length!==0&&d.diffs[d.diffs.length-1][0]===u?d.diffs[d.diffs.length-1][1]+=p:d.diffs.push(new n.Diff(u,p))),h||t.splice(++o,0,d)}}},n.prototype.patch_toText=function(t){for(var r=[],o=0;o<t.length;o++)r[o]=t[o];return r.join("")},n.prototype.patch_fromText=function(t){var r=[];if(!t)return r;for(var o=t.split(`
`),i=0,l=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;i<o.length;){var a=o[i].match(l);if(!a)throw new Error("Invalid patch string: "+o[i]);var s=new n.patch_obj;for(r.push(s),s.start1=parseInt(a[1],10),a[2]===""?(s.start1--,s.length1=1):a[2]=="0"?s.length1=0:(s.start1--,s.length1=parseInt(a[2],10)),s.start2=parseInt(a[3],10),a[4]===""?(s.start2--,s.length2=1):a[4]=="0"?s.length2=0:(s.start2--,s.length2=parseInt(a[4],10)),i++;i<o.length;){var d=o[i].charAt(0);try{var h=decodeURI(o[i].substring(1))}catch{throw new Error("Illegal escape in patch_fromText: "+h)}if(d=="-")s.diffs.push(new n.Diff(c,h));else if(d=="+")s.diffs.push(new n.Diff(f,h));else if(d==" ")s.diffs.push(new n.Diff(u,h));else{if(d=="@")break;if(d!=="")throw new Error('Invalid patch mode "'+d+'" in: '+h)}i++}}return r},n.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},n.patch_obj.prototype.toString=function(){var t,r;this.length1===0?t=this.start1+",0":this.length1==1?t=this.start1+1:t=this.start1+1+","+this.length1,this.length2===0?r=this.start2+",0":this.length2==1?r=this.start2+1:r=this.start2+1+","+this.length2;for(var o=["@@ -"+t+" +"+r+` @@
`],i,l=0;l<this.diffs.length;l++){switch(this.diffs[l][0]){case f:i="+";break;case c:i="-";break;case u:i=" ";break}o[l+1]=i+encodeURI(this.diffs[l][1])+`
`}return o.join("").replace(/%20/g," ")},e.exports=n,e.exports.diff_match_patch=n,e.exports.DIFF_DELETE=c,e.exports.DIFF_INSERT=f,e.exports.DIFF_EQUAL=u})(Ie)),Ie.exports}var _n=bn();const vn=yn(_n);async function Te(){return await Word.run(async e=>{const n=e.document.body;return n.load("text"),await e.sync(),(n.text||"").trim()})}async function wn(){return await Word.run(async e=>{const n=e.document.getSelection();return n.load("text"),await e.sync(),(n.text||"").trim()})}var lt={};const Me=globalThis,De=Me.OfficeExtension,ft="build-20250921-085759";console.log("ContractAI build",ft);let ut=null,dt="1",ht="1";try{ut=localStorage.getItem("cai_timeout_ms:analyze"),dt=localStorage.getItem("cai_abort_on_hidden")||"1",ht=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:ut,abort_on_hidden:dt,abort_on_navigation:ht}),!ft.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const e=document.createElement("div");e.textContent="FATAL: stale bundle",e.style.padding="12px",e.style.color="#f66",document.body.innerHTML="",document.body.appendChild(e),document.querySelectorAll("button").forEach(n=>{n.disabled=!0})}catch{}});const gt=(()=>{const e=Me.ENV_MODE||(typeof process<"u"?lt?.ENV_MODE:void 0);return e?e==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();De&&De.config&&(gt==="dev"||Me.__ENABLE_EXTENDED_LOGS__)&&(De.config.extendedErrorLogging=!0);function X(e,n="Word"){try{const c=e&&e.debugInfo||{};console.error(`[${n}] RichApi error`,{code:e.code,message:e.message,errorLocation:c.errorLocation,statements:c.statements,traceMessages:c.traceMessages,inner:c.innerError})}catch{}}const I=globalThis;I.parseFindings=I.parseFindings||re,I.applyMetaToBadges=I.applyMetaToBadges||be,I.getApiKeyFromStore=I.getApiKeyFromStore||J,I.getSchemaFromStore=I.getSchemaFromStore||K,I.logRichError=I.logRichError||X,I.getWholeDocText=I.getWholeDocText||Te,I.getSelectionText=I.getSelectionText||wn;const mt=I.__appliedRangeHashes||new Set;I.__appliedRangeHashes=mt;let Le="live";const z={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let ee="",pt=!1,Re=!1;const An=en.required_ids||[];function w(e){const n=document.getElementById(e);if(!n)throw new Error(`missing element #${e}`);return n}const Ne="companiesHouseBlock",En="https://find-and-update.company-information.service.gov.uk/company/",Cn={match:{label:"Match",bg:"#e6f4ea",color:"#1b5e20"},mismatch:{label:"Mismatch",bg:"#fdecea",color:"#b71c1c"},ambiguous:{label:"Ambiguous",bg:"#fff4e5",color:"#e65100"},not_found:{label:"Not found",bg:"#f5f5f5",color:"#424242"},ok:{label:"OK",bg:"#e3f2fd",color:"#0d47a1"}};function kn(e){const n=document.createElement("span"),c=Cn[e],f=c?.label||e.toUpperCase();return n.textContent=f,n.style.display="inline-block",n.style.padding="2px 6px",n.style.marginRight="8px",n.style.borderRadius="4px",n.style.fontSize="12px",n.style.fontWeight="bold",c&&(n.style.backgroundColor=c.bg,n.style.color=c.color),n}function P(e,n,c){const f=c?.trim();if(!f)return;const u=document.createElement("li");u.textContent=`${n}: ${f}`,e.appendChild(u)}function yt(e,n,c){!Array.isArray(c)||!c.length||P(e,n,c.join(", "))}function Sn(e,n,c){const f=c.filter(r=>r.href);if(!f.length)return;const u=document.createElement("li"),t=document.createElement("span");t.textContent=`${n}: `,u.appendChild(t),f.forEach((r,o)=>{if(o>0){const l=document.createElement("span");l.textContent=" | ",u.appendChild(l)}const i=document.createElement("a");i.href=r.href,i.textContent=r.label,i.target="_blank",u.appendChild(i)}),e.appendChild(u)}function j(e){return(e||"").trim()}function In(e,n,c){const f=j(e.number_or_duns).toLowerCase();if(f){const t=n.find(r=>{if(c.has(r))return!1;const o=j(r.from_document?.number).toLowerCase(),i=j(r.matched?.company_number).toLowerCase();return o===f||i===f});if(t)return t}const u=j(e.name).toLowerCase();if(u)return n.find(t=>{if(c.has(t))return!1;const r=j(t.from_document?.name).toLowerCase(),o=j(t.matched?.company_name).toLowerCase();return r&&r===u||o&&o===u})}function Tn(e){let n=document.getElementById(Ne);if(!n){if(typeof e.appendChild!="function")return null;n=document.createElement("div"),n.id=Ne,e.appendChild(n)}return n}function Mn(e,n){const c=Array.isArray(e)?e.filter(Boolean):[],f=Array.isArray(n)?n.filter(Boolean):[],u=document.getElementById(Ne);if(!c.length&&!f.length){u&&(u.parentElement&&typeof u.parentElement.removeChild=="function"?u.parentElement.removeChild(u):typeof u.remove=="function"&&u.remove());return}const t=w("resultsBlock"),r=Tn(t);if(!r)return;r.innerHTML="";const o=document.createElement("h3");o.textContent="Companies House",r.appendChild(o);const i=new Set,l=[];if(c.forEach(a=>{const s=In(a,f,i);s&&i.add(s),l.push({registry:a,meta:s})}),f.forEach(a=>{i.has(a)||l.push({meta:a})}),!l.length){const a=document.createElement("p");a.textContent="No Companies House data available.",r.appendChild(a);return}l.forEach(({registry:a,meta:s})=>{const d=document.createElement("div");r.appendChild(d);const h=document.createElement("div");s?.verdict&&h.appendChild(kn(s.verdict));const g=document.createElement("strong");if(g.textContent=j(a?.name||s?.from_document?.name||s?.matched?.company_name||"Company"),h.appendChild(g),d.appendChild(h),a?.number_or_duns||a?.status||a?.address||a?.sic_codes?.length||a?.incorp_date||s?.from_document?.number){const p=document.createElement("div");p.textContent="Document",d.appendChild(p);const y=document.createElement("ul");P(y,"Number",a?.number_or_duns||s?.from_document?.number),P(y,"Status",a?.status),P(y,"Address",a?.address),P(y,"Incorporated",a?.incorp_date),yt(y,"SIC",a?.sic_codes),d.appendChild(y)}if(s){const p=document.createElement("div");p.textContent="Companies House",d.appendChild(p);const y=document.createElement("ul"),b=s.matched?.company_number||s.from_document?.number;P(y,"Company number",b),P(y,"Status",s.matched?.company_status),P(y,"Address",s.matched?.address_snippet),yt(y,"SIC",s.matched?.sic_codes);const _=[];b&&_.push({label:"Profile",href:`${En}${b}`}),s.matched?.links?.self&&_.push({label:"Self",href:s.matched.links.self}),s.matched?.links?.officers&&_.push({label:"Officers",href:s.matched.links.officers}),s.matched?.links?.filing_history&&_.push({label:"Filings",href:s.matched.links.filing_history}),Sn(y,"Links",_),d.appendChild(y)}})}function Dn(e){const n=(e??"").trim();if(!n)return null;const c=`${Fe()}/api/trace/${n}`,f=`/api/trace/${n}`;return{href:c,label:f}}function bt(e){try{if(typeof document>"u")return}catch{return}const n=document.getElementById("resultsBlock");if(!n)return;const c=n.querySelector(".muted");if(!c)return;let f=c.querySelector('[data-role="trace-link"]');f||(f=document.createElement("span"),f.dataset.role="trace-link",f.style.marginLeft="8px",c.appendChild(f));const u=Dn(e);if(!u){f.textContent="",f.style.display="none";return}f.textContent="",f.style.display="";const t=document.createElement("span");t.textContent=" · ",f.appendChild(t);const r=document.createElement("a");r.href=u.href,r.target="_blank",r.rel="noreferrer noopener",r.textContent=u.label,f.appendChild(r)}function Oe(e,n){const c=w("status-chip"),f=(e??K())||"—",u=(n??ee)?.trim()||"",t=u||"—";c.textContent=`schema: ${f} | cid: ${t}`,bt(u)}function _t(){const e=w("anchorsBadge"),n=globalThis.__anchorsSkipped||0;e.style.display=n>0?"":"none"}I.updateAnchorBadge=I.updateAnchorBadge||_t;function Ln(){if(pt)return;N("#btnAnalyze",Gn);const e=w("btnAnalyze");e.disabled=!1,pt=!0,console.log("[PANEL] analyze enabled")}function Fe(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://127.0.0.1:9443").replace(/\/+$/,"")}catch{return"https://127.0.0.1:9443"}}function Rn(){const n=w("backendUrl").value.trim();if(n)try{localStorage.setItem("backend.url",n),localStorage.setItem("backendUrl",n)}catch{}location.reload()}function $e(){let e=J(),n=K();const c=w("hdrWarn"),u=(globalThis?.location?.hostname??"")==="127.0.0.1";if(u&&(e||(e="local-test-key-123",je(e)),!n)){const t=globalThis?.SCHEMA_VERSION||typeof process<"u"&&lt?.SCHEMA_VERSION||"1.4";n=String(t),Q(n)}return!e&&!n&&!u?c.style.display="":c.style.display="none",(!e||!n)&&console.warn("missing headers",{apiKey:!!e,schema:!!n}),!0}function x(e,n){const c=document.querySelector(`[data-role="${n}"]`);return c||w(e)}function le(){try{const n=w("selectRiskThreshold").value.toLowerCase();return n==="low"||n==="medium"||n==="high"||n==="critical"?n:"medium"}catch{return"medium"}}function vt(){const e=Nt();try{const n=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();return n.checked=e,!!n.checked}catch{return e}}function Nn(e){Ot(e)}function Be(e,n){if(!Array.isArray(e))return[];const c=oe(n);return e.filter(f=>f?oe(f.severity)>=c:!1)}I.annotateFindingsIntoWord=I.annotateFindingsIntoWord||it;async function On(){try{await Word.run(async e=>{const n=e.document.body,c=e.document.comments,f=typeof n.search=="function"?n.search($,{matchCase:!1}):null;if(c&&typeof c.load=="function"&&c.load("items"),f&&typeof f.load=="function"&&f.load("items"),await e.sync(),c?.items)for(const u of c.items)try{(u.text||"").startsWith($)&&u.delete()}catch{}if(f?.items&&f.items.length)for(const u of f.items)try{u.insertText("",Word.InsertLocation.replace)}catch{}try{n.font.highlightColor="NoColor"}catch{}await e.sync()}),q("Annotations cleared")}catch(e){X(e,"annotate"),L("Failed to clear annotations")}}function Fn(e,n){const c=new vn,f=i=>i.match(/\S+|\s+/g)||[],{chars1:u,chars2:t,tokenArray:r}=$n(f(e),f(n));let o=c.diff_main(u,t);return c.diff_cleanupSemantic(o),o.map(([i,l])=>[i,l.split("").map(a=>r[a.charCodeAt(0)]).join("")])}function $n(e,n){const c=[],f=new Map,u=o=>f.has(o)?String.fromCharCode(f.get(o)):(c.push(o),f.set(o,c.length-1),String.fromCharCode(c.length-1)),t=e.map(u).join(""),r=n.map(u).join("");return{chars1:t,chars2:r,tokenArray:c}}async function wt(e){return G(async()=>{let n=(e||[]).filter(u=>typeof u.start=="number"&&typeof u.end=="number"&&u.end>u.start).sort((u,t)=>u.start-t.start),c=-1;if(n=n.filter(u=>u.start<c?!1:(c=u.end,!0)),!n.length)return;const f=window.__lastAnalyzed||"";await Word.run(async u=>{const t=u.document.body;u.document.trackRevisions=!0;const r={matchCase:!1,matchWholeWord:!1},o=(i,l)=>{const a=i?.items||[];return a.length&&a[Math.min(Math.max(l,0),a.length-1)]||null};for(const i of n){const l=`${i.start}:${i.end}:${i.replacement}`;if(mt.has(l))continue;const a=f.slice(i.start,i.end),s=(()=>{let h=-1,g=0;for(;(h=f.indexOf(a,h+1))!==-1&&h<i.start;)g++;return g})();let d=null;if(i.context_before||i.context_after){const h=`${i.context_before||""}${a}${i.context_after||""}`,g=await U(t,h,r),m=o(g,s);if(m){const p=a.slice(0,240),y=a.slice(-240),b=m.search(p,r),_=m.search(y,r);b&&typeof b.load=="function"&&b.load("items"),_&&typeof _.load=="function"&&_.load("items"),await u.sync();const v=o(b,0),E=o(_,0);v&&E&&typeof v.expandTo=="function"?d=v.expandTo(E):d=v}}if(!d){const h=await U(t,a,r);d=o(h,s)}if(!d){const h=(()=>{const g=a.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(m=>m.length>=12);return g.length?g.sort((m,p)=>p.length-m.length)[0].slice(0,64):null})();if(h){const g=await U(t,h,r);d=o(g,0)}}if(d){const h=Fn(a,i.replacement);let g=d.getRange("Start");for(const[y,b]of h)if(b)if(y===0){const v=g.getRange("After").search(b,r);v&&typeof v.load=="function"&&v.load("items"),await u.sync();const E=o(v,0);E&&(g=E.getRange("After"))}else if(y===-1){const v=g.getRange("After").search(b,r);v&&typeof v.load=="function"&&v.load("items"),await u.sync();const E=o(v,0);E&&(E.insertText("","Replace"),g=E.getRange("After"))}else y===1&&(g=g.insertText(b,"Before").getRange("After"));const m=`${$} ${i.rationale||i.source||"AI edit"}`;(await Ce(d,m)).ok||await ce(d,m.replace($,"").trim())}else console.warn("[applyOpsTracked] match not found",{snippet:a,occIdx:s});await u.sync()}})})}I.applyOpsTracked=I.applyOpsTracked||wt;function At(e,n){if(n.__highlight){try{n.__highlight.font.highlightColor="NoColor"}catch{}e.trackedObjects.remove(n.__highlight),n.__highlight=null}}async function Et(){const e=window;e.__highlight&&await Word.run(async n=>{At(n,e),await n.sync()})}async function ze(e){await Word.run(async n=>{const c=window;At(n,c);const f=n.document.body;let u=await ie(f,e.raw),t=u[Math.min(e.occIdx,u.length-1)]||null;if(!t&&e.normalized_fallback&&e.normalized_fallback!==e.norm&&(u=await ie(f,e.normalized_fallback),t=u[Math.min(e.occIdx,u.length-1)]||null),t){c.__highlight=t,n.trackedObjects.add(t);try{t.select()}catch{}try{t.font.highlightColor="#ffff00"}catch{}}await n.sync()})}let Pe=!1;async function Ct(e){if(Pe)return;Pe=!0;const n=window.__findings||[];if(!n.length){Pe=!1;return}const c=w("btnPrevIssue"),f=w("btnNextIssue");c.disabled=!0,f.disabled=!0;const u=window;u.__findingIdx=(u.__findingIdx??0)+e,u.__findingIdx<0&&(u.__findingIdx=n.length-1),u.__findingIdx>=n.length&&(u.__findingIdx=0);const t=w("findingsList"),r=Array.from(t.querySelectorAll("li"));r.forEach((i,l)=>{i.classList.toggle("active",l===u.__findingIdx)});const o=r[u.__findingIdx];o&&o.scrollIntoView({block:"nearest"});try{await ze(n[u.__findingIdx])}catch{}}function Bn(e){const n=window.__findings||[];if(!n.length)return;const c=n.findIndex(r=>r.rule_id===e||r.code===e);if(c<0)return;window.__findingIdx=c;const f=w("findingsList"),u=Array.from(f.querySelectorAll("li"));u.forEach((r,o)=>{r.classList.toggle("active",o===c)});const t=u[c];t&&t.scrollIntoView({block:"nearest"});try{ze(n[c])}catch{}}async function zn(){await Ct(-1)}async function Pn(){await Ct(1)}function fe(e){Et().catch(()=>{});const n=e?.summary?.clause_type||e?.meta?.clause_type||e?.doc_type||"—",c=Array.isArray(e?.findings)?e.findings:[],f=Array.isArray(e?.recommendations)?e.recommendations:[],u=Array.isArray(e?.summary?.parties)?e.summary.parties.map(p=>p?.registry).filter(p=>!!p):[],t=Array.isArray(e?.meta?.companies_meta)?e.meta.companies_meta.filter(p=>!!p):[],r=le(),o=Be(c,r),i=o.length,l=c.length-i,a=(p,y)=>{w(p).textContent=y};a("clauseTypeOut",String(n)),a("resFindingsCount",String(c.length)),a("visibleHiddenOut",`${i} / ${l}`);const s=w("findingsBlock"),d=w("findingsList");d.innerHTML="",o.forEach((p,y)=>{const b=document.createElement("li"),_=p?.title||p?.finding?.title||p?.rule_id||"Issue",v=p?.snippet||p?.evidence?.text||"";b.textContent=v?`${_}: ${v}`:String(_),b.addEventListener("click",()=>{Array.from(d.querySelectorAll("li")).forEach((C,S)=>{C.classList.toggle("active",S===y)}),window.__findingIdx=y,ze(p).catch(()=>{})});const E=Array.isArray(p.links)?p.links.filter(A=>A?.type==="conflict"&&A?.targetFindingId):[];if(E.length){const A=document.createElement("div");A.textContent=`Conflicts: ${E.length} `,E.forEach((C,S)=>{const k=document.createElement("a");k.href="#",k.textContent="Jump to",k.addEventListener("click",D=>{D.preventDefault(),Bn(C.targetFindingId)}),A.appendChild(k),S<E.length-1&&A.append(" ")}),b.appendChild(A)}d.appendChild(b)}),s.style.display=o.length?"":"none";const h=document.getElementById("recommendationsBlock"),g=document.getElementById("recommendationsList");if(g){g.innerHTML="";for(const p of f){const y=document.createElement("li");y.textContent=p?.text||p?.advice||p?.message||"Recommendation",g.appendChild(y)}}h&&(h.style.display=f.length?"":"none"),w("resultsBlock").style.removeProperty("display"),Mn(u,t)}function ue(e){const n=x("resClauseType","clause-type");n.textContent=e?.clause_type||"—";const c=re(e);window.__findings=c,window.__findingIdx=0;const f=x("findingsList","findings");f&&(f.innerHTML="",c.forEach(s=>{const d=document.createElement("li");d.textContent=typeof s=="string"?s:JSON.stringify(s),f.appendChild(d)}));const u=w("findingsBlock");u.style.display=c.length?"":"none";const t=Array.isArray(e?.recommendations)?e.recommendations:[],r=x("recommendationsList","recommendations");r&&(r.innerHTML="",t.forEach(s=>{const d=document.createElement("li");d.textContent=typeof s=="string"?s:JSON.stringify(s),r.appendChild(d)}));const o=w("recommendationsBlock");o.style.display=t.length?"":"none";const i=x("resFindingsCount","findings-count");i.textContent=String(c.length);const l=e?.meta?.cid??e?.cid??null;bt(l??ee);const a=x("rawJson","raw-json");a.textContent=JSON.stringify(e??{},null,2)}function Wn(e){const n=window.__findings||[],c=re(e),f=Ge([...n,...c]);return{...e||{},findings:f}}function Hn(){const e=x("toggleRaw","toggle-raw-json"),n=x("rawJson","raw-json");n.style.display="none",e.addEventListener("click",()=>{n.style.display=n.style.display==="none"?"block":"none"})}function kt(e){const n=w("connBadge");n.textContent=`Conn: ${e===null?"—":e?"✓":"×"}`}function We(e){const n=w("officeBadge");n.textContent=`Office: ${e??"—"}`}async function Un(){await Word.run(async e=>{const n=["Heading 1","Heading 2","Heading 3"];for(let c=0;c<n.length;c++){const f=e.document.body.paragraphs.getByStyle(n[c]);f.load("items"),await e.sync();for(const u of f.items)try{u.listFormat.removeNumbers(),u.listFormat.applyNumberedDefault(),u.listItem&&(u.listItem.level=c);const t=36*(c+1);u.paragraphFormat.leftIndent=t,u.paragraphFormat.firstLineIndent=-36,u.paragraphFormat.lineSpacing=240}catch(t){console.warn("fixNumbering",t)}}await e.sync()}).catch(e=>X(e,"fixNumbering"))}function W(e){return document.querySelector(e)}function jn(){return(W(z.original)?.value||"").trim()}async function xn(){let e=jn();if(e.length>=20)return e;try{if(e=(await globalThis.getSelectionText()||"").trim(),e.length>=20){const n=W(z.original);if(n){n.value=e;try{n.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return e}}catch{}return L("Please paste the original clause (min 20 chars) or select text in the document."),null}function Kn(){try{return globalThis.detectContractType?.()||"unknown"}catch{return"unknown"}}function Vn(){try{const e=window.__findings||[];return Array.isArray(e)?e:[]}catch{return[]}}function qn(){try{return window.getSelectionOffsets?.()||null}catch{return null}}async function Yn(e){const n=await xn();if(!n)return;const c={mode:e,clause_id:ee||void 0,text:n,context:{law:"UK",language:"en-GB",contractType:Kn()},findings:Vn().slice(0,10),selection:qn()};let f;try{f=await fetch("/api/gpt/draft",{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":J()||"","X-Schema-Version":"1.4"},body:JSON.stringify(c)})}catch(i){console.warn("Draft error",i),L("Draft error");return}if(!f.ok){const i=await f.text();console.warn(`Draft failed: ${f.status} ${i}`);return}const u=await f.json(),t=(u?.draft_text||"").toString(),r=W(z.proposed),o=window;if(o.__last=o.__last||{},o.__last["gpt-draft"]={json:u},r){r.id||(r.id="draftText"),r.name||(r.name="proposed"),r.dataset.role="proposed-text",r.value=t,r.dispatchEvent(new Event("input",{bubbles:!0})),q("Draft ready");try{await gn(t,Le,u?.meta?.rationale)}catch{}te(t)}else L("Proposed textarea not found"),te("")}async function Jn(){const e=W(z.original),n=await Te(),c=ae(n||"");if(e){e.value=c;try{e.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const f=w("originalText");if(f!==e){f.value=c;try{f.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=c,window.toast?.("Whole doc loaded")}async function Qn(e){return G(()=>Yn(Le==="friendly"?"friendly":"strict"))}async function St(){try{const e=K(),{resp:n,json:c,ok:f}=await Ke({backend:Fe()}),u=n.headers.get("x-schema-version")||c?.schema||null;if(u&&(Q(u),u!==e&&console.log(`schema: ${u} (synced)`)),kt(f),f){console.log("[PANEL] health ok"),Ln(),Oe(u,null);try{be({cid:null,xcache:null,latencyMs:null,schema:u||null,provider:c?.provider||null,model:c?.model||null,llm_mode:null,usage:null,status:c?.status||null})}catch{}q(`Health: ${c?.status||"ok"}${u?` (schema ${u})`:""}`)}else L("Health failed")}catch(e){kt(!1),L("Health failed"),console.error(e)}}async function Zn(){const e=w("originalText");let n=ae(e.value||"");if(!n){const c=w("btnAnalyze");c.disabled=!0;try{n=ae(await globalThis.getWholeDocText()),e.value=n||""}catch{n=""}finally{c.disabled=!1}}return n?(window.__lastAnalyzed=n,n):(L("Document is empty"),null)}async function Gn(){if(Re){console.log("[PANEL] analyze in progress - ignoring click");return}for(const e of Z)if(e.__key==="/api/analyze"){console.log("[PANEL] pending /api/analyze fetch - ignoring click");return}Re=!0;try{if(!await Zn())return;await Xn()}finally{Re=!1}}async function Xn(){return G(async()=>{const e=w("btnAnalyze"),n=w("busyBar");e.disabled=!0,n.style.display="";try{te("");const c=window.__lastAnalyzed;if(!c){qe("В документе нет текста");return}$e();const{resp:f,json:u}=await Gt({text:c,mode:Le,risk:le()});if(!f.ok)throw new Error(`HTTP ${f.status}`);const t=f.headers.get("x-schema-version");t&&Q(t),u?.schema&&Q(u.schema),ee=f.headers.get("x-cid")||"",Oe(null,ee),ue(u),fe(u);try{localStorage.setItem("last_analysis_json",JSON.stringify(u))}catch{}try{const r=globalThis.parseFindings(u),o=le(),i=Be(r,o),l=Se(i);window.__findings=l,window.__findingIdx=0;const a=w("findingsList"),s=document.createDocumentFragment();l.forEach((d,h)=>{const g=document.createElement("li");g.textContent=`${d.rule_id}: ${d.raw}`,h===0&&g.classList.add("active"),s.appendChild(g)}),a.innerHTML="",a.appendChild(s),vt()&&i.length&&await it(i)}catch(r){console.warn("auto-annotate after analyze failed",r)}w("results").dispatchEvent(new CustomEvent("ca.results",{detail:u})),q("Analyze OK")}catch(c){let f="";if(c?.name==="AbortError"){const u=c?.message||"";if(u.startsWith("timeout")){const t=parseInt(u.replace(/[^0-9]/g,""),10)||0;f=`(timeout ${Math.round(t/1e3)} s)`}else u==="pagehide/unload"?f="(aborted by pagehide)":f="(aborted)"}else typeof c?.message=="string"&&(c.message.includes("HTTP 504")?f="(HTTP 504)":c.message.includes("HTTP 413")?f="(payload too large 413)":c.message.includes("HTTP 401")?f="(unauthorized 401)":c.message.includes("HTTP 403")?f="(forbidden 403)":c.message.includes("HTTP 422")&&(f="(schema mismatch 422)"));L(`Analyze failed ${f}`.trim()),console.error(c)}finally{e.disabled=!1,n.style.display="none"}})}async function er(){return G(async()=>{await Et(),$e();const e=window.__docId,n=le(),c={rules:{},risk:n};if(e)c.document_id=e;else{const t=await Te();window.__lastAnalyzed=t,c.text=t}const{json:f}=await postJSON("/api/qa-recheck",c);if(w("results").dispatchEvent(new CustomEvent("ca.qa",{detail:f})),!f?.error){const t=window.__findings||[],r=window.__findingIdx??0,o=y=>y?.code||y?.rule_id||`${y?.rule_id}|${y?.raw||y?.snippet||""}`,i=t[r]?o(t[r]):null,l=re(f),a=Be(l,n),s=Se(a),d=new Map;s.forEach(y=>{const b=o(y);b&&!d.has(b)&&d.set(b,y)});const h=Array.from(d.values());window.__findings=h;let g=0;if(i){const y=h.findIndex(b=>o(b)===i);y>=0&&(g=y)}g>=h.length&&(g=0),window.__findingIdx=g;const m=w("findingsList"),p=document.createDocumentFragment();h.forEach((y,b)=>{const _=document.createElement("li");_.textContent=`${y.rule_id}: ${y.raw}`,b===g&&_.classList.add("active"),p.appendChild(_)}),m.innerHTML="",m.appendChild(p),q("QA recheck OK")}else{const t=f?.error||f?.message||"unknown";qe(`QA recheck failed: ${t}`)}})}function N(e,n){const c=document.querySelector(e);c&&(c.addEventListener("click",f=>{f.preventDefault(),n()}),c.classList.remove("js-disable-while-busy"),c.removeAttribute("disabled"))}async function tr(){try{const e=window.__lastAnalyzed||"",n=(W(z.proposed)?.value||"").trim();if(!n){L("No draft to diff");return}const c=await Xt(e,n),f=c?.json?.html||c?.json?.diff_html||c?.json?.redlines||"",u=w("diffOutput"),t=w("diffContainer");u.innerHTML=f||"",t.style.display=f?"block":"none"}catch(e){L("Diff failed"),console.error(e)}}async function nr(){try{const e=window.__last||{},n=e["gpt-draft"]?.json?.ops||e.suggest?.json?.ops||[];if(!n.length){L("No ops to apply");return}await wt(n),q("Applied ops")}catch(e){L("Insert failed"),console.error(e)}}async function rr(){try{const n=(W(z.proposed)?.value||"").trim();if(!n){window.toast?.("Nothing to accept");return}const c=(w("cid").textContent||"").trim(),f=(()=>{try{return(localStorage.getItem("backendUrl")||"https://127.0.0.1:9443").replace(/\/+$/,"")}catch{return"https://127.0.0.1:9443"}})(),u=c&&c!=="—"?`${f}/api/trace/${c}`:"AI draft";await Word.run(async t=>{const r=t.document.getSelection();t.document.trackRevisions=!0,r.insertText(n,Word.InsertLocation.replace),(await Ce(r,`${$} ${u}`)).ok||await ce(r,u),await t.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(e){window.toast?.("Accept failed"),X(e,"insertDraft"),console.error(e)}}async function ar(){try{const e=W(z.proposed);e&&(e.value="",e.dispatchEvent(new Event("input",{bubbles:!0})),te("")),await Word.run(async n=>{const f=n.document.getSelection().revisions;f.load("items"),await n.sync(),(f.items||[]).forEach(u=>{try{u.reject()}catch{}}),await n.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(e){window.toast?.("Reject failed"),X(e,"insertDraft"),console.error(e)}}function It(){if(console.log("[PANEL] wireUI start"),globalThis.__CAI_TESTING__){console.log("[PANEL] wireUI (__CAI_TESTING__ mode)");return}const e=An.filter(s=>{try{return w(s),!1}catch{return!0}});if(e.length){console.error("[PANEL] wireUI missing IDs:",e);const s=`FATAL: panel template mismatch (missing: ${e.join(", ")}). Check build pipeline.`;try{const d=document.createElement?document.createElement("div"):null;d&&(d.textContent=s,d.style.padding="12px",d.style.color="#f66",document.body.innerHTML="",document.body.appendChild(d))}catch{}console.error(s);return}const n=w("loading-book");window.addEventListener("cai:busy",s=>{!!s?.detail?.busy?n.classList.remove("hidden"):n.classList.add("hidden")});const c=st(),f=(s,d)=>{const h=w(s);if(h.disabled=!0,h.title=d?`Not supported: ${d}`:"Not supported",d)try{console.log(`disabled ${s}: ${d}`)}catch{}};N("#btnUseWholeDoc",Jn);const u=w("btnUseWholeDoc");if(u.disabled=!1,N("#btnFixNumbering",Un),gt==="dev")N("#btnTest",St);else{const s=w("btnTest");s.style.display="none"}N("#btnQARecheck",er);const t=w("btnSuggestEdit"),r=W(z.original),o=()=>{t.disabled=!(r&&r.value.trim())};r?.addEventListener("input",o);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const s=await globalThis.getSelectionText();if(s&&r){r.value=s;try{r.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}o(),t.addEventListener("click",Qn),N("#btnApplyTracked",nr),N("#btnAcceptAll",rr),N("#btnRejectAll",ar),N("#btnPrevIssue",zn),N("#btnNextIssue",Pn),N("#btnPreviewDiff",tr),N("#btnClearAnnots",On),N("#btnSave",Rn);const i=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();i.checked=vt(),i.addEventListener("change",()=>Nn(!!i.checked));const l=w("btnAnnotate");l.addEventListener("click",async()=>{if(!l.disabled){l.disabled=!0;try{const s=window.__last?.analyze?.json||{},d=globalThis.parseFindings(s);try{await globalThis.annotateFindingsIntoWord(d)}catch(h){const g=h?.code||h?.name||"";g==="SearchStringInvalidOrTooLong"||g==="InvalidOrTooLong"||g==="InvalidArgument"?(globalThis.toast2?.("Search failed (long text), skipping some anchors","warn"),console.warn("[annotate run] search error",g)):console.warn("[annotate run] error",h)}}finally{l.disabled=!1}}}),l.classList.remove("js-disable-while-busy"),l.removeAttribute("disabled"),w("results").addEventListener("ca.qa",s=>{const d=s?.detail;try{if(!d||d.error){ue(d||{}),fe(d||{});return}const h=Wn(d);ue(h),fe(h)}catch(h){console.warn("ca.qa handler failed",h),ue(d||{}),fe(d||{})}}),te(""),Hn(),console.log("Panel UI wired [OK]");const a=w("btnAnalyze");if(a.disabled=!0,$e(),Oe(),_t(),c.revisions||(f("btnApplyTracked","revisions"),f("btnAcceptAll","revisions"),f("btnRejectAll","revisions")),c.comments||(f("btnAnnotate","comments"),f("btnAcceptAll",c.commentsReason),L("Comments API not available in this Word build")),c.search||(f("btnPrevIssue","search"),f("btnNextIssue","search"),f("btnQARecheck","search")),c.contentControls||f("btnAnnotate","contentControls"),!c.revisions||!c.comments||!c.search||!c.contentControls)try{We("Word ⚠")}catch{}}I.wireUI=I.wireUI||It;function te(e){const n=!!e.trim(),c=w("btnApplyTracked"),f=w("btnAcceptAll"),u=w("btnRejectAll"),t=w("btnPreviewDiff"),r=w("draftPane"),o=w("draftText");o.value=e,r.style.display=n?"":"none",c.disabled=!n,f.disabled=!n,u.disabled=!n,t.disabled=!n}async function or(e){console.log("[PANEL] bootstrap start"),Ut()&&(console.log("reopen clean OK"),jt()),It(),Ht();try{await pn(Fe())}catch{}try{await St()}catch{}try{We(`${e?.host||Office.context?.host||"Word"} ✓`)}catch{We(null)}}let He=!1,Tt=!1,Mt,Dt=!1,Lt=0;function Ue(){if(Dt){console.log(`bootstrap invoked x${Lt+1}`);return}He&&Tt&&(Dt=!0,Lt++,console.log("bootstrap invoked x1"),or(Mt))}globalThis.__CAI_TESTING__||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{He=!0,Ue()}):(He=!0,Ue()),Office.onReady(e=>{Tt=!0,Mt=e,Ue()}))})();
