(function(){"use strict";var q=typeof document<"u"?document.currentScript:null;const J="",V="1.4",O="cai-comment-on-analyze";function xt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",J),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",V),localStorage.getItem(O)===null&&localStorage.setItem(O,"1")}catch{}}xt();function D(){try{return localStorage.getItem("api_key")||J}catch{return J}}function ot(t){try{localStorage.setItem("api_key",t)}catch{}}function x(){try{return localStorage.getItem("schema_version")||V}catch{return V}}function R(t){try{localStorage.setItem("schema_version",t)}catch{}}function Bt(){try{const t=localStorage.getItem(O);return t===null?(localStorage.setItem(O,"1"),!0):t!=="0"}catch{return!0}}function Lt(t){try{localStorage.setItem(O,t?"1":"0")}catch{}}const I=typeof globalThis<"u"?globalThis:window;I.CAI=I.CAI||{},I.CAI.Store=I.CAI.Store||{},I.CAI.Store.setApiKey=ot,I.CAI.Store.setSchemaVersion=R,I.CAI.Store.get=()=>({apiKey:D(),schemaVersion:x()}),I.CAI.Store.DEFAULT_BASE=I.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const E=window;E.__cai_pending_fetches=E.__cai_pending_fetches||new Set,E.__cai_pending_timers=E.__cai_pending_timers||new Set;const W=E.__cai_pending_fetches,U=E.__cai_pending_timers,B={count:0};function $t(){B.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:B.count}}))}function Ot(){B.count=Math.max(0,B.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:B.count>0,count:B.count}}))}async function L(t){try{return $t(),await t()}finally{Ot()}}function Rt(t){W.add(t)}function Nt(t){W.delete(t)}function zt(t){U.add(t)}function Ft(t){U.delete(t)}function st(t){W.forEach(e=>{try{e.abort(t)}catch{}}),W.clear(),U.forEach(e=>{try{clearTimeout(e),clearInterval(e)}catch{}}),U.clear();try{document.querySelectorAll(".progress").forEach(e=>{e.style.display="none"})}catch{}}function Mt(){if(E.__pendingUnloadReg)return;E.__pendingUnloadReg=!0;const t=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),e=()=>{t&&st("pagehide/unload"),E.__wasUnloaded=!0};window.addEventListener("pagehide",e),window.addEventListener("unload",e),window.addEventListener("beforeunload",e),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&st("visibilitychange")})}function at(){return!!E.__wasUnloaded}function Dt(){E.__wasUnloaded=!1}let Y=null;async function ct(t={}){if(!Y){const e=(t.backend||"").replace(/\/+$/,""),n=e?`${e}/health`:"/health",o=new AbortController,s=t.timeoutMs??9e3,c=setTimeout(()=>o.abort("timeout"),s);Y=fetch(n,{signal:o.signal}).then(async l=>{clearTimeout(c);const d=await l.json().catch(()=>({}));return{ok:l.ok,json:d,resp:l}})}return Y}function it(t){const e=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(e)?e.filter(Boolean):[]}window.parseFindings=it;function rt(t){const e=(n,o)=>{const s=document.getElementById(n);s&&(s.textContent=o&&o.length?o:"—")};e("status",t.status),e("cid",t.cid),e("xcache",t.xcache),e("latency",t.latencyMs),e("schema",t.schema),e("provider",t.provider),e("model",t.model),e("mode",t.llm_mode),e("usage",t.usage)}async function Wt(){const t=new URL(q&&q.tagName.toUpperCase()==="SCRIPT"&&q.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const n=await(await fetch(t)).text(),o=new TextEncoder().encode(n),s=await crypto.subtle.digest("SHA-256",o),c=Array.from(new Uint8Array(s)).slice(0,4).map(l=>l.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${c} ${t}`)}catch{console.log(`[selftest] api-client.js fail ${t}`)}}const lt="https://localhost:9443";function Ut(){try{return(localStorage.getItem("backendUrl")||lt).replace(/\/+$/,"")}catch{return lt}}const Q=9e3,jt=60,Pt=9e4,Ht=1,Kt=3e3;async function N(t,e,n){return L(async()=>{const o=Ut()+t,s={"Content-Type":"application/json"},c=x()||"1.4";s["x-schema-version"]=c;const l=D();l&&(s["x-api-key"]=l);const d=JSON.stringify(e||{}),i=new TextEncoder().encode(d).length;let u=n,m=Ht,g=Kt;if(t==="/api/analyze"){if(u==null){const r=Q+jt*(i/1024);u=Math.max(Q,Math.min(Pt,Math.floor(r)))}try{for(const r of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const f=localStorage.getItem(r);if(f){const y=parseInt(f,10);if(Number.isFinite(y)){u=y;break}}}}catch{}try{const r=localStorage.getItem("cai.retry.analyze.count");r&&(m=parseInt(r,10))}catch{}try{const r=localStorage.getItem("cai.retry.analyze.backoff.ms");r&&(g=parseInt(r,10))}catch{}try{const r=new URLSearchParams(location.search),f=r.get("ta");f&&(u=parseInt(f,10));const y=r.get("rac");y&&(m=parseInt(y,10));const b=r.get("rb");b&&(g=parseInt(b,10))}catch{}}u=u??Q;async function a(r){const f=new AbortController,y=setTimeout(()=>f.abort(`timeout ${u}ms`),u);Rt(f),zt(y);try{const b=await fetch(o,{method:"POST",headers:s,body:d,credentials:"include",signal:f.signal}),S=await b.json().catch(()=>({}));return t==="/api/analyze"&&(b.status===504||b.status>=500)&&r<m?(await new Promise(w=>setTimeout(w,g)),a(r+1)):{resp:b,json:S}}catch(b){if(t==="/api/analyze"&&b?.name==="AbortError"){const S=f.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${S}`),r<m&&String(S).startsWith("timeout"))return await new Promise(w=>setTimeout(w,g)),a(r+1);throw new DOMException(S,"AbortError")}throw b}finally{clearTimeout(y),Ft(y),Nt(f)}}return a(0)})}window.postJson=N;async function qt(t,e){return N("/api/panel/redlines",{before_text:t,after_text:e})}const Jt={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function v(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function j(t){const e=(t||"").toLowerCase();return e==="high"?3:e==="medium"?2:1}function Vt(t){const e=new Map;let n=0,o=0;for(const c of t||[]){const l=v(c.snippet||""),d=typeof c.start=="number"?c.start:void 0,i=typeof c.end=="number"?c.end:d!==void 0?d+l.length:void 0;if(typeof d!="number"||typeof i!="number"||i<=d||i-d>1e4){n++;continue}const u=`${c.rule_id||""}|${d}|${i}|${l}`,m=e.get(u);!m||j(c.severity)>j(m.severity)?e.set(u,{...c,snippet:l,start:d,end:i}):o++}const s=Array.from(e.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),s}function Yt(){const t=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),e=globalThis.Word||{},n=t&&!!e?.Revision,o=t&&!!e?.Comment,s=t&&!!e?.SearchOptions,c=t&&!!e?.ContentControl,l={revisions:n,comments:o,search:s,contentControls:c};return!t&&e?.Comment&&localStorage.getItem("cai.force.comments")==="1"?{...l,comments:!0}:l}function dt(){const t=Yt();try{console.log("support matrix",t)}catch{}return t}async function Qt(t){const e=[];try{await Wt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(m=>{document.getElementById(m)||e.push(`missingID:${m}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||e.push("req1.4:0");const n=dt(),o={revisions:n.revisions?1:0,comments:n.comments?1:0,search:n.search?1:0,contentControls:n.contentControls?1:0};let s=!1;try{s=(await ct({backend:t})).ok,s||e.push("health")}catch{e.push("health:timeout")}const c="build-20250914-100041",l=Office?.context?.host||"Word",d=e.length===0,i=d?`Startup OK | build=${c} | host=${l} | req=1.4 | features=${JSON.stringify(o)} | backend=${t}`:`Startup FAIL: ${e.join("; ")}`;console.log(i);const u=document.getElementById("startupBadge");return u&&(u.textContent=d?"OK":"FAIL",u.setAttribute("data-status",d?"ok":"fail")),{ok:d,missing:e,features:o}}function T(t){try{console.log("[OK]",t)}catch{}}function ut(t){try{console.error("[ERR]",t)}catch{}}function h(t){try{console.warn("[WARN]",t)}catch{}}async function P(){return await Word.run(async t=>{const e=t.document.body;return e.load("text"),await t.sync(),(e.text||"").trim()})}var ft={};const G=globalThis,Z=G.OfficeExtension,mt="build-20250914-100041";console.log("ContractAI build",mt);let gt=null,yt="1",pt="1";try{gt=localStorage.getItem("cai_timeout_ms:analyze"),yt=localStorage.getItem("cai_abort_on_hidden")||"1",pt=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:gt,abort_on_hidden:yt,abort_on_navigation:pt}),!mt.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const t=document.createElement("div");t.textContent="FATAL: stale bundle",t.style.padding="12px",t.style.color="#f66",document.body.innerHTML="",document.body.appendChild(t),document.querySelectorAll("button").forEach(e=>{e.disabled=!0})}catch{}});const ht=(()=>{const t=G.ENV_MODE||(typeof process<"u"?ft?.ENV_MODE:void 0);return t?t==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();Z&&Z.config&&(ht==="dev"||G.__ENABLE_EXTENDED_LOGS__)&&(Z.config.extendedErrorLogging=!0);function z(t,e="Word"){try{const n=t&&t.debugInfo||{};console.error(`[${e}] RichApi error`,{code:t.code,message:t.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function bt(t){return(it(t)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const p=globalThis;p.parseFindings=p.parseFindings||bt,p.applyMetaToBadges=p.applyMetaToBadges||rt,p.getApiKeyFromStore=p.getApiKeyFromStore||D,p.getSchemaFromStore=p.getSchemaFromStore||x,p.logRichError=p.logRichError||z,p.getWholeDocText=p.getWholeDocText||P;const F={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let H="",_t=!1;const Gt=Jt.required_ids||[];function X(t,e){const n=document.getElementById("status-chip");if(!n)return;const o=(t??x())||"—",s=(e??H)||"—";n.textContent=`schema: ${o} | cid: ${s}`}function Zt(){if(_t)return;_("#btnAnalyze",fe);const t=document.getElementById("btnAnalyze");t&&(t.disabled=!1),_t=!0,console.log("[PANEL] analyze enabled")}function wt(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function Xt(){const e=document.getElementById("backendUrl")?.value?.trim();if(e)try{localStorage.setItem("backend.url",e),localStorage.setItem("backendUrl",e)}catch{}location.reload()}function tt(){try{let t=D(),e=x();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",s=o==="localhost"||o==="127.0.0.1";if(s&&(t||(t="local-test-key-123",ot(t)),!e)){const c=globalThis?.SCHEMA_VERSION||typeof process<"u"&&ft?.SCHEMA_VERSION||"1.4";e=String(c),R(e)}n&&(!t&&!e&&!s?n.style.display="":n.style.display="none"),(!t||!e)&&console.warn("missing headers",{apiKey:!!t,schema:!!e})}catch{}return!0}function k(t,e){return document.querySelector(`[data-role="${e}"]`)||document.getElementById(t)}function Et(){const e=document.getElementById("selectRiskThreshold")?.value?.toLowerCase();return e==="low"||e==="medium"||e==="high"?e:"medium"}function et(){const t=Bt();try{const e=globalThis.document,n=e?.getElementById("cai-comment-on-analyze")||e?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=t),n?!!n.checked:t}catch{return t}}function te(t){Lt(t)}function At(t,e){const n=j(e);return(t||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>j(o.severity)>=n)}function ee(t){if(!t||!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const e=(t.severity||"info").toUpperCase(),n=t.rule_id,o=t.clause_type?` (${t.clause_type})`:"",s=t.advice||"—",c=Array.isArray(t.law_refs)&&t.law_refs.length?t.law_refs.join("; "):"—",l=Array.isArray(t.conflict_with)&&t.conflict_with.length?t.conflict_with.join("; "):"—",d=t.suggestion?.text||"—",i=Array.isArray(t.citations)&&t.citations.length?`
Citations: ${t.citations.join("; ")}`:"";return`[${e}] ${n}${o}
Reason: ${s}
Law: ${c}
Conflict: ${l}${i}
Suggested fix: ${d}`}function It(t,e,n){if(!e)return 0;let o=-1,s=0;const c=typeof n=="number"?Math.max(0,n):Number.MAX_SAFE_INTEGER;for(;(o=t.indexOf(e,o+1))!==-1&&o<c;)s++;return s}async function ne(t){return L(async()=>{const e=document.getElementById("cai-dry-run-annotate");function n(){return e?!!e.checked:!!document.getElementById("cai-dry-run-annotate")?.checked}const o=v(window.__lastAnalyzed||""),s=Vt(t||[]),c=s.slice().sort((a,r)=>(r.end??0)-(a.end??0)),l=[];let d=Number.POSITIVE_INFINITY,i=0;for(const a of c){if(!a||!a.rule_id||!a.snippet){i++;continue}const r=a.snippet,f=typeof a.end=="number"?a.end:typeof a.start=="number"?a.start+r.length:void 0;if(typeof f=="number"&&f>d){i++;continue}l.push(a),typeof a.start=="number"&&(d=a.start)}i&&h(`Skipped ${i} overlaps/invalid`),T(`Will insert: ${l.length}`);const u=l.map(a=>{const r=a.snippet||"",f=v(r),y=It(o,f,a.start);return{raw:r,norm:f,msg:ee(a),rule_id:a.rule_id,occIdx:y,normalized_fallback:v(a.normalized_snippet||"")}}),m={matchCase:!1,matchWholeWord:!1};let g=0;for(const a of u)await Word.run(async r=>{const f=r.document.body;let y=null;const b=f.search(a.raw,m);b.load("items"),await r.sync();const S=(w,A)=>{const C=w?.items||[];return C.length&&C[Math.min(Math.max(A,0),C.length-1)]||null};if(y=S(b,a.occIdx),!y){const w=a.normalized_fallback&&a.normalized_fallback!==a.norm?a.normalized_fallback:a.norm;if(w&&w.trim()){const A=f.search(w,m);A.load("items"),await r.sync(),y=S(A,a.occIdx)}}if(!y){const w=(()=>{const A=a.raw.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(C=>C.length>=12);return A.length?A.sort((C,we)=>we.length-C.length)[0].slice(0,64):null})();if(w){const A=f.search(w,m);A.load("items"),await r.sync(),y=S(A,0)}}if(y){if(n())try{y.select()}catch{}else a.msg&&y.insertComment(a.msg);g++}else console.warn("[annotate] no match for snippet",{rid:a.rule_id,snippet:a.raw.slice(0,120)});await r.sync()}).catch(r=>{z(r,"annotate"),console.warn("annotate run fail",r?.code,r?.message,r?.debugInfo)});return console.log("panel:annotate",{total:t.length,deduped:s.length,skipped_overlaps:i,will_annotate:l.length,inserted:g}),g})}p.annotateFindingsIntoWord=p.annotateFindingsIntoWord||ne;async function oe(){try{await Word.run(async t=>{const e=t.document.body,n=t.document.comments;n.load("items"),await t.sync();for(const o of n.items)try{o.delete()}catch{}try{e.font.highlightColor="NoColor"}catch{}await t.sync()}),T("Annotations cleared")}catch(t){z(t,"annotate"),h("Failed to clear annotations")}}async function vt(t){return L(async()=>{let e=(t||[]).filter(s=>typeof s.start=="number"&&typeof s.end=="number"&&s.end>s.start).sort((s,c)=>s.start-c.start),n=-1;if(e=e.filter(s=>s.start<n?!1:(n=s.end,!0)),!e.length)return;const o=window.__lastAnalyzed||"";await Word.run(async s=>{const c=s.document.body;s.document.trackRevisions=!0;const l={matchCase:!1,matchWholeWord:!1},d=(i,u)=>{const m=i?.items||[];return m.length&&m[Math.min(Math.max(u,0),m.length-1)]||null};for(const i of e){const u=o.slice(i.start,i.end),m=(()=>{let a=-1,r=0;for(;(a=o.indexOf(u,a+1))!==-1&&a<i.start;)r++;return r})();let g=null;if(i.context_before||i.context_after){const a=`${i.context_before||""}${u}${i.context_after||""}`,r=c.search(a,l);r.load("items"),await s.sync();const f=d(r,m);if(f){const y=f.search(u,l);y.load("items"),await s.sync(),g=d(y,0)}}if(!g){const a=c.search(u,l);a.load("items"),await s.sync(),g=d(a,m)}if(!g){const a=(()=>{const r=u.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(f=>f.length>=12);return r.length?r.sort((f,y)=>y.length-f.length)[0].slice(0,64):null})();if(a){const r=c.search(a,l);r.load("items"),await s.sync(),g=d(r,0)}}if(g){g.insertText(i.replacement,"Replace");const a=i.rationale||i.source||"AI edit";try{g.insertComment(a)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:u,occIdx:m});await s.sync()}})})}p.applyOpsTracked=p.applyOpsTracked||vt;async function se(t){const e=v(window.__lastAnalyzed||""),n=t?.snippet||"",o=v(n),s=It(e,o,t.start),c={matchCase:!1,matchWholeWord:!1};await Word.run(async l=>{const d=l.document.body;let i=null;const u=(g,a)=>{const r=g?.items||[];return r.length&&r[Math.min(Math.max(a,0),r.length-1)]||null},m=d.search(n,c);if(m.load("items"),await l.sync(),i=u(m,s),!i){const g=t.normalized_snippet&&t.normalized_snippet!==o?t.normalized_snippet:o;if(g&&g.trim()){const a=d.search(g,c);a.load("items"),await l.sync(),i=u(a,s)}}if(!i){const g=(()=>{const a=n.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(r=>r.length>=12);return a.length?a.sort((r,f)=>f.length-r.length)[0].slice(0,64):null})();if(g){const a=d.search(g,c);a.load("items"),await l.sync(),i=u(a,0)}}if(i)try{i.select()}catch{}await l.sync()})}async function St(t){const e=window.__findings||[];if(!e.length)return;const n=window;n.__findingIdx=(n.__findingIdx??0)+t,n.__findingIdx<0&&(n.__findingIdx=e.length-1),n.__findingIdx>=e.length&&(n.__findingIdx=0);const o=document.getElementById("findingsList");if(o){const s=Array.from(o.querySelectorAll("li"));s.forEach((l,d)=>{l.classList.toggle("active",d===n.__findingIdx)});const c=s[n.__findingIdx];c&&c.scrollIntoView({block:"nearest"})}try{await se(e[n.__findingIdx])}catch{}}function ae(){St(-1)}function ce(){St(1)}function ie(t){const e=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",n=Array.isArray(t?.findings)?t.findings:[],o=Array.isArray(t?.recommendations)?t.recommendations:[],s=Et(),l=At(n,s).length,d=n.length-l,i=(a,r)=>{const f=document.getElementById(a);f&&(f.textContent=r)};i("clauseTypeOut",String(e)),i("resFindingsCount",String(n.length)),i("visibleHiddenOut",`${l} / ${d}`);const u=document.getElementById("findingsList");if(u){u.innerHTML="";for(const a of n){const r=document.createElement("li"),f=a?.title||a?.finding?.title||a?.rule_id||"Issue",y=a?.snippet||a?.evidence?.text||"";r.textContent=y?`${f}: ${y}`:String(f),u.appendChild(r)}}const m=document.getElementById("recsList");if(m){m.innerHTML="";for(const a of o){const r=document.createElement("li");r.textContent=a?.text||a?.advice||a?.message||"Recommendation",m.appendChild(r)}}const g=document.getElementById("resultsBlock");g&&g.style.removeProperty("display")}function re(t){const e=k("resClauseType","clause-type");e&&(e.textContent=t?.clause_type||"—");const n=bt(t);window.__findings=n,window.__findingIdx=0;const o=k("findingsList","findings");o&&(o.innerHTML="",n.forEach(i=>{const u=document.createElement("li");u.textContent=typeof i=="string"?i:JSON.stringify(i),o.appendChild(u)}));const s=Array.isArray(t?.recommendations)?t.recommendations:[],c=k("recoList","recommendations");c&&(c.innerHTML="",s.forEach(i=>{const u=document.createElement("li");u.textContent=typeof i=="string"?i:JSON.stringify(i),c.appendChild(u)}));const l=k("resFindingsCount","findings-count");l&&(l.textContent=String(n.length));const d=k("rawJson","raw-json");d&&(d.textContent=JSON.stringify(t??{},null,2))}function le(){const t=k("toggleRaw","toggle-raw-json"),e=k("rawJson","raw-json");t&&e&&(e.style.display="none",t.addEventListener("click",()=>{e.style.display=e.style.display==="none"?"block":"none"}))}function Tt(t){const e=document.getElementById("connBadge");e&&(e.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`)}function nt(t){const e=document.getElementById("officeBadge");e&&(e.textContent=`Office: ${t??"—"}`)}function M(t){return document.querySelector(t)}async function de(){const t=M(F.original),e=await P(),n=v(e||"");if(t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const o=document.getElementById("originalText");if(o&&o!==t){o.value=n;try{o.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function ue(t){return L(async()=>{try{const e=M(F.proposed);if(!(window.__lastAnalyzed||v(await P()))){h("No document text");return}const o=window.__findings||[],s=window.__findingIdx??0,c=o[s];if(!c){h("No active finding");return}const l=c.snippet||"",{json:d}=await N("/api/gpt-draft",{cid:H,clause:l,mode:"friendly"}),i=(d?.proposed_text??d?.text??"").toString(),u=window;u.__last=u.__last||{},u.__last["gpt-draft"]={json:d},e?(e.id||(e.id="draftText"),e.name||(e.name="proposed"),e.dataset.role="proposed-text",e.value=i,e.dispatchEvent(new Event("input",{bubbles:!0})),T("Draft ready"),$(i)):(h("Proposed textarea not found"),$(""))}catch(e){h("Draft error"),console.error(e),$("")}})}async function kt(){try{const t=x(),{resp:e,json:n,ok:o}=await ct({backend:wt()}),s=e.headers.get("x-schema-version")||n?.schema||null;if(s&&(R(s),s!==t&&console.log(`schema: ${s} (synced)`)),Tt(o),o){console.log("[PANEL] health ok"),Zt(),X(s,null);try{rt({cid:null,xcache:null,latencyMs:null,schema:s||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}T(`Health: ${n?.status||"ok"}${s?` (schema ${s})`:""}`)}else h("Health failed")}catch(t){Tt(!1),h("Health failed"),console.error(t)}}async function fe(){return L(async()=>{const t=document.getElementById("btnAnalyze"),e=document.getElementById("busyBar");t&&(t.disabled=!0),e&&(e.style.display="");try{$("");const n=window.__lastAnalyzed,o=n&&n.trim()?n:v(await globalThis.getWholeDocText());if(!o){ut("В документе нет текста");return}tt(),window.__lastAnalyzed=o;const s=document.getElementById("originalText");s&&(s.value=o);const{resp:c,json:l}=await N("/api/analyze",{text:o});if(!c.ok)throw new Error(`HTTP ${c.status}`);const d=c.headers.get("x-schema-version");d&&R(d),l?.schema&&R(l.schema),H=c.headers.get("x-cid")||"",X(null,H),re(l),ie(l);try{localStorage.setItem("last_analysis_json",JSON.stringify(l))}catch{}try{const i=globalThis.parseFindings(l),u=Et(),m=At(i,u);et()&&m.length&&await globalThis.annotateFindingsIntoWord(m)}catch(i){console.warn("auto-annotate after analyze failed",i)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:l})),T("Analyze OK")}catch(n){let o="";if(n?.name==="AbortError"){const s=n?.message||"";if(s.startsWith("timeout")){const c=parseInt(s.replace(/[^0-9]/g,""),10)||0;o=`(timeout ${Math.round(c/1e3)} s)`}else s==="pagehide/unload"?o="(aborted by pagehide)":o="(aborted)"}else typeof n?.message=="string"&&(n.message.includes("HTTP 504")?o="(HTTP 504)":n.message.includes("HTTP 413")?o="(payload too large 413)":n.message.includes("HTTP 401")?o="(unauthorized 401)":n.message.includes("HTTP 403")?o="(forbidden 403)":n.message.includes("HTTP 422")&&(o="(schema mismatch 422)"));h(`Analyze failed ${o}`.trim()),console.error(n)}finally{t&&(t.disabled=!1),e&&(e.style.display="none")}})}async function me(){return L(async()=>{tt();const t=await P(),{json:e}=await N("/api/qa-recheck",{text:t,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:e})),!e?.error)T("QA recheck OK");else{const o=e?.error||e?.message||"unknown";ut(`QA recheck failed: ${o}`)}})}function _(t,e){const n=document.querySelector(t);n&&(n.addEventListener("click",o=>{o.preventDefault(),e()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function ge(){try{const t=window.__lastAnalyzed||"",e=(M(F.proposed)?.value||"").trim();if(!e){h("No draft to diff");return}const n=await qt(t,e),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",s=document.getElementById("diffOutput"),c=document.getElementById("diffContainer");s&&c&&(s.innerHTML=o||"",c.style.display=o?"block":"none")}catch(t){h("Diff failed"),console.error(t)}}async function ye(){try{const t=window.__last||{},e=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!e.length){h("No ops to apply");return}await vt(e),T("Applied ops")}catch(t){h("Insert failed"),console.error(t)}}async function pe(){try{const e=(M(F.proposed)?.value||"").trim();if(!e){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),s=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async c=>{const l=c.document.getSelection();c.document.trackRevisions=!0,l.insertText(e,Word.InsertLocation.replace);try{l.insertComment(s)}catch{}await c.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),z(t,"insertDraft"),console.error(t)}}async function he(){try{const t=M(F.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),$("")),await Word.run(async e=>{const o=e.document.getSelection().revisions;o.load("items"),await e.sync(),(o.items||[]).forEach(s=>{try{s.reject()}catch{}}),await e.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),z(t,"insertDraft"),console.error(t)}}function Ct(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const d=Gt.filter(i=>!document.getElementById(i));if(d.length){console.error("[PANEL] wireUI missing IDs:",d);const i=`FATAL: panel template mismatch (missing: ${d.join(", ")}). Check build pipeline.`;try{const u=document.createElement?document.createElement("div"):null;u&&(u.textContent=i,u.style.padding="12px",u.style.color="#f66",document.body.innerHTML="",document.body.appendChild(u))}catch{}console.error(i);return}}const t=document.getElementById("loading-book");window.addEventListener("cai:busy",d=>{if(!t)return;!!d?.detail?.busy?t.classList.remove("hidden"):t.classList.add("hidden")});const e=dt(),n=d=>{const i=document.getElementById(d);i&&(i.disabled=!0,i.title="Not supported")};_("#btnUseWholeDoc",de);const o=document.getElementById("btnUseWholeDoc");if(o&&(o.disabled=!1),ht==="dev")_("#btnTest",kt);else{const d=document.getElementById("btnTest");d&&(d.style.display="none")}_("#btnQARecheck",me),document.getElementById("btnSuggestEdit")?.addEventListener("click",ue),_("#btnApplyTracked",ye),_("#btnAcceptAll",pe),_("#btnRejectAll",he),_("#btnPrevIssue",ae),_("#btnNextIssue",ce),_("#btnPreviewDiff",ge),_("#btnClearAnnots",oe),_("#btnSave",Xt);const s=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");s?(s.checked=et(),s.addEventListener("change",()=>te(!!s.checked))):et();const c=document.getElementById("btnAnnotate");c&&(c.addEventListener("click",async()=>{if(!c.disabled){c.disabled=!0;try{const d=window.__last?.analyze?.json||{},i=globalThis.parseFindings(d);await globalThis.annotateFindingsIntoWord(i)}finally{c.disabled=!1}}}),c.classList.remove("js-disable-while-busy"),c.removeAttribute("disabled")),$(""),le(),console.log("Panel UI wired");const l=document.getElementById("btnAnalyze");if(l&&(l.disabled=!0),tt(),X(),e.revisions||(n("btnApplyTracked"),n("btnAcceptAll"),n("btnRejectAll")),e.comments||n("btnAcceptAll"),e.search||(n("btnPrevIssue"),n("btnNextIssue"),n("btnQARecheck")),e.contentControls||n("btnAnnotate"),!e.revisions||!e.comments||!e.search||!e.contentControls)try{nt("Word ⚠")}catch{}}p.wireUI=p.wireUI||Ct;function $(t){const e=!!t.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),s=document.getElementById("btnRejectAll"),c=document.getElementById("btnPreviewDiff"),l=document.getElementById("draftPane"),d=document.getElementById("draftText");d&&(d.value=t),l&&(l.style.display=e?"":"none"),n&&(n.disabled=!e),o&&(o.disabled=!e),s&&(s.disabled=!e),c&&(c.disabled=!e)}async function be(t){console.log("[PANEL] bootstrap start"),at()&&(console.log("reopen clean OK"),Dt()),Ct(),Mt();try{await Qt(wt())}catch{}try{await kt()}catch{}try{nt(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{nt(null)}}let K=0;function _e(t){if(at()&&(K=0),K>0){console.log(`bootstrap invoked x${K+1}`);return}K++,console.log("bootstrap invoked x1"),be(t)}if(!globalThis.__CAI_TESTING__){const t=()=>Office.onReady(e=>_e(e));document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}})();
