(function(){"use strict";var ie=typeof document<"u"?document.currentScript:null;const oe="",ce="1.4",V="cai-comment-on-analyze";function ht(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",oe),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",ce),localStorage.getItem(V)===null&&localStorage.setItem(V,"1")}catch{}}ht();function q(){try{return localStorage.getItem("api_key")||oe}catch{return oe}}function Oe(r){try{localStorage.setItem("api_key",r)}catch{}}function j(){try{return localStorage.getItem("schema_version")||ce}catch{return ce}}function J(r){try{localStorage.setItem("schema_version",r)}catch{}}function gt(){try{const r=localStorage.getItem(V);return r===null?(localStorage.setItem(V,"1"),!0):r!=="0"}catch{return!0}}function mt(r){try{localStorage.setItem(V,r?"1":"0")}catch{}}const B=typeof globalThis<"u"?globalThis:window;B.CAI=B.CAI||{},B.CAI.Store=B.CAI.Store||{},B.CAI.Store.setApiKey=Oe,B.CAI.Store.setSchemaVersion=J,B.CAI.Store.get=()=>({apiKey:q(),schemaVersion:j()}),B.CAI.Store.DEFAULT_BASE=B.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const $=window;$.__cai_pending_fetches=$.__cai_pending_fetches||new Set,$.__cai_pending_timers=$.__cai_pending_timers||new Set;const Y=$.__cai_pending_fetches,x=$.__cai_pending_timers,U={count:0};function pt(){U.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:U.count}}))}function yt(){U.count=Math.max(0,U.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:U.count>0,count:U.count}}))}async function Q(r){try{return pt(),await r()}finally{yt()}}function vt(r){Y.add(r)}function _t(r){Y.delete(r)}function bt(r){x.add(r)}function wt(r){x.delete(r)}function $e(r){Y.forEach(t=>{try{t.abort(r)}catch{}}),Y.clear(),x.forEach(t=>{try{clearTimeout(t),clearInterval(t)}catch{}}),x.clear();try{document.querySelectorAll(".progress").forEach(t=>{t.style.display="none"})}catch{}}function At(){if($.__pendingUnloadReg)return;$.__pendingUnloadReg=!0;const r=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),t=()=>{r&&$e("pagehide/unload"),$.__wasUnloaded=!0};window.addEventListener("pagehide",t),window.addEventListener("unload",t),window.addEventListener("beforeunload",t),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&$e("visibilitychange")})}function Et(){return!!$.__wasUnloaded}function It(){$.__wasUnloaded=!1}let le=null;async function Be(r={}){if(!le){const t=(r.backend||"").replace(/\/+$/,""),l=t?`${t}/health`:"/health",f=new AbortController,u=r.timeoutMs??9e3,e=setTimeout(()=>f.abort("timeout"),u);le=fetch(l,{signal:f.signal}).then(async n=>{clearTimeout(e);const a=await n.json().catch(()=>({}));return{ok:n.ok,json:a,resp:n}})}return le}var Ne={};const ue=(()=>{if(typeof process<"u"&&(Ne!=null&&!0))return"production";try{if(typeof localStorage<"u")return localStorage.getItem("NODE_ENV")||""}catch{}return"development"})()==="production";function fe(r,t){try{const l=document.getElementById("console");if(!l)return;l.textContent=r,l.setAttribute("data-level",t),setTimeout(()=>{l.textContent="",l.removeAttribute("data-level")},3e3)}catch{}}function H(r,t){fe(r,"ok");try{ue?console.log("[OK]",r):console.log("[OK]",r,t)}catch{}}function Fe(r,t){fe(r,"error");try{ue?console.error("[ERR]",r):console.error("[ERR]",r,t)}catch{}}function L(r,t){fe(r,"warn");try{ue?console.warn("[WARN]",r):console.warn("[WARN]",r,t)}catch{}}const Pe=(()=>{try{return localStorage.getItem("cai_dev")==="1"?!0:new URLSearchParams(globalThis.location?.search||"").get("debug")==="1"}catch{return!1}})();function St(r,t,l){Pe?console.error(r,t,l):console.error(r,t)}function ze(r){const t=r?.analysis?.findings??r?.findings??r?.issues??[];return Array.isArray(t)?t.filter(Boolean):[]}window.parseFindings=ze;function Tt(r){const t=r.headers,l=r.json||{},f=l.llm||l;return{cid:t.get("x-cid"),xcache:t.get("x-cache"),latencyMs:t.get("x-latency-ms"),schema:t.get("x-schema-version"),provider:t.get("x-provider")||f.provider||l.provider||null,model:t.get("x-model")||f.model||l.model||null,llm_mode:t.get("x-llm-mode")||f.mode||l.mode||null,usage:t.get("x-usage-total"),status:r.status!=null?String(r.status):null}}function de(r){const t=(l,f)=>{const u=document.getElementById(l);u&&(u.textContent=f&&f.length?f:"—")};t("status",r.status),t("cid",r.cid),t("xcache",r.xcache),t("latency",r.latencyMs),t("schema",r.schema),t("provider",r.provider),t("model",r.model),t("mode",r.llm_mode),t("usage",r.usage)}async function kt(){const r=new URL(ie&&ie.tagName.toUpperCase()==="SCRIPT"&&ie.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const l=await(await fetch(r)).text(),f=new TextEncoder().encode(l),u=await crypto.subtle.digest("SHA-256",f),e=Array.from(new Uint8Array(u)).slice(0,4).map(n=>n.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${e} ${r}`)}catch{console.log(`[selftest] api-client.js fail ${r}`)}}const We="https://localhost:9443";function Ct(){try{return(localStorage.getItem("backendUrl")||We).replace(/\/+$/,"")}catch{return We}}const he=9e3,Mt=60,Dt=9e4,Lt=1,Rt=3e3;async function ee(r,t,l){return Q(async()=>{const f=Ct()+r,u={"Content-Type":"application/json"},e=j()||"1.4";u["x-schema-version"]=e;const n=q();n&&(u["x-api-key"]=n);const a={...t||{},schema:e},i=JSON.stringify(a),o=new TextEncoder().encode(i).length;let s=l,c=Lt,d=Rt;if(r==="/api/analyze"){if(s==null){const g=he+Mt*(o/1024);s=Math.max(he,Math.min(Dt,Math.floor(g)))}try{for(const g of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const m=localStorage.getItem(g);if(m){const p=parseInt(m,10);if(Number.isFinite(p)){s=p;break}}}}catch{}try{const g=localStorage.getItem("cai.retry.analyze.count");g&&(c=parseInt(g,10))}catch{}try{const g=localStorage.getItem("cai.retry.analyze.backoff.ms");g&&(d=parseInt(g,10))}catch{}try{const g=new URLSearchParams(location.search),m=g.get("ta");m&&(s=parseInt(m,10));const p=g.get("rac");p&&(c=parseInt(p,10));const y=g.get("rb");y&&(d=parseInt(y,10))}catch{}}s=s??he;async function h(g){const m=new AbortController;m.__key=r;const p=setTimeout(()=>m.abort(`timeout ${s}ms`),s);vt(m),bt(p);try{const y=await fetch(f,{method:"POST",headers:u,body:i,credentials:"include",signal:m.signal}),v=await y.json().catch(()=>({}));if(y.status===422){console.warn("[analyze] 422",v.detail);const _=Array.isArray(v?.detail)?v.detail.map(b=>b.msg).join("; "):v?.detail;try{L(`Validation error: ${_}`)}catch{}}return r==="/api/analyze"&&(y.status===504||y.status>=500)&&g<c?(await new Promise(_=>setTimeout(_,d)),h(g+1)):{resp:y,json:v}}catch(y){if(r==="/api/analyze"&&y?.name==="AbortError"){const v=m.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${v}`),g<c&&String(v).startsWith("timeout"))return await new Promise(_=>setTimeout(_,d)),h(g+1);throw new DOMException(v,"AbortError")}St(`[NET] ${r} failed`,y,{body:a});try{const v=Pe?String(y):"Analysis failed, please try again";L(v)}catch{}throw y}finally{clearTimeout(p),wt(p),_t(m)}}return h(0)})}window.postJson=ee;async function Ot(r={}){const t={text:r?.text??r?.content,mode:r?.mode??"live"},{resp:l,json:f}=await ee("/api/analyze",t),u=Tt({headers:l.headers,json:f,status:l.status});try{de(u)}catch{}try{const e=window;e.__last||(e.__last={}),e.__last.analyze={status:l.status,req:{path:"/api/analyze",method:"POST",body:t},json:f}}catch{}return{ok:l.ok,json:f,resp:l,meta:u}}async function $t(r,t){return ee("/api/panel/redlines",{before_text:r,after_text:t})}const Bt={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function F(r){return r?r.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function te(r){const t=(r||"").toLowerCase();return t==="high"?3:t==="medium"?2:1}function je(r){const t=new Map;let l=0,f=0;for(const e of r||[]){const n=F(e.snippet||""),a=typeof e.start=="number"?e.start:void 0,i=typeof e.end=="number"?e.end:a!==void 0?a+n.length:void 0;if(typeof a!="number"||typeof i!="number"||i<=a||i-a>1e4){l++;continue}const o=`${e.rule_id||""}|${a}|${i}|${n}`,s=t.get(o);!s||te(e.severity)>te(s.severity)?t.set(o,{...e,snippet:n,start:a,end:i}):f++}const u=Array.from(t.values());return console.log("panel:annotate",`dedupe dropped ${l} invalid, ${f} duplicates`),u}async function ne(r,t,l){const f=r?.context,u=(t??"").trim();if(!u)return{items:[]};if(u.length<=240)try{const o=r.search(u,l);return o?.load?.("items"),await f?.sync?.(),o}catch{return{items:[]}}const e=u.slice(0,120);let n;try{n=r.search(e,l),n?.load?.("items"),await f?.sync?.()}catch{return{items:[]}}const a=[],i=u.slice(0,240);for(const o of n?.items||[]){let s=o;try{s=o.paragraphs?.getFirst?.()||o,s?.load?.("text"),await f?.sync?.()}catch{}const c=s?.text||"";if(c.includes(i))try{const g=s.search(i,l);g?.load?.("items"),await f?.sync?.(),g?.items?.length&&a.push(...g.items);continue}catch{}const d=i.split(/\s+/).filter(g=>g.length>3).slice(0,5);let h=!0;for(const g of d)if(!c.includes(g)){h=!1;break}h&&a.push(s)}return{items:a}}async function X(r,t){const l=r.context,f={matchCase:!1,matchWholeWord:!1},u=async i=>await ne(r,i,f);let n=(await u(t||""))?.items||[];if(!n.length){const i=F(t||"");n=(await u(i))?.items||[]}n.sort((i,o)=>{const s=i.start??0,c=o.start??0;if(s!==c)return s-c;const d=i.end??s,h=o.end??c;return d-h});const a=[];for(const i of n){const o=i.start??0,s=i.end??o,c=a[a.length-1];if(c&&o<(c.end??o)){const d=(c.end??0)-(c.start??0);s-o>d&&(a[a.length-1]=i);continue}a.push(i)}for(const i of a)try{l.trackedObjects?.add?.(i)}catch{}return a}async function ge(r,t){const l=r.context;let f=null;try{const e=l?.document;if(e?.comments?.add){e.comments.add(r,t),await l?.sync?.();return}}catch(e){f=e}try{r.insertComment(t),await l?.sync?.();return}catch(e){f=e}try{await l?.sync?.();const e=l?.document;if(e?.comments?.add){e.comments.add(r,t),await l?.sync?.();return}}catch(e){f=e}const u=globalThis;console.warn("safeInsertComment failed",f),u.logRichError?.(f,"insertComment"),u.notifyWarn?.("Failed to insert comment")}function Nt(r,t,l){if(!r||!t)return 0;let f=-1,u=0;for(;(f=r.indexOf(t,f+1))!==-1&&f<(l??r.length);)u++;return u}function Ft(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const K="[CAI]";function Pt(r){if(!r.rule_id||!r.snippet)return console.warn("buildLegalComment: missing required fields",r),"";const t=[r.rule_id];if(r.advice&&t.push(r.advice),r.law_refs?.length&&t.push(r.law_refs.join("; ")),r.norm_quote&&t.push(`"${r.norm_quote}"`),r.clause_url||r.clause_id){const l=r.clause_id?`Clause ${r.clause_id}`:"Clause";r.clause_url?t.push(`${l}: ${r.clause_url}`):t.push(l)}return`${K} ${t.join(`
`)}`}const me=200;function pe(r){const t=F(globalThis.__lastAnalyzed||""),l=Array.isArray(r)?r:[],f=je(l),u=f.slice().sort((o,s)=>(o.start??Number.POSITIVE_INFINITY)-(s.start??Number.POSITIVE_INFINITY)),e=[];let n=-1,a=0;for(const o of u){if(!o||!o.rule_id||!o.snippet||typeof o.start!="number"){a++;continue}const s=o.snippet,c=o.start,d=typeof o.end=="number"?o.end:c+s.length;if(c<n){a++;continue}const h=F(s),g=Nt(t,h,c);if(e.push({raw:s,norm:h,occIdx:g,msg:Pt(o),rule_id:o.rule_id,code:o.code,normalized_fallback:F(o.normalized_snippet||"")}),n=d,e.length>=me)break}const i=globalThis;return a&&i.notifyWarn?.(`Skipped ${a} overlaps/invalid`),f.length>me&&i.notifyWarn?.(`Truncated to first ${me} findings`),i.notifyOk?.(`Will insert: ${e.length}`),e}async function Ue(r){const t=pe(r);return t.length?await globalThis.Word?.run?.(async f=>{const u=f.document.body,e=[];let n=0;for(const a of t){let i=await X(u,a.raw),o=i[Math.min(a.occIdx,i.length-1)]||null;if(!o&&a.normalized_fallback&&a.normalized_fallback!==a.norm&&(i=await X(u,a.normalized_fallback),o=i[Math.min(a.occIdx,i.length-1)]||null),o){o.load?.(["start","end"]),await f.sync();const s=o.start??0,c=o.end??s;if(e.some(d=>Math.max(d.start,s)<Math.min(d.end,c))){console.warn("[annotate] overlapping range",{rid:a.rule_id,start:s,end:c});continue}if(Ft())try{o.select()}catch{}else a.msg&&await ge(o,a.msg);e.push({start:s,end:c}),n++}else console.warn("[annotate] no match for snippet",{rid:a.rule_id,snippet:a.raw.slice(0,120)});await f.sync()}return n}).catch(f=>(globalThis.logRichError?.(f,"annotate"),console.warn("annotate run fail",f?.code,f?.message,f?.debugInfo),0)):0}async function zt(r,t,l){if(!r||!r.trim())return;const f=globalThis;if(!f.Word?.run){await f.navigator?.clipboard?.writeText(r).catch(()=>{}),f.alert?.("Draft copied to clipboard (Office not ready). Paste it into the document.");return}if(f.Office?.context?.document?.mode&&f.Office.context.document.mode!=="edit")throw f.alert?.("Document is read-only."),new Error("Document mode is not editable");await f.Word.run(async u=>{const e=u.document;let n=null;const a=e.trackRevisions;try{const h=f.__findings||[],g=f.__findingIdx,m=h&&typeof g=="number"?h[g]:null,p=e.body;if(n=(m?.snippet?await X(p,m.snippet):[])[0]||null,!n){const v=e.getSelection();v.load("isEmpty"),await u.sync(),n=v.isEmpty?e.body.getRange("End"):v}}catch{const h=e.getSelection();h.load("isEmpty"),await u.sync(),n=h.isEmpty?e.body.getRange("End"):h}e.trackRevisions=!0;const i=n.insertText(r,f.Word.InsertLocation.replace),o=[`${K} Suggested clause – ${t}`],s=(l||"").split(/\r?\n/).slice(0,2).join(" "),c=f.__findings||[],d=f.__findingIdx;if(s)o.push(s);else{const h=c&&typeof d=="number"?c[d]:null,g=h?.rule_id||h?.title||"";g&&o.push(g)}o.push("schema 1.4 | model gpt-4o-mini | provider azure");try{e.comments.add(i,o.join(`
`))}catch{}await u.sync(),e.trackRevisions=a,await u.sync()}).catch(u=>{throw globalThis.logRichError?.(u,"insertDraft"),console.warn("insertDraftText error",u?.code,u?.message,u?.debugInfo),u})}function Wt(){const r=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),t=globalThis.Word||{},l=r&&!!t?.Revision,f=r&&!!t?.SearchOptions,u=r&&!!t?.ContentControl,n=globalThis.localStorage?.getItem?.("cai.force.comments")==="1";let a=!1,i="unsupported";return n?(a=!0,i="dev override"):t?.Comment?(a=!0,i="Word.Comment available"):r?(a=!0,i="WordApi 1.4"):(a=!1,i="Word.Comment missing"),{revisions:l,comments:a,search:f,contentControls:u,commentsReason:i}}function He(){const r=Wt();try{console.log("support matrix",{comments:r.comments,reason:r.commentsReason})}catch{}return r}async function jt(r){const t=[];try{await kt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(s=>{document.getElementById(s)||t.push(`missingID:${s}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||t.push("req1.4:0");const l=He(),f={revisions:l.revisions?1:0,comments:l.comments?1:0,search:l.search?1:0,contentControls:l.contentControls?1:0};let u=!1;try{u=(await Be({backend:r})).ok,u||t.push("health")}catch{t.push("health:timeout")}const e="__BUILD_TS__",n=Office?.context?.host||"Word",a=t.length===0,i=a?`Startup OK | build=${e} | host=${n} | req=1.4 | features=${JSON.stringify(f)} | backend=${r}`:`Startup FAIL: ${t.join("; ")}`;console.log(i);const o=document.getElementById("startupBadge");return o&&(o.textContent=a?"OK":"FAIL",o.setAttribute("data-status",a?"ok":"fail")),{ok:a,missing:t,features:f}}function Ut(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var ye={exports:{}},Ke;function Ht(){return Ke||(Ke=1,(function(r){var t=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},l=-1,f=1,u=0;t.Diff=function(e,n){return[e,n]},t.prototype.diff_main=function(e,n,a,i){typeof i>"u"&&(this.Diff_Timeout<=0?i=Number.MAX_VALUE:i=new Date().getTime()+this.Diff_Timeout*1e3);var o=i;if(e==null||n==null)throw new Error("Null input. (diff_main)");if(e==n)return e?[new t.Diff(u,e)]:[];typeof a>"u"&&(a=!0);var s=a,c=this.diff_commonPrefix(e,n),d=e.substring(0,c);e=e.substring(c),n=n.substring(c),c=this.diff_commonSuffix(e,n);var h=e.substring(e.length-c);e=e.substring(0,e.length-c),n=n.substring(0,n.length-c);var g=this.diff_compute_(e,n,s,o);return d&&g.unshift(new t.Diff(u,d)),h&&g.push(new t.Diff(u,h)),this.diff_cleanupMerge(g),g},t.prototype.diff_compute_=function(e,n,a,i){var o;if(!e)return[new t.Diff(f,n)];if(!n)return[new t.Diff(l,e)];var s=e.length>n.length?e:n,c=e.length>n.length?n:e,d=s.indexOf(c);if(d!=-1)return o=[new t.Diff(f,s.substring(0,d)),new t.Diff(u,c),new t.Diff(f,s.substring(d+c.length))],e.length>n.length&&(o[0][0]=o[2][0]=l),o;if(c.length==1)return[new t.Diff(l,e),new t.Diff(f,n)];var h=this.diff_halfMatch_(e,n);if(h){var g=h[0],m=h[1],p=h[2],y=h[3],v=h[4],_=this.diff_main(g,p,a,i),b=this.diff_main(m,y,a,i);return _.concat([new t.Diff(u,v)],b)}return a&&e.length>100&&n.length>100?this.diff_lineMode_(e,n,i):this.diff_bisect_(e,n,i)},t.prototype.diff_lineMode_=function(e,n,a){var i=this.diff_linesToChars_(e,n);e=i.chars1,n=i.chars2;var o=i.lineArray,s=this.diff_main(e,n,!1,a);this.diff_charsToLines_(s,o),this.diff_cleanupSemantic(s),s.push(new t.Diff(u,""));for(var c=0,d=0,h=0,g="",m="";c<s.length;){switch(s[c][0]){case f:h++,m+=s[c][1];break;case l:d++,g+=s[c][1];break;case u:if(d>=1&&h>=1){s.splice(c-d-h,d+h),c=c-d-h;for(var p=this.diff_main(g,m,!1,a),y=p.length-1;y>=0;y--)s.splice(c,0,p[y]);c=c+p.length}h=0,d=0,g="",m="";break}c++}return s.pop(),s},t.prototype.diff_bisect_=function(e,n,a){for(var i=e.length,o=n.length,s=Math.ceil((i+o)/2),c=s,d=2*s,h=new Array(d),g=new Array(d),m=0;m<d;m++)h[m]=-1,g[m]=-1;h[c+1]=0,g[c+1]=0;for(var p=i-o,y=p%2!=0,v=0,_=0,b=0,I=0,A=0;A<s&&!(new Date().getTime()>a);A++){for(var E=-A+v;E<=A-_;E+=2){var S=c+E,k;E==-A||E!=A&&h[S-1]<h[S+1]?k=h[S+1]:k=h[S-1]+1;for(var D=k-E;k<i&&D<o&&e.charAt(k)==n.charAt(D);)k++,D++;if(h[S]=k,k>i)_+=2;else if(D>o)v+=2;else if(y){var M=c+p-E;if(M>=0&&M<d&&g[M]!=-1){var C=i-g[M];if(k>=C)return this.diff_bisectSplit_(e,n,k,D,a)}}}for(var R=-A+b;R<=A-I;R+=2){var M=c+R,C;R==-A||R!=A&&g[M-1]<g[M+1]?C=g[M+1]:C=g[M-1]+1;for(var N=C-R;C<i&&N<o&&e.charAt(i-C-1)==n.charAt(o-N-1);)C++,N++;if(g[M]=C,C>i)I+=2;else if(N>o)b+=2;else if(!y){var S=c+p-R;if(S>=0&&S<d&&h[S]!=-1){var k=h[S],D=c+k-S;if(C=i-C,k>=C)return this.diff_bisectSplit_(e,n,k,D,a)}}}}return[new t.Diff(l,e),new t.Diff(f,n)]},t.prototype.diff_bisectSplit_=function(e,n,a,i,o){var s=e.substring(0,a),c=n.substring(0,i),d=e.substring(a),h=n.substring(i),g=this.diff_main(s,c,!1,o),m=this.diff_main(d,h,!1,o);return g.concat(m)},t.prototype.diff_linesToChars_=function(e,n){var a=[],i={};a[0]="";function o(h){for(var g="",m=0,p=-1,y=a.length;p<h.length-1;){p=h.indexOf(`
`,m),p==-1&&(p=h.length-1);var v=h.substring(m,p+1);(i.hasOwnProperty?i.hasOwnProperty(v):i[v]!==void 0)?g+=String.fromCharCode(i[v]):(y==s&&(v=h.substring(m),p=h.length),g+=String.fromCharCode(y),i[v]=y,a[y++]=v),m=p+1}return g}var s=4e4,c=o(e);s=65535;var d=o(n);return{chars1:c,chars2:d,lineArray:a}},t.prototype.diff_charsToLines_=function(e,n){for(var a=0;a<e.length;a++){for(var i=e[a][1],o=[],s=0;s<i.length;s++)o[s]=n[i.charCodeAt(s)];e[a][1]=o.join("")}},t.prototype.diff_commonPrefix=function(e,n){if(!e||!n||e.charAt(0)!=n.charAt(0))return 0;for(var a=0,i=Math.min(e.length,n.length),o=i,s=0;a<o;)e.substring(s,o)==n.substring(s,o)?(a=o,s=a):i=o,o=Math.floor((i-a)/2+a);return o},t.prototype.diff_commonSuffix=function(e,n){if(!e||!n||e.charAt(e.length-1)!=n.charAt(n.length-1))return 0;for(var a=0,i=Math.min(e.length,n.length),o=i,s=0;a<o;)e.substring(e.length-o,e.length-s)==n.substring(n.length-o,n.length-s)?(a=o,s=a):i=o,o=Math.floor((i-a)/2+a);return o},t.prototype.diff_commonOverlap_=function(e,n){var a=e.length,i=n.length;if(a==0||i==0)return 0;a>i?e=e.substring(a-i):a<i&&(n=n.substring(0,a));var o=Math.min(a,i);if(e==n)return o;for(var s=0,c=1;;){var d=e.substring(o-c),h=n.indexOf(d);if(h==-1)return s;c+=h,(h==0||e.substring(o-c)==n.substring(0,c))&&(s=c,c++)}},t.prototype.diff_halfMatch_=function(e,n){if(this.Diff_Timeout<=0)return null;var a=e.length>n.length?e:n,i=e.length>n.length?n:e;if(a.length<4||i.length*2<a.length)return null;var o=this;function s(_,b,I){for(var A=_.substring(I,I+Math.floor(_.length/4)),E=-1,S="",k,D,M,C;(E=b.indexOf(A,E+1))!=-1;){var R=o.diff_commonPrefix(_.substring(I),b.substring(E)),N=o.diff_commonSuffix(_.substring(0,I),b.substring(0,E));S.length<N+R&&(S=b.substring(E-N,E)+b.substring(E,E+R),k=_.substring(0,I-N),D=_.substring(I+R),M=b.substring(0,E-N),C=b.substring(E+R))}return S.length*2>=_.length?[k,D,M,C,S]:null}var c=s(a,i,Math.ceil(a.length/4)),d=s(a,i,Math.ceil(a.length/2)),h;if(!c&&!d)return null;d?c?h=c[4].length>d[4].length?c:d:h=d:h=c;var g,m,p,y;e.length>n.length?(g=h[0],m=h[1],p=h[2],y=h[3]):(p=h[0],y=h[1],g=h[2],m=h[3]);var v=h[4];return[g,m,p,y,v]},t.prototype.diff_cleanupSemantic=function(e){for(var n=!1,a=[],i=0,o=null,s=0,c=0,d=0,h=0,g=0;s<e.length;)e[s][0]==u?(a[i++]=s,c=h,d=g,h=0,g=0,o=e[s][1]):(e[s][0]==f?h+=e[s][1].length:g+=e[s][1].length,o&&o.length<=Math.max(c,d)&&o.length<=Math.max(h,g)&&(e.splice(a[i-1],0,new t.Diff(l,o)),e[a[i-1]+1][0]=f,i--,i--,s=i>0?a[i-1]:-1,c=0,d=0,h=0,g=0,o=null,n=!0)),s++;for(n&&this.diff_cleanupMerge(e),this.diff_cleanupSemanticLossless(e),s=1;s<e.length;){if(e[s-1][0]==l&&e[s][0]==f){var m=e[s-1][1],p=e[s][1],y=this.diff_commonOverlap_(m,p),v=this.diff_commonOverlap_(p,m);y>=v?(y>=m.length/2||y>=p.length/2)&&(e.splice(s,0,new t.Diff(u,p.substring(0,y))),e[s-1][1]=m.substring(0,m.length-y),e[s+1][1]=p.substring(y),s++):(v>=m.length/2||v>=p.length/2)&&(e.splice(s,0,new t.Diff(u,m.substring(0,v))),e[s-1][0]=f,e[s-1][1]=p.substring(0,p.length-v),e[s+1][0]=l,e[s+1][1]=m.substring(v),s++),s++}s++}},t.prototype.diff_cleanupSemanticLossless=function(e){function n(v,_){if(!v||!_)return 6;var b=v.charAt(v.length-1),I=_.charAt(0),A=b.match(t.nonAlphaNumericRegex_),E=I.match(t.nonAlphaNumericRegex_),S=A&&b.match(t.whitespaceRegex_),k=E&&I.match(t.whitespaceRegex_),D=S&&b.match(t.linebreakRegex_),M=k&&I.match(t.linebreakRegex_),C=D&&v.match(t.blanklineEndRegex_),R=M&&_.match(t.blanklineStartRegex_);return C||R?5:D||M?4:A&&!S&&k?3:S||k?2:A||E?1:0}for(var a=1;a<e.length-1;){if(e[a-1][0]==u&&e[a+1][0]==u){var i=e[a-1][1],o=e[a][1],s=e[a+1][1],c=this.diff_commonSuffix(i,o);if(c){var d=o.substring(o.length-c);i=i.substring(0,i.length-c),o=d+o.substring(0,o.length-c),s=d+s}for(var h=i,g=o,m=s,p=n(i,o)+n(o,s);o.charAt(0)===s.charAt(0);){i+=o.charAt(0),o=o.substring(1)+s.charAt(0),s=s.substring(1);var y=n(i,o)+n(o,s);y>=p&&(p=y,h=i,g=o,m=s)}e[a-1][1]!=h&&(h?e[a-1][1]=h:(e.splice(a-1,1),a--),e[a][1]=g,m?e[a+1][1]=m:(e.splice(a+1,1),a--))}a++}},t.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,t.whitespaceRegex_=/\s/,t.linebreakRegex_=/[\r\n]/,t.blanklineEndRegex_=/\n\r?\n$/,t.blanklineStartRegex_=/^\r?\n\r?\n/,t.prototype.diff_cleanupEfficiency=function(e){for(var n=!1,a=[],i=0,o=null,s=0,c=!1,d=!1,h=!1,g=!1;s<e.length;)e[s][0]==u?(e[s][1].length<this.Diff_EditCost&&(h||g)?(a[i++]=s,c=h,d=g,o=e[s][1]):(i=0,o=null),h=g=!1):(e[s][0]==l?g=!0:h=!0,o&&(c&&d&&h&&g||o.length<this.Diff_EditCost/2&&c+d+h+g==3)&&(e.splice(a[i-1],0,new t.Diff(l,o)),e[a[i-1]+1][0]=f,i--,o=null,c&&d?(h=g=!0,i=0):(i--,s=i>0?a[i-1]:-1,h=g=!1),n=!0)),s++;n&&this.diff_cleanupMerge(e)},t.prototype.diff_cleanupMerge=function(e){e.push(new t.Diff(u,""));for(var n=0,a=0,i=0,o="",s="",c;n<e.length;)switch(e[n][0]){case f:i++,s+=e[n][1],n++;break;case l:a++,o+=e[n][1],n++;break;case u:a+i>1?(a!==0&&i!==0&&(c=this.diff_commonPrefix(s,o),c!==0&&(n-a-i>0&&e[n-a-i-1][0]==u?e[n-a-i-1][1]+=s.substring(0,c):(e.splice(0,0,new t.Diff(u,s.substring(0,c))),n++),s=s.substring(c),o=o.substring(c)),c=this.diff_commonSuffix(s,o),c!==0&&(e[n][1]=s.substring(s.length-c)+e[n][1],s=s.substring(0,s.length-c),o=o.substring(0,o.length-c))),n-=a+i,e.splice(n,a+i),o.length&&(e.splice(n,0,new t.Diff(l,o)),n++),s.length&&(e.splice(n,0,new t.Diff(f,s)),n++),n++):n!==0&&e[n-1][0]==u?(e[n-1][1]+=e[n][1],e.splice(n,1)):n++,i=0,a=0,o="",s="";break}e[e.length-1][1]===""&&e.pop();var d=!1;for(n=1;n<e.length-1;)e[n-1][0]==u&&e[n+1][0]==u&&(e[n][1].substring(e[n][1].length-e[n-1][1].length)==e[n-1][1]?(e[n][1]=e[n-1][1]+e[n][1].substring(0,e[n][1].length-e[n-1][1].length),e[n+1][1]=e[n-1][1]+e[n+1][1],e.splice(n-1,1),d=!0):e[n][1].substring(0,e[n+1][1].length)==e[n+1][1]&&(e[n-1][1]+=e[n+1][1],e[n][1]=e[n][1].substring(e[n+1][1].length)+e[n+1][1],e.splice(n+1,1),d=!0)),n++;d&&this.diff_cleanupMerge(e)},t.prototype.diff_xIndex=function(e,n){var a=0,i=0,o=0,s=0,c;for(c=0;c<e.length&&(e[c][0]!==f&&(a+=e[c][1].length),e[c][0]!==l&&(i+=e[c][1].length),!(a>n));c++)o=a,s=i;return e.length!=c&&e[c][0]===l?s:s+(n-o)},t.prototype.diff_prettyHtml=function(e){for(var n=[],a=/&/g,i=/</g,o=/>/g,s=/\n/g,c=0;c<e.length;c++){var d=e[c][0],h=e[c][1],g=h.replace(a,"&amp;").replace(i,"&lt;").replace(o,"&gt;").replace(s,"&para;<br>");switch(d){case f:n[c]='<ins style="background:#e6ffe6;">'+g+"</ins>";break;case l:n[c]='<del style="background:#ffe6e6;">'+g+"</del>";break;case u:n[c]="<span>"+g+"</span>";break}}return n.join("")},t.prototype.diff_text1=function(e){for(var n=[],a=0;a<e.length;a++)e[a][0]!==f&&(n[a]=e[a][1]);return n.join("")},t.prototype.diff_text2=function(e){for(var n=[],a=0;a<e.length;a++)e[a][0]!==l&&(n[a]=e[a][1]);return n.join("")},t.prototype.diff_levenshtein=function(e){for(var n=0,a=0,i=0,o=0;o<e.length;o++){var s=e[o][0],c=e[o][1];switch(s){case f:a+=c.length;break;case l:i+=c.length;break;case u:n+=Math.max(a,i),a=0,i=0;break}}return n+=Math.max(a,i),n},t.prototype.diff_toDelta=function(e){for(var n=[],a=0;a<e.length;a++)switch(e[a][0]){case f:n[a]="+"+encodeURI(e[a][1]);break;case l:n[a]="-"+e[a][1].length;break;case u:n[a]="="+e[a][1].length;break}return n.join("	").replace(/%20/g," ")},t.prototype.diff_fromDelta=function(e,n){for(var a=[],i=0,o=0,s=n.split(/\t/g),c=0;c<s.length;c++){var d=s[c].substring(1);switch(s[c].charAt(0)){case"+":try{a[i++]=new t.Diff(f,decodeURI(d))}catch{throw new Error("Illegal escape in diff_fromDelta: "+d)}break;case"-":case"=":var h=parseInt(d,10);if(isNaN(h)||h<0)throw new Error("Invalid number in diff_fromDelta: "+d);var g=e.substring(o,o+=h);s[c].charAt(0)=="="?a[i++]=new t.Diff(u,g):a[i++]=new t.Diff(l,g);break;default:if(s[c])throw new Error("Invalid diff operation in diff_fromDelta: "+s[c])}}if(o!=e.length)throw new Error("Delta length ("+o+") does not equal source text length ("+e.length+").");return a},t.prototype.match_main=function(e,n,a){if(e==null||n==null||a==null)throw new Error("Null input. (match_main)");return a=Math.max(0,Math.min(a,e.length)),e==n?0:e.length?e.substring(a,a+n.length)==n?a:this.match_bitap_(e,n,a):-1},t.prototype.match_bitap_=function(e,n,a){if(n.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var i=this.match_alphabet_(n),o=this;function s(k,D){var M=k/n.length,C=Math.abs(a-D);return o.Match_Distance?M+C/o.Match_Distance:C?1:M}var c=this.Match_Threshold,d=e.indexOf(n,a);d!=-1&&(c=Math.min(s(0,d),c),d=e.lastIndexOf(n,a+n.length),d!=-1&&(c=Math.min(s(0,d),c)));var h=1<<n.length-1;d=-1;for(var g,m,p=n.length+e.length,y,v=0;v<n.length;v++){for(g=0,m=p;g<m;)s(v,a+m)<=c?g=m:p=m,m=Math.floor((p-g)/2+g);p=m;var _=Math.max(1,a-m+1),b=Math.min(a+m,e.length)+n.length,I=Array(b+2);I[b+1]=(1<<v)-1;for(var A=b;A>=_;A--){var E=i[e.charAt(A-1)];if(v===0?I[A]=(I[A+1]<<1|1)&E:I[A]=(I[A+1]<<1|1)&E|((y[A+1]|y[A])<<1|1)|y[A+1],I[A]&h){var S=s(v,A-1);if(S<=c)if(c=S,d=A-1,d>a)_=Math.max(1,2*a-d);else break}}if(s(v+1,a)>c)break;y=I}return d},t.prototype.match_alphabet_=function(e){for(var n={},a=0;a<e.length;a++)n[e.charAt(a)]=0;for(var a=0;a<e.length;a++)n[e.charAt(a)]|=1<<e.length-a-1;return n},t.prototype.patch_addContext_=function(e,n){if(n.length!=0){if(e.start2===null)throw Error("patch not initialized");for(var a=n.substring(e.start2,e.start2+e.length1),i=0;n.indexOf(a)!=n.lastIndexOf(a)&&a.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)i+=this.Patch_Margin,a=n.substring(e.start2-i,e.start2+e.length1+i);i+=this.Patch_Margin;var o=n.substring(e.start2-i,e.start2);o&&e.diffs.unshift(new t.Diff(u,o));var s=n.substring(e.start2+e.length1,e.start2+e.length1+i);s&&e.diffs.push(new t.Diff(u,s)),e.start1-=o.length,e.start2-=o.length,e.length1+=o.length+s.length,e.length2+=o.length+s.length}},t.prototype.patch_make=function(e,n,a){var i,o;if(typeof e=="string"&&typeof n=="string"&&typeof a>"u")i=e,o=this.diff_main(i,n,!0),o.length>2&&(this.diff_cleanupSemantic(o),this.diff_cleanupEfficiency(o));else if(e&&typeof e=="object"&&typeof n>"u"&&typeof a>"u")o=e,i=this.diff_text1(o);else if(typeof e=="string"&&n&&typeof n=="object"&&typeof a>"u")i=e,o=n;else if(typeof e=="string"&&typeof n=="string"&&a&&typeof a=="object")i=e,o=a;else throw new Error("Unknown call format to patch_make.");if(o.length===0)return[];for(var s=[],c=new t.patch_obj,d=0,h=0,g=0,m=i,p=i,y=0;y<o.length;y++){var v=o[y][0],_=o[y][1];switch(!d&&v!==u&&(c.start1=h,c.start2=g),v){case f:c.diffs[d++]=o[y],c.length2+=_.length,p=p.substring(0,g)+_+p.substring(g);break;case l:c.length1+=_.length,c.diffs[d++]=o[y],p=p.substring(0,g)+p.substring(g+_.length);break;case u:_.length<=2*this.Patch_Margin&&d&&o.length!=y+1?(c.diffs[d++]=o[y],c.length1+=_.length,c.length2+=_.length):_.length>=2*this.Patch_Margin&&d&&(this.patch_addContext_(c,m),s.push(c),c=new t.patch_obj,d=0,m=p,h=g);break}v!==f&&(h+=_.length),v!==l&&(g+=_.length)}return d&&(this.patch_addContext_(c,m),s.push(c)),s},t.prototype.patch_deepCopy=function(e){for(var n=[],a=0;a<e.length;a++){var i=e[a],o=new t.patch_obj;o.diffs=[];for(var s=0;s<i.diffs.length;s++)o.diffs[s]=new t.Diff(i.diffs[s][0],i.diffs[s][1]);o.start1=i.start1,o.start2=i.start2,o.length1=i.length1,o.length2=i.length2,n[a]=o}return n},t.prototype.patch_apply=function(e,n){if(e.length==0)return[n,[]];e=this.patch_deepCopy(e);var a=this.patch_addPadding(e);n=a+n+a,this.patch_splitMax(e);for(var i=0,o=[],s=0;s<e.length;s++){var c=e[s].start2+i,d=this.diff_text1(e[s].diffs),h,g=-1;if(d.length>this.Match_MaxBits?(h=this.match_main(n,d.substring(0,this.Match_MaxBits),c),h!=-1&&(g=this.match_main(n,d.substring(d.length-this.Match_MaxBits),c+d.length-this.Match_MaxBits),(g==-1||h>=g)&&(h=-1))):h=this.match_main(n,d,c),h==-1)o[s]=!1,i-=e[s].length2-e[s].length1;else{o[s]=!0,i=h-c;var m;if(g==-1?m=n.substring(h,h+d.length):m=n.substring(h,g+this.Match_MaxBits),d==m)n=n.substring(0,h)+this.diff_text2(e[s].diffs)+n.substring(h+d.length);else{var p=this.diff_main(d,m,!1);if(d.length>this.Match_MaxBits&&this.diff_levenshtein(p)/d.length>this.Patch_DeleteThreshold)o[s]=!1;else{this.diff_cleanupSemanticLossless(p);for(var y=0,v,_=0;_<e[s].diffs.length;_++){var b=e[s].diffs[_];b[0]!==u&&(v=this.diff_xIndex(p,y)),b[0]===f?n=n.substring(0,h+v)+b[1]+n.substring(h+v):b[0]===l&&(n=n.substring(0,h+v)+n.substring(h+this.diff_xIndex(p,y+b[1].length))),b[0]!==l&&(y+=b[1].length)}}}}}return n=n.substring(a.length,n.length-a.length),[n,o]},t.prototype.patch_addPadding=function(e){for(var n=this.Patch_Margin,a="",i=1;i<=n;i++)a+=String.fromCharCode(i);for(var i=0;i<e.length;i++)e[i].start1+=n,e[i].start2+=n;var o=e[0],s=o.diffs;if(s.length==0||s[0][0]!=u)s.unshift(new t.Diff(u,a)),o.start1-=n,o.start2-=n,o.length1+=n,o.length2+=n;else if(n>s[0][1].length){var c=n-s[0][1].length;s[0][1]=a.substring(s[0][1].length)+s[0][1],o.start1-=c,o.start2-=c,o.length1+=c,o.length2+=c}if(o=e[e.length-1],s=o.diffs,s.length==0||s[s.length-1][0]!=u)s.push(new t.Diff(u,a)),o.length1+=n,o.length2+=n;else if(n>s[s.length-1][1].length){var c=n-s[s.length-1][1].length;s[s.length-1][1]+=a.substring(0,c),o.length1+=c,o.length2+=c}return a},t.prototype.patch_splitMax=function(e){for(var n=this.Match_MaxBits,a=0;a<e.length;a++)if(!(e[a].length1<=n)){var i=e[a];e.splice(a--,1);for(var o=i.start1,s=i.start2,c="";i.diffs.length!==0;){var d=new t.patch_obj,h=!0;for(d.start1=o-c.length,d.start2=s-c.length,c!==""&&(d.length1=d.length2=c.length,d.diffs.push(new t.Diff(u,c)));i.diffs.length!==0&&d.length1<n-this.Patch_Margin;){var g=i.diffs[0][0],m=i.diffs[0][1];g===f?(d.length2+=m.length,s+=m.length,d.diffs.push(i.diffs.shift()),h=!1):g===l&&d.diffs.length==1&&d.diffs[0][0]==u&&m.length>2*n?(d.length1+=m.length,o+=m.length,h=!1,d.diffs.push(new t.Diff(g,m)),i.diffs.shift()):(m=m.substring(0,n-d.length1-this.Patch_Margin),d.length1+=m.length,o+=m.length,g===u?(d.length2+=m.length,s+=m.length):h=!1,d.diffs.push(new t.Diff(g,m)),m==i.diffs[0][1]?i.diffs.shift():i.diffs[0][1]=i.diffs[0][1].substring(m.length))}c=this.diff_text2(d.diffs),c=c.substring(c.length-this.Patch_Margin);var p=this.diff_text1(i.diffs).substring(0,this.Patch_Margin);p!==""&&(d.length1+=p.length,d.length2+=p.length,d.diffs.length!==0&&d.diffs[d.diffs.length-1][0]===u?d.diffs[d.diffs.length-1][1]+=p:d.diffs.push(new t.Diff(u,p))),h||e.splice(++a,0,d)}}},t.prototype.patch_toText=function(e){for(var n=[],a=0;a<e.length;a++)n[a]=e[a];return n.join("")},t.prototype.patch_fromText=function(e){var n=[];if(!e)return n;for(var a=e.split(`
`),i=0,o=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;i<a.length;){var s=a[i].match(o);if(!s)throw new Error("Invalid patch string: "+a[i]);var c=new t.patch_obj;for(n.push(c),c.start1=parseInt(s[1],10),s[2]===""?(c.start1--,c.length1=1):s[2]=="0"?c.length1=0:(c.start1--,c.length1=parseInt(s[2],10)),c.start2=parseInt(s[3],10),s[4]===""?(c.start2--,c.length2=1):s[4]=="0"?c.length2=0:(c.start2--,c.length2=parseInt(s[4],10)),i++;i<a.length;){var d=a[i].charAt(0);try{var h=decodeURI(a[i].substring(1))}catch{throw new Error("Illegal escape in patch_fromText: "+h)}if(d=="-")c.diffs.push(new t.Diff(l,h));else if(d=="+")c.diffs.push(new t.Diff(f,h));else if(d==" ")c.diffs.push(new t.Diff(u,h));else{if(d=="@")break;if(d!=="")throw new Error('Invalid patch mode "'+d+'" in: '+h)}i++}}return n},t.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},t.patch_obj.prototype.toString=function(){var e,n;this.length1===0?e=this.start1+",0":this.length1==1?e=this.start1+1:e=this.start1+1+","+this.length1,this.length2===0?n=this.start2+",0":this.length2==1?n=this.start2+1:n=this.start2+1+","+this.length2;for(var a=["@@ -"+e+" +"+n+` @@
`],i,o=0;o<this.diffs.length;o++){switch(this.diffs[o][0]){case f:i="+";break;case l:i="-";break;case u:i=" ";break}a[o+1]=i+encodeURI(this.diffs[o][1])+`
`}return a.join("").replace(/%20/g," ")},r.exports=t,r.exports.diff_match_patch=t,r.exports.DIFF_DELETE=l,r.exports.DIFF_INSERT=f,r.exports.DIFF_EQUAL=u})(ye)),ye.exports}var Kt=Ht();const Vt=Ut(Kt);async function ve(){return await Word.run(async r=>{const t=r.document.body;return t.load("text"),await r.sync(),(t.text||"").trim()})}async function qt(){return await Word.run(async r=>{const t=r.document.getSelection();return t.load("text"),await r.sync(),(t.text||"").trim()})}var Ve={};const _e=globalThis,be=_e.OfficeExtension,qe="build-20250912-195756";console.log("ContractAI build",qe);let Je=null,Ye="1",Qe="1";try{Je=localStorage.getItem("cai_timeout_ms:analyze"),Ye=localStorage.getItem("cai_abort_on_hidden")||"1",Qe=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:Je,abort_on_hidden:Ye,abort_on_navigation:Qe}),!qe.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const r=document.createElement("div");r.textContent="FATAL: stale bundle",r.style.padding="12px",r.style.color="#f66",document.body.innerHTML="",document.body.appendChild(r),document.querySelectorAll("button").forEach(t=>{t.disabled=!0})}catch{}});const Xe=(()=>{const r=_e.ENV_MODE||(typeof process<"u"?Ve?.ENV_MODE:void 0);return r?r==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();be&&be.config&&(Xe==="dev"||_e.__ENABLE_EXTENDED_LOGS__)&&(be.config.extendedErrorLogging=!0);function G(r,t="Word"){try{const l=r&&r.debugInfo||{};console.error(`[${t}] RichApi error`,{code:r.code,message:r.message,errorLocation:l.errorLocation,statements:l.statements,traceMessages:l.traceMessages,inner:l.innerError})}catch{}}function re(r){return(ze(r)||[]).filter(l=>l&&l.rule_id&&l.snippet).map(l=>({...l,clause_type:l.clause_type||"Unknown"})).filter(l=>l.clause_type)}const T=globalThis;T.parseFindings=T.parseFindings||re,T.applyMetaToBadges=T.applyMetaToBadges||de,T.getApiKeyFromStore=T.getApiKeyFromStore||q,T.getSchemaFromStore=T.getSchemaFromStore||j,T.logRichError=T.logRichError||G,T.getWholeDocText=T.getWholeDocText||ve,T.getSelectionText=T.getSelectionText||qt;const Ge=T.__appliedRangeHashes||new Set;T.__appliedRangeHashes=Ge;let we="live";const P={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let Ae="",Ze=!1,Ee=!1;const Jt=Bt.required_ids||[];function w(r){const t=document.getElementById(r);if(!t)throw new Error(`missing element #${r}`);return t}function Ie(r,t){const l=w("status-chip"),f=(r??j())||"—",u=(t??Ae)||"—";l.textContent=`schema: ${f} | cid: ${u}`}function xe(){const r=w("anchorsBadge"),t=globalThis.__anchorsSkipped||0;r.style.display=t>0?"":"none"}T.updateAnchorBadge=T.updateAnchorBadge||xe;function Yt(){if(Ze)return;O("#btnAnalyze",pn);const r=w("btnAnalyze");r.disabled=!1,Ze=!0,console.log("[PANEL] analyze enabled")}function et(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function Qt(){const t=w("backendUrl").value.trim();if(t)try{localStorage.setItem("backend.url",t),localStorage.setItem("backendUrl",t)}catch{}location.reload()}function Se(){let r=q(),t=j();const l=w("hdrWarn"),f=globalThis?.location?.hostname??"",u=f==="localhost"||f==="127.0.0.1";if(u&&(r||(r="local-test-key-123",Oe(r)),!t)){const e=globalThis?.SCHEMA_VERSION||typeof process<"u"&&Ve?.SCHEMA_VERSION||"1.4";t=String(e),J(t)}return!r&&!t&&!u?l.style.display="":l.style.display="none",(!r||!t)&&console.warn("missing headers",{apiKey:!!r,schema:!!t}),!0}function W(r,t){const l=document.querySelector(`[data-role="${t}"]`);return l||w(r)}function Te(){const t=w("selectRiskThreshold").value.toLowerCase();return t==="low"||t==="medium"||t==="high"?t:"medium"}function tt(){const r=gt();try{const t=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();return t.checked=r,!!t.checked}catch{return r}}function Xt(r){mt(r)}function ke(r,t){const l=te(t);return(r||[]).filter(f=>f&&f.rule_id&&f.snippet).map(f=>({...f,clause_type:f.clause_type||"Unknown"})).filter(f=>te(f.severity)>=l)}T.annotateFindingsIntoWord=T.annotateFindingsIntoWord||Ue;async function Gt(){try{await Word.run(async r=>{const t=r.document.body,l=r.document.comments,f=typeof t.search=="function"?t.search(K,{matchCase:!1}):null;if(l&&typeof l.load=="function"&&l.load("items"),f&&typeof f.load=="function"&&f.load("items"),await r.sync(),l?.items)for(const u of l.items)try{(u.text||"").startsWith(K)&&u.delete()}catch{}if(f?.items&&f.items.length)for(const u of f.items)try{u.insertText("",Word.InsertLocation.replace)}catch{}try{t.font.highlightColor="NoColor"}catch{}await r.sync()}),H("Annotations cleared")}catch(r){G(r,"annotate"),L("Failed to clear annotations")}}function Zt(r,t){const l=new Vt,f=i=>i.match(/\S+|\s+/g)||[],{chars1:u,chars2:e,tokenArray:n}=xt(f(r),f(t));let a=l.diff_main(u,e);return l.diff_cleanupSemantic(a),a.map(([i,o])=>[i,o.split("").map(s=>n[s.charCodeAt(0)]).join("")])}function xt(r,t){const l=[],f=new Map,u=a=>f.has(a)?String.fromCharCode(f.get(a)):(l.push(a),f.set(a,l.length-1),String.fromCharCode(l.length-1)),e=r.map(u).join(""),n=t.map(u).join("");return{chars1:e,chars2:n,tokenArray:l}}async function nt(r){return Q(async()=>{let t=(r||[]).filter(u=>typeof u.start=="number"&&typeof u.end=="number"&&u.end>u.start).sort((u,e)=>u.start-e.start),l=-1;if(t=t.filter(u=>u.start<l?!1:(l=u.end,!0)),!t.length)return;const f=window.__lastAnalyzed||"";await Word.run(async u=>{const e=u.document.body;u.document.trackRevisions=!0;const n={matchCase:!1,matchWholeWord:!1},a=(i,o)=>{const s=i?.items||[];return s.length&&s[Math.min(Math.max(o,0),s.length-1)]||null};for(const i of t){const o=`${i.start}:${i.end}:${i.replacement}`;if(Ge.has(o))continue;const s=f.slice(i.start,i.end),c=(()=>{let h=-1,g=0;for(;(h=f.indexOf(s,h+1))!==-1&&h<i.start;)g++;return g})();let d=null;if(i.context_before||i.context_after){const h=`${i.context_before||""}${s}${i.context_after||""}`,g=await ne(e,h,n),m=a(g,c);if(m){const p=s.slice(0,240),y=m.search(p,n);y&&typeof y.load=="function"&&y.load("items"),await u.sync(),d=a(y,0)}}if(!d){const h=await ne(e,s,n);d=a(h,c)}if(!d){const h=(()=>{const g=s.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(m=>m.length>=12);return g.length?g.sort((m,p)=>p.length-m.length)[0].slice(0,64):null})();if(h){const g=await ne(e,h,n);d=a(g,0)}}if(d){const h=Zt(s,i.replacement);let g=d.getRange("Start");for(const[p,y]of h)if(y)if(p===0){const _=g.getRange("After").search(y,n);_&&typeof _.load=="function"&&_.load("items"),await u.sync();const b=a(_,0);b&&(g=b.getRange("After"))}else if(p===-1){const _=g.getRange("After").search(y,n);_&&typeof _.load=="function"&&_.load("items"),await u.sync();const b=a(_,0);b&&(b.insertText("","Replace"),g=b.getRange("After"))}else p===1&&(g=g.insertText(y,"Before").getRange("After"));const m=`${K} ${i.rationale||i.source||"AI edit"}`;try{await ge(d,m)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:s,occIdx:c});await u.sync()}})})}T.applyOpsTracked=T.applyOpsTracked||nt;function rt(r,t){if(t.__highlight){try{t.__highlight.font.highlightColor="NoColor"}catch{}r.trackedObjects.remove(t.__highlight),t.__highlight=null}}async function at(){const r=window;r.__highlight&&await Word.run(async t=>{rt(t,r),await t.sync()})}async function Ce(r){await Word.run(async t=>{const l=window;rt(t,l);const f=t.document.body;let u=await X(f,r.raw),e=u[Math.min(r.occIdx,u.length-1)]||null;if(!e&&r.normalized_fallback&&r.normalized_fallback!==r.norm&&(u=await X(f,r.normalized_fallback),e=u[Math.min(r.occIdx,u.length-1)]||null),e){l.__highlight=e,t.trackedObjects.add(e);try{e.select()}catch{}try{e.font.highlightColor="#ffff00"}catch{}}await t.sync()})}let Me=!1;async function st(r){if(Me)return;Me=!0;const t=window.__findings||[];if(!t.length){Me=!1;return}const l=document.getElementById("btnPrevIssue"),f=document.getElementById("btnNextIssue");l&&(l.disabled=!0),f&&(f.disabled=!0);const u=window;u.__findingIdx=(u.__findingIdx??0)+r,u.__findingIdx<0&&(u.__findingIdx=t.length-1),u.__findingIdx>=t.length&&(u.__findingIdx=0);const e=w("findingsList"),n=Array.from(e.querySelectorAll("li"));n.forEach((i,o)=>{i.classList.toggle("active",o===u.__findingIdx)});const a=n[u.__findingIdx];a&&a.scrollIntoView({block:"nearest"});try{await Ce(t[u.__findingIdx])}catch{}}function en(r){const t=window.__findings||[];if(!t.length)return;const l=t.findIndex(n=>n.rule_id===r||n.code===r);if(l<0)return;window.__findingIdx=l;const f=w("findingsList"),u=Array.from(f.querySelectorAll("li"));u.forEach((n,a)=>{n.classList.toggle("active",a===l)});const e=u[l];e&&e.scrollIntoView({block:"nearest"});try{Ce(t[l])}catch{}}async function tn(){await st(-1)}async function nn(){await st(1)}function ae(r){at().catch(()=>{});const t=r?.summary?.clause_type||r?.meta?.clause_type||r?.doc_type||"—",l=Array.isArray(r?.findings)?r.findings:[],f=Array.isArray(r?.recommendations)?r.recommendations:[],u=Te(),e=ke(l,u),n=e.length,a=l.length-n,i=(g,m)=>{w(g).textContent=m};i("clauseTypeOut",String(t)),i("resFindingsCount",String(l.length)),i("visibleHiddenOut",`${n} / ${a}`);const o=w("findingsBlock"),s=document.getElementById("findingsList");s&&(s.innerHTML="",e.forEach((g,m)=>{const p=document.createElement("li"),y=g?.title||g?.finding?.title||g?.rule_id||"Issue",v=g?.snippet||g?.evidence?.text||"";p.textContent=v?`${y}: ${v}`:String(y),p.addEventListener("click",()=>{Array.from(s.querySelectorAll("li")).forEach((I,A)=>{I.classList.toggle("active",A===m)}),window.__findingIdx=m,Ce(g).catch(()=>{})});const _=Array.isArray(g.links)?g.links.filter(b=>b?.type==="conflict"&&b?.targetFindingId):[];if(_.length){const b=document.createElement("div");b.textContent=`Conflicts: ${_.length} `,_.forEach((I,A)=>{const E=document.createElement("a");E.href="#",E.textContent="Jump to",E.addEventListener("click",S=>{S.preventDefault(),en(I.targetFindingId)}),b.appendChild(E),A<_.length-1&&b.append(" ")}),p.appendChild(b)}s.appendChild(p)})),o.style.display=e.length?"":"none";const c=w("recommendationsBlock"),d=document.getElementById("recommendationsList");if(d){d.innerHTML="";for(const g of f){const m=document.createElement("li");m.textContent=g?.text||g?.advice||g?.message||"Recommendation",d.appendChild(m)}}c.style.display=f.length?"":"none",w("resultsBlock").style.removeProperty("display")}function se(r){const t=W("resClauseType","clause-type");t.textContent=r?.clause_type||"—";const l=re(r);window.__findings=l,window.__findingIdx=0;const f=W("findingsList","findings");f&&(f.innerHTML="",l.forEach(s=>{const c=document.createElement("li");c.textContent=typeof s=="string"?s:JSON.stringify(s),f.appendChild(c)}));const u=w("findingsBlock");u.style.display=l.length?"":"none";const e=Array.isArray(r?.recommendations)?r.recommendations:[],n=W("recommendationsList","recommendations");n&&(n.innerHTML="",e.forEach(s=>{const c=document.createElement("li");c.textContent=typeof s=="string"?s:JSON.stringify(s),n.appendChild(c)}));const a=w("recommendationsBlock");a.style.display=e.length?"":"none";const i=W("resFindingsCount","findings-count");i.textContent=String(l.length);const o=W("rawJson","raw-json");o.textContent=JSON.stringify(r??{},null,2)}function rn(r){const t=window.__findings||[],l=re(r),f=je([...t,...l]);return{...r||{},findings:f}}function an(){const r=W("toggleRaw","toggle-raw-json"),t=W("rawJson","raw-json");t.style.display="none",r.addEventListener("click",()=>{t.style.display=t.style.display==="none"?"block":"none"})}function it(r){const t=w("connBadge");t.textContent=`Conn: ${r===null?"—":r?"✓":"×"}`}function De(r){const t=w("officeBadge");t.textContent=`Office: ${r??"—"}`}async function sn(){await Word.run(async r=>{const t=["Heading 1","Heading 2","Heading 3"];for(let l=0;l<t.length;l++){const f=r.document.body.paragraphs.getByStyle(t[l]);f.load("items"),await r.sync();for(const u of f.items)try{u.listFormat.removeNumbers(),u.listFormat.applyNumberedDefault(),u.listItem&&(u.listItem.level=l);const e=36*(l+1);u.paragraphFormat.leftIndent=e,u.paragraphFormat.firstLineIndent=-36,u.paragraphFormat.lineSpacing=240}catch(e){console.warn("fixNumbering",e)}}await r.sync()}).catch(r=>G(r,"fixNumbering"))}function z(r){return document.querySelector(r)}function on(){return(z(P.original)?.value||"").trim()}async function cn(){let r=on();if(r.length>=20)return r;try{if(r=(await globalThis.getSelectionText()||"").trim(),r.length>=20){const t=z(P.original);if(t){t.value=r;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return r}}catch{}return L("Please paste the original clause (min 20 chars) or select text in the document."),null}function ln(){try{return globalThis.detectContractType?.()||"unknown"}catch{return"unknown"}}function un(){try{const r=window.__findings||[];return Array.isArray(r)?r:[]}catch{return[]}}function fn(){try{return window.getSelectionOffsets?.()||null}catch{return null}}async function dn(r){const t=await cn();if(!t)return;const l={mode:r,clause:t,context:{law:"UK",language:"en-GB",contractType:ln()},findings:un().slice(0,10),selection:fn()};let f;try{f=await fetch("/api/gpt/draft",{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":q()||"","X-Schema-Version":"1.4"},body:JSON.stringify(l)})}catch(i){console.warn("Draft error",i),L("Draft error");return}if(!f.ok){const i=await f.text();console.warn(`Draft failed: ${f.status} ${i}`);return}const u=await f.json(),e=(u?.proposed_text??u?.text??"").toString(),n=z(P.proposed),a=window;if(a.__last=a.__last||{},a.__last["gpt-draft"]={json:u},n){n.id||(n.id="draftText"),n.name||(n.name="proposed"),n.dataset.role="proposed-text",n.value=e,n.dispatchEvent(new Event("input",{bubbles:!0})),H("Draft ready");try{await zt(e,we,u?.meta?.rationale)}catch{}Z(e)}else L("Proposed textarea not found"),Z("")}async function hn(){const r=z(P.original),t=await ve(),l=F(t||"");if(r){r.value=l;try{r.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const f=w("originalText");if(f!==r){f.value=l;try{f.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=l,window.toast?.("Whole doc loaded")}async function gn(r){return Q(()=>dn(we==="friendly"?"friendly":"strict"))}async function ot(){try{const r=j(),{resp:t,json:l,ok:f}=await Be({backend:et()}),u=t.headers.get("x-schema-version")||l?.schema||null;if(u&&(J(u),u!==r&&console.log(`schema: ${u} (synced)`)),it(f),f){console.log("[PANEL] health ok"),Yt(),Ie(u,null);try{de({cid:null,xcache:null,latencyMs:null,schema:u||null,provider:l?.provider||null,model:l?.model||null,llm_mode:null,usage:null,status:l?.status||null})}catch{}H(`Health: ${l?.status||"ok"}${u?` (schema ${u})`:""}`)}else L("Health failed")}catch(r){it(!1),L("Health failed"),console.error(r)}}async function mn(){const r=w("originalText");let t=F(r.value||"");if(!t){const l=w("btnAnalyze");l.disabled=!0;try{t=F(await globalThis.getWholeDocText()),r.value=t||""}catch{t=""}finally{l.disabled=!1}}return t?(window.__lastAnalyzed=t,t):(L("Document is empty"),null)}async function pn(){if(Ee){console.log("[PANEL] analyze in progress - ignoring click");return}for(const r of Y)if(r.__key==="/api/analyze"){console.log("[PANEL] pending /api/analyze fetch - ignoring click");return}Ee=!0;try{if(!await mn())return;await yn()}finally{Ee=!1}}async function yn(){return Q(async()=>{const r=w("btnAnalyze"),t=w("busyBar");r.disabled=!0,t.style.display="";try{Z("");const l=window.__lastAnalyzed;if(!l){Fe("В документе нет текста");return}Se();const{resp:f,json:u}=await Ot({text:l,mode:we});if(!f.ok)throw new Error(`HTTP ${f.status}`);const e=f.headers.get("x-schema-version");e&&J(e),u?.schema&&J(u.schema),Ae=f.headers.get("x-cid")||"",Ie(null,Ae),se(u),ae(u);try{localStorage.setItem("last_analysis_json",JSON.stringify(u))}catch{}try{const n=globalThis.parseFindings(u),a=Te(),i=ke(n,a),o=pe(i);window.__findings=o,window.__findingIdx=0;const s=document.getElementById("findingsList");if(s){const c=document.createDocumentFragment();o.forEach((d,h)=>{const g=document.createElement("li");g.textContent=`${d.rule_id}: ${d.raw}`,h===0&&g.classList.add("active"),c.appendChild(g)}),s.innerHTML="",s.appendChild(c)}tt()&&i.length&&await Ue(i)}catch(n){console.warn("auto-annotate after analyze failed",n)}w("results").dispatchEvent(new CustomEvent("ca.results",{detail:u})),H("Analyze OK")}catch(l){let f="";if(l?.name==="AbortError"){const u=l?.message||"";if(u.startsWith("timeout")){const e=parseInt(u.replace(/[^0-9]/g,""),10)||0;f=`(timeout ${Math.round(e/1e3)} s)`}else u==="pagehide/unload"?f="(aborted by pagehide)":f="(aborted)"}else typeof l?.message=="string"&&(l.message.includes("HTTP 504")?f="(HTTP 504)":l.message.includes("HTTP 413")?f="(payload too large 413)":l.message.includes("HTTP 401")?f="(unauthorized 401)":l.message.includes("HTTP 403")?f="(forbidden 403)":l.message.includes("HTTP 422")&&(f="(schema mismatch 422)"));L(`Analyze failed ${f}`.trim()),console.error(l)}finally{r.disabled=!1,t.style.display="none"}})}async function vn(){return Q(async()=>{await at(),Se();const r=await ve();window.__lastAnalyzed=r;const{json:t}=await ee("/api/qa-recheck",{text:r,rules:{}});if(w("results").dispatchEvent(new CustomEvent("ca.qa",{detail:t})),!t?.error){const f=window.__findings||[],u=window.__findingIdx??0,e=m=>m?.code||m?.rule_id||`${m?.rule_id}|${m?.raw||m?.snippet||""}`,n=f[u]?e(f[u]):null,a=re(t),i=Te(),o=ke(a,i),s=pe(o),c=new Map;s.forEach(m=>{const p=e(m);p&&!c.has(p)&&c.set(p,m)});const d=Array.from(c.values());window.__findings=d;let h=0;if(n){const m=d.findIndex(p=>e(p)===n);m>=0&&(h=m)}h>=d.length&&(h=0),window.__findingIdx=h;const g=document.getElementById("findingsList");if(g){const m=document.createDocumentFragment();d.forEach((p,y)=>{const v=document.createElement("li");v.textContent=`${p.rule_id}: ${p.raw}`,y===h&&v.classList.add("active"),m.appendChild(v)}),g.innerHTML="",g.appendChild(m)}H("QA recheck OK")}else{const f=t?.error||t?.message||"unknown";Fe(`QA recheck failed: ${f}`)}})}function O(r,t){const l=document.querySelector(r);l&&(l.addEventListener("click",f=>{f.preventDefault(),t()}),l.classList.remove("js-disable-while-busy"),l.removeAttribute("disabled"))}async function _n(){try{const r=window.__lastAnalyzed||"",t=(z(P.proposed)?.value||"").trim();if(!t){L("No draft to diff");return}const l=await $t(r,t),f=l?.json?.html||l?.json?.diff_html||l?.json?.redlines||"",u=w("diffOutput"),e=w("diffContainer");u.innerHTML=f||"",e.style.display=f?"block":"none"}catch(r){L("Diff failed"),console.error(r)}}async function bn(){try{const r=window.__last||{},t=r["gpt-draft"]?.json?.ops||r.suggest?.json?.ops||[];if(!t.length){L("No ops to apply");return}await nt(t),H("Applied ops")}catch(r){L("Insert failed"),console.error(r)}}async function wn(){try{const t=(z(P.proposed)?.value||"").trim();if(!t){window.toast?.("Nothing to accept");return}const l=(w("cid").textContent||"").trim(),f=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),u=l&&l!=="—"?`${f}/api/trace/${l}`:"AI draft";await Word.run(async e=>{const n=e.document.getSelection();e.document.trackRevisions=!0,n.insertText(t,Word.InsertLocation.replace);try{await ge(n,`${K} ${u}`)}catch{}await e.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(r){window.toast?.("Accept failed"),G(r,"insertDraft"),console.error(r)}}async function An(){try{const r=z(P.proposed);r&&(r.value="",r.dispatchEvent(new Event("input",{bubbles:!0})),Z("")),await Word.run(async t=>{const f=t.document.getSelection().revisions;f.load("items"),await t.sync(),(f.items||[]).forEach(u=>{try{u.reject()}catch{}}),await t.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(r){window.toast?.("Reject failed"),G(r,"insertDraft"),console.error(r)}}function ct(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const s=Jt.filter(c=>{try{return w(c),!1}catch{return!0}});if(s.length){console.error("[PANEL] wireUI missing IDs:",s);const c=`FATAL: panel template mismatch (missing: ${s.join(", ")}). Check build pipeline.`;try{const d=document.createElement?document.createElement("div"):null;d&&(d.textContent=c,d.style.padding="12px",d.style.color="#f66",document.body.innerHTML="",document.body.appendChild(d))}catch{}console.error(c);return}}const r=w("loading-book");window.addEventListener("cai:busy",s=>{!!s?.detail?.busy?r.classList.remove("hidden"):r.classList.add("hidden")});const t=He(),l=(s,c)=>{const d=w(s);if(d.disabled=!0,d.title=c?`Not supported: ${c}`:"Not supported",c)try{console.log(`disabled ${s}: ${c}`)}catch{}};O("#btnUseWholeDoc",hn);const f=w("btnUseWholeDoc");if(f.disabled=!1,O("#btnFixNumbering",sn),Xe==="dev")O("#btnTest",ot);else{const s=w("btnTest");s.style.display="none"}O("#btnQARecheck",vn);const u=w("btnSuggestEdit"),e=z(P.original),n=()=>{u.disabled=!(e&&e.value.trim())};e?.addEventListener("input",n);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const s=await globalThis.getSelectionText();if(s&&e){e.value=s;try{e.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}n(),u.addEventListener("click",gn),O("#btnApplyTracked",bn),O("#btnAcceptAll",wn),O("#btnRejectAll",An),O("#btnPrevIssue",tn),O("#btnNextIssue",nn),O("#btnPreviewDiff",_n),O("#btnClearAnnots",Gt),O("#btnSave",Qt);const a=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();a.checked=tt(),a.addEventListener("change",()=>Xt(!!a.checked));const i=w("btnAnnotate");i.addEventListener("click",async()=>{if(!i.disabled){i.disabled=!0;try{const s=window.__last?.analyze?.json||{},c=globalThis.parseFindings(s);try{await globalThis.annotateFindingsIntoWord(c)}catch(d){const h=d?.code||d?.name||"";h==="SearchStringInvalidOrTooLong"||h==="InvalidOrTooLong"||h==="InvalidArgument"?(globalThis.toast2?.("Search failed (long text), skipping some anchors","warn"),console.warn("[annotate run] search error",h)):console.warn("[annotate run] error",d)}}finally{i.disabled=!1}}}),i.classList.remove("js-disable-while-busy"),i.removeAttribute("disabled"),document.body.addEventListener("ca.qa",s=>{const c=s?.detail;try{if(!c||c.error){se(c||{}),ae(c||{});return}const d=rn(c);se(d),ae(d)}catch(d){console.warn("ca.qa handler failed",d),se(c||{}),ae(c||{})}}),Z(""),an(),console.log("Panel UI wired [OK]");const o=document.getElementById("btnAnalyze");if(o&&(o.disabled=!0),Se(),Ie(),xe(),t.revisions||(l("btnApplyTracked","revisions"),l("btnAcceptAll","revisions"),l("btnRejectAll","revisions")),t.comments||l("btnAcceptAll",t.commentsReason),t.search||(l("btnPrevIssue","search"),l("btnNextIssue","search"),l("btnQARecheck","search")),t.contentControls||l("btnAnnotate","contentControls"),!t.revisions||!t.comments||!t.search||!t.contentControls)try{De("Word ⚠")}catch{}}T.wireUI=T.wireUI||ct;function Z(r){const t=!!r.trim(),l=w("btnApplyTracked"),f=w("btnAcceptAll"),u=w("btnRejectAll"),e=w("btnPreviewDiff"),n=w("draftPane"),a=w("draftText");a.value=r,n.style.display=t?"":"none",l.disabled=!t,f.disabled=!t,u.disabled=!t,e.disabled=!t}async function En(r){console.log("[PANEL] bootstrap start"),Et()&&(console.log("reopen clean OK"),It()),ct(),At();try{await jt(et())}catch{}try{await ot()}catch{}try{De(`${r?.host||Office.context?.host||"Word"} ✓`)}catch{De(null)}}let Le=!1,lt=!1,ut,ft=!1,dt=0;function Re(){if(ft){console.log(`bootstrap invoked x${dt+1}`);return}Le&&lt&&(ft=!0,dt++,console.log("bootstrap invoked x1"),En(ut))}globalThis.__CAI_TESTING__||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Le=!0,Re()}):(Le=!0,Re()),Office.onReady(r=>{lt=!0,ut=r,Re()}))})();
