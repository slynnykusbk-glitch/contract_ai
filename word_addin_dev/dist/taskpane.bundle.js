(function(){"use strict";var V=typeof document<"u"?document.currentScript:null;const Y="",J="1.4",O="cai-comment-on-analyze";function zt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",Y),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",J),localStorage.getItem(O)===null&&localStorage.setItem(O,"1")}catch{}}zt();function W(){try{return localStorage.getItem("api_key")||Y}catch{return Y}}function rt(t){try{localStorage.setItem("api_key",t)}catch{}}function k(){try{return localStorage.getItem("schema_version")||J}catch{return J}}function $(t){try{localStorage.setItem("schema_version",t)}catch{}}function Mt(){try{const t=localStorage.getItem(O);return t===null?(localStorage.setItem(O,"1"),!0):t!=="0"}catch{return!0}}function Dt(t){try{localStorage.setItem(O,t?"1":"0")}catch{}}const I=typeof globalThis<"u"?globalThis:window;I.CAI=I.CAI||{},I.CAI.Store=I.CAI.Store||{},I.CAI.Store.setApiKey=rt,I.CAI.Store.setSchemaVersion=$,I.CAI.Store.get=()=>({apiKey:W(),schemaVersion:k()}),I.CAI.Store.DEFAULT_BASE=I.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const w=window;w.__cai_pending_fetches=w.__cai_pending_fetches||new Set,w.__cai_pending_timers=w.__cai_pending_timers||new Set;const F=w.__cai_pending_fetches,U=w.__cai_pending_timers,C={count:0};function Nt(){C.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:C.count}}))}function Wt(){C.count=Math.max(0,C.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:C.count>0,count:C.count}}))}async function R(t){try{return Nt(),await t()}finally{Wt()}}function Ft(t){F.add(t)}function Ut(t){F.delete(t)}function jt(t){U.add(t)}function Pt(t){U.delete(t)}function lt(t){F.forEach(e=>{try{e.abort(t)}catch{}}),F.clear(),U.forEach(e=>{try{clearTimeout(e),clearInterval(e)}catch{}}),U.clear();try{document.querySelectorAll(".progress").forEach(e=>{e.style.display="none"})}catch{}}function Ht(){if(w.__pendingUnloadReg)return;w.__pendingUnloadReg=!0;const t=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),e=()=>{t&&lt("pagehide/unload"),w.__wasUnloaded=!0};window.addEventListener("pagehide",e),window.addEventListener("unload",e),window.addEventListener("beforeunload",e),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&lt("visibilitychange")})}function dt(){return!!w.__wasUnloaded}function Kt(){w.__wasUnloaded=!1}let Q=null;async function ut(t={}){if(!Q){const e=(t.backend||"").replace(/\/+$/,""),n=e?`${e}/health`:"/health",o=new AbortController,s=t.timeoutMs??9e3,c=setTimeout(()=>o.abort("timeout"),s);Q=fetch(n,{signal:o.signal}).then(async u=>{clearTimeout(c);const i=await u.json().catch(()=>({}));return{ok:u.ok,json:i,resp:u}})}return Q}function B(t){try{console.log("[OK]",t)}catch{}}function ft(t){try{console.error("[ERR]",t)}catch{}}function b(t){try{console.warn("[WARN]",t)}catch{}}function mt(t){const e=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(e)?e.filter(Boolean):[]}window.parseFindings=mt;function qt(t){const e=t.headers,n=t.json||{},o=n.llm||n;return{cid:e.get("x-cid"),xcache:e.get("x-cache"),latencyMs:e.get("x-latency-ms"),schema:e.get("x-schema-version"),provider:e.get("x-provider")||o.provider||n.provider||null,model:e.get("x-model")||o.model||n.model||null,llm_mode:e.get("x-llm-mode")||o.mode||n.mode||null,usage:e.get("x-usage-total"),status:t.status!=null?String(t.status):null}}function Z(t){const e=(n,o)=>{const s=document.getElementById(n);s&&(s.textContent=o&&o.length?o:"—")};e("status",t.status),e("cid",t.cid),e("xcache",t.xcache),e("latency",t.latencyMs),e("schema",t.schema),e("provider",t.provider),e("model",t.model),e("mode",t.llm_mode),e("usage",t.usage)}async function Vt(){const t=new URL(V&&V.tagName.toUpperCase()==="SCRIPT"&&V.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const n=await(await fetch(t)).text(),o=new TextEncoder().encode(n),s=await crypto.subtle.digest("SHA-256",o),c=Array.from(new Uint8Array(s)).slice(0,4).map(u=>u.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${c} ${t}`)}catch{console.log(`[selftest] api-client.js fail ${t}`)}}const gt="https://localhost:9443";function Yt(){try{return(localStorage.getItem("backendUrl")||gt).replace(/\/+$/,"")}catch{return gt}}const G=9e3,Jt=60,Qt=9e4,Zt=1,Gt=3e3;async function z(t,e,n){return R(async()=>{const o=Yt()+t,s={"Content-Type":"application/json"},c=k()||"1.4";s["x-schema-version"]=c;const u=W();u&&(s["x-api-key"]=u);const i={...e||{},schema:c},a=JSON.stringify(i),r=new TextEncoder().encode(a).length;let l=n,f=Zt,d=Gt;if(t==="/api/analyze"){if(l==null){const g=G+Jt*(r/1024);l=Math.max(G,Math.min(Qt,Math.floor(g)))}try{for(const g of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const h=localStorage.getItem(g);if(h){const E=parseInt(h,10);if(Number.isFinite(E)){l=E;break}}}}catch{}try{const g=localStorage.getItem("cai.retry.analyze.count");g&&(f=parseInt(g,10))}catch{}try{const g=localStorage.getItem("cai.retry.analyze.backoff.ms");g&&(d=parseInt(g,10))}catch{}try{const g=new URLSearchParams(location.search),h=g.get("ta");h&&(l=parseInt(h,10));const E=g.get("rac");E&&(f=parseInt(E,10));const p=g.get("rb");p&&(d=parseInt(p,10))}catch{}}l=l??G;async function m(g){const h=new AbortController,E=setTimeout(()=>h.abort(`timeout ${l}ms`),l);Ft(h),jt(E);try{const p=await fetch(o,{method:"POST",headers:s,body:a,credentials:"include",signal:h.signal}),A=await p.json().catch(()=>({}));if(p.status===422){console.warn("[analyze] 422",A.detail);const N=Array.isArray(A?.detail)?A.detail.map(Re=>Re.msg).join("; "):A?.detail;try{b(`Validation error: ${N}`)}catch{}}return t==="/api/analyze"&&(p.status===504||p.status>=500)&&g<f?(await new Promise(N=>setTimeout(N,d)),m(g+1)):{resp:p,json:A}}catch(p){if(t==="/api/analyze"&&p?.name==="AbortError"){const A=h.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${A}`),g<f&&String(A).startsWith("timeout"))return await new Promise(N=>setTimeout(N,d)),m(g+1);throw new DOMException(A,"AbortError")}throw p}finally{clearTimeout(E),Pt(E),Ut(h)}}return m(0)})}window.postJson=z;async function Xt(t={}){const e={text:t?.text??t?.content,mode:t?.mode??"live"},{resp:n,json:o}=await z("/api/analyze",e),s=qt({headers:n.headers,json:o,status:n.status});try{Z(s)}catch{}try{const c=window;c.__last||(c.__last={}),c.__last.analyze={status:n.status,req:{path:"/api/analyze",method:"POST",body:e},json:o}}catch{}return{ok:n.ok,json:o,resp:n,meta:s}}async function te(t,e){return z("/api/panel/redlines",{before_text:t,after_text:e})}const ee={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function v(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function j(t){const e=(t||"").toLowerCase();return e==="high"?3:e==="medium"?2:1}function ne(t){const e=new Map;let n=0,o=0;for(const c of t||[]){const u=v(c.snippet||""),i=typeof c.start=="number"?c.start:void 0,a=typeof c.end=="number"?c.end:i!==void 0?i+u.length:void 0;if(typeof i!="number"||typeof a!="number"||a<=i||a-i>1e4){n++;continue}const r=`${c.rule_id||""}|${i}|${a}|${u}`,l=e.get(r);!l||j(c.severity)>j(l.severity)?e.set(r,{...c,snippet:u,start:i,end:a}):o++}const s=Array.from(e.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),s}async function P(t,e,n){const o={items:[]};try{e=(e||"").trim()}catch{e=""}if(!e)return o;const s=t?.context,c=[200,160,120,80,40],u=(i,a)=>{if(i.length<=a)return i;let r=i.slice(0,a);const l=/[\s.,;:!?]/g;let f=-1,d;for(;d=l.exec(r);)f=d.index;return f>=120?r=r.slice(0,f):r=r.slice(0,120),r};for(let i=0;i<c.length;i++){const a=c[i];let r=e;r.length>a&&(r=i===0?u(r,a):r.slice(0,a));try{const l=t.search(r,n);if(l?.load?.("items"),await s?.sync?.(),Array.isArray(l?.items)&&l.items.length||l?.items)return l}catch(l){const f=l?.code||l?.name||"";if(f==="SearchStringInvalidOrTooLong"||f==="InvalidOrTooLong"||f==="InvalidArgument"){try{console.warn("[safeBodySearch]",f)}catch{}continue}try{console.warn("[safeBodySearch]",l)}catch{}return o}return o}return o}async function M(t,e){const n=t.context,o={matchCase:!1,matchWholeWord:!1},s=async a=>await P(t,a,o);let u=(await s(e||""))?.items||[];if(!u.length){const a=v(e||"");u=(await s(a))?.items||[]}u.sort((a,r)=>{const l=a.start??0,f=r.start??0;if(l!==f)return l-f;const d=a.end??l,m=r.end??f;return d-m});const i=[];for(const a of u){const r=a.start??0,l=a.end??r,f=i[i.length-1];if(f&&r<(f.end??r)){const d=(f.end??0)-(f.start??0);l-r>d&&(i[i.length-1]=a);continue}i.push(a)}for(const a of i)try{n.trackedObjects?.add?.(a)}catch{}return i}function oe(t,e,n){if(!t||!e)return 0;let o=-1,s=0;for(;(o=t.indexOf(e,o+1))!==-1&&o<(n??t.length);)s++;return s}function se(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const D="[CAI]";function ae(t){if(!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const e=[t.rule_id];return t.advice&&e.push(t.advice),t.law_refs?.length&&e.push(t.law_refs.join("; ")),`${D} ${e.join(`
`)}`}const X=200;function yt(t){const e=v(globalThis.__lastAnalyzed||""),n=Array.isArray(t)?t:[],o=ne(n),s=o.slice().sort((r,l)=>(r.start??Number.POSITIVE_INFINITY)-(l.start??Number.POSITIVE_INFINITY)),c=[];let u=-1,i=0;for(const r of s){if(!r||!r.rule_id||!r.snippet||typeof r.start!="number"){i++;continue}const l=r.snippet,f=r.start,d=typeof r.end=="number"?r.end:f+l.length;if(f<u){i++;continue}const m=v(l),g=oe(e,m,f);if(c.push({raw:l,norm:m,occIdx:g,msg:ae(r),rule_id:r.rule_id,normalized_fallback:v(r.normalized_snippet||"")}),u=d,c.length>=X)break}const a=globalThis;return i&&a.notifyWarn?.(`Skipped ${i} overlaps/invalid`),o.length>X&&a.notifyWarn?.(`Truncated to first ${X} findings`),a.notifyOk?.(`Will insert: ${c.length}`),c}async function ht(t){const e=yt(t);return e.length?await globalThis.Word?.run?.(async o=>{const s=o.document.body,c=[];let u=0;for(const i of e){let a=await M(s,i.raw),r=a[Math.min(i.occIdx,a.length-1)]||null;if(!r&&i.normalized_fallback&&i.normalized_fallback!==i.norm&&(a=await M(s,i.normalized_fallback),r=a[Math.min(i.occIdx,a.length-1)]||null),r){r.load?.(["start","end"]),await o.sync();const l=r.start??0,f=r.end??l;if(c.some(d=>Math.max(d.start,l)<Math.min(d.end,f))){console.warn("[annotate] overlapping range",{rid:i.rule_id,start:l,end:f});continue}if(se())try{r.select()}catch{}else i.msg&&r.insertComment(i.msg);c.push({start:l,end:f}),u++}else console.warn("[annotate] no match for snippet",{rid:i.rule_id,snippet:i.raw.slice(0,120)});await o.sync()}return u}).catch(o=>(globalThis.logRichError?.(o,"annotate"),console.warn("annotate run fail",o?.code,o?.message,o?.debugInfo),0)):0}async function ce(t,e,n){if(!t||!t.trim())return;const o=globalThis;if(!o.Word?.run){await o.navigator?.clipboard?.writeText(t).catch(()=>{}),o.alert?.("Draft copied to clipboard (Office not ready). Paste it into the document.");return}if(o.Office?.context?.document?.mode&&o.Office.context.document.mode!=="edit")throw o.alert?.("Document is read-only."),new Error("Document mode is not editable");await o.Word.run(async s=>{const c=s.document;let u=null;try{const d=o.__findings||[],m=o.__findingIdx,g=d&&typeof m=="number"?d[m]:null,h=c.body;if(u=(g?.snippet?await M(h,g.snippet):[])[0]||null,!u){const p=c.getSelection();p.load("isEmpty"),await s.sync(),u=p.isEmpty?c.body.getRange("End"):p}}catch{const d=c.getSelection();d.load("isEmpty"),await s.sync(),u=d.isEmpty?c.body.getRange("End"):d}const i=u.insertText(t,o.Word.InsertLocation.replace),a=[`${D} Suggested clause – ${e}`],r=(n||"").split(/\r?\n/).slice(0,2).join(" "),l=o.__findings||[],f=o.__findingIdx;if(r)a.push(r);else{const d=l&&typeof f=="number"?l[f]:null,m=d?.rule_id||d?.title||"";m&&a.push(m)}a.push("schema 1.4 | model gpt-4o-mini | provider azure");try{c.comments.add(i,a.join(`
`))}catch{}await s.sync()}).catch(s=>{throw globalThis.logRichError?.(s,"insertDraft"),console.warn("insertDraftText error",s?.code,s?.message,s?.debugInfo),s})}function ie(){const t=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),e=globalThis.Word||{},n=t&&!!e?.Revision,o=t&&!!e?.SearchOptions,s=t&&!!e?.ContentControl,u=globalThis.localStorage?.getItem?.("cai.force.comments")==="1";let i=!1,a="unsupported";return u?(i=!0,a="dev override"):e?.Comment?(i=!0,a="Word.Comment available"):t?(i=!0,a="WordApi 1.4"):(i=!1,a="Word.Comment missing"),{revisions:n,comments:i,search:o,contentControls:s,commentsReason:a}}function pt(){const t=ie();try{console.log("support matrix",{comments:t.comments,reason:t.commentsReason})}catch{}return t}async function re(t){const e=[];try{await Vt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(l=>{document.getElementById(l)||e.push(`missingID:${l}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||e.push("req1.4:0");const n=pt(),o={revisions:n.revisions?1:0,comments:n.comments?1:0,search:n.search?1:0,contentControls:n.contentControls?1:0};let s=!1;try{s=(await ut({backend:t})).ok,s||e.push("health")}catch{e.push("health:timeout")}const c="__BUILD_TS__",u=Office?.context?.host||"Word",i=e.length===0,a=i?`Startup OK | build=${c} | host=${u} | req=1.4 | features=${JSON.stringify(o)} | backend=${t}`:`Startup FAIL: ${e.join("; ")}`;console.log(a);const r=document.getElementById("startupBadge");return r&&(r.textContent=i?"OK":"FAIL",r.setAttribute("data-status",i?"ok":"fail")),{ok:i,missing:e,features:o}}async function tt(){return await Word.run(async t=>{const e=t.document.body;return e.load("text"),await t.sync(),(e.text||"").trim()})}async function le(){return await Word.run(async t=>{const e=t.document.getSelection();return e.load("text"),await t.sync(),(e.text||"").trim()})}var bt={};const et=globalThis,nt=et.OfficeExtension,_t="build-20250912-195756";console.log("ContractAI build",_t);let wt=null,Et="1",It="1";try{wt=localStorage.getItem("cai_timeout_ms:analyze"),Et=localStorage.getItem("cai_abort_on_hidden")||"1",It=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:wt,abort_on_hidden:Et,abort_on_navigation:It}),!_t.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const t=document.createElement("div");t.textContent="FATAL: stale bundle",t.style.padding="12px",t.style.color="#f66",document.body.innerHTML="",document.body.appendChild(t),document.querySelectorAll("button").forEach(e=>{e.disabled=!0})}catch{}});const At=(()=>{const t=et.ENV_MODE||(typeof process<"u"?bt?.ENV_MODE:void 0);return t?t==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();nt&&nt.config&&(At==="dev"||et.__ENABLE_EXTENDED_LOGS__)&&(nt.config.extendedErrorLogging=!0);function H(t,e="Word"){try{const n=t&&t.debugInfo||{};console.error(`[${e}] RichApi error`,{code:t.code,message:t.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function vt(t){return(mt(t)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const y=globalThis;y.parseFindings=y.parseFindings||vt,y.applyMetaToBadges=y.applyMetaToBadges||Z,y.getApiKeyFromStore=y.getApiKeyFromStore||W,y.getSchemaFromStore=y.getSchemaFromStore||k,y.logRichError=y.logRichError||H,y.getWholeDocText=y.getWholeDocText||tt,y.getSelectionText=y.getSelectionText||le;let ot="live";const S={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let K="",St=!1;const de=ee.required_ids||[];function st(t,e){const n=document.getElementById("status-chip");if(!n)return;const o=(t??k())||"—",s=(e??K)||"—";n.textContent=`schema: ${o} | cid: ${s}`}function Tt(){const t=document.getElementById("anchorsBadge");if(!t)return;const e=globalThis.__anchorsSkipped||0;t.style.display=e>0?"":"none"}y.updateAnchorBadge=y.updateAnchorBadge||Tt;function ue(){if(St)return;_("#btnAnalyze",Se);const t=document.getElementById("btnAnalyze");t&&(t.disabled=!1),St=!0,console.log("[PANEL] analyze enabled")}function xt(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function fe(){const e=document.getElementById("backendUrl")?.value?.trim();if(e)try{localStorage.setItem("backend.url",e),localStorage.setItem("backendUrl",e)}catch{}location.reload()}function at(){try{let t=W(),e=k();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",s=o==="localhost"||o==="127.0.0.1";if(s&&(t||(t="local-test-key-123",rt(t)),!e)){const c=globalThis?.SCHEMA_VERSION||typeof process<"u"&&bt?.SCHEMA_VERSION||"1.4";e=String(c),$(e)}n&&(!t&&!e&&!s?n.style.display="":n.style.display="none"),(!t||!e)&&console.warn("missing headers",{apiKey:!!t,schema:!!e})}catch{}return!0}function T(t,e){return document.querySelector(`[data-role="${e}"]`)||document.getElementById(t)}function kt(){const e=document.getElementById("selectRiskThreshold")?.value?.toLowerCase();return e==="low"||e==="medium"||e==="high"?e:"medium"}function ct(){const t=Mt();try{const e=globalThis.document,n=e?.getElementById("cai-comment-on-analyze")||e?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=t),n?!!n.checked:t}catch{return t}}function me(t){Dt(t)}function Ct(t,e){const n=j(e);return(t||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>j(o.severity)>=n)}y.annotateFindingsIntoWord=y.annotateFindingsIntoWord||ht;async function ge(){try{await Word.run(async t=>{const e=t.document.body,n=t.document.comments;n.load("items"),await t.sync();for(const o of n.items)try{(o.text||"").startsWith(D)&&o.delete()}catch{}try{e.font.highlightColor="NoColor"}catch{}await t.sync()}),B("Annotations cleared")}catch(t){H(t,"annotate"),b("Failed to clear annotations")}}async function Bt(t){return R(async()=>{let e=(t||[]).filter(s=>typeof s.start=="number"&&typeof s.end=="number"&&s.end>s.start).sort((s,c)=>s.start-c.start),n=-1;if(e=e.filter(s=>s.start<n?!1:(n=s.end,!0)),!e.length)return;const o=window.__lastAnalyzed||"";await Word.run(async s=>{const c=s.document.body;s.document.trackRevisions=!0;const u={matchCase:!1,matchWholeWord:!1},i=(a,r)=>{const l=a?.items||[];return l.length&&l[Math.min(Math.max(r,0),l.length-1)]||null};for(const a of e){const r=o.slice(a.start,a.end),l=(()=>{let d=-1,m=0;for(;(d=o.indexOf(r,d+1))!==-1&&d<a.start;)m++;return m})();let f=null;if(a.context_before||a.context_after){const d=`${a.context_before||""}${r}${a.context_after||""}`,m=await P(c,d,u),g=i(m,l);if(g){const h=g.search(r,u);h.load("items"),await s.sync(),f=i(h,0)}}if(!f){const d=await P(c,r,u);f=i(d,l)}if(!f){const d=(()=>{const m=r.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(g=>g.length>=12);return m.length?m.sort((g,h)=>h.length-g.length)[0].slice(0,64):null})();if(d){const m=await P(c,d,u);f=i(m,0)}}if(f){f.insertText(a.replacement,"Replace");const d=`${D} ${a.rationale||a.source||"AI edit"}`;try{f.insertComment(d)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:r,occIdx:l});await s.sync()}})})}y.applyOpsTracked=y.applyOpsTracked||Bt;async function ye(t){await Word.run(async e=>{const n=e.document.body;let o=await M(n,t.raw),s=o[Math.min(t.occIdx,o.length-1)]||null;if(!s&&t.normalized_fallback&&t.normalized_fallback!==t.norm&&(o=await M(n,t.normalized_fallback),s=o[Math.min(t.occIdx,o.length-1)]||null),s)try{s.select()}catch{}await e.sync()})}async function Lt(t){const e=window.__findings||[];if(!e.length)return;const n=window;n.__findingIdx=(n.__findingIdx??0)+t,n.__findingIdx<0&&(n.__findingIdx=e.length-1),n.__findingIdx>=e.length&&(n.__findingIdx=0);const o=document.getElementById("findingsList");if(o){const s=Array.from(o.querySelectorAll("li"));s.forEach((u,i)=>{u.classList.toggle("active",i===n.__findingIdx)});const c=s[n.__findingIdx];c&&c.scrollIntoView({block:"nearest"})}try{await ye(e[n.__findingIdx])}catch{}}function he(){Lt(-1)}function pe(){Lt(1)}function be(t){const e=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",n=Array.isArray(t?.findings)?t.findings:[],o=Array.isArray(t?.recommendations)?t.recommendations:[],s=kt(),u=Ct(n,s).length,i=n.length-u,a=(d,m)=>{const g=document.getElementById(d);g&&(g.textContent=m)};a("clauseTypeOut",String(e)),a("resFindingsCount",String(n.length)),a("visibleHiddenOut",`${u} / ${i}`);const r=document.getElementById("findingsList");if(r){r.innerHTML="";for(const d of n){const m=document.createElement("li"),g=d?.title||d?.finding?.title||d?.rule_id||"Issue",h=d?.snippet||d?.evidence?.text||"";m.textContent=h?`${g}: ${h}`:String(g),r.appendChild(m)}}const l=document.getElementById("recsList");if(l){l.innerHTML="";for(const d of o){const m=document.createElement("li");m.textContent=d?.text||d?.advice||d?.message||"Recommendation",l.appendChild(m)}}const f=document.getElementById("resultsBlock");f&&f.style.removeProperty("display")}function _e(t){const e=T("resClauseType","clause-type");e&&(e.textContent=t?.clause_type||"—");const n=vt(t);window.__findings=n,window.__findingIdx=0;const o=T("findingsList","findings");o&&(o.innerHTML="",n.forEach(a=>{const r=document.createElement("li");r.textContent=typeof a=="string"?a:JSON.stringify(a),o.appendChild(r)}));const s=Array.isArray(t?.recommendations)?t.recommendations:[],c=T("recoList","recommendations");c&&(c.innerHTML="",s.forEach(a=>{const r=document.createElement("li");r.textContent=typeof a=="string"?a:JSON.stringify(a),c.appendChild(r)}));const u=T("resFindingsCount","findings-count");u&&(u.textContent=String(n.length));const i=T("rawJson","raw-json");i&&(i.textContent=JSON.stringify(t??{},null,2))}function we(){const t=T("toggleRaw","toggle-raw-json"),e=T("rawJson","raw-json");t&&e&&(e.style.display="none",t.addEventListener("click",()=>{e.style.display=e.style.display==="none"?"block":"none"}))}function Ot(t){const e=document.getElementById("connBadge");e&&(e.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`)}function it(t){const e=document.getElementById("officeBadge");e&&(e.textContent=`Office: ${t??"—"}`)}function x(t){return document.querySelector(t)}async function Ee(){const t=x(S.original),e=(t?.value||"").trim();if(e)return e;const n=await globalThis.getSelectionText();if(n&&t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return n.trim()}async function Ie(){const t=x(S.original),e=await tt(),n=v(e||"");if(t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const o=document.getElementById("originalText");if(o&&o!==t){o.value=n;try{o.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function Ae(t){return R(async()=>{let e;try{e=await Ee()}catch{b("Select some text or paste into 'Original clause'");return}if(!e){b("Select some text or paste into 'Original clause'");return}try{const n=x(S.proposed),{json:o}=await z("/api/gpt-draft",{cid:K,clause:e,mode:ot}),s=(o?.proposed_text??o?.text??"").toString(),c=window;if(c.__last=c.__last||{},c.__last["gpt-draft"]={json:o},n){n.id||(n.id="draftText"),n.name||(n.name="proposed"),n.dataset.role="proposed-text",n.value=s,n.dispatchEvent(new Event("input",{bubbles:!0})),B("Draft ready");try{await ce(s,ot,o?.meta?.rationale)}catch{}L(s)}else b("Proposed textarea not found"),L("")}catch(n){b("Draft error"),console.error(n),L("")}})}async function $t(){try{const t=k(),{resp:e,json:n,ok:o}=await ut({backend:xt()}),s=e.headers.get("x-schema-version")||n?.schema||null;if(s&&($(s),s!==t&&console.log(`schema: ${s} (synced)`)),Ot(o),o){console.log("[PANEL] health ok"),ue(),st(s,null);try{Z({cid:null,xcache:null,latencyMs:null,schema:s||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}B(`Health: ${n?.status||"ok"}${s?` (schema ${s})`:""}`)}else b("Health failed")}catch(t){Ot(!1),b("Health failed"),console.error(t)}}async function ve(){const t=document.getElementById("originalText");let e=v(t?.value||"");if(!e){const n=document.getElementById("btnAnalyze");n&&(n.disabled=!0);try{e=v(await globalThis.getWholeDocText()),t&&(t.value=e||"")}catch{e=""}finally{n&&(n.disabled=!1)}}return e?(window.__lastAnalyzed=e,e):(b("Document is empty"),null)}async function Se(){await ve()&&await Te()}async function Te(){return R(async()=>{const t=document.getElementById("btnAnalyze"),e=document.getElementById("busyBar");t&&(t.disabled=!0),e&&(e.style.display="");try{L("");const n=window.__lastAnalyzed;if(!n){ft("В документе нет текста");return}at();const{resp:o,json:s}=await Xt({text:n,mode:ot});if(!o.ok)throw new Error(`HTTP ${o.status}`);const c=o.headers.get("x-schema-version");c&&$(c),s?.schema&&$(s.schema),K=o.headers.get("x-cid")||"",st(null,K),_e(s),be(s);try{localStorage.setItem("last_analysis_json",JSON.stringify(s))}catch{}try{const u=globalThis.parseFindings(s),i=kt(),a=Ct(u,i),r=yt(a);window.__findings=r;const l=document.getElementById("findingsList");l&&(l.innerHTML="",r.forEach(f=>{const d=document.createElement("li");d.textContent=f.rule_id||f.raw.slice(0,64),l.appendChild(d)})),ct()&&a.length&&await ht(a)}catch(u){console.warn("auto-annotate after analyze failed",u)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:s})),B("Analyze OK")}catch(n){let o="";if(n?.name==="AbortError"){const s=n?.message||"";if(s.startsWith("timeout")){const c=parseInt(s.replace(/[^0-9]/g,""),10)||0;o=`(timeout ${Math.round(c/1e3)} s)`}else s==="pagehide/unload"?o="(aborted by pagehide)":o="(aborted)"}else typeof n?.message=="string"&&(n.message.includes("HTTP 504")?o="(HTTP 504)":n.message.includes("HTTP 413")?o="(payload too large 413)":n.message.includes("HTTP 401")?o="(unauthorized 401)":n.message.includes("HTTP 403")?o="(forbidden 403)":n.message.includes("HTTP 422")&&(o="(schema mismatch 422)"));b(`Analyze failed ${o}`.trim()),console.error(n)}finally{t&&(t.disabled=!1),e&&(e.style.display="none")}})}async function xe(){return R(async()=>{at();const t=await tt(),{json:e}=await z("/api/qa-recheck",{text:t,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:e})),!e?.error)B("QA recheck OK");else{const o=e?.error||e?.message||"unknown";ft(`QA recheck failed: ${o}`)}})}function _(t,e){const n=document.querySelector(t);n&&(n.addEventListener("click",o=>{o.preventDefault(),e()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function ke(){try{const t=window.__lastAnalyzed||"",e=(x(S.proposed)?.value||"").trim();if(!e){b("No draft to diff");return}const n=await te(t,e),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",s=document.getElementById("diffOutput"),c=document.getElementById("diffContainer");s&&c&&(s.innerHTML=o||"",c.style.display=o?"block":"none")}catch(t){b("Diff failed"),console.error(t)}}async function Ce(){try{const t=window.__last||{},e=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!e.length){b("No ops to apply");return}await Bt(e),B("Applied ops")}catch(t){b("Insert failed"),console.error(t)}}async function Be(){try{const e=(x(S.proposed)?.value||"").trim();if(!e){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),s=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async c=>{const u=c.document.getSelection();c.document.trackRevisions=!0,u.insertText(e,Word.InsertLocation.replace);try{u.insertComment(`${D} ${s}`)}catch{}await c.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),H(t,"insertDraft"),console.error(t)}}async function Le(){try{const t=x(S.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),L("")),await Word.run(async e=>{const o=e.document.getSelection().revisions;o.load("items"),await e.sync(),(o.items||[]).forEach(s=>{try{s.reject()}catch{}}),await e.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),H(t,"insertDraft"),console.error(t)}}function Rt(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const l=de.filter(f=>!document.getElementById(f));if(l.length){console.error("[PANEL] wireUI missing IDs:",l);const f=`FATAL: panel template mismatch (missing: ${l.join(", ")}). Check build pipeline.`;try{const d=document.createElement?document.createElement("div"):null;d&&(d.textContent=f,d.style.padding="12px",d.style.color="#f66",document.body.innerHTML="",document.body.appendChild(d))}catch{}console.error(f);return}}const t=document.getElementById("loading-book");window.addEventListener("cai:busy",l=>{if(!t)return;!!l?.detail?.busy?t.classList.remove("hidden"):t.classList.add("hidden")});const e=pt(),n=(l,f)=>{const d=document.getElementById(l);if(d&&(d.disabled=!0,d.title=f?`Not supported: ${f}`:"Not supported"),f)try{console.log(`disabled ${l}: ${f}`)}catch{}};_("#btnUseWholeDoc",Ie);const o=document.getElementById("btnUseWholeDoc");if(o&&(o.disabled=!1),At==="dev")_("#btnTest",$t);else{const l=document.getElementById("btnTest");l&&(l.style.display="none")}_("#btnQARecheck",xe);const s=document.getElementById("btnSuggestEdit"),c=x(S.original),u=()=>{s&&(s.disabled=!(c&&c.value.trim()))};c?.addEventListener("input",u);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const l=await globalThis.getSelectionText();if(l&&c){c.value=l;try{c.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}u(),s?.addEventListener("click",Ae),_("#btnApplyTracked",Ce),_("#btnAcceptAll",Be),_("#btnRejectAll",Le),_("#btnPrevIssue",he),_("#btnNextIssue",pe),_("#btnPreviewDiff",ke),_("#btnClearAnnots",ge),_("#btnSave",fe);const i=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");i?(i.checked=ct(),i.addEventListener("change",()=>me(!!i.checked))):ct();const a=document.getElementById("btnAnnotate");a&&(a.addEventListener("click",async()=>{if(!a.disabled){a.disabled=!0;try{const l=window.__last?.analyze?.json||{},f=globalThis.parseFindings(l);try{await globalThis.annotateFindingsIntoWord(f)}catch(d){const m=d?.code||d?.name||"";m==="SearchStringInvalidOrTooLong"||m==="InvalidOrTooLong"||m==="InvalidArgument"?(globalThis.toast2?.("Search failed (long text), skipping some anchors","warn"),console.warn("[annotate run] search error",m)):console.warn("[annotate run] error",d)}}finally{a.disabled=!1}}}),a.classList.remove("js-disable-while-busy"),a.removeAttribute("disabled")),L(""),we(),console.log("Panel UI wired");const r=document.getElementById("btnAnalyze");if(r&&(r.disabled=!0),at(),st(),Tt(),e.revisions||(n("btnApplyTracked","revisions"),n("btnAcceptAll","revisions"),n("btnRejectAll","revisions")),e.comments||n("btnAcceptAll",e.commentsReason),e.search||(n("btnPrevIssue","search"),n("btnNextIssue","search"),n("btnQARecheck","search")),e.contentControls||n("btnAnnotate","contentControls"),!e.revisions||!e.comments||!e.search||!e.contentControls)try{it("Word ⚠")}catch{}}y.wireUI=y.wireUI||Rt;function L(t){const e=!!t.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),s=document.getElementById("btnRejectAll"),c=document.getElementById("btnPreviewDiff"),u=document.getElementById("draftPane"),i=document.getElementById("draftText");i&&(i.value=t),u&&(u.style.display=e?"":"none"),n&&(n.disabled=!e),o&&(o.disabled=!e),s&&(s.disabled=!e),c&&(c.disabled=!e)}async function Oe(t){console.log("[PANEL] bootstrap start"),dt()&&(console.log("reopen clean OK"),Kt()),Rt(),Ht();try{await re(xt())}catch{}try{await $t()}catch{}try{it(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{it(null)}}let q=0;function $e(t){if(dt()&&(q=0),q>0){console.log(`bootstrap invoked x${q+1}`);return}q++,console.log("bootstrap invoked x1"),Oe(t)}if(!globalThis.__CAI_TESTING__){const t=()=>Office.onReady(e=>$e(e));document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}})();
