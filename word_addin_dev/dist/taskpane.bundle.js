(function(){"use strict";var q=typeof document<"u"?document.currentScript:null;const V="",Y="1.4",O="cai-comment-on-analyze";function Rt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",V),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",Y),localStorage.getItem(O)===null&&localStorage.setItem(O,"1")}catch{}}Rt();function N(){try{return localStorage.getItem("api_key")||V}catch{return V}}function ct(t){try{localStorage.setItem("api_key",t)}catch{}}function C(){try{return localStorage.getItem("schema_version")||Y}catch{return Y}}function R(t){try{localStorage.setItem("schema_version",t)}catch{}}function $t(){try{const t=localStorage.getItem(O);return t===null?(localStorage.setItem(O,"1"),!0):t!=="0"}catch{return!0}}function zt(t){try{localStorage.setItem(O,t?"1":"0")}catch{}}const E=typeof globalThis<"u"?globalThis:window;E.CAI=E.CAI||{},E.CAI.Store=E.CAI.Store||{},E.CAI.Store.setApiKey=ct,E.CAI.Store.setSchemaVersion=R,E.CAI.Store.get=()=>({apiKey:N(),schemaVersion:C()}),E.CAI.Store.DEFAULT_BASE=E.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const _=window;_.__cai_pending_fetches=_.__cai_pending_fetches||new Set,_.__cai_pending_timers=_.__cai_pending_timers||new Set;const F=_.__cai_pending_fetches,W=_.__cai_pending_timers,k={count:0};function Mt(){k.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:k.count}}))}function Nt(){k.count=Math.max(0,k.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:k.count>0,count:k.count}}))}async function $(t){try{return Mt(),await t()}finally{Nt()}}function Ft(t){F.add(t)}function Wt(t){F.delete(t)}function Dt(t){W.add(t)}function Ut(t){W.delete(t)}function it(t){F.forEach(e=>{try{e.abort(t)}catch{}}),F.clear(),W.forEach(e=>{try{clearTimeout(e),clearInterval(e)}catch{}}),W.clear();try{document.querySelectorAll(".progress").forEach(e=>{e.style.display="none"})}catch{}}function jt(){if(_.__pendingUnloadReg)return;_.__pendingUnloadReg=!0;const t=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),e=()=>{t&&it("pagehide/unload"),_.__wasUnloaded=!0};window.addEventListener("pagehide",e),window.addEventListener("unload",e),window.addEventListener("beforeunload",e),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&it("visibilitychange")})}function rt(){return!!_.__wasUnloaded}function Pt(){_.__wasUnloaded=!1}let J=null;async function lt(t={}){if(!J){const e=(t.backend||"").replace(/\/+$/,""),n=e?`${e}/health`:"/health",o=new AbortController,s=t.timeoutMs??9e3,a=setTimeout(()=>o.abort("timeout"),s);J=fetch(n,{signal:o.signal}).then(async d=>{clearTimeout(a);const r=await d.json().catch(()=>({}));return{ok:d.ok,json:r,resp:d}})}return J}function B(t){try{console.log("[OK]",t)}catch{}}function dt(t){try{console.error("[ERR]",t)}catch{}}function p(t){try{console.warn("[WARN]",t)}catch{}}function ut(t){const e=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(e)?e.filter(Boolean):[]}window.parseFindings=ut;function Ht(t){const e=t.headers,n=t.json||{},o=n.llm||n;return{cid:e.get("x-cid"),xcache:e.get("x-cache"),latencyMs:e.get("x-latency-ms"),schema:e.get("x-schema-version"),provider:e.get("x-provider")||o.provider||n.provider||null,model:e.get("x-model")||o.model||n.model||null,llm_mode:e.get("x-llm-mode")||o.mode||n.mode||null,usage:e.get("x-usage-total"),status:t.status!=null?String(t.status):null}}function Q(t){const e=(n,o)=>{const s=document.getElementById(n);s&&(s.textContent=o&&o.length?o:"—")};e("status",t.status),e("cid",t.cid),e("xcache",t.xcache),e("latency",t.latencyMs),e("schema",t.schema),e("provider",t.provider),e("model",t.model),e("mode",t.llm_mode),e("usage",t.usage)}async function Kt(){const t=new URL(q&&q.tagName.toUpperCase()==="SCRIPT"&&q.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const n=await(await fetch(t)).text(),o=new TextEncoder().encode(n),s=await crypto.subtle.digest("SHA-256",o),a=Array.from(new Uint8Array(s)).slice(0,4).map(d=>d.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${a} ${t}`)}catch{console.log(`[selftest] api-client.js fail ${t}`)}}const ft="https://localhost:9443";function qt(){try{return(localStorage.getItem("backendUrl")||ft).replace(/\/+$/,"")}catch{return ft}}const Z=9e3,Vt=60,Yt=9e4,Jt=1,Qt=3e3;async function z(t,e,n){return $(async()=>{const o=qt()+t,s={"Content-Type":"application/json"},a=C()||"1.4";s["x-schema-version"]=a;const d=N();d&&(s["x-api-key"]=d);const r={...e||{},schema:a},c=JSON.stringify(r),i=new TextEncoder().encode(c).length;let l=n,f=Jt,u=Qt;if(t==="/api/analyze"){if(l==null){const m=Z+Vt*(i/1024);l=Math.max(Z,Math.min(Yt,Math.floor(m)))}try{for(const m of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const h=localStorage.getItem(m);if(h){const A=parseInt(h,10);if(Number.isFinite(A)){l=A;break}}}}catch{}try{const m=localStorage.getItem("cai.retry.analyze.count");m&&(f=parseInt(m,10))}catch{}try{const m=localStorage.getItem("cai.retry.analyze.backoff.ms");m&&(u=parseInt(m,10))}catch{}try{const m=new URLSearchParams(location.search),h=m.get("ta");h&&(l=parseInt(h,10));const A=m.get("rac");A&&(f=parseInt(A,10));const w=m.get("rb");w&&(u=parseInt(w,10))}catch{}}l=l??Z;async function g(m){const h=new AbortController,A=setTimeout(()=>h.abort(`timeout ${l}ms`),l);Ft(h),Dt(A);try{const w=await fetch(o,{method:"POST",headers:s,body:c,credentials:"include",signal:h.signal}),I=await w.json().catch(()=>({}));if(w.status===422){console.warn("[analyze] 422",I.detail);const M=Array.isArray(I?.detail)?I.detail.map(Oe=>Oe.msg).join("; "):I?.detail;try{p(`Validation error: ${M}`)}catch{}}return t==="/api/analyze"&&(w.status===504||w.status>=500)&&m<f?(await new Promise(M=>setTimeout(M,u)),g(m+1)):{resp:w,json:I}}catch(w){if(t==="/api/analyze"&&w?.name==="AbortError"){const I=h.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${I}`),m<f&&String(I).startsWith("timeout"))return await new Promise(M=>setTimeout(M,u)),g(m+1);throw new DOMException(I,"AbortError")}throw w}finally{clearTimeout(A),Ut(A),Wt(h)}}return g(0)})}window.postJson=z;async function Zt(t={}){const e={text:t?.text??t?.content,mode:t?.mode??"live"},{resp:n,json:o}=await z("/api/analyze",e),s=Ht({headers:n.headers,json:o,status:n.status});try{Q(s)}catch{}try{const a=window;a.__last||(a.__last={}),a.__last.analyze={status:n.status,req:{path:"/api/analyze",method:"POST",body:e},json:o}}catch{}return{ok:n.ok,json:o,resp:n,meta:s}}async function Gt(t,e){return z("/api/panel/redlines",{before_text:t,after_text:e})}const Xt={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function v(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function D(t){const e=(t||"").toLowerCase();return e==="high"?3:e==="medium"?2:1}function te(t){const e=new Map;let n=0,o=0;for(const a of t||[]){const d=v(a.snippet||""),r=typeof a.start=="number"?a.start:void 0,c=typeof a.end=="number"?a.end:r!==void 0?r+d.length:void 0;if(typeof r!="number"||typeof c!="number"||c<=r||c-r>1e4){n++;continue}const i=`${a.rule_id||""}|${r}|${c}|${d}`,l=e.get(i);!l||D(a.severity)>D(l.severity)?e.set(i,{...a,snippet:d,start:r,end:c}):o++}const s=Array.from(e.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),s}function U(t,e,n){const o={items:[],load:()=>{}};if(!e)return o;let s=e;s.length>200&&(s=s.slice(0,100).trim(),s.length>200&&(s=s.slice(0,120)));try{return t.search(s,n)}catch(a){const d=a?.code||a?.name||"";if(d==="SearchStringInvalidOrTooLong"||d==="InvalidArgument"){try{console.warn("[WARN] safeBodySearch",d)}catch{}return o}throw a}}async function j(t,e){const n=t.context,o={matchCase:!1,matchWholeWord:!1},s=c=>{const i=U(t,c,o);return i&&typeof i.load=="function"&&i.load("items"),i},a=s(e||"");await n.sync();let d=a?.items||[];if(!d.length){const c=v(e||""),i=s(c);await n.sync(),d=i?.items||[]}d.sort((c,i)=>{const l=c.start??0,f=i.start??0;if(l!==f)return l-f;const u=c.end??l,g=i.end??f;return u-g});const r=[];for(const c of d){const i=c.start??0,l=c.end??i,f=r[r.length-1];if(f&&i<(f.end??i)){const u=(f.end??0)-(f.start??0);l-i>u&&(r[r.length-1]=c);continue}r.push(c)}for(const c of r)try{n.trackedObjects?.add?.(c)}catch{}return r}function ee(t,e,n){if(!t||!e)return 0;let o=-1,s=0;for(;(o=t.indexOf(e,o+1))!==-1&&o<(n??t.length);)s++;return s}function ne(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const mt="AI edit:";function oe(t){if(!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const e=[t.rule_id];return t.advice&&e.push(t.advice),t.law_refs?.length&&e.push(t.law_refs.join("; ")),`${mt} ${e.join(`
`)}`}const G=200;function gt(t){const e=v(globalThis.__lastAnalyzed||""),n=Array.isArray(t)?t:[],o=te(n),s=o.slice().sort((i,l)=>(i.start??Number.POSITIVE_INFINITY)-(l.start??Number.POSITIVE_INFINITY)),a=[];let d=-1,r=0;for(const i of s){if(!i||!i.rule_id||!i.snippet||typeof i.start!="number"){r++;continue}const l=i.snippet,f=i.start,u=typeof i.end=="number"?i.end:f+l.length;if(f<d){r++;continue}const g=v(l),m=ee(e,g,f);if(a.push({raw:l,norm:g,occIdx:m,msg:oe(i),rule_id:i.rule_id,normalized_fallback:v(i.normalized_snippet||"")}),d=u,a.length>=G)break}const c=globalThis;return r&&c.notifyWarn?.(`Skipped ${r} overlaps/invalid`),o.length>G&&c.notifyWarn?.(`Truncated to first ${G} findings`),c.notifyOk?.(`Will insert: ${a.length}`),a}async function yt(t){const e=gt(t);return e.length?await globalThis.Word?.run?.(async o=>{const s=o.document.body,a=[];let d=0;for(const r of e){let c=await j(s,r.raw),i=c[Math.min(r.occIdx,c.length-1)]||null;if(!i&&r.normalized_fallback&&r.normalized_fallback!==r.norm&&(c=await j(s,r.normalized_fallback),i=c[Math.min(r.occIdx,c.length-1)]||null),i){i.load?.(["start","end"]),await o.sync();const l=i.start??0,f=i.end??l;if(a.some(u=>Math.max(u.start,l)<Math.min(u.end,f))){console.warn("[annotate] overlapping range",{rid:r.rule_id,start:l,end:f});continue}if(ne())try{i.select()}catch{}else r.msg&&i.insertComment(r.msg);a.push({start:l,end:f}),d++}else console.warn("[annotate] no match for snippet",{rid:r.rule_id,snippet:r.raw.slice(0,120)});await o.sync()}return d}).catch(o=>(globalThis.logRichError?.(o,"annotate"),console.warn("annotate run fail",o?.code,o?.message,o?.debugInfo),0)):0}function se(){const t=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),e=globalThis.Word||{},n=t&&!!e?.Revision,o=t&&!!e?.SearchOptions,s=t&&!!e?.ContentControl,d=globalThis.localStorage?.getItem?.("cai.force.comments")==="1";let r=!1,c="unsupported";return d?(r=!0,c="dev override"):e?.Comment?(r=!0,c="Word.Comment available"):t?(r=!0,c="WordApi 1.4"):(r=!1,c="Word.Comment missing"),{revisions:n,comments:r,search:o,contentControls:s,commentsReason:c}}function ht(){const t=se();try{console.log("support matrix",{comments:t.comments,reason:t.commentsReason})}catch{}return t}async function ae(t){const e=[];try{await Kt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(l=>{document.getElementById(l)||e.push(`missingID:${l}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||e.push("req1.4:0");const n=ht(),o={revisions:n.revisions?1:0,comments:n.comments?1:0,search:n.search?1:0,contentControls:n.contentControls?1:0};let s=!1;try{s=(await lt({backend:t})).ok,s||e.push("health")}catch{e.push("health:timeout")}const a="__BUILD_TS__",d=Office?.context?.host||"Word",r=e.length===0,c=r?`Startup OK | build=${a} | host=${d} | req=1.4 | features=${JSON.stringify(o)} | backend=${t}`:`Startup FAIL: ${e.join("; ")}`;console.log(c);const i=document.getElementById("startupBadge");return i&&(i.textContent=r?"OK":"FAIL",i.setAttribute("data-status",r?"ok":"fail")),{ok:r,missing:e,features:o}}async function X(){return await Word.run(async t=>{const e=t.document.body;return e.load("text"),await t.sync(),(e.text||"").trim()})}async function ce(){return await Word.run(async t=>{const e=t.document.getSelection();return e.load("text"),await t.sync(),(e.text||"").trim()})}var pt={};const tt=globalThis,et=tt.OfficeExtension,bt="build-20250912-195756";console.log("ContractAI build",bt);let _t=null,wt="1",Et="1";try{_t=localStorage.getItem("cai_timeout_ms:analyze"),wt=localStorage.getItem("cai_abort_on_hidden")||"1",Et=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:_t,abort_on_hidden:wt,abort_on_navigation:Et}),!bt.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const t=document.createElement("div");t.textContent="FATAL: stale bundle",t.style.padding="12px",t.style.color="#f66",document.body.innerHTML="",document.body.appendChild(t),document.querySelectorAll("button").forEach(e=>{e.disabled=!0})}catch{}});const At=(()=>{const t=tt.ENV_MODE||(typeof process<"u"?pt?.ENV_MODE:void 0);return t?t==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();et&&et.config&&(At==="dev"||tt.__ENABLE_EXTENDED_LOGS__)&&(et.config.extendedErrorLogging=!0);function P(t,e="Word"){try{const n=t&&t.debugInfo||{};console.error(`[${e}] RichApi error`,{code:t.code,message:t.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function It(t){return(ut(t)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const y=globalThis;y.parseFindings=y.parseFindings||It,y.applyMetaToBadges=y.applyMetaToBadges||Q,y.getApiKeyFromStore=y.getApiKeyFromStore||N,y.getSchemaFromStore=y.getSchemaFromStore||C,y.logRichError=y.logRichError||P,y.getWholeDocText=y.getWholeDocText||X,y.getSelectionText=y.getSelectionText||ce;let ie="live";const S={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let H="",vt=!1;const re=Xt.required_ids||[];function nt(t,e){const n=document.getElementById("status-chip");if(!n)return;const o=(t??C())||"—",s=(e??H)||"—";n.textContent=`schema: ${o} | cid: ${s}`}function le(){if(vt)return;b("#btnAnalyze",Ie);const t=document.getElementById("btnAnalyze");t&&(t.disabled=!1),vt=!0,console.log("[PANEL] analyze enabled")}function St(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function de(){const e=document.getElementById("backendUrl")?.value?.trim();if(e)try{localStorage.setItem("backend.url",e),localStorage.setItem("backendUrl",e)}catch{}location.reload()}function ot(){try{let t=N(),e=C();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",s=o==="localhost"||o==="127.0.0.1";if(s&&(t||(t="local-test-key-123",ct(t)),!e)){const a=globalThis?.SCHEMA_VERSION||typeof process<"u"&&pt?.SCHEMA_VERSION||"1.4";e=String(a),R(e)}n&&(!t&&!e&&!s?n.style.display="":n.style.display="none"),(!t||!e)&&console.warn("missing headers",{apiKey:!!t,schema:!!e})}catch{}return!0}function T(t,e){return document.querySelector(`[data-role="${e}"]`)||document.getElementById(t)}function Tt(){const e=document.getElementById("selectRiskThreshold")?.value?.toLowerCase();return e==="low"||e==="medium"||e==="high"?e:"medium"}function st(){const t=$t();try{const e=globalThis.document,n=e?.getElementById("cai-comment-on-analyze")||e?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=t),n?!!n.checked:t}catch{return t}}function ue(t){zt(t)}function xt(t,e){const n=D(e);return(t||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>D(o.severity)>=n)}y.annotateFindingsIntoWord=y.annotateFindingsIntoWord||yt;async function fe(){try{await Word.run(async t=>{const e=t.document.body,n=t.document.comments;n.load("items"),await t.sync();for(const o of n.items)try{(o.text||"").startsWith(mt)&&o.delete()}catch{}try{e.font.highlightColor="NoColor"}catch{}await t.sync()}),B("Annotations cleared")}catch(t){P(t,"annotate"),p("Failed to clear annotations")}}async function Ct(t){return $(async()=>{let e=(t||[]).filter(s=>typeof s.start=="number"&&typeof s.end=="number"&&s.end>s.start).sort((s,a)=>s.start-a.start),n=-1;if(e=e.filter(s=>s.start<n?!1:(n=s.end,!0)),!e.length)return;const o=window.__lastAnalyzed||"";await Word.run(async s=>{const a=s.document.body;s.document.trackRevisions=!0;const d={matchCase:!1,matchWholeWord:!1},r=(c,i)=>{const l=c?.items||[];return l.length&&l[Math.min(Math.max(i,0),l.length-1)]||null};for(const c of e){const i=o.slice(c.start,c.end),l=(()=>{let u=-1,g=0;for(;(u=o.indexOf(i,u+1))!==-1&&u<c.start;)g++;return g})();let f=null;if(c.context_before||c.context_after){const u=`${c.context_before||""}${i}${c.context_after||""}`,g=U(a,u,d);g.load("items"),await s.sync();const m=r(g,l);if(m){const h=m.search(i,d);h.load("items"),await s.sync(),f=r(h,0)}}if(!f){const u=U(a,i,d);u.load("items"),await s.sync(),f=r(u,l)}if(!f){const u=(()=>{const g=i.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(m=>m.length>=12);return g.length?g.sort((m,h)=>h.length-m.length)[0].slice(0,64):null})();if(u){const g=U(a,u,d);g.load("items"),await s.sync(),f=r(g,0)}}if(f){f.insertText(c.replacement,"Replace");const u=c.rationale||c.source||"AI edit";try{f.insertComment(u)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:i,occIdx:l});await s.sync()}})})}y.applyOpsTracked=y.applyOpsTracked||Ct;async function me(t){await Word.run(async e=>{const n=e.document.body;let o=await j(n,t.raw),s=o[Math.min(t.occIdx,o.length-1)]||null;if(!s&&t.normalized_fallback&&t.normalized_fallback!==t.norm&&(o=await j(n,t.normalized_fallback),s=o[Math.min(t.occIdx,o.length-1)]||null),s)try{s.select()}catch{}await e.sync()})}async function kt(t){const e=window.__findings||[];if(!e.length)return;const n=window;n.__findingIdx=(n.__findingIdx??0)+t,n.__findingIdx<0&&(n.__findingIdx=e.length-1),n.__findingIdx>=e.length&&(n.__findingIdx=0);const o=document.getElementById("findingsList");if(o){const s=Array.from(o.querySelectorAll("li"));s.forEach((d,r)=>{d.classList.toggle("active",r===n.__findingIdx)});const a=s[n.__findingIdx];a&&a.scrollIntoView({block:"nearest"})}try{await me(e[n.__findingIdx])}catch{}}function ge(){kt(-1)}function ye(){kt(1)}function he(t){const e=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",n=Array.isArray(t?.findings)?t.findings:[],o=Array.isArray(t?.recommendations)?t.recommendations:[],s=Tt(),d=xt(n,s).length,r=n.length-d,c=(u,g)=>{const m=document.getElementById(u);m&&(m.textContent=g)};c("clauseTypeOut",String(e)),c("resFindingsCount",String(n.length)),c("visibleHiddenOut",`${d} / ${r}`);const i=document.getElementById("findingsList");if(i){i.innerHTML="";for(const u of n){const g=document.createElement("li"),m=u?.title||u?.finding?.title||u?.rule_id||"Issue",h=u?.snippet||u?.evidence?.text||"";g.textContent=h?`${m}: ${h}`:String(m),i.appendChild(g)}}const l=document.getElementById("recsList");if(l){l.innerHTML="";for(const u of o){const g=document.createElement("li");g.textContent=u?.text||u?.advice||u?.message||"Recommendation",l.appendChild(g)}}const f=document.getElementById("resultsBlock");f&&f.style.removeProperty("display")}function pe(t){const e=T("resClauseType","clause-type");e&&(e.textContent=t?.clause_type||"—");const n=It(t);window.__findings=n,window.__findingIdx=0;const o=T("findingsList","findings");o&&(o.innerHTML="",n.forEach(c=>{const i=document.createElement("li");i.textContent=typeof c=="string"?c:JSON.stringify(c),o.appendChild(i)}));const s=Array.isArray(t?.recommendations)?t.recommendations:[],a=T("recoList","recommendations");a&&(a.innerHTML="",s.forEach(c=>{const i=document.createElement("li");i.textContent=typeof c=="string"?c:JSON.stringify(c),a.appendChild(i)}));const d=T("resFindingsCount","findings-count");d&&(d.textContent=String(n.length));const r=T("rawJson","raw-json");r&&(r.textContent=JSON.stringify(t??{},null,2))}function be(){const t=T("toggleRaw","toggle-raw-json"),e=T("rawJson","raw-json");t&&e&&(e.style.display="none",t.addEventListener("click",()=>{e.style.display=e.style.display==="none"?"block":"none"}))}function Bt(t){const e=document.getElementById("connBadge");e&&(e.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`)}function at(t){const e=document.getElementById("officeBadge");e&&(e.textContent=`Office: ${t??"—"}`)}function x(t){return document.querySelector(t)}async function _e(){const t=x(S.original),e=(t?.value||"").trim();if(e)return e;const n=await globalThis.getSelectionText();if(n&&t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return n.trim()}async function we(){const t=x(S.original),e=await X(),n=v(e||"");if(t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const o=document.getElementById("originalText");if(o&&o!==t){o.value=n;try{o.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function Ee(t){return $(async()=>{let e;try{e=await _e()}catch{p("Select some text or paste into 'Original clause'");return}if(!e){p("Select some text or paste into 'Original clause'");return}try{const n=x(S.proposed),{json:o}=await z("/api/gpt-draft",{cid:H,clause:e,mode:"friendly"}),s=(o?.proposed_text??o?.text??"").toString(),a=window;a.__last=a.__last||{},a.__last["gpt-draft"]={json:o},n?(n.id||(n.id="draftText"),n.name||(n.name="proposed"),n.dataset.role="proposed-text",n.value=s,n.dispatchEvent(new Event("input",{bubbles:!0})),B("Draft ready"),L(s)):(p("Proposed textarea not found"),L(""))}catch(n){p("Draft error"),console.error(n),L("")}})}async function Lt(){try{const t=C(),{resp:e,json:n,ok:o}=await lt({backend:St()}),s=e.headers.get("x-schema-version")||n?.schema||null;if(s&&(R(s),s!==t&&console.log(`schema: ${s} (synced)`)),Bt(o),o){console.log("[PANEL] health ok"),le(),nt(s,null);try{Q({cid:null,xcache:null,latencyMs:null,schema:s||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}B(`Health: ${n?.status||"ok"}${s?` (schema ${s})`:""}`)}else p("Health failed")}catch(t){Bt(!1),p("Health failed"),console.error(t)}}async function Ae(){const t=document.getElementById("originalText");let e=v(t?.value||"");if(!e){const n=document.getElementById("btnAnalyze");n&&(n.disabled=!0);try{e=v(await globalThis.getWholeDocText()),t&&(t.value=e||"")}catch{e=""}finally{n&&(n.disabled=!1)}}return e?(window.__lastAnalyzed=e,e):(p("Document is empty"),null)}async function Ie(){await Ae()&&await ve()}async function ve(){return $(async()=>{const t=document.getElementById("btnAnalyze"),e=document.getElementById("busyBar");t&&(t.disabled=!0),e&&(e.style.display="");try{L("");const n=window.__lastAnalyzed;if(!n){dt("В документе нет текста");return}ot();const{resp:o,json:s}=await Zt({text:n,mode:ie});if(!o.ok)throw new Error(`HTTP ${o.status}`);const a=o.headers.get("x-schema-version");a&&R(a),s?.schema&&R(s.schema),H=o.headers.get("x-cid")||"",nt(null,H),pe(s),he(s);try{localStorage.setItem("last_analysis_json",JSON.stringify(s))}catch{}try{const d=globalThis.parseFindings(s),r=Tt(),c=xt(d,r),i=gt(c);window.__findings=i;const l=document.getElementById("findingsList");l&&(l.innerHTML="",i.forEach(f=>{const u=document.createElement("li");u.textContent=f.rule_id||f.raw.slice(0,64),l.appendChild(u)})),st()&&c.length&&await yt(c)}catch(d){console.warn("auto-annotate after analyze failed",d)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:s})),B("Analyze OK")}catch(n){let o="";if(n?.name==="AbortError"){const s=n?.message||"";if(s.startsWith("timeout")){const a=parseInt(s.replace(/[^0-9]/g,""),10)||0;o=`(timeout ${Math.round(a/1e3)} s)`}else s==="pagehide/unload"?o="(aborted by pagehide)":o="(aborted)"}else typeof n?.message=="string"&&(n.message.includes("HTTP 504")?o="(HTTP 504)":n.message.includes("HTTP 413")?o="(payload too large 413)":n.message.includes("HTTP 401")?o="(unauthorized 401)":n.message.includes("HTTP 403")?o="(forbidden 403)":n.message.includes("HTTP 422")&&(o="(schema mismatch 422)"));p(`Analyze failed ${o}`.trim()),console.error(n)}finally{t&&(t.disabled=!1),e&&(e.style.display="none")}})}async function Se(){return $(async()=>{ot();const t=await X(),{json:e}=await z("/api/qa-recheck",{text:t,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:e})),!e?.error)B("QA recheck OK");else{const o=e?.error||e?.message||"unknown";dt(`QA recheck failed: ${o}`)}})}function b(t,e){const n=document.querySelector(t);n&&(n.addEventListener("click",o=>{o.preventDefault(),e()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function Te(){try{const t=window.__lastAnalyzed||"",e=(x(S.proposed)?.value||"").trim();if(!e){p("No draft to diff");return}const n=await Gt(t,e),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",s=document.getElementById("diffOutput"),a=document.getElementById("diffContainer");s&&a&&(s.innerHTML=o||"",a.style.display=o?"block":"none")}catch(t){p("Diff failed"),console.error(t)}}async function xe(){try{const t=window.__last||{},e=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!e.length){p("No ops to apply");return}await Ct(e),B("Applied ops")}catch(t){p("Insert failed"),console.error(t)}}async function Ce(){try{const e=(x(S.proposed)?.value||"").trim();if(!e){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),s=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async a=>{const d=a.document.getSelection();a.document.trackRevisions=!0,d.insertText(e,Word.InsertLocation.replace);try{d.insertComment(s)}catch{}await a.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),P(t,"insertDraft"),console.error(t)}}async function ke(){try{const t=x(S.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),L("")),await Word.run(async e=>{const o=e.document.getSelection().revisions;o.load("items"),await e.sync(),(o.items||[]).forEach(s=>{try{s.reject()}catch{}}),await e.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),P(t,"insertDraft"),console.error(t)}}function Ot(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const l=re.filter(f=>!document.getElementById(f));if(l.length){console.error("[PANEL] wireUI missing IDs:",l);const f=`FATAL: panel template mismatch (missing: ${l.join(", ")}). Check build pipeline.`;try{const u=document.createElement?document.createElement("div"):null;u&&(u.textContent=f,u.style.padding="12px",u.style.color="#f66",document.body.innerHTML="",document.body.appendChild(u))}catch{}console.error(f);return}}const t=document.getElementById("loading-book");window.addEventListener("cai:busy",l=>{if(!t)return;!!l?.detail?.busy?t.classList.remove("hidden"):t.classList.add("hidden")});const e=ht(),n=(l,f)=>{const u=document.getElementById(l);if(u&&(u.disabled=!0,u.title=f?`Not supported: ${f}`:"Not supported"),f)try{console.log(`disabled ${l}: ${f}`)}catch{}};b("#btnUseWholeDoc",we);const o=document.getElementById("btnUseWholeDoc");if(o&&(o.disabled=!1),At==="dev")b("#btnTest",Lt);else{const l=document.getElementById("btnTest");l&&(l.style.display="none")}b("#btnQARecheck",Se);const s=document.getElementById("btnSuggestEdit"),a=x(S.original),d=()=>{s&&(s.disabled=!(a&&a.value.trim()))};a?.addEventListener("input",d);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const l=await globalThis.getSelectionText();if(l&&a){a.value=l;try{a.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}d(),s?.addEventListener("click",Ee),b("#btnApplyTracked",xe),b("#btnAcceptAll",Ce),b("#btnRejectAll",ke),b("#btnPrevIssue",ge),b("#btnNextIssue",ye),b("#btnPreviewDiff",Te),b("#btnClearAnnots",fe),b("#btnSave",de);const r=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");r?(r.checked=st(),r.addEventListener("change",()=>ue(!!r.checked))):st();const c=document.getElementById("btnAnnotate");c&&(c.addEventListener("click",async()=>{if(!c.disabled){c.disabled=!0;try{const l=window.__last?.analyze?.json||{},f=globalThis.parseFindings(l);await globalThis.annotateFindingsIntoWord(f)}finally{c.disabled=!1}}}),c.classList.remove("js-disable-while-busy"),c.removeAttribute("disabled")),L(""),be(),console.log("Panel UI wired");const i=document.getElementById("btnAnalyze");if(i&&(i.disabled=!0),ot(),nt(),e.revisions||(n("btnApplyTracked","revisions"),n("btnAcceptAll","revisions"),n("btnRejectAll","revisions")),e.comments||n("btnAcceptAll",e.commentsReason),e.search||(n("btnPrevIssue","search"),n("btnNextIssue","search"),n("btnQARecheck","search")),e.contentControls||n("btnAnnotate","contentControls"),!e.revisions||!e.comments||!e.search||!e.contentControls)try{at("Word ⚠")}catch{}}y.wireUI=y.wireUI||Ot;function L(t){const e=!!t.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),s=document.getElementById("btnRejectAll"),a=document.getElementById("btnPreviewDiff"),d=document.getElementById("draftPane"),r=document.getElementById("draftText");r&&(r.value=t),d&&(d.style.display=e?"":"none"),n&&(n.disabled=!e),o&&(o.disabled=!e),s&&(s.disabled=!e),a&&(a.disabled=!e)}async function Be(t){console.log("[PANEL] bootstrap start"),rt()&&(console.log("reopen clean OK"),Pt()),Ot(),jt();try{await ae(St())}catch{}try{await Lt()}catch{}try{at(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{at(null)}}let K=0;function Le(t){if(rt()&&(K=0),K>0){console.log(`bootstrap invoked x${K+1}`);return}K++,console.log("bootstrap invoked x1"),Be(t)}if(!globalThis.__CAI_TESTING__){const t=()=>Office.onReady(e=>Le(e));document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}})();
