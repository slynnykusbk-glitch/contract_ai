<!-- word_addin_dev/panel_selftest.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contract AI — Panel Self-Test (Doctor)</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0f1318; --panel:#0b0f14; --muted:#9ca3af; --text:#e5e7eb; --border:#1f2937; --border2:#374151;
      --mono: ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;
      --ui: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      --ok:#10b981; --err:#f87171; --ink:#d1d5db;
    }
    html,body{ height:100%; }
    body { background:var(--bg); color:var(--text); font-family:var(--ui); margin:0; }
    .wrap { max-width:1100px; margin:28px auto; padding:0 16px; }
    h1 { font-size:22px; margin:0 0 12px; display:flex; align-items:center; gap:10px; }
    .muted { color:var(--muted); font-weight:500; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--border2); color:var(--muted); font-size:12px; }
    .row { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    input[type=text]{ width:420px; background:#111827; color:var(--text); border:1px solid var(--border2); border-radius:6px; padding:8px 10px; }
    button { background:#111827; color:var(--text); border:1px solid var(--border2); border-radius:6px; padding:8px 10px; cursor:pointer; }
    button:hover { background:#0b1220; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:12px; margin-top:14px; }
    .card h3 { margin:0 0 8px; font-size:14px; color:var(--muted);}
    .pre { white-space:pre-wrap; word-break:break-word; font-family:var(--mono); font-size:12px;
           background:#0a0d12; border:1px solid var(--border); border-radius:6px; padding:8px; color:var(--ink); min-height:48px;}
    .mono{ font-family:var(--mono); }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border-bottom:1px solid var(--border); padding:6px 8px; text-align:left; }
    th { color:var(--muted); font-weight:600; }
    tr:last-child td { border-bottom:none; }
    .ok { color:var(--ok); }
    .err{ color:var(--err); }
    .pill{ display:inline-block; padding:2px 6px; border-radius:999px; border:1px solid var(--border2); font-size:12px; }
    .btns { display:flex; flex-wrap:wrap; gap:8px; }
    .small { font-size:12px; color:var(--muted); }
    .snapshot-row { display:flex; gap:8px; font-size:13px; }
    .snapshot-row > div:first-child { width:100px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Contract AI — <span class="muted">Panel Self-Test</span> <span class="badge">Doctor</span></h1>

  <div class="row">
    <label for="backendInput">Backend URL:</label>
    <input id="backendInput" type="text" value="https://127.0.0.1:9443" class="mono" />
    <button id="saveBtn">Save</button>
    <button id="runAllBtn">Run All</button>
    <span class="small">Saved in localStorage</span>
  </div>

  <div class="row">
    <textarea id="testText" placeholder="Sample text" style="flex:1; min-height:60px;">Governing law: England and Wales.</textarea>
  </div>

  <div class="row" id="llmInfo">LLM: <span id="llmProv">—</span> / <span id="llmModel">—</span> / <span id="llmMode">—</span> <span id="llmBadge" class="badge" style="display:none;background:#facc15;color:#000;">MOCK</span></div>

    <div class="card">
      <h3>Tests</h3>
      <div class="btns" style="margin-bottom:8px;">
        <button id="btnHealth">GET /health</button>
        <button id="btnAnalyze">POST /api/analyze</button>
        <button id="btnSummary">POST /api/summary</button>
        <button id="btnDraft">POST /api/gpt-draft</button>
        <button id="btnSuggest">POST /api/suggest_edits</button>
        <button id="btnQA">POST /api/qa-recheck</button>
        <button id="btnCalloff">POST /api/calloff/validate</button>
        <button id="btnTrace">GET /api/trace/{cid}</button>
      </div>
      <div class="small">CID used for requests: <span id="cidLbl" class="mono pill"></span></div>
      <div class="small">Last response CID (from headers): <span id="lastCidLbl" class="mono pill"></span></div>
      <div style="overflow:auto;">
        <table id="statusTbl">
          <thead>
            <tr>
              <th style="width:160px;">Test</th>
              <th>HTTP</th>
              <th>x-cid</th>
              <th>x-cache</th>
              <th>x-schema-version</th>
              <th>latency</th>
              <th>status</th>
            </tr>
          </thead>
          <tbody>
            <tr id="row-health"><td>GET /health</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr id="row-analyze"><td>POST /api/analyze</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr id="row-summary"><td>POST /api/summary</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr id="row-draft"><td>POST /api/gpt-draft</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr id="row-suggest"><td>POST /api/suggest_edits</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr id="row-qa"><td>POST /api/qa-recheck</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr id="row-calloff"><td>POST /api/calloff/validate</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr id="row-trace"><td>GET /api/trace/{cid}</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Last Response JSON</h3>
      <div id="resp" class="pre"></div>
    </div>

    <div class="card">
      <h3>Document Snapshot</h3>
      <div class="snapshot-row">
        <div>Type:</div><div data-snap-type>—</div>
      </div>
      <div class="snapshot-row">
        <div>Confidence:</div><div data-snap-type-confidence>—</div>
      </div>
      <div id="docSnap" class="pre"></div>
    </div>

    <div class="card">
      <h3>Trace Payload</h3>
      <div id="trace" class="pre"></div>
    </div>

    <p class="small muted">Tip: For local dev, ensure the backend sends headers: x-cid, x-cache, x-schema-version="1.3".</p>
  </div>

  <script>
    // ---------------------- helpers ----------------------
    const LS_KEY = "panel:backendUrl";
    const DRAFT_PATH = "/api/gpt-draft";
    const SAMPLE = "Governing law: England and Wales.";
    let clientCid = genCid();
    let lastCid = ""; // from response headers

    function showMeta(meta){
      const prov = document.getElementById("llmProv");
      const model = document.getElementById("llmModel");
      prov.textContent = (meta && meta.provider) || "—";
      model.textContent = (meta && meta.model) || "—";
    }

    function pickDocType(summary) {
      summary = summary || {};
      let list = [];
      if (Array.isArray(summary.doc_types)) list = summary.doc_types;
      else if (summary.document && Array.isArray(summary.document.doc_types)) list = summary.document.doc_types;
      // legacy: summary.doc_type = { top:{type,score}, confidence, candidates[] }
      if (!list.length && summary.doc_type && (summary.doc_type.top || summary.doc_type.candidates)) {
        const top = summary.doc_type.top || {};
        const conf = (typeof summary.doc_type.confidence === 'number')
          ? summary.doc_type.confidence
          : (typeof top.score === 'number' ? top.score : null);
        return { name: top.type || top.name || null, confidence: conf };
      }
      let best = null;
      if (list && list.length) {
        best = list.reduce((acc, cur) => {
          const c = typeof cur.confidence === 'number' ? cur.confidence : (typeof cur.score === 'number' ? cur.score : 0);
          const n = cur.name || cur.type || cur.slug || cur.id || null;
          if (!acc || c > acc.confidence) return { name: n, confidence: c };
          return acc;
        }, null);
      } else {
        let n2 = summary.type || (summary.document && summary.document.type) || null;
        let c2 = summary.type_confidence;
        if (c2 == null && summary.document && summary.document.type_confidence != null) c2 = summary.document.type_confidence;
        if (typeof c2 === 'string') { const f = parseFloat(c2); c2 = isNaN(f) ? null : f; }
        best = { name: n2, confidence: c2 };
      }
      return best || { name: null, confidence: null };
    }

    function genCid(){ return "cid-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }

    function normBase(u){
      if (!u) return "";
      let s = String(u).trim();
      if (s.startsWith("//")) s = "https:" + s;
      if (!/^[a-zA-Z][a-zA-Z0-9+\-.]*:\/\//.test(s)) s = "https://" + s;
      s = s.replace(/^http:\/\/(127\.0\.0\.1|localhost)(:9443)(\/|$)/, "https://$1$2$3");
      return s.replace(/\/+$/, "");
    }
    function saveBase(){ try{ localStorage.setItem(LS_KEY, document.getElementById("backendInput").value.trim()); }catch{} }
    function loadBase(){
      let v = localStorage.getItem(LS_KEY) || document.getElementById("backendInput").value || "https://127.0.0.1:9443";
      v = normBase(v);
      document.getElementById("backendInput").value = v || "https://127.0.0.1:9443";
      return v;
    }
    function setCidLabels(){
      document.getElementById("cidLbl").textContent = clientCid;
      document.getElementById("lastCidLbl").textContent = lastCid || "(none yet)";
    }
    function setJSON(elId, obj){
      const el = document.getElementById(elId);
      try { el.textContent = JSON.stringify(obj, null, 2); }
      catch { el.textContent = String(obj); }
    }
    function setStatusRow(rowId, {code, xcid, xcache, xschema, latencyMs, ok, error_code, detail}){
      const tr = document.getElementById(rowId);
      const cells = tr.getElementsByTagName('td');
      const latencyText = (latencyMs != null ? `${latencyMs} ms` : (xcid ? "" : ""));
      cells[1].textContent = code ?? "";
      cells[2].textContent = xcid ?? "";
      cells[3].textContent = xcache ?? "";
      cells[4].textContent = xschema ?? "";
      cells[5].textContent = latencyText;
      if (ok) {
        cells[6].innerHTML = '<span class="ok">ok</span>';
      } else {
        const msg = error_code ? `${error_code}${detail ? ': ' + detail : ''}` : 'error';
        cells[6].innerHTML = `<span class="err">${msg}</span>`;
      }
    }

    function showResp(r){
      const el = document.getElementById("resp");
      if(!r.ok){
        try{ el.textContent = `HTTP ${r.code}\n` + JSON.stringify(r.body, null, 2); }
        catch{ el.textContent = `HTTP ${r.code}`; }
        return;
      }
      if(r.body && r.body.status && r.body.status !== "ok"){
        el.textContent = `API error: ${r.body.detail || r.body.error_code || ''}`;
        return;
      }
      setJSON("resp", r.body);
    }

    async function callEndpoint({name, method, path, body, dynamicPathFn}) {
      const base = normBase(document.getElementById("backendInput").value);
      if (!base) { alert("Please enter backend URL"); return { error:true }; }
      const url = base + (dynamicPathFn ? dynamicPathFn() : path);
      const headers = { "content-type": "application/json", "x-cid": clientCid, "x-schema-version": "1.3" };
      const t0 = performance.now();
      let resp, json;
      try{
        resp = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
      }catch(err){
        console.warn("[HTTP]", method, path, "network error");
        return { error:true, err, url };
      }
      const t1 = performance.now();
      const hdrCid = resp.headers.get("x-cid") || "";
      const hdrCache = resp.headers.get("x-cache") || "";
      const hdrSchema = resp.headers.get("x-schema-version") || "";
      const hdrLatency = resp.headers.get("x-latency-ms");
      const latencyMs = hdrLatency ? parseInt(hdrLatency,10) : Math.round(t1 - t0);
      if (hdrCid) lastCid = hdrCid;
      setCidLabels();
      try{ json = await resp.json(); }catch{ json = {}; }
      const ok = resp.ok && json && (json.status === "ok");
      const error_code = json && json.status === "error" ? (json.error_code || "") : "";
      const detail = json && json.status === "error" ? (json.detail || "") : "";
      console.info("[HTTP]", method, path, "→", resp.status, "cid=", hdrCid || "—", "latency=", latencyMs + "ms", "schema=", hdrSchema || "—");
      if (!resp.ok || json.status === "error") {
        const title = json.title || error_code || "";
        const det = json.detail || detail || "";
        if (title || det) console.warn("[ERROR]", title, det);
      }
      return {
        url, code: resp.status, body: json,
        xcid: hdrCid, xcache: hdrCache, xschema: hdrSchema, latencyMs, ok,
        error_code, detail
      };
    }

    // ---------------------- individual tests ----------------------
    async function testHealth(){
      const r = await callEndpoint({ name:"health", method:"GET", path:"/health" });
      setStatusRow("row-health", r);
      showResp(r);
      return r;
    }
    function getSampleText(){
      return SAMPLE;
    }

    async function testAnalyze(){
      const r = await callEndpoint({
        name:"analyze", method:"POST", path:"/api/analyze",
        body:{ text: SAMPLE }
      });
      setStatusRow("row-analyze", r);
      showResp(r);
      showMeta(r.body && r.body.meta || {});
      return r;
    }
    async function testSummary(){
      const r = await callEndpoint({
        name:"summary", method:"POST", path:"/api/summary",
        body:{ text: SAMPLE }
      });
      setStatusRow("row-summary", r);
      if(!r.ok || (r.body && r.body.status !== "ok")){
        showResp(r);
        return r;
      }
      const el = document.getElementById("resp");
      try {
        const s = JSON.stringify(r.body, null, 2)
          .replace(/"schema_version"\s*:\s*"([^"]+)"/,'<span class="ok">"schema_version": "$1"</span>')
          .replace(/"type"\s*:\s*"([^"]+)"/,'<span class="ok">"type": "$1"</span>')
          .replace(/"has_cap"\s*:\s*(true|false)/,'<span class="ok">"has_cap": $1</span>')
          .replace(/"has_conditions"\s*:\s*(true|false)/,'<span class="ok">"has_conditions": $1</span>')
          .replace(/"has_warranties"\s*:\s*(true|false)/,'<span class="ok">"has_warranties": $1</span>');
        el.innerHTML = s;
      } catch {
        setJSON("resp", r.body);
      }
      const snapEl = document.getElementById("docSnap");
      const summary = r.body && (r.body.summary || r.body) || null;
      const docType = pickDocType(summary || {});
      const typeEl = document.querySelector('[data-snap-type]');
      const confEl = document.querySelector('[data-snap-type-confidence]');
      if (typeEl) typeEl.textContent = docType.name ?? '—';
      if (confEl) confEl.textContent =
        docType.confidence != null ? Math.round(docType.confidence * 100) + '%' : '—';
      if (summary) {
        try { snapEl.textContent = JSON.stringify(summary, null, 2); }
        catch { snapEl.textContent = String(summary); }
      } else {
        snapEl.textContent = "";
      }
      return r;
    }

    async function testDraft(){
      const r = await callEndpoint({
        name:"draft", method:"POST", path:DRAFT_PATH,
        body:{ text: SAMPLE }
      });
      const ok = r.ok && r.body && r.body.status === "ok";
      setStatusRow("row-draft", Object.assign({}, r, { ok: !!ok }));
      showResp(r);
      showMeta(r.body && r.body.meta || {});
      const badge = document.getElementById("llmBadge");
      const meta = r.body && r.body.meta ? r.body.meta : {};
      if (meta.mode === "mock") { badge.style.display = "inline-block"; } else { badge.style.display = "none"; }
      return r;
    }
    async function testSuggest(){
      const r = await callEndpoint({
        name:"suggest", method:"POST", path:"/api/suggest_edits",
        body:{ text: SAMPLE }
      });
      setStatusRow("row-suggest", r);
      showResp(r);
      showMeta(r.body && r.body.meta || {});
      return r;
    }
    async function testQA(){
      const r = await callEndpoint({
        name:"qa", method:"POST", path:"/api/qa-recheck",
        body:{ text: SAMPLE, applied_changes:[] }
      });
      setStatusRow("row-qa", r);
      showResp(r);
      showMeta(r.body && r.body.meta || {});
      return r;
    }
    async function testCalloff(){
      const r = await callEndpoint({
        name:"calloff", method:"POST", path:"/api/calloff/validate",
        body:{ description:"[●]" }
      });
      setStatusRow("row-calloff", r);
      if(!r.ok || (r.body && r.body.status !== "ok")){
        showResp(r);
        return r;
      }
      const issues = (r.body && r.body.issues) ? r.body.issues.length : 0;
      const tr = document.getElementById("row-calloff");
      const cells = tr.getElementsByTagName('td');
      cells[6].innerHTML = r.ok ? `<span class="ok">ok / issues ${issues}</span>` : '<span class="err">error</span>';
      setJSON("resp", r.body);
      return r;
    }
    async function testTrace(){
      const cid = lastCid || clientCid || "cid-dummy";
      const r = await callEndpoint({
        name:"trace", method:"GET",
        dynamicPathFn: () => `/api/trace/${encodeURIComponent(cid)}`
      });
      setStatusRow("row-trace", r);
      setJSON("trace", r.body);
      return r;
    }

    async function runAll(){
      // reset table rows
      for (const id of ["row-health","row-analyze","row-summary","row-draft","row-suggest","row-qa","row-calloff","row-trace"]) {
        setStatusRow(id, {code:"",xcid:"",xcache:"",xschema:"",latencyMs:null,ok:false});
      }
      document.getElementById("resp").textContent = "";
      document.getElementById("docSnap").textContent = "";
      document.getElementById("trace").textContent = "";
      clientCid = genCid();
      setCidLabels();

      await testHealth();
      await testAnalyze();
      await testSummary();
      await testSuggest();
      await testQA();
      await testCalloff();
      await testDraft();
    }

    // ---------------------- init & events ----------------------
    document.getElementById("saveBtn").addEventListener("click", () => { saveBase(); alert("Saved"); });
    document.getElementById("runAllBtn").addEventListener("click", runAll);
    document.getElementById("btnHealth").addEventListener("click", testHealth);
    document.getElementById("btnAnalyze").addEventListener("click", testAnalyze);
    document.getElementById("btnDraft").addEventListener("click", testDraft);
    document.getElementById("btnSummary").addEventListener("click", testSummary);
    document.getElementById("btnSuggest").addEventListener("click", testSuggest);
    document.getElementById("btnQA").addEventListener("click", testQA);
    document.getElementById("btnCalloff").addEventListener("click", testCalloff);
    document.getElementById("btnTrace").addEventListener("click", testTrace);

    // Load defaults on first paint
    window.addEventListener("DOMContentLoaded", () => {
      loadBase();
      setCidLabels();
    });
  </script>
</body>
</html>
