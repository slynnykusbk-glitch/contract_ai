(function(){"use strict";const C="cai-comment-on-analyze";function at(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",""),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version","1.4"),localStorage.getItem(C)===null&&localStorage.setItem(C,"1")}catch{}}at();function O(){try{return localStorage.getItem("api_key")||""}catch{return""}}function j(t){try{localStorage.setItem("api_key",t)}catch{}}function T(){try{return localStorage.getItem("schema_version")||"1.4"}catch{return"1.4"}}function x(t){try{localStorage.setItem("schema_version",t)}catch{}}function it(){try{const t=localStorage.getItem(C);return t===null?(localStorage.setItem(C,"1"),!0):t!=="0"}catch{return!0}}function ct(t){try{localStorage.setItem(C,t?"1":"0")}catch{}}const b=typeof globalThis<"u"?globalThis:window;b.CAI=b.CAI||{},b.CAI.Store=b.CAI.Store||{},b.CAI.Store.setApiKey=j,b.CAI.Store.setSchemaVersion=x,b.CAI.Store.get=()=>({apiKey:O(),schemaVersion:T()}),b.CAI.Store.DEFAULT_BASE=b.CAI.Store.DEFAULT_BASE||"https://localhost:9443";function K(t){const e=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(e)?e.filter(Boolean):[]}window.parseFindings=K;function H(t){const e=(n,o)=>{const s=document.getElementById(n);s&&(s.textContent=o&&o.length?o:"—")};e("status",t.status),e("cid",t.cid),e("xcache",t.xcache),e("latency",t.latencyMs),e("schema",t.schema),e("provider",t.provider),e("model",t.model),e("mode",t.llm_mode),e("usage",t.usage)}const P="https://localhost:9443";function rt(){try{return(localStorage.getItem("backendUrl")||P).replace(/\/+$/,"")}catch{return P}}async function B(t,e){const n=rt()+t,o={"Content-Type":"application/json"},s=T()||"1.4";o["x-schema-version"]=s;const a=O();a&&(o["x-api-key"]=a);const r=await fetch(n,{method:"POST",headers:o,body:JSON.stringify(e||{}),credentials:"include"}),d=await r.json().catch(()=>({}));return{resp:r,json:d}}window.postJson=B;async function lt(t,e){return B("/api/panel/redlines",{before_text:t,after_text:e})}function A(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function z(t){const e=(t||"").toLowerCase();return e==="high"?3:e==="medium"?2:1}function dt(t){const e=new Map;let n=0,o=0;for(const a of t||[]){const r=A(a.snippet||""),d=typeof a.start=="number"?a.start:void 0,c=typeof a.end=="number"?a.end:d!==void 0?d+r.length:void 0;if(typeof d!="number"||typeof c!="number"||c<=d||c-d>1e4){n++;continue}const m=`${a.rule_id||""}|${d}|${c}|${r}`,i=e.get(m);!i||z(a.severity)>z(i.severity)?e.set(m,{...a,snippet:r,start:d,end:c}):o++}const s=Array.from(e.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),s}function E(t){try{console.log("[OK]",t)}catch{}}function V(t){try{console.error("[ERR]",t)}catch{}}function p(t){try{console.warn("[WARN]",t)}catch{}}async function D(){return await Word.run(async t=>{const e=t.document.body;return e.load("text"),await t.sync(),(e.text||"").trim()})}var ut={};const W=globalThis.OfficeExtension,J=globalThis;W&&W.config&&(!((J.__ENV__??"production")==="production")||J.__ENABLE_EXTENDED_LOGS__)&&(W.config.extendedErrorLogging=!0);function L(t,e="Word"){try{const n=t&&t.debugInfo||{};console.error(`[${e}] RichApi error`,{code:t.code,message:t.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function q(t){return(K(t)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const g=globalThis;g.parseFindings=g.parseFindings||q,g.applyMetaToBadges=g.applyMetaToBadges||H,g.getApiKeyFromStore=g.getApiKeyFromStore||O,g.getSchemaFromStore=g.getSchemaFromStore||T,g.logRichError=g.logRichError||L,g.getWholeDocText=g.getWholeDocText||D;const $={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let R="",Y=!1;function N(t,e){const n=document.getElementById("status-chip");if(!n)return;const o=(t??T())||"—",s=(e??R)||"—";n.textContent=`schema: ${o} | cid: ${s}`}function ft(){if(Y)return;h("#btnAnalyze",Ct);const t=document.getElementById("btnAnalyze");t&&(t.disabled=!1),Y=!0}function mt(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function gt(){const e=document.getElementById("backendUrl")?.value?.trim();if(e)try{localStorage.setItem("backend.url",e),localStorage.setItem("backendUrl",e)}catch{}location.reload()}function M(){try{let t=O(),e=T();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",s=o==="localhost"||o==="127.0.0.1";if(s&&(t||(t="local-test-key-123",j(t)),!e)){const a=globalThis?.SCHEMA_VERSION||typeof process<"u"&&ut?.SCHEMA_VERSION||"1.4";e=String(a),x(e)}n&&(!t&&!e&&!s?n.style.display="":n.style.display="none"),(!t||!e)&&console.warn("missing headers",{apiKey:!!t,schema:!!e})}catch{}return!0}function v(t,e){return document.querySelector(`[data-role="${e}"]`)||document.getElementById(t)}function Q(){const e=(document.getElementById("selectRiskThreshold")||document.getElementById("riskThreshold"))?.value?.toLowerCase();return e==="low"||e==="medium"||e==="high"?e:"medium"}function U(){const t=it();try{const e=globalThis.document,n=e?.getElementById("cai-comment-on-analyze")||e?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=t),n?!!n.checked:t}catch{return t}}function yt(t){ct(t)}function pt(){const t=document.getElementById("cai-dry-run-annotate");return t?!!t.checked:!1}function G(t,e){const n=z(e);return(t||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>z(o.severity)>=n)}function ht(t){if(!t||!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const e=(t.severity||"info").toUpperCase(),n=t.rule_id,o=t.clause_type?` (${t.clause_type})`:"",s=t.advice||"—",a=Array.isArray(t.law_refs)&&t.law_refs.length?t.law_refs.join("; "):"—",r=Array.isArray(t.conflict_with)&&t.conflict_with.length?t.conflict_with.join("; "):"—",d=t.suggestion?.text||"—",c=Array.isArray(t.citations)&&t.citations.length?`
Citations: ${t.citations.join("; ")}`:"";return`[${e}] ${n}${o}
Reason: ${s}
Law: ${a}
Conflict: ${r}${c}
Suggested fix: ${d}`}function X(t,e,n){if(!e)return 0;let o=-1,s=0;const a=typeof n=="number"?Math.max(0,n):Number.MAX_SAFE_INTEGER;for(;(o=t.indexOf(e,o+1))!==-1&&o<a;)s++;return s}async function wt(t){const e=A(window.__lastAnalyzed||""),n=dt(t||[]),o=n.slice().sort((i,u)=>(u.end??0)-(i.end??0)),s=[];let a=Number.POSITIVE_INFINITY,r=0;for(const i of o){if(!i||!i.rule_id||!i.snippet){r++;continue}const u=i.snippet,l=typeof i.end=="number"?i.end:typeof i.start=="number"?i.start+u.length:void 0;if(typeof l=="number"&&l>a){r++;continue}s.push(i),typeof i.start=="number"&&(a=i.start)}r&&p(`Skipped ${r} overlaps/invalid`),E(`Will insert: ${s.length}`);const d=s.map(i=>{const u=i.snippet||"",l=A(u),f=X(e,l,i.start);return{raw:u,norm:l,msg:ht(i),rule_id:i.rule_id,occIdx:f,normalized_fallback:A(i.normalized_snippet||"")}}),c={matchCase:!1,matchWholeWord:!1};let m=0;for(const i of d)await Word.run(async u=>{const l=u.document.body;let f=null;const y=l.search(i.raw,c);y.load("items"),await u.sync();const w=(I,_)=>{const S=I?.items||[];return S.length&&S[Math.min(Math.max(_,0),S.length-1)]||null};if(f=w(y,i.occIdx),!f){const I=i.normalized_fallback&&i.normalized_fallback!==i.norm?i.normalized_fallback:i.norm;if(I&&I.trim()){const _=l.search(I,c);_.load("items"),await u.sync(),f=w(_,i.occIdx)}}if(!f){const I=(()=>{const _=i.raw.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(S=>S.length>=12);return _.length?_.sort((S,zt)=>zt.length-S.length)[0].slice(0,64):null})();if(I){const _=l.search(I,c);_.load("items"),await u.sync(),f=w(_,0)}}if(f){if(pt())try{f.select()}catch{}else i.msg&&f.insertComment(i.msg);m++}else console.warn("[annotate] no match for snippet",{rid:i.rule_id,snippet:i.raw.slice(0,120)});await u.sync()}).catch(u=>{L(u,"annotate"),console.warn("annotate run fail",u?.code,u?.message,u?.debugInfo)});return console.log("panel:annotate",{total:t.length,deduped:n.length,skipped_overlaps:r,will_annotate:s.length,inserted:m}),m}g.annotateFindingsIntoWord=g.annotateFindingsIntoWord||wt;async function _t(){try{await Word.run(async t=>{const e=t.document.body,n=t.document.comments;n.load("items"),await t.sync();for(const o of n.items)try{o.delete()}catch{}try{e.font.highlightColor="NoColor"}catch{}await t.sync()}),E("Annotations cleared")}catch(t){L(t,"annotate"),p("Failed to clear annotations")}}async function Z(t){let e=(t||[]).filter(s=>typeof s.start=="number"&&typeof s.end=="number"&&s.end>s.start).sort((s,a)=>s.start-a.start),n=-1;if(e=e.filter(s=>s.start<n?!1:(n=s.end,!0)),!e.length)return;const o=window.__lastAnalyzed||"";await Word.run(async s=>{const a=s.document.body;s.document.trackRevisions=!0;const r={matchCase:!1,matchWholeWord:!1},d=(c,m)=>{const i=c?.items||[];return i.length&&i[Math.min(Math.max(m,0),i.length-1)]||null};for(const c of e){const m=o.slice(c.start,c.end),i=(()=>{let l=-1,f=0;for(;(l=o.indexOf(m,l+1))!==-1&&l<c.start;)f++;return f})();let u=null;if(c.context_before||c.context_after){const l=`${c.context_before||""}${m}${c.context_after||""}`,f=a.search(l,r);f.load("items"),await s.sync();const y=d(f,i);if(y){const w=y.search(m,r);w.load("items"),await s.sync(),u=d(w,0)}}if(!u){const l=a.search(m,r);l.load("items"),await s.sync(),u=d(l,i)}if(!u){const l=(()=>{const f=m.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(y=>y.length>=12);return f.length?f.sort((y,w)=>w.length-y.length)[0].slice(0,64):null})();if(l){const f=a.search(l,r);f.load("items"),await s.sync(),u=d(f,0)}}if(u){u.insertText(c.replacement,"Replace");const l=c.rationale||c.source||"AI edit";try{u.insertComment(l)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:m,occIdx:i});await s.sync()}})}g.applyOpsTracked=g.applyOpsTracked||Z;async function bt(t){const e=A(window.__lastAnalyzed||""),n=t?.snippet||"",o=A(n),s=X(e,o,t.start),a={matchCase:!1,matchWholeWord:!1};await Word.run(async r=>{const d=r.document.body;let c=null;const m=(u,l)=>{const f=u?.items||[];return f.length&&f[Math.min(Math.max(l,0),f.length-1)]||null},i=d.search(n,a);if(i.load("items"),await r.sync(),c=m(i,s),!c){const u=t.normalized_snippet&&t.normalized_snippet!==o?t.normalized_snippet:o;if(u&&u.trim()){const l=d.search(u,a);l.load("items"),await r.sync(),c=m(l,s)}}if(!c){const u=(()=>{const l=n.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(f=>f.length>=12);return l.length?l.sort((f,y)=>y.length-f.length)[0].slice(0,64):null})();if(u){const l=d.search(u,a);l.load("items"),await r.sync(),c=m(l,0)}}if(c)try{c.select()}catch{}await r.sync()})}async function tt(t){const e=window.__findings||[];if(!e.length)return;const n=window;n.__findingIdx=(n.__findingIdx??0)+t,n.__findingIdx<0&&(n.__findingIdx=e.length-1),n.__findingIdx>=e.length&&(n.__findingIdx=0);const o=document.getElementById("findingsList");if(o){const s=Array.from(o.querySelectorAll("li"));s.forEach((r,d)=>{r.classList.toggle("active",d===n.__findingIdx)});const a=s[n.__findingIdx];a&&a.scrollIntoView({block:"nearest"})}try{await bt(e[n.__findingIdx])}catch{}}function At(){tt(-1)}function It(){tt(1)}function Et(t){const e=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",n=Array.isArray(t?.findings)?t.findings:[],o=Array.isArray(t?.recommendations)?t.recommendations:[],s=Q(),r=G(n,s).length,d=n.length-r,c=(l,f)=>{const y=document.getElementById(l);y&&(y.textContent=f)};c("clauseTypeOut",String(e)),c("resFindingsCount",String(n.length)),c("visibleHiddenOut",`${r} / ${d}`);const m=document.getElementById("findingsList");if(m){m.innerHTML="";for(const l of n){const f=document.createElement("li"),y=l?.title||l?.finding?.title||l?.rule_id||"Issue",w=l?.snippet||l?.evidence?.text||"";f.textContent=w?`${y}: ${w}`:String(y),m.appendChild(f)}}const i=document.getElementById("recsList");if(i){i.innerHTML="";for(const l of o){const f=document.createElement("li");f.textContent=l?.text||l?.advice||l?.message||"Recommendation",i.appendChild(f)}}const u=document.getElementById("resultsBlock");u&&u.style.removeProperty("display")}function vt(t){const e=v("resClauseType","clause-type");e&&(e.textContent=t?.clause_type||"—");const n=q(t);window.__findings=n,window.__findingIdx=0;const o=v("findingsList","findings");o&&(o.innerHTML="",n.forEach(c=>{const m=document.createElement("li");m.textContent=typeof c=="string"?c:JSON.stringify(c),o.appendChild(m)}));const s=Array.isArray(t?.recommendations)?t.recommendations:[],a=v("recoList","recommendations");a&&(a.innerHTML="",s.forEach(c=>{const m=document.createElement("li");m.textContent=typeof c=="string"?c:JSON.stringify(c),a.appendChild(m)}));const r=v("resFindingsCount","findings-count");r&&(r.textContent=String(n.length));const d=v("rawJson","raw-json");d&&(d.textContent=JSON.stringify(t??{},null,2))}function St(){const t=v("toggleRaw","toggle-raw-json"),e=v("rawJson","raw-json");t&&e&&(e.style.display="none",t.addEventListener("click",()=>{e.style.display=e.style.display==="none"?"block":"none"}))}function et(t){const e=document.getElementById("connBadge");e&&(e.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`)}function nt(t){const e=document.getElementById("officeBadge");e&&(e.textContent=`Office: ${t??"—"}`)}function F(t){return document.querySelector(t)}async function Tt(){const t=F($.original),e=await D(),n=A(e||"");t&&(t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0}))),window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function kt(t){try{const e=F($.proposed);if(!(window.__lastAnalyzed||A(await D()))){p("No document text");return}const o=window.__findings||[],s=window.__findingIdx??0,a=o[s];if(!a){p("No active finding");return}const r=a.snippet||"",{json:d}=await B("/api/gpt-draft",{cid:R,clause:r,mode:"friendly"}),c=(d?.proposed_text??d?.text??"").toString(),m=window;m.__last=m.__last||{},m.__last["gpt-draft"]={json:d},e?(e.id||(e.id="draftText"),e.name||(e.name="proposed"),e.dataset.role="proposed-text",e.value=c,e.dispatchEvent(new Event("input",{bubbles:!0})),E("Draft ready"),k(c)):(p("Proposed textarea not found"),k(""))}catch(e){p("Draft error"),console.error(e),k("")}}async function ot(){try{const t=T(),e=await fetch(`${mt()}/health`,{method:"GET"}),n=await e.json().catch(()=>({})),o=e.headers.get("x-schema-version")||n?.schema||null;o&&(x(o),o!==t&&console.log(`schema: ${o} (synced)`)),et(!0),ft(),N(o,null);try{H({cid:null,xcache:null,latencyMs:null,schema:o||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}E(`Health: ${n?.status||"ok"}${o?` (schema ${o})`:""}`)}catch(t){et(!1),p("Health failed"),console.error(t)}}async function Ct(){const t=document.getElementById("btnAnalyze"),e=document.getElementById("busyBar");t&&(t.disabled=!0),e&&(e.style.display="");try{k("");const n=window.__lastAnalyzed,o=n&&n.trim()?n:A(await globalThis.getWholeDocText());if(!o){V("В документе нет текста");return}M(),window.__lastAnalyzed=o;const s=document.getElementById("originalText");s&&(s.value=o);const{resp:a,json:r}=await B("/api/analyze",{text:o});if(!a.ok)throw new Error(`HTTP ${a.status}`);const d=a.headers.get("x-schema-version");d&&x(d),r?.schema&&x(r.schema),R=a.headers.get("x-cid")||"",N(null,R),vt(r),Et(r);try{localStorage.setItem("last_analysis_json",JSON.stringify(r))}catch{}try{const c=globalThis.parseFindings(r),m=Q(),i=G(c,m);U()&&i.length&&await globalThis.annotateFindingsIntoWord(i)}catch(c){console.warn("auto-annotate after analyze failed",c)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:r})),E("Analyze OK")}catch(n){p("Analyze failed"),console.error(n)}finally{t&&(t.disabled=!1),e&&(e.style.display="none")}}async function xt(){M();const t=await D(),{json:e}=await B("/api/qa-recheck",{text:t,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:e})),!e?.error)E("QA recheck OK");else{const o=e?.error||e?.message||"unknown";V(`QA recheck failed: ${o}`)}}function h(t,e){const n=document.querySelector(t);n&&(n.addEventListener("click",o=>{o.preventDefault(),e()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function Bt(){try{const t=window.__lastAnalyzed||"",e=(F($.proposed)?.value||"").trim();if(!e){p("No draft to diff");return}const n=await lt(t,e),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",s=document.getElementById("diffOutput"),a=document.getElementById("diffContainer");s&&a&&(s.innerHTML=o||"",a.style.display=o?"block":"none")}catch(t){p("Diff failed"),console.error(t)}}async function Lt(){try{const t=window.__last||{},e=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!e.length){p("No ops to apply");return}await Z(e),E("Applied ops")}catch(t){p("Insert failed"),console.error(t)}}async function $t(){try{const e=(F($.proposed)?.value||"").trim();if(!e){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),s=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async a=>{const r=a.document.getSelection();a.document.trackRevisions=!0,r.insertText(e,Word.InsertLocation.replace);try{r.insertComment(s)}catch{}await a.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),L(t,"insertDraft"),console.error(t)}}async function Ft(){try{const t=F($.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),k("")),await Word.run(async e=>{const o=e.document.getSelection().revisions;o.load("items"),await e.sync(),(o.items||[]).forEach(s=>{try{s.reject()}catch{}}),await e.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),L(t,"insertDraft"),console.error(t)}}function st(){h("#btnUseWholeDoc",Tt),h("#btnTest",ot),h("#btnQARecheck",xt),document.getElementById("btnSuggestEdit")?.addEventListener("click",kt),h("#btnApplyTracked",Lt),h("#btnAcceptAll",$t),h("#btnRejectAll",Ft),h("#btnPrevIssue",At),h("#btnNextIssue",It),h("#btnPreviewDiff",Bt),h("#btnClearAnnots",_t),h("#btnSave",gt);const t=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");t?(t.checked=U(),t.addEventListener("change",()=>yt(!!t.checked))):U();const e=document.getElementById("btnAnnotate");e&&(e.addEventListener("click",async()=>{if(!e.disabled){e.disabled=!0;try{const o=window.__last?.analyze?.json||{},s=globalThis.parseFindings(o);await globalThis.annotateFindingsIntoWord(s)}finally{e.disabled=!1}}}),e.classList.remove("js-disable-while-busy"),e.removeAttribute("disabled")),k(""),St(),console.log("Panel UI wired");const n=document.getElementById("btnAnalyze");n&&(n.disabled=!0),M(),N()}g.wireUI=g.wireUI||st;function k(t){const e=!!t.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),s=document.getElementById("btnRejectAll"),a=document.getElementById("btnPreviewDiff"),r=document.getElementById("draftPane"),d=document.getElementById("draftText");d&&(d.value=t),r&&(r.style.display=e?"":"none"),n&&(n.disabled=!e),o&&(o.disabled=!e),s&&(s.disabled=!e),a&&(a.disabled=!e)}async function Ot(t){st();try{await ot()}catch{}try{nt(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{nt(null)}}globalThis.__CAI_TESTING__||document.addEventListener("DOMContentLoaded",()=>{typeof Violins<"u"&&typeof Violins.initAudio=="function"&&Violins.initAudio(),Office.onReady(t=>Ot(t)),console.log("ContractAI build","__BUILD_TS__")})})();
