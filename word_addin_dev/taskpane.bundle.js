(function(){"use strict";var de=typeof document<"u"?document.currentScript:null;const he="",ge="1.4",J="cai-comment-on-analyze";function Rt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",he),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",ge),localStorage.getItem(J)===null&&localStorage.setItem(J,"1")}catch{}}Rt();function Q(){try{return localStorage.getItem("api_key")||he}catch{return he}}function He(t){try{localStorage.setItem("api_key",t)}catch{}}function K(){try{return localStorage.getItem("schema_version")||ge}catch{return ge}}function Y(t){try{localStorage.setItem("schema_version",t)}catch{}}function Ot(){try{const t=localStorage.getItem(J);return t===null?(localStorage.setItem(J,"1"),!0):t!=="0"}catch{return!0}}function Nt(t){try{localStorage.setItem(J,t?"1":"0")}catch{}}const F=typeof globalThis<"u"?globalThis:window;F.CAI=F.CAI||{},F.CAI.Store=F.CAI.Store||{},F.CAI.Store.setApiKey=He,F.CAI.Store.setSchemaVersion=Y,F.CAI.Store.get=()=>({apiKey:Q(),schemaVersion:K()}),F.CAI.Store.DEFAULT_BASE=F.CAI.Store.DEFAULT_BASE||"https://127.0.0.1:9443";const N=window;N.__cai_pending_fetches=N.__cai_pending_fetches||new Set,N.__cai_pending_timers=N.__cai_pending_timers||new Set;const G=N.__cai_pending_fetches,ne=N.__cai_pending_timers,V={count:0};function Ft(){V.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:V.count}}))}function Bt(){V.count=Math.max(0,V.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:V.count>0,count:V.count}}))}async function X(t){try{return Ft(),await t()}finally{Bt()}}function $t(t){G.add(t)}function zt(t){G.delete(t)}function Pt(t){ne.add(t)}function Wt(t){ne.delete(t)}function Ue(t){G.forEach(n=>{try{n.abort(t)}catch{}}),G.clear(),ne.forEach(n=>{try{clearTimeout(n),clearInterval(n)}catch{}}),ne.clear();try{document.querySelectorAll(".progress").forEach(n=>{n.style.display="none"})}catch{}}function jt(){if(N.__pendingUnloadReg)return;N.__pendingUnloadReg=!0;const t=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),n=()=>{t&&Ue("pagehide/unload"),N.__wasUnloaded=!0};window.addEventListener("pagehide",n),window.addEventListener("unload",n),window.addEventListener("beforeunload",n),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Ue("visibilitychange")})}function Ht(){return!!N.__wasUnloaded}function Ut(){N.__wasUnloaded=!1}let me=null;async function xe(t={}){if(!me){const n=(t.backend||"").replace(/\/+$/,""),c=n?`${n}/health`:"/health",f=new AbortController,u=t.timeoutMs??9e3,e=setTimeout(()=>f.abort("timeout"),u);me=fetch(c,{signal:f.signal}).then(async r=>{clearTimeout(e);const o=await r.json().catch(()=>({}));return{ok:r.ok,json:o,resp:r}})}return me}var Ke={};const pe=(()=>{if(typeof process<"u"&&(Ke!=null&&!0))return"production";try{if(typeof localStorage<"u")return localStorage.getItem("NODE_ENV")||""}catch{}return"development"})()==="production";function ye(t,n){try{const c=document.getElementById("console");if(!c)return;c.textContent=t,c.setAttribute("data-level",n),setTimeout(()=>{c.textContent="",c.removeAttribute("data-level")},3e3)}catch{}}function q(t,n){ye(t,"ok");try{pe?console.log("[OK]",t):console.log("[OK]",t,n)}catch{}}function Ve(t,n){ye(t,"error");try{pe?console.error("[ERR]",t):console.error("[ERR]",t,n)}catch{}}function D(t,n){ye(t,"warn");try{pe?console.warn("[WARN]",t):console.warn("[WARN]",t,n)}catch{}}const qe=(()=>{try{return localStorage.getItem("cai_dev")==="1"?!0:new URLSearchParams(globalThis.location?.search||"").get("debug")==="1"}catch{return!1}})();function xt(t,n,c){qe?console.error(t,n,c):console.error(t,n)}function Je(t){if(Array.isArray(t))return t.filter(Boolean);const n=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(n)?n.filter(Boolean):[]}window.parseFindings=Je;function Kt(t){const n=t.headers,c=t.json||{},f=c.llm||c;return{cid:n.get("x-cid"),xcache:n.get("x-cache"),latencyMs:n.get("x-latency-ms"),schema:n.get("x-schema-version"),provider:n.get("x-provider")||f.provider||c.provider||null,model:n.get("x-model")||f.model||c.model||null,llm_mode:n.get("x-llm-mode")||f.mode||c.mode||null,usage:n.get("x-usage-total"),status:t.status!=null?String(t.status):null}}function be(t){const n=(c,f)=>{const u=document.getElementById(c);u&&(u.textContent=f&&f.length?f:"—")};n("status",t.status),n("cid",t.cid),n("xcache",t.xcache),n("latency",t.latencyMs),n("schema",t.schema),n("provider",t.provider),n("model",t.model),n("mode",t.llm_mode),n("usage",t.usage)}async function Vt(){const t=new URL(de&&de.tagName.toUpperCase()==="SCRIPT"&&de.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const c=await(await fetch(t)).text(),f=new TextEncoder().encode(c),u=await crypto.subtle.digest("SHA-256",f),e=Array.from(new Uint8Array(u)).slice(0,4).map(r=>r.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${e} ${t}`)}catch{console.log(`[selftest] api-client.js fail ${t}`)}}const Qe="https://127.0.0.1:9443";function qt(){try{return(localStorage.getItem("backendUrl")||Qe).replace(/\/+$/,"")}catch{return Qe}}function Ye(t){const u=Math.ceil((t||0)/1024);return Math.min(12e4,28e3+50*u)}const Jt=9e3,Qt=1,Yt=3e3;async function _e(t,n,c){return X(async()=>{const f=qt()+t,u={"Content-Type":"application/json"},e=K()||"1.4";u["x-schema-version"]=e;const r=Q();r&&(u["x-api-key"]=r);const o={...n||{},schema:e},i=JSON.stringify(o),l=new TextEncoder().encode(i).length;let a=c,s=Qt,d=Yt;if(t==="/api/analyze"){a==null&&(a=Ye(l));try{for(const g of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const m=localStorage.getItem(g);if(m){const y=parseInt(m,10);if(Number.isFinite(y)){a=y;break}}}}catch{}try{const g=localStorage.getItem("cai.retry.analyze.count");g&&(s=parseInt(g,10))}catch{}try{const g=localStorage.getItem("cai.retry.analyze.backoff.ms");g&&(d=parseInt(g,10))}catch{}try{const g=new URLSearchParams(location.search),m=g.get("ta");m&&(a=parseInt(m,10));const y=g.get("rac");y&&(s=parseInt(y,10));const p=g.get("rb");p&&(d=parseInt(p,10))}catch{}}a=a??Jt;async function h(g){const m=new AbortController;m.__key=t;const y=setTimeout(()=>m.abort(`timeout ${a}ms`),a);$t(m),Pt(y);try{const p=await fetch(f,{method:"POST",headers:u,body:i,credentials:"include",signal:m.signal}),b=await p.json().catch(()=>({}));if(p.status===422){console.warn("[analyze] 422",b.detail);const _=Array.isArray(b?.detail)?b.detail.map(v=>v.msg).join("; "):b?.detail;try{D(`Validation error: ${_}`)}catch{}}return t==="/api/analyze"&&(p.status===504||p.status>=500)&&g<s?(await new Promise(_=>setTimeout(_,d)),h(g+1)):{resp:p,json:b}}catch(p){if(t==="/api/analyze"&&p?.name==="AbortError"){const b=m.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${b}`),g<s&&String(b).startsWith("timeout"))return await new Promise(_=>setTimeout(_,d)),h(g+1);throw new DOMException(b,"AbortError")}xt(`[NET] ${t} failed`,p,{body:o});try{const b=qe?String(p):"Analysis failed, please try again";D(b)}catch{}throw p}finally{clearTimeout(y),Wt(y),zt(m)}}return h(0)})}window.postJson=_e;async function Gt(t={}){const n={text:t?.text??t?.content,mode:t?.mode??"live",risk:t?.risk??"medium"};let c=0;const f=i=>{if(!i)return 0;if(typeof i=="string")return new TextEncoder().encode(i).length;if(typeof i=="number"&&Number.isFinite(i))return i;if(typeof i=="object"){const l=i;if(typeof l.text=="string")return new TextEncoder().encode(l.text).length;if(l.text&&typeof l.text.length=="number")return Number(l.text.length)||0}return 0};try{const i=window;if(c=f(i?.__lastAnalyzed),!c){const l=i?.__last?.analyze?.json?.meta?.text_bytes??i?.__last?.analyze?.json?.meta?.textBytes;c=f(l)}}catch{}c||(c=f(n.text));const u=Ye(c),{resp:e,json:r}=await _e("/api/analyze",n,u),o=Kt({headers:e.headers,json:r,status:e.status});try{be(o)}catch{}try{const i=window;i.__last||(i.__last={}),i.__last.analyze={status:e.status,req:{path:"/api/analyze",method:"POST",body:n},json:r}}catch{}return{ok:e.ok,json:r,resp:e,meta:o}}async function Xt(t,n){return _e("/api/panel/redlines",{before_text:t,after_text:n})}function ve(t){return typeof t=="number"&&Number.isFinite(t)?t:void 0}function re(t){return(Je(t)||[]).filter(c=>c&&c.rule_id&&c.snippet).map(c=>({...c,start:ve(c.start),end:ve(c.end),nth:ve(c.nth),clause_type:c.clause_type||"Unknown"})).filter(c=>c.clause_type)}const Zt={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]},en=new Set(["​","‌","‍","‎","‏","⁠","⁡","⁢","⁣","⁤","\uFEFF"]),tn=new Set([" "," "]),Ge={"‐":"-","‑":"-","‒":"-","–":"-","—":"-","―":"-","−":"-"},Xe={"“":'"',"”":'"',"„":'"',"‟":'"',"«":'"',"»":'"',"″":'"',"‶":'"'},Ze={"‘":"'","’":"'","‚":"'","‛":"'","′":"'","‵":"'"};function nn(t){return en.has(t)}function rn(t){return Ge[t]?Ge[t]:Xe[t]?Xe[t]:Ze[t]?Ze[t]:tn.has(t)?" ":t}function an(t){const{text:n,map:c}=t;let f=0,u=n.length;for(;f<u&&/\s/.test(n[f]);)f++;for(;u>f&&/\s/.test(n[u-1]);)u--;return f===0&&u===n.length?t:{text:n.slice(f,u),map:c.slice(f,u)}}function we(t){const n=typeof t=="string"?t.normalize("NFC"):"";if(!n)return{text:"",map:[]};const c=[],f=[];let u=!1;for(let o=0;o<n.length;){const i=n.codePointAt(o);let l=String.fromCodePoint(i);const a=l.length;if(l==="\r"){f.push(o),c.push(`
`),o+=a,o<n.length&&n[o]===`
`&&(o+=1),u=!1;continue}if(l===`
`){f.push(o),c.push(`
`),o+=a,u=!1;continue}if(nn(l)){o+=a;continue}if(l=rn(l),l==="	"&&(l=" "),l===" "){if(u){o+=a;continue}u=!0}else u=!1;c.push(l),f.push(o),o+=a}const r={text:c.join("").normalize("NFC"),map:f};return an(r)}function z(t){return t?we(t).text:""}const et=["low","medium","high","critical"];function ae(t){return z(t??"")}function on(t){if(typeof t!="string")return null;const n=t.trim().toLowerCase();return n==="low"||n==="medium"||n==="high"||n==="critical"?n:null}function oe(t){const n=on(t);return n?et.indexOf(n):et.indexOf("medium")}function tt(t){const n=new Map;let c=0,f=0;for(const e of t||[]){const r=ae(e.snippet||""),o=typeof e.start=="number"?e.start:void 0,i=typeof e.end=="number"?e.end:o!==void 0?o+r.length:void 0;if(typeof o!="number"||typeof i!="number"||i<=o||i-o>1e4){c++;continue}const l=`${e.rule_id||""}|${o}|${i}|${r}`,a=n.get(l);!a||oe(e.severity)>oe(a.severity)?n.set(l,{...e,snippet:r,start:o,end:i}):f++}const u=Array.from(n.values());return console.log("panel:annotate",`dedupe dropped ${c} invalid, ${f} duplicates`),u}async function H(t,n,c){const f=t?.context,u=(n??"").trim();if(!u)return{items:[]};if(u.length<=240)try{const l=t.search(u,c);return l?.load?.("items"),await f?.sync?.(),l}catch{return{items:[]}}const e=u.slice(0,120);let r;try{r=t.search(e,c),r?.load?.("items"),await f?.sync?.()}catch{return{items:[]}}const o=[],i=u.slice(0,240);for(const l of r?.items||[]){let a=l;try{a=l.paragraphs?.getFirst?.()||l,a?.load?.("text"),await f?.sync?.()}catch{}const s=a?.text||"";if(s.includes(i))try{const g=a.search(i,c);g?.load?.("items"),await f?.sync?.(),g?.items?.length&&o.push(...g.items);continue}catch{}const d=i.split(/\s+/).filter(g=>g.length>3).slice(0,5);let h=!0;for(const g of d)if(!s.includes(g)){h=!1;break}h&&o.push(a)}return{items:o}}function nt(t){return t?we(String(t)).text:""}function rt(t){if(!t)return null;const c=z(String(t)).replace(/[^\p{L}\p{N} ]/gu," ").split(" ").map(e=>e.trim()).filter(Boolean);if(!c.length)return null;const f=c.sort((e,r)=>r.length-e.length),u=f.find(e=>e.length>=8)||f[0];return u?u.slice(0,64):null}async function ie(t,n,c){const f=t.context,u={matchCase:!1,matchWholeWord:!1},e=async s=>await H(t,s,u),r=n||"";let i=(await e(r))?.items||[];if(!i.length){const s=z(r).trim();s&&(i=(await e(s))?.items||[])}i.sort((s,d)=>{const h=s.start??0,g=d.start??0;if(h!==g)return h-g;const m=s.end??h,y=d.end??g;return m-y});const l=[];for(const s of i){const d=s.start??0,h=s.end??d,g=l[l.length-1];if(g&&d<(g.end??d)){const m=(g.end??0)-(g.start??0);h-d>m&&(l[l.length-1]=s);continue}l.push(s)}const a=c?.nth;if(typeof a=="number"&&Number.isFinite(a)&&a>=0&&l.length){const s=Math.min(Math.floor(a),l.length-1),d=l[s];if(d){const h=[d,...l.slice(0,s),...l.slice(s+1)];l.length=0,l.push(...h)}}for(const s of l)try{f.trackedObjects?.add?.(s)}catch{}return l}async function Ae(t,n,c,f){if(!t||!n)return null;const u=typeof c=="number"&&Number.isFinite(c)&&c>=0?Math.floor(c):0,e=f||{matchCase:!1,matchWholeWord:!1};let o=(await H(t,n,e))?.items||[];if(!o.length){const l=z(n).trim();l&&l!==n&&(o=(await H(t,l,e))?.items||[])}if(!o.length||u>=o.length)return null;const i=o[u]??null;if(!i)return null;try{t.context?.trackedObjects?.add?.(i)}catch{}return i}function se(t,n,c){if(!n)return;const f=nt(n);f&&(c&&f===c||t.add(f))}function sn(t,n){if(n)try{t.context?.trackedObjects?.add?.(n)}catch{}}async function cn(t){if(!t?.body||!t.snippet)return null;const{body:n,snippet:c}=t,f=t.searchOptions||{matchCase:!1,matchWholeWord:!1},u=typeof t.nth=="number"&&Number.isFinite(t.nth)&&t.nth>=0?Math.floor(t.nth):0,e=s=>{try{t.onMethod?.(s)}catch{}};if(globalThis?.__cfg_anchorOffsets!==0&&typeof t.start=="number"&&Number.isFinite(t.start)&&t.start>=0){const s=Math.floor(t.start),d=typeof t.end=="number"&&Number.isFinite(t.end)&&t.end>=t.start?Math.floor(t.end):s+nt(c).length,h=Math.max(1,d-s),g=new Set;c&&g.add(c),se(g,c);for(const p of t.normalizedCandidates||[])se(g,p);let m=null,y=Number.POSITIVE_INFINITY;for(const p of g){if(!p)continue;const _=(await H(n,p,f))?.items||[];for(const v of _){const E=typeof v.start=="number"?v.start:0,A=Math.abs(E-s);if(A<y&&(y=A,m=v,A===0))break}if(y===0)break}if(m&&y<=Math.max(5,h))return sn(n,m),e("offset"),m}let i=await Ae(n,c,u,f);if(i)return e("nth"),i;const l=new Set;se(l,c,c);for(const s of t.normalizedCandidates||[])se(l,s,c);for(const s of l)if(i=await Ae(n,s,u,f),i)return e("normalized"),i;const a=t.token??rt(c);if(a){const s=await Ae(n,a,0,f);if(s)return e("token"),s}return null}async function Ee(t,n){try{if(!Office.context.requirements.isSetSupported("WordApi","1.4"))return!1}catch{return!1}const c=t.context;let f=null;try{const e=c?.document;if(e?.comments?.add)return e.comments.add(t,n),await c?.sync?.(),{ok:!0}}catch(e){if(e?.code==="NotImplemented")return!1}try{return t.insertComment(n),await c?.sync?.(),{ok:!0}}catch(e){f=e}try{await c?.sync?.();const e=c?.document;if(e?.comments?.add)return e.comments.add(t,n),await c?.sync?.(),{ok:!0}}catch(e){f=e}const u=globalThis;return console.warn("safeInsertComment failed",f),u.logRichError?.(f,"insertComment"),u.notifyWarn?.("Failed to insert comment"),{ok:!1,err:f}}async function ce(t,n){const c=t.context;try{t.load?.("parentContentControl"),await c?.sync?.()}catch{}try{const f=t.parentContentControl;if(f&&f.tag==="cai-note")return{ok:!1}}catch{}try{const f=t.insertContentControl();f.tag="cai-note",f.title="ContractAI Note";try{f.color="yellow"}catch{}return f.insertText(`CAI: ${n}`,Word.InsertLocation.end),await c?.sync?.(),{ok:!0}}catch(f){return console.warn("fallbackAnnotateWithContentControl failed",f),{ok:!1}}}function ln(t,n,c){if(!t||!n)return 0;let f=-1,u=0;for(;(f=t.indexOf(n,f+1))!==-1&&f<(c??t.length);)u++;return u}const at=new Map;function fn(t){let n=at.get(t);return n||(n=we(t),at.set(t,n)),n}function un(t,n,c){if(!t||!n||typeof c!="number"||!Number.isFinite(c)||c<0)return null;const f=z(n).trim();if(!f)return null;const{text:u,map:e}=fn(t);if(!u)return null;const r=Math.floor(c);let o=e.length;for(let a=0;a<e.length;a++)if(e[a]>=r){o=a;break}let i=0,l=0;for(;;){const a=u.indexOf(f,l);if(a===-1||a>=o)break;i++,l=a+Math.max(f.length,1)}return i}function ot(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const B="[CAI]";function dn(t){if(!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const n=[t.rule_id];if(t.advice&&n.push(t.advice),t.law_refs?.length&&n.push(t.law_refs.join("; ")),t.norm_quote&&n.push(`"${t.norm_quote}"`),t.clause_url||t.clause_id){const c=t.clause_id?`Clause ${t.clause_id}`:"Clause";t.clause_url?n.push(`${c}: ${t.clause_url}`):n.push(c)}return`${B} ${n.join(`
`)}`}const Ce=200;function ke(t){const n=String(globalThis.__lastAnalyzed||""),c=z(n).trim(),f=Array.isArray(t)?t:[],u=tt(f),e=u.slice().sort((a,s)=>(a.start??Number.POSITIVE_INFINITY)-(s.start??Number.POSITIVE_INFINITY)),r=[];let o=-1,i=0;for(const a of e){if(!a||!a.rule_id||!a.snippet||typeof a.start!="number"){i++;continue}const s=a.snippet,d=a.start,h=typeof a.end=="number"?a.end:d+s.length;if(d<o){i++;continue}const g=z(s).trim(),m=typeof a.nth=="number"?a.nth:un(n,s,d),y=typeof m=="number"&&m>=0?Math.floor(m):void 0,p=typeof y=="number"?y:ln(c,g,d);if(r.push({raw:s,norm:g,occIdx:p,msg:dn(a),rule_id:a.rule_id,code:a.code,normalized_fallback:z(a.normalized_snippet||"").trim(),start:d,end:h,nth:y}),o=h,r.length>=Ce)break}const l=globalThis;return i&&l.notifyWarn?.(`Skipped ${i} overlaps/invalid`),u.length>Ce&&l.notifyWarn?.(`Truncated to first ${Ce} findings`),l.notifyOk?.(`Will insert: ${r.length}`),r}async function it(t){const n=ke(t);return n.length?await globalThis.Word?.run?.(async f=>{const u=f.document.body,e={matchCase:!1,matchWholeWord:!1},r=[];let o=0;for(const i of n){const l=typeof i.nth=="number"?i.nth:i.occIdx;let a=null,s;const d=[i.normalized_fallback&&i.normalized_fallback!==i.raw?i.normalized_fallback:null,i.norm&&i.norm!==i.raw?i.norm:null];try{a=await cn({body:u,snippet:i.raw,start:i.start,end:i.end,nth:typeof l=="number"?l:void 0,searchOptions:e,normalizedCandidates:d,token:rt(i.raw),onMethod:h=>{s=h}})}catch(h){console.warn("anchorByOffsets failed",h)}if(!a){const g=(await ie(u,i.raw,{nth:typeof l=="number"?l:void 0}))[0]||null;g&&(a=g,s||(s="nth"))}if(a){a.load?.(["start","end"]),await f.sync();const h=a.start??0,g=a.end??h;if(r.some(y=>Math.max(y.start,h)<Math.min(y.end,g))){console.warn("[annotate] overlapping range",{rid:i.rule_id,start:h,end:g});continue}let m=!1;if(ot())try{a.select(),m=!0}catch{}else i.msg&&((await Ee(a,i.msg)).ok?m=!0:(m=(await ce(a,i.msg.replace(B,"").trim())).ok,m&&(s="cc")));m&&(r.push({start:h,end:g}),o++,s&&console.log("[annotate] anchor",{rid:i.rule_id,anchor_method:s}))}else if(console.warn("[annotate] no match for snippet",{rid:i.rule_id,snippet:i.raw.slice(0,120)}),!ot())try{const h=u.getRange?.("End")??null;h&&(await ce(h,i.msg.replace(B,"").trim())).ok&&(o++,console.log("[annotate] anchor",{rid:i.rule_id,anchor_method:"cc"}))}catch(h){console.warn("[annotate] cc fallback failed",h)}await f.sync()}return o}).catch(f=>(globalThis.logRichError?.(f,"annotate"),console.warn("annotate run fail",f?.code,f?.message,f?.debugInfo),0)):0}async function hn(t,n,c){if(!t||!t.trim())return;const f=globalThis;if(!f.Word?.run){await f.navigator?.clipboard?.writeText(t).catch(()=>{}),f.alert?.("Draft copied to clipboard (Office not ready). Paste it into the document.");return}if(f.Office?.context?.document?.mode&&f.Office.context.document.mode!=="edit")throw f.alert?.("Document is read-only."),new Error("Document mode is not editable");await f.Word.run(async u=>{const e=u.document;let r=null;const o=e.trackRevisions;try{const h=f.__findings||[],g=f.__findingIdx,m=h&&typeof g=="number"?h[g]:null,y=e.body;if(r=(m?.snippet?await ie(y,m.snippet):[])[0]||null,!r){const b=e.getSelection();b.load("isEmpty"),await u.sync(),r=b.isEmpty?e.body.getRange("End"):b}}catch{const h=e.getSelection();h.load("isEmpty"),await u.sync(),r=h.isEmpty?e.body.getRange("End"):h}e.trackRevisions=!0;const i=r.insertText(t,f.Word.InsertLocation.replace),l=[`${B} Suggested clause – ${n}`],a=(c||"").split(/\r?\n/).slice(0,2).join(" "),s=f.__findings||[],d=f.__findingIdx;if(a)l.push(a);else{const h=s&&typeof d=="number"?s[d]:null,g=h?.rule_id||h?.title||"";g&&l.push(g)}l.push("schema 1.4 | model gpt-4o-mini | provider azure");try{e.comments.add(i,l.join(`
`))}catch{}await u.sync(),e.trackRevisions=o,await u.sync()}).catch(u=>{throw globalThis.logRichError?.(u,"insertDraft"),console.warn("insertDraftText error",u?.code,u?.message,u?.debugInfo),u})}function gn(){const t=globalThis,n=!!t.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),c=t.Word||{},f=!!c?.Comment,u=(()=>{try{const a=t.localStorage?.getItem?.("cai.force.comments");if(!a)return!1;const s=String(a).trim().toLowerCase();return s!=="0"&&s!=="false"&&s!=="no"}catch{return!1}})(),e=!!(n||u||f),r=u?"forced by cai.force.comments":n?"WordApi 1.4":f?"Word.Comment":"WordApi < 1.4",o=!!(n&&c?.Revision),i=!!(n&&c?.SearchOptions),l=!!(n&&c?.ContentControl);return{revisions:o,comments:e,search:i,contentControls:l,commentsReason:r}}function st(){const t=gn();try{console.log("support matrix",t)}catch{}return t}async function mn(t){const n=[];try{await Vt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(a=>{document.getElementById(a)||n.push(`missingID:${a}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||n.push("req1.4:0");const c=st(),f={revisions:c.revisions?1:0,comments:c.comments?1:0,search:c.search?1:0,contentControls:c.contentControls?1:0};let u=!1;try{u=(await xe({backend:t})).ok,u||n.push("health")}catch{n.push("health:timeout")}const e="build-20250921-085759",r=Office?.context?.host||"Word",o=n.length===0,i=o?`Startup OK | build=${e} | host=${r} | req=1.4 | features=${JSON.stringify(f)} | backend=${t}`:`Startup FAIL: ${n.join("; ")}`;console.log(i);const l=document.getElementById("startupBadge");return l&&(l.textContent=o?"OK":"FAIL",l.setAttribute("data-status",o?"ok":"fail")),{ok:o,missing:n,features:f}}function pn(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Se={exports:{}},ct;function yn(){return ct||(ct=1,(function(t){var n=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},c=-1,f=1,u=0;n.Diff=function(e,r){return[e,r]},n.prototype.diff_main=function(e,r,o,i){typeof i>"u"&&(this.Diff_Timeout<=0?i=Number.MAX_VALUE:i=new Date().getTime()+this.Diff_Timeout*1e3);var l=i;if(e==null||r==null)throw new Error("Null input. (diff_main)");if(e==r)return e?[new n.Diff(u,e)]:[];typeof o>"u"&&(o=!0);var a=o,s=this.diff_commonPrefix(e,r),d=e.substring(0,s);e=e.substring(s),r=r.substring(s),s=this.diff_commonSuffix(e,r);var h=e.substring(e.length-s);e=e.substring(0,e.length-s),r=r.substring(0,r.length-s);var g=this.diff_compute_(e,r,a,l);return d&&g.unshift(new n.Diff(u,d)),h&&g.push(new n.Diff(u,h)),this.diff_cleanupMerge(g),g},n.prototype.diff_compute_=function(e,r,o,i){var l;if(!e)return[new n.Diff(f,r)];if(!r)return[new n.Diff(c,e)];var a=e.length>r.length?e:r,s=e.length>r.length?r:e,d=a.indexOf(s);if(d!=-1)return l=[new n.Diff(f,a.substring(0,d)),new n.Diff(u,s),new n.Diff(f,a.substring(d+s.length))],e.length>r.length&&(l[0][0]=l[2][0]=c),l;if(s.length==1)return[new n.Diff(c,e),new n.Diff(f,r)];var h=this.diff_halfMatch_(e,r);if(h){var g=h[0],m=h[1],y=h[2],p=h[3],b=h[4],_=this.diff_main(g,y,o,i),v=this.diff_main(m,p,o,i);return _.concat([new n.Diff(u,b)],v)}return o&&e.length>100&&r.length>100?this.diff_lineMode_(e,r,i):this.diff_bisect_(e,r,i)},n.prototype.diff_lineMode_=function(e,r,o){var i=this.diff_linesToChars_(e,r);e=i.chars1,r=i.chars2;var l=i.lineArray,a=this.diff_main(e,r,!1,o);this.diff_charsToLines_(a,l),this.diff_cleanupSemantic(a),a.push(new n.Diff(u,""));for(var s=0,d=0,h=0,g="",m="";s<a.length;){switch(a[s][0]){case f:h++,m+=a[s][1];break;case c:d++,g+=a[s][1];break;case u:if(d>=1&&h>=1){a.splice(s-d-h,d+h),s=s-d-h;for(var y=this.diff_main(g,m,!1,o),p=y.length-1;p>=0;p--)a.splice(s,0,y[p]);s=s+y.length}h=0,d=0,g="",m="";break}s++}return a.pop(),a},n.prototype.diff_bisect_=function(e,r,o){for(var i=e.length,l=r.length,a=Math.ceil((i+l)/2),s=a,d=2*a,h=new Array(d),g=new Array(d),m=0;m<d;m++)h[m]=-1,g[m]=-1;h[s+1]=0,g[s+1]=0;for(var y=i-l,p=y%2!=0,b=0,_=0,v=0,E=0,A=0;A<a&&!(new Date().getTime()>o);A++){for(var C=-A+b;C<=A-_;C+=2){var k=s+C,I;C==-A||C!=A&&h[k-1]<h[k+1]?I=h[k+1]:I=h[k-1]+1;for(var L=I-C;I<i&&L<l&&e.charAt(I)==r.charAt(L);)I++,L++;if(h[k]=I,I>i)_+=2;else if(L>l)b+=2;else if(p){var M=s+y-C;if(M>=0&&M<d&&g[M]!=-1){var T=i-g[M];if(I>=T)return this.diff_bisectSplit_(e,r,I,L,o)}}}for(var R=-A+v;R<=A-E;R+=2){var M=s+R,T;R==-A||R!=A&&g[M-1]<g[M+1]?T=g[M+1]:T=g[M-1]+1;for(var $=T-R;T<i&&$<l&&e.charAt(i-T-1)==r.charAt(l-$-1);)T++,$++;if(g[M]=T,T>i)E+=2;else if($>l)v+=2;else if(!p){var k=s+y-R;if(k>=0&&k<d&&h[k]!=-1){var I=h[k],L=s+I-k;if(T=i-T,I>=T)return this.diff_bisectSplit_(e,r,I,L,o)}}}}return[new n.Diff(c,e),new n.Diff(f,r)]},n.prototype.diff_bisectSplit_=function(e,r,o,i,l){var a=e.substring(0,o),s=r.substring(0,i),d=e.substring(o),h=r.substring(i),g=this.diff_main(a,s,!1,l),m=this.diff_main(d,h,!1,l);return g.concat(m)},n.prototype.diff_linesToChars_=function(e,r){var o=[],i={};o[0]="";function l(h){for(var g="",m=0,y=-1,p=o.length;y<h.length-1;){y=h.indexOf(`
`,m),y==-1&&(y=h.length-1);var b=h.substring(m,y+1);(i.hasOwnProperty?i.hasOwnProperty(b):i[b]!==void 0)?g+=String.fromCharCode(i[b]):(p==a&&(b=h.substring(m),y=h.length),g+=String.fromCharCode(p),i[b]=p,o[p++]=b),m=y+1}return g}var a=4e4,s=l(e);a=65535;var d=l(r);return{chars1:s,chars2:d,lineArray:o}},n.prototype.diff_charsToLines_=function(e,r){for(var o=0;o<e.length;o++){for(var i=e[o][1],l=[],a=0;a<i.length;a++)l[a]=r[i.charCodeAt(a)];e[o][1]=l.join("")}},n.prototype.diff_commonPrefix=function(e,r){if(!e||!r||e.charAt(0)!=r.charAt(0))return 0;for(var o=0,i=Math.min(e.length,r.length),l=i,a=0;o<l;)e.substring(a,l)==r.substring(a,l)?(o=l,a=o):i=l,l=Math.floor((i-o)/2+o);return l},n.prototype.diff_commonSuffix=function(e,r){if(!e||!r||e.charAt(e.length-1)!=r.charAt(r.length-1))return 0;for(var o=0,i=Math.min(e.length,r.length),l=i,a=0;o<l;)e.substring(e.length-l,e.length-a)==r.substring(r.length-l,r.length-a)?(o=l,a=o):i=l,l=Math.floor((i-o)/2+o);return l},n.prototype.diff_commonOverlap_=function(e,r){var o=e.length,i=r.length;if(o==0||i==0)return 0;o>i?e=e.substring(o-i):o<i&&(r=r.substring(0,o));var l=Math.min(o,i);if(e==r)return l;for(var a=0,s=1;;){var d=e.substring(l-s),h=r.indexOf(d);if(h==-1)return a;s+=h,(h==0||e.substring(l-s)==r.substring(0,s))&&(a=s,s++)}},n.prototype.diff_halfMatch_=function(e,r){if(this.Diff_Timeout<=0)return null;var o=e.length>r.length?e:r,i=e.length>r.length?r:e;if(o.length<4||i.length*2<o.length)return null;var l=this;function a(_,v,E){for(var A=_.substring(E,E+Math.floor(_.length/4)),C=-1,k="",I,L,M,T;(C=v.indexOf(A,C+1))!=-1;){var R=l.diff_commonPrefix(_.substring(E),v.substring(C)),$=l.diff_commonSuffix(_.substring(0,E),v.substring(0,C));k.length<$+R&&(k=v.substring(C-$,C)+v.substring(C,C+R),I=_.substring(0,E-$),L=_.substring(E+R),M=v.substring(0,C-$),T=v.substring(C+R))}return k.length*2>=_.length?[I,L,M,T,k]:null}var s=a(o,i,Math.ceil(o.length/4)),d=a(o,i,Math.ceil(o.length/2)),h;if(!s&&!d)return null;d?s?h=s[4].length>d[4].length?s:d:h=d:h=s;var g,m,y,p;e.length>r.length?(g=h[0],m=h[1],y=h[2],p=h[3]):(y=h[0],p=h[1],g=h[2],m=h[3]);var b=h[4];return[g,m,y,p,b]},n.prototype.diff_cleanupSemantic=function(e){for(var r=!1,o=[],i=0,l=null,a=0,s=0,d=0,h=0,g=0;a<e.length;)e[a][0]==u?(o[i++]=a,s=h,d=g,h=0,g=0,l=e[a][1]):(e[a][0]==f?h+=e[a][1].length:g+=e[a][1].length,l&&l.length<=Math.max(s,d)&&l.length<=Math.max(h,g)&&(e.splice(o[i-1],0,new n.Diff(c,l)),e[o[i-1]+1][0]=f,i--,i--,a=i>0?o[i-1]:-1,s=0,d=0,h=0,g=0,l=null,r=!0)),a++;for(r&&this.diff_cleanupMerge(e),this.diff_cleanupSemanticLossless(e),a=1;a<e.length;){if(e[a-1][0]==c&&e[a][0]==f){var m=e[a-1][1],y=e[a][1],p=this.diff_commonOverlap_(m,y),b=this.diff_commonOverlap_(y,m);p>=b?(p>=m.length/2||p>=y.length/2)&&(e.splice(a,0,new n.Diff(u,y.substring(0,p))),e[a-1][1]=m.substring(0,m.length-p),e[a+1][1]=y.substring(p),a++):(b>=m.length/2||b>=y.length/2)&&(e.splice(a,0,new n.Diff(u,m.substring(0,b))),e[a-1][0]=f,e[a-1][1]=y.substring(0,y.length-b),e[a+1][0]=c,e[a+1][1]=m.substring(b),a++),a++}a++}},n.prototype.diff_cleanupSemanticLossless=function(e){function r(b,_){if(!b||!_)return 6;var v=b.charAt(b.length-1),E=_.charAt(0),A=v.match(n.nonAlphaNumericRegex_),C=E.match(n.nonAlphaNumericRegex_),k=A&&v.match(n.whitespaceRegex_),I=C&&E.match(n.whitespaceRegex_),L=k&&v.match(n.linebreakRegex_),M=I&&E.match(n.linebreakRegex_),T=L&&b.match(n.blanklineEndRegex_),R=M&&_.match(n.blanklineStartRegex_);return T||R?5:L||M?4:A&&!k&&I?3:k||I?2:A||C?1:0}for(var o=1;o<e.length-1;){if(e[o-1][0]==u&&e[o+1][0]==u){var i=e[o-1][1],l=e[o][1],a=e[o+1][1],s=this.diff_commonSuffix(i,l);if(s){var d=l.substring(l.length-s);i=i.substring(0,i.length-s),l=d+l.substring(0,l.length-s),a=d+a}for(var h=i,g=l,m=a,y=r(i,l)+r(l,a);l.charAt(0)===a.charAt(0);){i+=l.charAt(0),l=l.substring(1)+a.charAt(0),a=a.substring(1);var p=r(i,l)+r(l,a);p>=y&&(y=p,h=i,g=l,m=a)}e[o-1][1]!=h&&(h?e[o-1][1]=h:(e.splice(o-1,1),o--),e[o][1]=g,m?e[o+1][1]=m:(e.splice(o+1,1),o--))}o++}},n.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,n.whitespaceRegex_=/\s/,n.linebreakRegex_=/[\r\n]/,n.blanklineEndRegex_=/\n\r?\n$/,n.blanklineStartRegex_=/^\r?\n\r?\n/,n.prototype.diff_cleanupEfficiency=function(e){for(var r=!1,o=[],i=0,l=null,a=0,s=!1,d=!1,h=!1,g=!1;a<e.length;)e[a][0]==u?(e[a][1].length<this.Diff_EditCost&&(h||g)?(o[i++]=a,s=h,d=g,l=e[a][1]):(i=0,l=null),h=g=!1):(e[a][0]==c?g=!0:h=!0,l&&(s&&d&&h&&g||l.length<this.Diff_EditCost/2&&s+d+h+g==3)&&(e.splice(o[i-1],0,new n.Diff(c,l)),e[o[i-1]+1][0]=f,i--,l=null,s&&d?(h=g=!0,i=0):(i--,a=i>0?o[i-1]:-1,h=g=!1),r=!0)),a++;r&&this.diff_cleanupMerge(e)},n.prototype.diff_cleanupMerge=function(e){e.push(new n.Diff(u,""));for(var r=0,o=0,i=0,l="",a="",s;r<e.length;)switch(e[r][0]){case f:i++,a+=e[r][1],r++;break;case c:o++,l+=e[r][1],r++;break;case u:o+i>1?(o!==0&&i!==0&&(s=this.diff_commonPrefix(a,l),s!==0&&(r-o-i>0&&e[r-o-i-1][0]==u?e[r-o-i-1][1]+=a.substring(0,s):(e.splice(0,0,new n.Diff(u,a.substring(0,s))),r++),a=a.substring(s),l=l.substring(s)),s=this.diff_commonSuffix(a,l),s!==0&&(e[r][1]=a.substring(a.length-s)+e[r][1],a=a.substring(0,a.length-s),l=l.substring(0,l.length-s))),r-=o+i,e.splice(r,o+i),l.length&&(e.splice(r,0,new n.Diff(c,l)),r++),a.length&&(e.splice(r,0,new n.Diff(f,a)),r++),r++):r!==0&&e[r-1][0]==u?(e[r-1][1]+=e[r][1],e.splice(r,1)):r++,i=0,o=0,l="",a="";break}e[e.length-1][1]===""&&e.pop();var d=!1;for(r=1;r<e.length-1;)e[r-1][0]==u&&e[r+1][0]==u&&(e[r][1].substring(e[r][1].length-e[r-1][1].length)==e[r-1][1]?(e[r][1]=e[r-1][1]+e[r][1].substring(0,e[r][1].length-e[r-1][1].length),e[r+1][1]=e[r-1][1]+e[r+1][1],e.splice(r-1,1),d=!0):e[r][1].substring(0,e[r+1][1].length)==e[r+1][1]&&(e[r-1][1]+=e[r+1][1],e[r][1]=e[r][1].substring(e[r+1][1].length)+e[r+1][1],e.splice(r+1,1),d=!0)),r++;d&&this.diff_cleanupMerge(e)},n.prototype.diff_xIndex=function(e,r){var o=0,i=0,l=0,a=0,s;for(s=0;s<e.length&&(e[s][0]!==f&&(o+=e[s][1].length),e[s][0]!==c&&(i+=e[s][1].length),!(o>r));s++)l=o,a=i;return e.length!=s&&e[s][0]===c?a:a+(r-l)},n.prototype.diff_prettyHtml=function(e){for(var r=[],o=/&/g,i=/</g,l=/>/g,a=/\n/g,s=0;s<e.length;s++){var d=e[s][0],h=e[s][1],g=h.replace(o,"&amp;").replace(i,"&lt;").replace(l,"&gt;").replace(a,"&para;<br>");switch(d){case f:r[s]='<ins style="background:#e6ffe6;">'+g+"</ins>";break;case c:r[s]='<del style="background:#ffe6e6;">'+g+"</del>";break;case u:r[s]="<span>"+g+"</span>";break}}return r.join("")},n.prototype.diff_text1=function(e){for(var r=[],o=0;o<e.length;o++)e[o][0]!==f&&(r[o]=e[o][1]);return r.join("")},n.prototype.diff_text2=function(e){for(var r=[],o=0;o<e.length;o++)e[o][0]!==c&&(r[o]=e[o][1]);return r.join("")},n.prototype.diff_levenshtein=function(e){for(var r=0,o=0,i=0,l=0;l<e.length;l++){var a=e[l][0],s=e[l][1];switch(a){case f:o+=s.length;break;case c:i+=s.length;break;case u:r+=Math.max(o,i),o=0,i=0;break}}return r+=Math.max(o,i),r},n.prototype.diff_toDelta=function(e){for(var r=[],o=0;o<e.length;o++)switch(e[o][0]){case f:r[o]="+"+encodeURI(e[o][1]);break;case c:r[o]="-"+e[o][1].length;break;case u:r[o]="="+e[o][1].length;break}return r.join("	").replace(/%20/g," ")},n.prototype.diff_fromDelta=function(e,r){for(var o=[],i=0,l=0,a=r.split(/\t/g),s=0;s<a.length;s++){var d=a[s].substring(1);switch(a[s].charAt(0)){case"+":try{o[i++]=new n.Diff(f,decodeURI(d))}catch{throw new Error("Illegal escape in diff_fromDelta: "+d)}break;case"-":case"=":var h=parseInt(d,10);if(isNaN(h)||h<0)throw new Error("Invalid number in diff_fromDelta: "+d);var g=e.substring(l,l+=h);a[s].charAt(0)=="="?o[i++]=new n.Diff(u,g):o[i++]=new n.Diff(c,g);break;default:if(a[s])throw new Error("Invalid diff operation in diff_fromDelta: "+a[s])}}if(l!=e.length)throw new Error("Delta length ("+l+") does not equal source text length ("+e.length+").");return o},n.prototype.match_main=function(e,r,o){if(e==null||r==null||o==null)throw new Error("Null input. (match_main)");return o=Math.max(0,Math.min(o,e.length)),e==r?0:e.length?e.substring(o,o+r.length)==r?o:this.match_bitap_(e,r,o):-1},n.prototype.match_bitap_=function(e,r,o){if(r.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var i=this.match_alphabet_(r),l=this;function a(I,L){var M=I/r.length,T=Math.abs(o-L);return l.Match_Distance?M+T/l.Match_Distance:T?1:M}var s=this.Match_Threshold,d=e.indexOf(r,o);d!=-1&&(s=Math.min(a(0,d),s),d=e.lastIndexOf(r,o+r.length),d!=-1&&(s=Math.min(a(0,d),s)));var h=1<<r.length-1;d=-1;for(var g,m,y=r.length+e.length,p,b=0;b<r.length;b++){for(g=0,m=y;g<m;)a(b,o+m)<=s?g=m:y=m,m=Math.floor((y-g)/2+g);y=m;var _=Math.max(1,o-m+1),v=Math.min(o+m,e.length)+r.length,E=Array(v+2);E[v+1]=(1<<b)-1;for(var A=v;A>=_;A--){var C=i[e.charAt(A-1)];if(b===0?E[A]=(E[A+1]<<1|1)&C:E[A]=(E[A+1]<<1|1)&C|((p[A+1]|p[A])<<1|1)|p[A+1],E[A]&h){var k=a(b,A-1);if(k<=s)if(s=k,d=A-1,d>o)_=Math.max(1,2*o-d);else break}}if(a(b+1,o)>s)break;p=E}return d},n.prototype.match_alphabet_=function(e){for(var r={},o=0;o<e.length;o++)r[e.charAt(o)]=0;for(var o=0;o<e.length;o++)r[e.charAt(o)]|=1<<e.length-o-1;return r},n.prototype.patch_addContext_=function(e,r){if(r.length!=0){if(e.start2===null)throw Error("patch not initialized");for(var o=r.substring(e.start2,e.start2+e.length1),i=0;r.indexOf(o)!=r.lastIndexOf(o)&&o.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)i+=this.Patch_Margin,o=r.substring(e.start2-i,e.start2+e.length1+i);i+=this.Patch_Margin;var l=r.substring(e.start2-i,e.start2);l&&e.diffs.unshift(new n.Diff(u,l));var a=r.substring(e.start2+e.length1,e.start2+e.length1+i);a&&e.diffs.push(new n.Diff(u,a)),e.start1-=l.length,e.start2-=l.length,e.length1+=l.length+a.length,e.length2+=l.length+a.length}},n.prototype.patch_make=function(e,r,o){var i,l;if(typeof e=="string"&&typeof r=="string"&&typeof o>"u")i=e,l=this.diff_main(i,r,!0),l.length>2&&(this.diff_cleanupSemantic(l),this.diff_cleanupEfficiency(l));else if(e&&typeof e=="object"&&typeof r>"u"&&typeof o>"u")l=e,i=this.diff_text1(l);else if(typeof e=="string"&&r&&typeof r=="object"&&typeof o>"u")i=e,l=r;else if(typeof e=="string"&&typeof r=="string"&&o&&typeof o=="object")i=e,l=o;else throw new Error("Unknown call format to patch_make.");if(l.length===0)return[];for(var a=[],s=new n.patch_obj,d=0,h=0,g=0,m=i,y=i,p=0;p<l.length;p++){var b=l[p][0],_=l[p][1];switch(!d&&b!==u&&(s.start1=h,s.start2=g),b){case f:s.diffs[d++]=l[p],s.length2+=_.length,y=y.substring(0,g)+_+y.substring(g);break;case c:s.length1+=_.length,s.diffs[d++]=l[p],y=y.substring(0,g)+y.substring(g+_.length);break;case u:_.length<=2*this.Patch_Margin&&d&&l.length!=p+1?(s.diffs[d++]=l[p],s.length1+=_.length,s.length2+=_.length):_.length>=2*this.Patch_Margin&&d&&(this.patch_addContext_(s,m),a.push(s),s=new n.patch_obj,d=0,m=y,h=g);break}b!==f&&(h+=_.length),b!==c&&(g+=_.length)}return d&&(this.patch_addContext_(s,m),a.push(s)),a},n.prototype.patch_deepCopy=function(e){for(var r=[],o=0;o<e.length;o++){var i=e[o],l=new n.patch_obj;l.diffs=[];for(var a=0;a<i.diffs.length;a++)l.diffs[a]=new n.Diff(i.diffs[a][0],i.diffs[a][1]);l.start1=i.start1,l.start2=i.start2,l.length1=i.length1,l.length2=i.length2,r[o]=l}return r},n.prototype.patch_apply=function(e,r){if(e.length==0)return[r,[]];e=this.patch_deepCopy(e);var o=this.patch_addPadding(e);r=o+r+o,this.patch_splitMax(e);for(var i=0,l=[],a=0;a<e.length;a++){var s=e[a].start2+i,d=this.diff_text1(e[a].diffs),h,g=-1;if(d.length>this.Match_MaxBits?(h=this.match_main(r,d.substring(0,this.Match_MaxBits),s),h!=-1&&(g=this.match_main(r,d.substring(d.length-this.Match_MaxBits),s+d.length-this.Match_MaxBits),(g==-1||h>=g)&&(h=-1))):h=this.match_main(r,d,s),h==-1)l[a]=!1,i-=e[a].length2-e[a].length1;else{l[a]=!0,i=h-s;var m;if(g==-1?m=r.substring(h,h+d.length):m=r.substring(h,g+this.Match_MaxBits),d==m)r=r.substring(0,h)+this.diff_text2(e[a].diffs)+r.substring(h+d.length);else{var y=this.diff_main(d,m,!1);if(d.length>this.Match_MaxBits&&this.diff_levenshtein(y)/d.length>this.Patch_DeleteThreshold)l[a]=!1;else{this.diff_cleanupSemanticLossless(y);for(var p=0,b,_=0;_<e[a].diffs.length;_++){var v=e[a].diffs[_];v[0]!==u&&(b=this.diff_xIndex(y,p)),v[0]===f?r=r.substring(0,h+b)+v[1]+r.substring(h+b):v[0]===c&&(r=r.substring(0,h+b)+r.substring(h+this.diff_xIndex(y,p+v[1].length))),v[0]!==c&&(p+=v[1].length)}}}}}return r=r.substring(o.length,r.length-o.length),[r,l]},n.prototype.patch_addPadding=function(e){for(var r=this.Patch_Margin,o="",i=1;i<=r;i++)o+=String.fromCharCode(i);for(var i=0;i<e.length;i++)e[i].start1+=r,e[i].start2+=r;var l=e[0],a=l.diffs;if(a.length==0||a[0][0]!=u)a.unshift(new n.Diff(u,o)),l.start1-=r,l.start2-=r,l.length1+=r,l.length2+=r;else if(r>a[0][1].length){var s=r-a[0][1].length;a[0][1]=o.substring(a[0][1].length)+a[0][1],l.start1-=s,l.start2-=s,l.length1+=s,l.length2+=s}if(l=e[e.length-1],a=l.diffs,a.length==0||a[a.length-1][0]!=u)a.push(new n.Diff(u,o)),l.length1+=r,l.length2+=r;else if(r>a[a.length-1][1].length){var s=r-a[a.length-1][1].length;a[a.length-1][1]+=o.substring(0,s),l.length1+=s,l.length2+=s}return o},n.prototype.patch_splitMax=function(e){for(var r=this.Match_MaxBits,o=0;o<e.length;o++)if(!(e[o].length1<=r)){var i=e[o];e.splice(o--,1);for(var l=i.start1,a=i.start2,s="";i.diffs.length!==0;){var d=new n.patch_obj,h=!0;for(d.start1=l-s.length,d.start2=a-s.length,s!==""&&(d.length1=d.length2=s.length,d.diffs.push(new n.Diff(u,s)));i.diffs.length!==0&&d.length1<r-this.Patch_Margin;){var g=i.diffs[0][0],m=i.diffs[0][1];g===f?(d.length2+=m.length,a+=m.length,d.diffs.push(i.diffs.shift()),h=!1):g===c&&d.diffs.length==1&&d.diffs[0][0]==u&&m.length>2*r?(d.length1+=m.length,l+=m.length,h=!1,d.diffs.push(new n.Diff(g,m)),i.diffs.shift()):(m=m.substring(0,r-d.length1-this.Patch_Margin),d.length1+=m.length,l+=m.length,g===u?(d.length2+=m.length,a+=m.length):h=!1,d.diffs.push(new n.Diff(g,m)),m==i.diffs[0][1]?i.diffs.shift():i.diffs[0][1]=i.diffs[0][1].substring(m.length))}s=this.diff_text2(d.diffs),s=s.substring(s.length-this.Patch_Margin);var y=this.diff_text1(i.diffs).substring(0,this.Patch_Margin);y!==""&&(d.length1+=y.length,d.length2+=y.length,d.diffs.length!==0&&d.diffs[d.diffs.length-1][0]===u?d.diffs[d.diffs.length-1][1]+=y:d.diffs.push(new n.Diff(u,y))),h||e.splice(++o,0,d)}}},n.prototype.patch_toText=function(e){for(var r=[],o=0;o<e.length;o++)r[o]=e[o];return r.join("")},n.prototype.patch_fromText=function(e){var r=[];if(!e)return r;for(var o=e.split(`
`),i=0,l=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;i<o.length;){var a=o[i].match(l);if(!a)throw new Error("Invalid patch string: "+o[i]);var s=new n.patch_obj;for(r.push(s),s.start1=parseInt(a[1],10),a[2]===""?(s.start1--,s.length1=1):a[2]=="0"?s.length1=0:(s.start1--,s.length1=parseInt(a[2],10)),s.start2=parseInt(a[3],10),a[4]===""?(s.start2--,s.length2=1):a[4]=="0"?s.length2=0:(s.start2--,s.length2=parseInt(a[4],10)),i++;i<o.length;){var d=o[i].charAt(0);try{var h=decodeURI(o[i].substring(1))}catch{throw new Error("Illegal escape in patch_fromText: "+h)}if(d=="-")s.diffs.push(new n.Diff(c,h));else if(d=="+")s.diffs.push(new n.Diff(f,h));else if(d==" ")s.diffs.push(new n.Diff(u,h));else{if(d=="@")break;if(d!=="")throw new Error('Invalid patch mode "'+d+'" in: '+h)}i++}}return r},n.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},n.patch_obj.prototype.toString=function(){var e,r;this.length1===0?e=this.start1+",0":this.length1==1?e=this.start1+1:e=this.start1+1+","+this.length1,this.length2===0?r=this.start2+",0":this.length2==1?r=this.start2+1:r=this.start2+1+","+this.length2;for(var o=["@@ -"+e+" +"+r+` @@
`],i,l=0;l<this.diffs.length;l++){switch(this.diffs[l][0]){case f:i="+";break;case c:i="-";break;case u:i=" ";break}o[l+1]=i+encodeURI(this.diffs[l][1])+`
`}return o.join("").replace(/%20/g," ")},t.exports=n,t.exports.diff_match_patch=n,t.exports.DIFF_DELETE=c,t.exports.DIFF_INSERT=f,t.exports.DIFF_EQUAL=u})(Se)),Se.exports}var bn=yn();const _n=pn(bn);async function Ie(){return await Word.run(async t=>{const n=t.document.body;return n.load("text"),await t.sync(),(n.text||"").trim()})}async function vn(){return await Word.run(async t=>{const n=t.document.getSelection();return n.load("text"),await t.sync(),(n.text||"").trim()})}var lt={};const Te=globalThis,Me=Te.OfficeExtension,ft="build-20250921-085759";console.log("ContractAI build",ft);let ut=null,dt="1",ht="1";try{ut=localStorage.getItem("cai_timeout_ms:analyze"),dt=localStorage.getItem("cai_abort_on_hidden")||"1",ht=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:ut,abort_on_hidden:dt,abort_on_navigation:ht}),!ft.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const t=document.createElement("div");t.textContent="FATAL: stale bundle",t.style.padding="12px",t.style.color="#f66",document.body.innerHTML="",document.body.appendChild(t),document.querySelectorAll("button").forEach(n=>{n.disabled=!0})}catch{}});const gt=(()=>{const t=Te.ENV_MODE||(typeof process<"u"?lt?.ENV_MODE:void 0);return t?t==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();Me&&Me.config&&(gt==="dev"||Te.__ENABLE_EXTENDED_LOGS__)&&(Me.config.extendedErrorLogging=!0);function Z(t,n="Word"){try{const c=t&&t.debugInfo||{};console.error(`[${n}] RichApi error`,{code:t.code,message:t.message,errorLocation:c.errorLocation,statements:c.statements,traceMessages:c.traceMessages,inner:c.innerError})}catch{}}const S=globalThis;S.parseFindings=S.parseFindings||re,S.applyMetaToBadges=S.applyMetaToBadges||be,S.getApiKeyFromStore=S.getApiKeyFromStore||Q,S.getSchemaFromStore=S.getSchemaFromStore||K,S.logRichError=S.logRichError||Z,S.getWholeDocText=S.getWholeDocText||Ie,S.getSelectionText=S.getSelectionText||vn;const mt=S.__appliedRangeHashes||new Set;S.__appliedRangeHashes=mt;let De="live";const P={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let ee="",pt=!1,Le=!1;const wn=Zt.required_ids||[];function w(t){const n=document.getElementById(t);if(!n)throw new Error(`missing element #${t}`);return n}const Re="companiesHouseBlock",An="https://find-and-update.company-information.service.gov.uk/company/",En={match:{label:"Match",bg:"#e6f4ea",color:"#1b5e20"},mismatch:{label:"Mismatch",bg:"#fdecea",color:"#b71c1c"},ambiguous:{label:"Ambiguous",bg:"#fff4e5",color:"#e65100"},not_found:{label:"Not found",bg:"#f5f5f5",color:"#424242"},ok:{label:"OK",bg:"#e3f2fd",color:"#0d47a1"}};function Cn(t){const n=document.createElement("span"),c=En[t],f=c?.label||t.toUpperCase();return n.textContent=f,n.style.display="inline-block",n.style.padding="2px 6px",n.style.marginRight="8px",n.style.borderRadius="4px",n.style.fontSize="12px",n.style.fontWeight="bold",c&&(n.style.backgroundColor=c.bg,n.style.color=c.color),n}function W(t,n,c){const f=c?.trim();if(!f)return;const u=document.createElement("li");u.textContent=`${n}: ${f}`,t.appendChild(u)}function yt(t,n,c){!Array.isArray(c)||!c.length||W(t,n,c.join(", "))}function kn(t,n,c){const f=c.filter(r=>r.href);if(!f.length)return;const u=document.createElement("li"),e=document.createElement("span");e.textContent=`${n}: `,u.appendChild(e),f.forEach((r,o)=>{if(o>0){const l=document.createElement("span");l.textContent=" | ",u.appendChild(l)}const i=document.createElement("a");i.href=r.href,i.textContent=r.label,i.target="_blank",u.appendChild(i)}),t.appendChild(u)}function U(t){return(t||"").trim()}function Sn(t,n,c){const f=U(t.number_or_duns).toLowerCase();if(f){const e=n.find(r=>{if(c.has(r))return!1;const o=U(r.from_document?.number).toLowerCase(),i=U(r.matched?.company_number).toLowerCase();return o===f||i===f});if(e)return e}const u=U(t.name).toLowerCase();if(u)return n.find(e=>{if(c.has(e))return!1;const r=U(e.from_document?.name).toLowerCase(),o=U(e.matched?.company_name).toLowerCase();return r&&r===u||o&&o===u})}function In(t){let n=document.getElementById(Re);if(!n){if(typeof t.appendChild!="function")return null;n=document.createElement("div"),n.id=Re,t.appendChild(n)}return n}function Tn(t,n){let c=[],f=[];if(Array.isArray(t))c=t.filter(Boolean),f=Array.isArray(n)?n.filter(Boolean):[];else{const a=t;c=Array.isArray(a?.summary?.parties)?a.summary.parties.map(s=>s?.registry).filter(s=>!!s):[],f=Array.isArray(a?.meta?.companies_meta)?a.meta.companies_meta.filter(s=>!!s):[]}const u=document.getElementById(Re);if(!c.length&&!f.length){u&&(u.parentElement&&typeof u.parentElement.removeChild=="function"?u.parentElement.removeChild(u):typeof u.remove=="function"&&u.remove());return}const e=w("resultsBlock"),r=In(e);if(!r)return;r.innerHTML="";const o=document.createElement("h3");o.textContent="Companies House",r.appendChild(o);const i=new Set,l=[];if(c.forEach(a=>{const s=Sn(a,f,i);s&&i.add(s),l.push({registry:a,meta:s})}),f.forEach(a=>{i.has(a)||l.push({meta:a})}),!l.length){const a=document.createElement("p");a.textContent="No Companies House data available.",r.appendChild(a);return}l.forEach(({registry:a,meta:s})=>{const d=document.createElement("div");r.appendChild(d);const h=document.createElement("div");s?.verdict&&h.appendChild(Cn(s.verdict));const g=document.createElement("strong");if(g.textContent=U(a?.name||s?.from_document?.name||s?.matched?.company_name||"Company"),h.appendChild(g),d.appendChild(h),a?.number_or_duns||a?.status||a?.address||a?.sic_codes?.length||a?.incorp_date||s?.from_document?.number){const y=document.createElement("div");y.textContent="Document",d.appendChild(y);const p=document.createElement("ul");W(p,"Number",a?.number_or_duns||s?.from_document?.number),W(p,"Status",a?.status),W(p,"Address",a?.address),W(p,"Incorporated",a?.incorp_date),yt(p,"SIC",a?.sic_codes),d.appendChild(p)}if(s){const y=document.createElement("div");y.textContent="Companies House",d.appendChild(y);const p=document.createElement("ul"),b=s.matched?.company_number||s.from_document?.number;W(p,"Company number",b),W(p,"Status",s.matched?.company_status),W(p,"Address",s.matched?.address_snippet),yt(p,"SIC",s.matched?.sic_codes);const _=[];b&&_.push({label:"Profile",href:`${An}${b}`}),s.matched?.links?.self&&_.push({label:"Self",href:s.matched.links.self}),s.matched?.links?.officers&&_.push({label:"Officers",href:s.matched.links.officers}),s.matched?.links?.filing_history&&_.push({label:"Filings",href:s.matched.links.filing_history}),kn(p,"Links",_),d.appendChild(p)}})}function Mn(t){const n=(t??"").trim();if(!n)return null;const c=`${Ne()}/api/trace/${n}`,f=`/api/trace/${n}`;return{href:c,label:f}}function bt(t){try{if(typeof document>"u")return}catch{return}const n=document.getElementById("resultsBlock");if(!n)return;const c=n.querySelector(".muted");if(!c)return;let f=c.querySelector('[data-role="trace-link"]');f||(f=document.createElement("span"),f.dataset.role="trace-link",f.style.marginLeft="8px",c.appendChild(f));const u=Mn(t);if(!u){f.textContent="",f.style.display="none";return}f.textContent="",f.style.display="";const e=document.createElement("span");e.textContent=" · ",f.appendChild(e);const r=document.createElement("a");r.href=u.href,r.target="_blank",r.rel="noreferrer noopener",r.textContent=u.label,f.appendChild(r)}function Oe(t,n){const c=w("status-chip"),f=(t??K())||"—",u=(n??ee)?.trim()||"",e=u||"—";c.textContent=`schema: ${f} | cid: ${e}`,bt(u)}function _t(){const t=w("anchorsBadge"),n=globalThis.__anchorsSkipped||0;t.style.display=n>0?"":"none"}S.updateAnchorBadge=S.updateAnchorBadge||_t;function Dn(){if(pt)return;O("#btnAnalyze",Gn);const t=w("btnAnalyze");t.disabled=!1,pt=!0,console.log("[PANEL] analyze enabled")}function Ne(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://127.0.0.1:9443").replace(/\/+$/,"")}catch{return"https://127.0.0.1:9443"}}function Ln(){const n=w("backendUrl").value.trim();if(n)try{localStorage.setItem("backend.url",n),localStorage.setItem("backendUrl",n)}catch{}location.reload()}function Fe(){let t=Q(),n=K();const c=w("hdrWarn"),u=(globalThis?.location?.hostname??"")==="127.0.0.1";if(u&&(t||(t="local-test-key-123",He(t)),!n)){const e=globalThis?.SCHEMA_VERSION||typeof process<"u"&&lt?.SCHEMA_VERSION||"1.4";n=String(e),Y(n)}return!t&&!n&&!u?c.style.display="":c.style.display="none",(!t||!n)&&console.warn("missing headers",{apiKey:!!t,schema:!!n}),!0}function x(t,n){const c=document.querySelector(`[data-role="${n}"]`);return c||w(t)}function le(){try{const n=w("selectRiskThreshold").value.toLowerCase();return n==="low"||n==="medium"||n==="high"||n==="critical"?n:"medium"}catch{return"medium"}}function vt(){const t=Ot();try{const n=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();return n.checked=t,!!n.checked}catch{return t}}function Rn(t){Nt(t)}function Be(t,n){if(!Array.isArray(t))return[];const c=oe(n);return t.filter(f=>f?oe(f.severity)>=c:!1)}S.annotateFindingsIntoWord=S.annotateFindingsIntoWord||it;async function On(){try{await Word.run(async t=>{const n=t.document.body,c=t.document.comments,f=typeof n.search=="function"?n.search(B,{matchCase:!1}):null;if(c&&typeof c.load=="function"&&c.load("items"),f&&typeof f.load=="function"&&f.load("items"),await t.sync(),c?.items)for(const u of c.items)try{(u.text||"").startsWith(B)&&u.delete()}catch{}if(f?.items&&f.items.length)for(const u of f.items)try{u.insertText("",Word.InsertLocation.replace)}catch{}try{n.font.highlightColor="NoColor"}catch{}await t.sync()}),q("Annotations cleared")}catch(t){Z(t,"annotate"),D("Failed to clear annotations")}}function Nn(t,n){const c=new _n,f=i=>i.match(/\S+|\s+/g)||[],{chars1:u,chars2:e,tokenArray:r}=Fn(f(t),f(n));let o=c.diff_main(u,e);return c.diff_cleanupSemantic(o),o.map(([i,l])=>[i,l.split("").map(a=>r[a.charCodeAt(0)]).join("")])}function Fn(t,n){const c=[],f=new Map,u=o=>f.has(o)?String.fromCharCode(f.get(o)):(c.push(o),f.set(o,c.length-1),String.fromCharCode(c.length-1)),e=t.map(u).join(""),r=n.map(u).join("");return{chars1:e,chars2:r,tokenArray:c}}async function wt(t){return X(async()=>{let n=(t||[]).filter(u=>typeof u.start=="number"&&typeof u.end=="number"&&u.end>u.start).sort((u,e)=>u.start-e.start),c=-1;if(n=n.filter(u=>u.start<c?!1:(c=u.end,!0)),!n.length)return;const f=window.__lastAnalyzed||"";await Word.run(async u=>{const e=u.document.body;u.document.trackRevisions=!0;const r={matchCase:!1,matchWholeWord:!1},o=(i,l)=>{const a=i?.items||[];return a.length&&a[Math.min(Math.max(l,0),a.length-1)]||null};for(const i of n){const l=`${i.start}:${i.end}:${i.replacement}`;if(mt.has(l))continue;const a=f.slice(i.start,i.end),s=(()=>{let h=-1,g=0;for(;(h=f.indexOf(a,h+1))!==-1&&h<i.start;)g++;return g})();let d=null;if(i.context_before||i.context_after){const h=`${i.context_before||""}${a}${i.context_after||""}`,g=await H(e,h,r),m=o(g,s);if(m){const y=a.slice(0,240),p=a.slice(-240),b=m.search(y,r),_=m.search(p,r);b&&typeof b.load=="function"&&b.load("items"),_&&typeof _.load=="function"&&_.load("items"),await u.sync();const v=o(b,0),E=o(_,0);v&&E&&typeof v.expandTo=="function"?d=v.expandTo(E):d=v}}if(!d){const h=await H(e,a,r);d=o(h,s)}if(!d){const h=(()=>{const g=a.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(m=>m.length>=12);return g.length?g.sort((m,y)=>y.length-m.length)[0].slice(0,64):null})();if(h){const g=await H(e,h,r);d=o(g,0)}}if(d){const h=Nn(a,i.replacement);let g=d.getRange("Start");for(const[p,b]of h)if(b)if(p===0){const v=g.getRange("After").search(b,r);v&&typeof v.load=="function"&&v.load("items"),await u.sync();const E=o(v,0);E&&(g=E.getRange("After"))}else if(p===-1){const v=g.getRange("After").search(b,r);v&&typeof v.load=="function"&&v.load("items"),await u.sync();const E=o(v,0);E&&(E.insertText("","Replace"),g=E.getRange("After"))}else p===1&&(g=g.insertText(b,"Before").getRange("After"));const m=`${B} ${i.rationale||i.source||"AI edit"}`;(await Ee(d,m)).ok||await ce(d,m.replace(B,"").trim())}else console.warn("[applyOpsTracked] match not found",{snippet:a,occIdx:s});await u.sync()}})})}S.applyOpsTracked=S.applyOpsTracked||wt;function At(t,n){if(n.__highlight){try{n.__highlight.font.highlightColor="NoColor"}catch{}t.trackedObjects.remove(n.__highlight),n.__highlight=null}}async function Et(){const t=window;t.__highlight&&await Word.run(async n=>{At(n,t),await n.sync()})}async function $e(t){await Word.run(async n=>{const c=window;At(n,c);const f=n.document.body;let u=await ie(f,t.raw),e=u[Math.min(t.occIdx,u.length-1)]||null;if(!e&&t.normalized_fallback&&t.normalized_fallback!==t.norm&&(u=await ie(f,t.normalized_fallback),e=u[Math.min(t.occIdx,u.length-1)]||null),e){c.__highlight=e,n.trackedObjects.add(e);try{e.select()}catch{}try{e.font.highlightColor="#ffff00"}catch{}}await n.sync()})}let ze=!1;async function Ct(t){if(ze)return;ze=!0;const n=window.__findings||[];if(!n.length){ze=!1;return}const c=w("btnPrevIssue"),f=w("btnNextIssue");c.disabled=!0,f.disabled=!0;const u=window;u.__findingIdx=(u.__findingIdx??0)+t,u.__findingIdx<0&&(u.__findingIdx=n.length-1),u.__findingIdx>=n.length&&(u.__findingIdx=0);const e=w("findingsList"),r=Array.from(e.querySelectorAll("li"));r.forEach((i,l)=>{i.classList.toggle("active",l===u.__findingIdx)});const o=r[u.__findingIdx];o&&o.scrollIntoView({block:"nearest"});try{await $e(n[u.__findingIdx])}catch{}}function Bn(t){const n=window.__findings||[];if(!n.length)return;const c=n.findIndex(r=>r.rule_id===t||r.code===t);if(c<0)return;window.__findingIdx=c;const f=w("findingsList"),u=Array.from(f.querySelectorAll("li"));u.forEach((r,o)=>{r.classList.toggle("active",o===c)});const e=u[c];e&&e.scrollIntoView({block:"nearest"});try{$e(n[c])}catch{}}async function $n(){await Ct(-1)}async function zn(){await Ct(1)}function fe(t){Et().catch(()=>{});const n=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",c=Array.isArray(t?.findings)?t.findings:[],f=Array.isArray(t?.recommendations)?t.recommendations:[],u=le(),e=Be(c,u),r=e.length,o=c.length-r,i=(g,m)=>{w(g).textContent=m};i("clauseTypeOut",String(n)),i("resFindingsCount",String(c.length)),i("visibleHiddenOut",`${r} / ${o}`);const l=w("findingsBlock"),a=w("findingsList");a.innerHTML="",e.forEach((g,m)=>{const y=document.createElement("li"),p=g?.title||g?.finding?.title||g?.rule_id||"Issue",b=g?.snippet||g?.evidence?.text||"";y.textContent=b?`${p}: ${b}`:String(p),y.addEventListener("click",()=>{Array.from(a.querySelectorAll("li")).forEach((E,A)=>{E.classList.toggle("active",A===m)}),window.__findingIdx=m,$e(g).catch(()=>{})});const _=Array.isArray(g.links)?g.links.filter(v=>v?.type==="conflict"&&v?.targetFindingId):[];if(_.length){const v=document.createElement("div");v.textContent=`Conflicts: ${_.length} `,_.forEach((E,A)=>{const C=document.createElement("a");C.href="#",C.textContent="Jump to",C.addEventListener("click",k=>{k.preventDefault(),Bn(E.targetFindingId)}),v.appendChild(C),A<_.length-1&&v.append(" ")}),y.appendChild(v)}a.appendChild(y)}),l.style.display=e.length?"":"none";const s=document.getElementById("recommendationsBlock"),d=document.getElementById("recommendationsList");if(d){d.innerHTML="";for(const g of f){const m=document.createElement("li");m.textContent=g?.text||g?.advice||g?.message||"Recommendation",d.appendChild(m)}}s&&(s.style.display=f.length?"":"none"),w("resultsBlock").style.removeProperty("display"),Tn(t)}function ue(t){const n=x("resClauseType","clause-type");n.textContent=t?.clause_type||"—";const c=re(t);window.__findings=c,window.__findingIdx=0;const f=x("findingsList","findings");f&&(f.innerHTML="",c.forEach(s=>{const d=document.createElement("li");d.textContent=typeof s=="string"?s:JSON.stringify(s),f.appendChild(d)}));const u=w("findingsBlock");u.style.display=c.length?"":"none";const e=Array.isArray(t?.recommendations)?t.recommendations:[],r=x("recommendationsList","recommendations");r&&(r.innerHTML="",e.forEach(s=>{const d=document.createElement("li");d.textContent=typeof s=="string"?s:JSON.stringify(s),r.appendChild(d)}));const o=w("recommendationsBlock");o.style.display=e.length?"":"none";const i=x("resFindingsCount","findings-count");i.textContent=String(c.length);const l=t?.meta?.cid??t?.cid??null;bt(l??ee);const a=x("rawJson","raw-json");a.textContent=JSON.stringify(t??{},null,2)}function Pn(t){const n=window.__findings||[],c=re(t),f=tt([...n,...c]);return{...t||{},findings:f}}function Wn(){const t=x("toggleRaw","toggle-raw-json"),n=x("rawJson","raw-json");n.style.display="none",t.addEventListener("click",()=>{n.style.display=n.style.display==="none"?"block":"none"})}function kt(t){const n=w("connBadge");n.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`}function Pe(t){const n=w("officeBadge");n.textContent=`Office: ${t??"—"}`}async function jn(){await Word.run(async t=>{const n=["Heading 1","Heading 2","Heading 3"];for(let c=0;c<n.length;c++){const f=t.document.body.paragraphs.getByStyle(n[c]);f.load("items"),await t.sync();for(const u of f.items)try{u.listFormat.removeNumbers(),u.listFormat.applyNumberedDefault(),u.listItem&&(u.listItem.level=c);const e=36*(c+1);u.paragraphFormat.leftIndent=e,u.paragraphFormat.firstLineIndent=-36,u.paragraphFormat.lineSpacing=240}catch(e){console.warn("fixNumbering",e)}}await t.sync()}).catch(t=>Z(t,"fixNumbering"))}function j(t){return document.querySelector(t)}function Hn(){return(j(P.original)?.value||"").trim()}async function Un(){let t=Hn();if(t.length>=20)return t;try{if(t=(await globalThis.getSelectionText()||"").trim(),t.length>=20){const n=j(P.original);if(n){n.value=t;try{n.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return t}}catch{}return D("Please paste the original clause (min 20 chars) or select text in the document."),null}function xn(){try{return globalThis.detectContractType?.()||"unknown"}catch{return"unknown"}}function Kn(){try{const t=window.__findings||[];return Array.isArray(t)?t:[]}catch{return[]}}function Vn(){try{return window.getSelectionOffsets?.()||null}catch{return null}}async function qn(t){const n=await Un();if(!n)return;const c={mode:t,clause_id:ee||void 0,text:n,context:{law:"UK",language:"en-GB",contractType:xn()},findings:Kn().slice(0,10),selection:Vn()};let f;try{f=await fetch("/api/gpt/draft",{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":Q()||"","X-Schema-Version":"1.4"},body:JSON.stringify(c)})}catch(i){console.warn("Draft error",i),D("Draft error");return}if(!f.ok){const i=await f.text();console.warn(`Draft failed: ${f.status} ${i}`);return}const u=await f.json(),e=(u?.draft_text||"").toString(),r=j(P.proposed),o=window;if(o.__last=o.__last||{},o.__last["gpt-draft"]={json:u},r){r.id||(r.id="draftText"),r.name||(r.name="proposed"),r.dataset.role="proposed-text",r.value=e,r.dispatchEvent(new Event("input",{bubbles:!0})),q("Draft ready");try{await hn(e,De,u?.meta?.rationale)}catch{}te(e)}else D("Proposed textarea not found"),te("")}async function Jn(){const t=j(P.original),n=await Ie(),c=ae(n||"");if(t){t.value=c;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const f=w("originalText");if(f!==t){f.value=c;try{f.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=c,window.toast?.("Whole doc loaded")}async function Qn(t){return X(()=>qn(De==="friendly"?"friendly":"strict"))}async function St(){try{const t=K(),{resp:n,json:c,ok:f}=await xe({backend:Ne()}),u=n.headers.get("x-schema-version")||c?.schema||null;if(u&&(Y(u),u!==t&&console.log(`schema: ${u} (synced)`)),kt(f),f){console.log("[PANEL] health ok"),Dn(),Oe(u,null);try{be({cid:null,xcache:null,latencyMs:null,schema:u||null,provider:c?.provider||null,model:c?.model||null,llm_mode:null,usage:null,status:c?.status||null})}catch{}q(`Health: ${c?.status||"ok"}${u?` (schema ${u})`:""}`)}else D("Health failed")}catch(t){kt(!1),D("Health failed"),console.error(t)}}async function Yn(){const t=w("originalText");let n=ae(t.value||"");if(!n){const c=w("btnAnalyze");c.disabled=!0;try{n=ae(await globalThis.getWholeDocText()),t.value=n||""}catch{n=""}finally{c.disabled=!1}}return n?(window.__lastAnalyzed=n,n):(D("Document is empty"),null)}async function Gn(){if(Le){console.log("[PANEL] analyze in progress - ignoring click");return}for(const t of G)if(t.__key==="/api/analyze"){console.log("[PANEL] pending /api/analyze fetch - ignoring click");return}Le=!0;try{if(!await Yn())return;await Xn()}finally{Le=!1}}async function Xn(){return X(async()=>{const t=w("btnAnalyze"),n=w("busyBar");t.disabled=!0,n.style.display="";try{te("");const c=window.__lastAnalyzed;if(!c){Ve("В документе нет текста");return}Fe();const{resp:f,json:u}=await Gt({text:c,mode:De,risk:le()});if(!f.ok)throw new Error(`HTTP ${f.status}`);const e=f.headers.get("x-schema-version");e&&Y(e),u?.schema&&Y(u.schema),ee=f.headers.get("x-cid")||"",Oe(null,ee),ue(u),fe(u);try{localStorage.setItem("last_analysis_json",JSON.stringify(u))}catch{}try{const r=globalThis.parseFindings(u),o=le(),i=Be(r,o),l=ke(i);window.__findings=l,window.__findingIdx=0;const a=w("findingsList"),s=document.createDocumentFragment();l.forEach((d,h)=>{const g=document.createElement("li");g.textContent=`${d.rule_id}: ${d.raw}`,h===0&&g.classList.add("active"),s.appendChild(g)}),a.innerHTML="",a.appendChild(s),vt()&&i.length&&await it(i)}catch(r){console.warn("auto-annotate after analyze failed",r)}w("results").dispatchEvent(new CustomEvent("ca.results",{detail:u})),q("Analyze OK")}catch(c){let f="";if(c?.name==="AbortError"){const u=c?.message||"";if(u.startsWith("timeout")){const e=parseInt(u.replace(/[^0-9]/g,""),10)||0;f=`(timeout ${Math.round(e/1e3)} s)`}else u==="pagehide/unload"?f="(aborted by pagehide)":f="(aborted)"}else typeof c?.message=="string"&&(c.message.includes("HTTP 504")?f="(HTTP 504)":c.message.includes("HTTP 413")?f="(payload too large 413)":c.message.includes("HTTP 401")?f="(unauthorized 401)":c.message.includes("HTTP 403")?f="(forbidden 403)":c.message.includes("HTTP 422")&&(f="(schema mismatch 422)"));D(`Analyze failed ${f}`.trim()),console.error(c)}finally{t.disabled=!1,n.style.display="none"}})}async function Zn(){return X(async()=>{await Et(),Fe();const t=window.__docId,n=le(),c={rules:{},risk:n};if(t)c.document_id=t;else{const e=await Ie();window.__lastAnalyzed=e,c.text=e}const{json:f}=await postJSON("/api/qa-recheck",c);if(w("results").dispatchEvent(new CustomEvent("ca.qa",{detail:f})),!f?.error){const e=window.__findings||[],r=window.__findingIdx??0,o=p=>p?.code||p?.rule_id||`${p?.rule_id}|${p?.raw||p?.snippet||""}`,i=e[r]?o(e[r]):null,l=re(f),a=Be(l,n),s=ke(a),d=new Map;s.forEach(p=>{const b=o(p);b&&!d.has(b)&&d.set(b,p)});const h=Array.from(d.values());window.__findings=h;let g=0;if(i){const p=h.findIndex(b=>o(b)===i);p>=0&&(g=p)}g>=h.length&&(g=0),window.__findingIdx=g;const m=w("findingsList"),y=document.createDocumentFragment();h.forEach((p,b)=>{const _=document.createElement("li");_.textContent=`${p.rule_id}: ${p.raw}`,b===g&&_.classList.add("active"),y.appendChild(_)}),m.innerHTML="",m.appendChild(y),q("QA recheck OK")}else{const e=f?.error||f?.message||"unknown";Ve(`QA recheck failed: ${e}`)}})}function O(t,n){const c=document.querySelector(t);c&&(c.addEventListener("click",f=>{f.preventDefault(),n()}),c.classList.remove("js-disable-while-busy"),c.removeAttribute("disabled"))}async function er(){try{const t=window.__lastAnalyzed||"",n=(j(P.proposed)?.value||"").trim();if(!n){D("No draft to diff");return}const c=await Xt(t,n),f=c?.json?.html||c?.json?.diff_html||c?.json?.redlines||"",u=w("diffOutput"),e=w("diffContainer");u.innerHTML=f||"",e.style.display=f?"block":"none"}catch(t){D("Diff failed"),console.error(t)}}async function tr(){try{const t=window.__last||{},n=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!n.length){D("No ops to apply");return}await wt(n),q("Applied ops")}catch(t){D("Insert failed"),console.error(t)}}async function nr(){try{const n=(j(P.proposed)?.value||"").trim();if(!n){window.toast?.("Nothing to accept");return}const c=(w("cid").textContent||"").trim(),f=(()=>{try{return(localStorage.getItem("backendUrl")||"https://127.0.0.1:9443").replace(/\/+$/,"")}catch{return"https://127.0.0.1:9443"}})(),u=c&&c!=="—"?`${f}/api/trace/${c}`:"AI draft";await Word.run(async e=>{const r=e.document.getSelection();e.document.trackRevisions=!0,r.insertText(n,Word.InsertLocation.replace),(await Ee(r,`${B} ${u}`)).ok||await ce(r,u),await e.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),Z(t,"insertDraft"),console.error(t)}}async function rr(){try{const t=j(P.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),te("")),await Word.run(async n=>{const f=n.document.getSelection().revisions;f.load("items"),await n.sync(),(f.items||[]).forEach(u=>{try{u.reject()}catch{}}),await n.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),Z(t,"insertDraft"),console.error(t)}}function It(){if(console.log("[PANEL] wireUI start"),globalThis.__CAI_TESTING__){console.log("[PANEL] wireUI (__CAI_TESTING__ mode)");return}const t=wn.filter(s=>{try{return w(s),!1}catch{return!0}});if(t.length){console.error("[PANEL] wireUI missing IDs:",t);const s=`FATAL: panel template mismatch (missing: ${t.join(", ")}). Check build pipeline.`;try{const d=document.createElement?document.createElement("div"):null;d&&(d.textContent=s,d.style.padding="12px",d.style.color="#f66",document.body.innerHTML="",document.body.appendChild(d))}catch{}console.error(s);return}const n=w("loading-book");window.addEventListener("cai:busy",s=>{!!s?.detail?.busy?n.classList.remove("hidden"):n.classList.add("hidden")});const c=st(),f=(s,d)=>{const h=w(s);if(h.disabled=!0,h.title=d?`Not supported: ${d}`:"Not supported",d)try{console.log(`disabled ${s}: ${d}`)}catch{}};O("#btnUseWholeDoc",Jn);const u=w("btnUseWholeDoc");if(u.disabled=!1,O("#btnFixNumbering",jn),gt==="dev")O("#btnTest",St);else{const s=w("btnTest");s.style.display="none"}O("#btnQARecheck",Zn);const e=w("btnSuggestEdit"),r=j(P.original),o=()=>{e.disabled=!(r&&r.value.trim())};r?.addEventListener("input",o);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const s=await globalThis.getSelectionText();if(s&&r){r.value=s;try{r.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}o(),e.addEventListener("click",Qn),O("#btnApplyTracked",tr),O("#btnAcceptAll",nr),O("#btnRejectAll",rr),O("#btnPrevIssue",$n),O("#btnNextIssue",zn),O("#btnPreviewDiff",er),O("#btnClearAnnots",On),O("#btnSave",Ln);const i=(()=>{try{return w("cai-comment-on-analyze")}catch{return w("chkAddCommentsOnAnalyze")}})();i.checked=vt(),i.addEventListener("change",()=>Rn(!!i.checked));const l=w("btnAnnotate");l.addEventListener("click",async()=>{if(!l.disabled){l.disabled=!0;try{const s=window.__last?.analyze?.json||{},d=globalThis.parseFindings(s);try{await globalThis.annotateFindingsIntoWord(d)}catch(h){const g=h?.code||h?.name||"";g==="SearchStringInvalidOrTooLong"||g==="InvalidOrTooLong"||g==="InvalidArgument"?(globalThis.toast2?.("Search failed (long text), skipping some anchors","warn"),console.warn("[annotate run] search error",g)):console.warn("[annotate run] error",h)}}finally{l.disabled=!1}}}),l.classList.remove("js-disable-while-busy"),l.removeAttribute("disabled"),w("results").addEventListener("ca.qa",s=>{const d=s?.detail;try{if(!d||d.error){ue(d||{}),fe(d||{});return}const h=Pn(d);ue(h),fe(h)}catch(h){console.warn("ca.qa handler failed",h),ue(d||{}),fe(d||{})}}),te(""),Wn(),console.log("Panel UI wired [OK]");const a=w("btnAnalyze");if(a.disabled=!0,Fe(),Oe(),_t(),c.revisions||(f("btnApplyTracked","revisions"),f("btnAcceptAll","revisions"),f("btnRejectAll","revisions")),c.comments||(f("btnAnnotate","comments"),f("btnAcceptAll",c.commentsReason),D("Comments API not available in this Word build")),c.search||(f("btnPrevIssue","search"),f("btnNextIssue","search"),f("btnQARecheck","search")),c.contentControls||f("btnAnnotate","contentControls"),!c.revisions||!c.comments||!c.search||!c.contentControls)try{Pe("Word ⚠")}catch{}}S.wireUI=S.wireUI||It;function te(t){const n=!!t.trim(),c=w("btnApplyTracked"),f=w("btnAcceptAll"),u=w("btnRejectAll"),e=w("btnPreviewDiff"),r=w("draftPane"),o=w("draftText");o.value=t,r.style.display=n?"":"none",c.disabled=!n,f.disabled=!n,u.disabled=!n,e.disabled=!n}async function ar(t){console.log("[PANEL] bootstrap start"),Ht()&&(console.log("reopen clean OK"),Ut()),It(),jt();try{await mn(Ne())}catch{}try{await St()}catch{}try{Pe(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{Pe(null)}}let We=!1,Tt=!1,Mt,Dt=!1,Lt=0;function je(){if(Dt){console.log(`bootstrap invoked x${Lt+1}`);return}We&&Tt&&(Dt=!0,Lt++,console.log("bootstrap invoked x1"),ar(Mt))}globalThis.__CAI_TESTING__||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{We=!0,je()}):(We=!0,je()),Office.onReady(t=>{Tt=!0,Mt=t,je()}))})();
