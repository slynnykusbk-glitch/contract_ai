(function(){"use strict";var J=typeof document<"u"?document.currentScript:null;const Y="",Q="1.4",N="cai-comment-on-analyze";function Wt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",Y),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",Q),localStorage.getItem(N)===null&&localStorage.setItem(N,"1")}catch{}}Wt();function R(){try{return localStorage.getItem("api_key")||Y}catch{return Y}}function ut(t){try{localStorage.setItem("api_key",t)}catch{}}function k(){try{return localStorage.getItem("schema_version")||Q}catch{return Q}}function F(t){try{localStorage.setItem("schema_version",t)}catch{}}function jt(){try{const t=localStorage.getItem(N);return t===null?(localStorage.setItem(N,"1"),!0):t!=="0"}catch{return!0}}function Ut(t){try{localStorage.setItem(N,t?"1":"0")}catch{}}const v=typeof globalThis<"u"?globalThis:window;v.CAI=v.CAI||{},v.CAI.Store=v.CAI.Store||{},v.CAI.Store.setApiKey=ut,v.CAI.Store.setSchemaVersion=F,v.CAI.Store.get=()=>({apiKey:R(),schemaVersion:k()}),v.CAI.Store.DEFAULT_BASE=v.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const I=window;I.__cai_pending_fetches=I.__cai_pending_fetches||new Set,I.__cai_pending_timers=I.__cai_pending_timers||new Set;const j=I.__cai_pending_fetches,U=I.__cai_pending_timers,B={count:0};function Pt(){B.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:B.count}}))}function Ht(){B.count=Math.max(0,B.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:B.count>0,count:B.count}}))}async function D(t){try{return Pt(),await t()}finally{Ht()}}function Kt(t){j.add(t)}function qt(t){j.delete(t)}function Vt(t){U.add(t)}function Jt(t){U.delete(t)}function ft(t){j.forEach(e=>{try{e.abort(t)}catch{}}),j.clear(),U.forEach(e=>{try{clearTimeout(e),clearInterval(e)}catch{}}),U.clear();try{document.querySelectorAll(".progress").forEach(e=>{e.style.display="none"})}catch{}}function Yt(){if(I.__pendingUnloadReg)return;I.__pendingUnloadReg=!0;const t=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),e=()=>{t&&ft("pagehide/unload"),I.__wasUnloaded=!0};window.addEventListener("pagehide",e),window.addEventListener("unload",e),window.addEventListener("beforeunload",e),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&ft("visibilitychange")})}function mt(){return!!I.__wasUnloaded}function Qt(){I.__wasUnloaded=!1}let X=null;async function gt(t={}){if(!X){const e=(t.backend||"").replace(/\/+$/,""),n=e?`${e}/health`:"/health",o=new AbortController,a=t.timeoutMs??9e3,s=setTimeout(()=>o.abort("timeout"),a);X=fetch(n,{signal:o.signal}).then(async r=>{clearTimeout(s);const i=await r.json().catch(()=>({}));return{ok:r.ok,json:i,resp:r}})}return X}function L(t){try{console.log("[OK]",t)}catch{}}function yt(t){try{console.error("[ERR]",t)}catch{}}function w(t){try{console.warn("[WARN]",t)}catch{}}const ht=(()=>{try{return localStorage.getItem("cai_dev")==="1"?!0:new URLSearchParams(globalThis.location?.search||"").get("debug")==="1"}catch{return!1}})();function Xt(t,e,n){ht?console.error(t,e,n):console.error(t,e)}function pt(t){const e=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(e)?e.filter(Boolean):[]}window.parseFindings=pt;function Gt(t){const e=t.headers,n=t.json||{},o=n.llm||n;return{cid:e.get("x-cid"),xcache:e.get("x-cache"),latencyMs:e.get("x-latency-ms"),schema:e.get("x-schema-version"),provider:e.get("x-provider")||o.provider||n.provider||null,model:e.get("x-model")||o.model||n.model||null,llm_mode:e.get("x-llm-mode")||o.mode||n.mode||null,usage:e.get("x-usage-total"),status:t.status!=null?String(t.status):null}}function G(t){const e=(n,o)=>{const a=document.getElementById(n);a&&(a.textContent=o&&o.length?o:"—")};e("status",t.status),e("cid",t.cid),e("xcache",t.xcache),e("latency",t.latencyMs),e("schema",t.schema),e("provider",t.provider),e("model",t.model),e("mode",t.llm_mode),e("usage",t.usage)}async function Zt(){const t=new URL(J&&J.tagName.toUpperCase()==="SCRIPT"&&J.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const n=await(await fetch(t)).text(),o=new TextEncoder().encode(n),a=await crypto.subtle.digest("SHA-256",o),s=Array.from(new Uint8Array(a)).slice(0,4).map(r=>r.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${s} ${t}`)}catch{console.log(`[selftest] api-client.js fail ${t}`)}}const bt="https://localhost:9443";function te(){try{return(localStorage.getItem("backendUrl")||bt).replace(/\/+$/,"")}catch{return bt}}const Z=9e3,ee=60,ne=9e4,oe=1,ae=3e3;async function P(t,e,n){return D(async()=>{const o=te()+t,a={"Content-Type":"application/json"},s=k()||"1.4";a["x-schema-version"]=s;const r=R();r&&(a["x-api-key"]=r);const i={...e||{},schema:s},c=JSON.stringify(i),l=new TextEncoder().encode(c).length;let d=n,f=oe,u=ae;if(t==="/api/analyze"){if(d==null){const g=Z+ee*(l/1024);d=Math.max(Z,Math.min(ne,Math.floor(g)))}try{for(const g of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const h=localStorage.getItem(g);if(h){const b=parseInt(h,10);if(Number.isFinite(b)){d=b;break}}}}catch{}try{const g=localStorage.getItem("cai.retry.analyze.count");g&&(f=parseInt(g,10))}catch{}try{const g=localStorage.getItem("cai.retry.analyze.backoff.ms");g&&(u=parseInt(g,10))}catch{}try{const g=new URLSearchParams(location.search),h=g.get("ta");h&&(d=parseInt(h,10));const b=g.get("rac");b&&(f=parseInt(b,10));const y=g.get("rb");y&&(u=parseInt(y,10))}catch{}}d=d??Z;async function m(g){const h=new AbortController,b=setTimeout(()=>h.abort(`timeout ${d}ms`),d);Kt(h),Vt(b);try{const y=await fetch(o,{method:"POST",headers:a,body:c,credentials:"include",signal:h.signal}),E=await y.json().catch(()=>({}));if(y.status===422){console.warn("[analyze] 422",E.detail);const C=Array.isArray(E?.detail)?E.detail.map($=>$.msg).join("; "):E?.detail;try{w(`Validation error: ${C}`)}catch{}}return t==="/api/analyze"&&(y.status===504||y.status>=500)&&g<f?(await new Promise(C=>setTimeout(C,u)),m(g+1)):{resp:y,json:E}}catch(y){if(t==="/api/analyze"&&y?.name==="AbortError"){const E=h.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${E}`),g<f&&String(E).startsWith("timeout"))return await new Promise(C=>setTimeout(C,u)),m(g+1);throw new DOMException(E,"AbortError")}Xt(`[NET] ${t} failed`,y,{body:i});try{const E=ht?String(y):"Analysis failed, please try again";w(E)}catch{}throw y}finally{clearTimeout(b),Jt(b),qt(h)}}return m(0)})}window.postJson=P;async function se(t={}){const e={text:t?.text??t?.content,mode:t?.mode??"live"},{resp:n,json:o}=await P("/api/analyze",e),a=Gt({headers:n.headers,json:o,status:n.status});try{G(a)}catch{}try{const s=window;s.__last||(s.__last={}),s.__last.analyze={status:n.status,req:{path:"/api/analyze",method:"POST",body:e},json:o}}catch{}return{ok:n.ok,json:o,resp:n,meta:a}}async function ce(t,e){return P("/api/panel/redlines",{before_text:t,after_text:e})}const ie={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function A(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function H(t){const e=(t||"").toLowerCase();return e==="high"?3:e==="medium"?2:1}function re(t){const e=new Map;let n=0,o=0;for(const s of t||[]){const r=A(s.snippet||""),i=typeof s.start=="number"?s.start:void 0,c=typeof s.end=="number"?s.end:i!==void 0?i+r.length:void 0;if(typeof i!="number"||typeof c!="number"||c<=i||c-i>1e4){n++;continue}const l=`${s.rule_id||""}|${i}|${c}|${r}`,d=e.get(l);!d||H(s.severity)>H(d.severity)?e.set(l,{...s,snippet:r,start:i,end:c}):o++}const a=Array.from(e.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),a}async function K(t,e,n){const o=t?.context,a=(e??"").slice(0,240);let s;try{s=t.search(a,n)}catch{const i=a.slice(0,120);try{s=t.search(i,n)}catch{return{items:[]}}}try{s?.load?.("items"),await o?.sync?.()}catch{}return s}async function M(t,e){const n=t.context,o={matchCase:!1,matchWholeWord:!1},a=async c=>await K(t,c,o);let r=(await a(e||""))?.items||[];if(!r.length){const c=A(e||"");r=(await a(c))?.items||[]}r.sort((c,l)=>{const d=c.start??0,f=l.start??0;if(d!==f)return d-f;const u=c.end??d,m=l.end??f;return u-m});const i=[];for(const c of r){const l=c.start??0,d=c.end??l,f=i[i.length-1];if(f&&l<(f.end??l)){const u=(f.end??0)-(f.start??0);d-l>u&&(i[i.length-1]=c);continue}i.push(c)}for(const c of i)try{n.trackedObjects?.add?.(c)}catch{}return i}async function tt(t,e){const n=t.context;try{const a=n.document;if(a?.comments?.add){a.comments.add(t,e),await n.sync();return}}catch{}try{t.insertComment(e),await n.sync();return}catch{}const o=t.insertContentControl();o.tag="CAI_COMMENT",o.title="Contract AI — comment",o.color="yellow",o.appearance="BoundingBox",o.insertText(`COMMENT: ${e}`,Word.InsertLocation.replace),await n.sync()}function le(t,e,n){if(!t||!e)return 0;let o=-1,a=0;for(;(o=t.indexOf(e,o+1))!==-1&&o<(n??t.length);)a++;return a}function de(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const O="[CAI]";function ue(t){if(!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const e=[t.rule_id];return t.advice&&e.push(t.advice),t.law_refs?.length&&e.push(t.law_refs.join("; ")),`${O} ${e.join(`
`)}`}const et=200;function wt(t){const e=A(globalThis.__lastAnalyzed||""),n=Array.isArray(t)?t:[],o=re(n),a=o.slice().sort((l,d)=>(l.start??Number.POSITIVE_INFINITY)-(d.start??Number.POSITIVE_INFINITY)),s=[];let r=-1,i=0;for(const l of a){if(!l||!l.rule_id||!l.snippet||typeof l.start!="number"){i++;continue}const d=l.snippet,f=l.start,u=typeof l.end=="number"?l.end:f+d.length;if(f<r){i++;continue}const m=A(d),g=le(e,m,f);if(s.push({raw:d,norm:m,occIdx:g,msg:ue(l),rule_id:l.rule_id,code:l.code,normalized_fallback:A(l.normalized_snippet||"")}),r=u,s.length>=et)break}const c=globalThis;return i&&c.notifyWarn?.(`Skipped ${i} overlaps/invalid`),o.length>et&&c.notifyWarn?.(`Truncated to first ${et} findings`),c.notifyOk?.(`Will insert: ${s.length}`),s}async function _t(t){const e=wt(t);return e.length?await globalThis.Word?.run?.(async o=>{const a=o.document.body,s=[];let r=0;for(const i of e){let c=await M(a,i.raw),l=c[Math.min(i.occIdx,c.length-1)]||null;if(!l&&i.normalized_fallback&&i.normalized_fallback!==i.norm&&(c=await M(a,i.normalized_fallback),l=c[Math.min(i.occIdx,c.length-1)]||null),l){l.load?.(["start","end"]),await o.sync();const d=l.start??0,f=l.end??d;if(s.some(u=>Math.max(u.start,d)<Math.min(u.end,f))){console.warn("[annotate] overlapping range",{rid:i.rule_id,start:d,end:f});continue}if(de())try{l.select()}catch{}else i.msg&&await tt(l,i.msg);s.push({start:d,end:f}),r++}else console.warn("[annotate] no match for snippet",{rid:i.rule_id,snippet:i.raw.slice(0,120)});await o.sync()}return r}).catch(o=>(globalThis.logRichError?.(o,"annotate"),console.warn("annotate run fail",o?.code,o?.message,o?.debugInfo),0)):0}async function fe(t,e,n){if(!t||!t.trim())return;const o=globalThis;if(!o.Word?.run){await o.navigator?.clipboard?.writeText(t).catch(()=>{}),o.alert?.("Draft copied to clipboard (Office not ready). Paste it into the document.");return}if(o.Office?.context?.document?.mode&&o.Office.context.document.mode!=="edit")throw o.alert?.("Document is read-only."),new Error("Document mode is not editable");await o.Word.run(async a=>{const s=a.document;let r=null;try{const u=o.__findings||[],m=o.__findingIdx,g=u&&typeof m=="number"?u[m]:null,h=s.body;if(r=(g?.snippet?await M(h,g.snippet):[])[0]||null,!r){const y=s.getSelection();y.load("isEmpty"),await a.sync(),r=y.isEmpty?s.body.getRange("End"):y}}catch{const u=s.getSelection();u.load("isEmpty"),await a.sync(),r=u.isEmpty?s.body.getRange("End"):u}const i=r.insertText(t,o.Word.InsertLocation.replace),c=[`${O} Suggested clause – ${e}`],l=(n||"").split(/\r?\n/).slice(0,2).join(" "),d=o.__findings||[],f=o.__findingIdx;if(l)c.push(l);else{const u=d&&typeof f=="number"?d[f]:null,m=u?.rule_id||u?.title||"";m&&c.push(m)}c.push("schema 1.4 | model gpt-4o-mini | provider azure");try{s.comments.add(i,c.join(`
`))}catch{}await a.sync()}).catch(a=>{throw globalThis.logRichError?.(a,"insertDraft"),console.warn("insertDraftText error",a?.code,a?.message,a?.debugInfo),a})}function me(){const t=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),e=globalThis.Word||{},n=t&&!!e?.Revision,o=t&&!!e?.SearchOptions,a=t&&!!e?.ContentControl,r=globalThis.localStorage?.getItem?.("cai.force.comments")==="1";let i=!1,c="unsupported";return r?(i=!0,c="dev override"):e?.Comment?(i=!0,c="Word.Comment available"):t?(i=!0,c="WordApi 1.4"):(i=!1,c="Word.Comment missing"),{revisions:n,comments:i,search:o,contentControls:a,commentsReason:c}}function Et(){const t=me();try{console.log("support matrix",{comments:t.comments,reason:t.commentsReason})}catch{}return t}async function ge(t){const e=[];try{await Zt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(d=>{document.getElementById(d)||e.push(`missingID:${d}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||e.push("req1.4:0");const n=Et(),o={revisions:n.revisions?1:0,comments:n.comments?1:0,search:n.search?1:0,contentControls:n.contentControls?1:0};let a=!1;try{a=(await gt({backend:t})).ok,a||e.push("health")}catch{e.push("health:timeout")}const s="__BUILD_TS__",r=Office?.context?.host||"Word",i=e.length===0,c=i?`Startup OK | build=${s} | host=${r} | req=1.4 | features=${JSON.stringify(o)} | backend=${t}`:`Startup FAIL: ${e.join("; ")}`;console.log(c);const l=document.getElementById("startupBadge");return l&&(l.textContent=i?"OK":"FAIL",l.setAttribute("data-status",i?"ok":"fail")),{ok:i,missing:e,features:o}}async function nt(){return await Word.run(async t=>{const e=t.document.body;return e.load("text"),await t.sync(),(e.text||"").trim()})}async function ye(){return await Word.run(async t=>{const e=t.document.getSelection();return e.load("text"),await t.sync(),(e.text||"").trim()})}var It={};const ot=globalThis,at=ot.OfficeExtension,vt="build-20250912-195756";console.log("ContractAI build",vt);let At=null,St="1",Tt="1";try{At=localStorage.getItem("cai_timeout_ms:analyze"),St=localStorage.getItem("cai_abort_on_hidden")||"1",Tt=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:At,abort_on_hidden:St,abort_on_navigation:Tt}),!vt.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const t=document.createElement("div");t.textContent="FATAL: stale bundle",t.style.padding="12px",t.style.color="#f66",document.body.innerHTML="",document.body.appendChild(t),document.querySelectorAll("button").forEach(e=>{e.disabled=!0})}catch{}});const xt=(()=>{const t=ot.ENV_MODE||(typeof process<"u"?It?.ENV_MODE:void 0);return t?t==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();at&&at.config&&(xt==="dev"||ot.__ENABLE_EXTENDED_LOGS__)&&(at.config.extendedErrorLogging=!0);function z(t,e="Word"){try{const n=t&&t.debugInfo||{};console.error(`[${e}] RichApi error`,{code:t.code,message:t.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function Ct(t){return(pt(t)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const p=globalThis;p.parseFindings=p.parseFindings||Ct,p.applyMetaToBadges=p.applyMetaToBadges||G,p.getApiKeyFromStore=p.getApiKeyFromStore||R,p.getSchemaFromStore=p.getSchemaFromStore||k,p.logRichError=p.logRichError||z,p.getWholeDocText=p.getWholeDocText||nt,p.getSelectionText=p.getSelectionText||ye;let st="live";const S={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let ct="",kt=!1;const he=ie.required_ids||[];function it(t,e){const n=document.getElementById("status-chip");if(!n)return;const o=(t??k())||"—",a=(e??ct)||"—";n.textContent=`schema: ${o} | cid: ${a}`}function Bt(){const t=document.getElementById("anchorsBadge");if(!t)return;const e=globalThis.__anchorsSkipped||0;t.style.display=e>0?"":"none"}p.updateAnchorBadge=p.updateAnchorBadge||Bt;function pe(){if(kt)return;_("#btnAnalyze",De);const t=document.getElementById("btnAnalyze");t&&(t.disabled=!1),kt=!0,console.log("[PANEL] analyze enabled")}function Lt(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function be(){const e=document.getElementById("backendUrl")?.value?.trim();if(e)try{localStorage.setItem("backend.url",e),localStorage.setItem("backendUrl",e)}catch{}location.reload()}function rt(){try{let t=R(),e=k();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",a=o==="localhost"||o==="127.0.0.1";if(a&&(t||(t="local-test-key-123",ut(t)),!e)){const s=globalThis?.SCHEMA_VERSION||typeof process<"u"&&It?.SCHEMA_VERSION||"1.4";e=String(s),F(e)}n&&(!t&&!e&&!a?n.style.display="":n.style.display="none"),(!t||!e)&&console.warn("missing headers",{apiKey:!!t,schema:!!e})}catch{}return!0}function x(t,e){return document.querySelector(`[data-role="${e}"]`)||document.getElementById(t)}function Ot(){const e=document.getElementById("selectRiskThreshold")?.value?.toLowerCase();return e==="low"||e==="medium"||e==="high"?e:"medium"}function lt(){const t=jt();try{const e=globalThis.document,n=e?.getElementById("cai-comment-on-analyze")||e?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=t),n?!!n.checked:t}catch{return t}}function we(t){Ut(t)}function $t(t,e){const n=H(e);return(t||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>H(o.severity)>=n)}p.annotateFindingsIntoWord=p.annotateFindingsIntoWord||_t;async function _e(){try{await Word.run(async t=>{const e=t.document.body,n=t.document.comments,o=typeof e.search=="function"?e.search(O,{matchCase:!1}):null;n&&typeof n.load=="function"&&n.load("items"),await t.sync();for(const a of n.items)try{(a.text||"").startsWith(O)&&a.delete()}catch{}if(o&&(o.load("items"),await t.sync(),o.items&&o.items.length))for(const a of o.items)try{a.insertText("",Word.InsertLocation.replace)}catch{}try{e.font.highlightColor="NoColor"}catch{}await t.sync()}),L("Annotations cleared")}catch(t){z(t,"annotate"),w("Failed to clear annotations")}}async function Nt(t){return D(async()=>{let e=(t||[]).filter(a=>typeof a.start=="number"&&typeof a.end=="number"&&a.end>a.start).sort((a,s)=>a.start-s.start),n=-1;if(e=e.filter(a=>a.start<n?!1:(n=a.end,!0)),!e.length)return;const o=window.__lastAnalyzed||"";await Word.run(async a=>{const s=a.document.body;a.document.trackRevisions=!0;const r={matchCase:!1,matchWholeWord:!1},i=(c,l)=>{const d=c?.items||[];return d.length&&d[Math.min(Math.max(l,0),d.length-1)]||null};for(const c of e){const l=o.slice(c.start,c.end),d=(()=>{let u=-1,m=0;for(;(u=o.indexOf(l,u+1))!==-1&&u<c.start;)m++;return m})();let f=null;if(c.context_before||c.context_after){const u=`${c.context_before||""}${l}${c.context_after||""}`,m=await K(s,u,r),g=i(m,d);if(g){const h=g.search(l,r);h&&typeof h.load=="function"&&h.load("items"),await a.sync(),f=i(h,0)}}if(!f){const u=await K(s,l,r);f=i(u,d)}if(!f){const u=(()=>{const m=l.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(g=>g.length>=12);return m.length?m.sort((g,h)=>h.length-g.length)[0].slice(0,64):null})();if(u){const m=await K(s,u,r);f=i(m,0)}}if(f){f.insertText(c.replacement,"Replace");const u=`${O} ${c.rationale||c.source||"AI edit"}`;try{await tt(f,u)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:l,occIdx:d});await a.sync()}})})}p.applyOpsTracked=p.applyOpsTracked||Nt;async function Rt(t){await Word.run(async e=>{const n=e.document.body;let o=await M(n,t.raw),a=o[Math.min(t.occIdx,o.length-1)]||null;if(!a&&t.normalized_fallback&&t.normalized_fallback!==t.norm&&(o=await M(n,t.normalized_fallback),a=o[Math.min(t.occIdx,o.length-1)]||null),a)try{a.select()}catch{}await e.sync()})}let q=!1;async function Ft(t){if(q)return;q=!0;const e=window.__findings||[];if(!e.length){q=!1;return}const n=document.getElementById("btnPrevIssue"),o=document.getElementById("btnNextIssue");n&&(n.disabled=!0),o&&(o.disabled=!0);const a=window;a.__findingIdx=(a.__findingIdx??0)+t,a.__findingIdx<0&&(a.__findingIdx=e.length-1),a.__findingIdx>=e.length&&(a.__findingIdx=0);const s=document.getElementById("findingsList");if(s){const i=Array.from(s.querySelectorAll("li"));i.forEach((l,d)=>{l.classList.toggle("active",d===a.__findingIdx)});const c=i[a.__findingIdx];c&&c.scrollIntoView({block:"nearest"})}const r=document.getElementById("findingIndex");r&&(r.textContent=`${a.__findingIdx+1}/${e.length}`);try{await Rt(e[a.__findingIdx])}catch{}n&&(n.disabled=!1),o&&(o.disabled=!1),q=!1}function Ee(t){const e=window.__findings||[];if(!e.length)return;const n=e.findIndex(a=>a.rule_id===t||a.code===t);if(n<0)return;window.__findingIdx=n;const o=document.getElementById("findingsList");if(o){const a=Array.from(o.querySelectorAll("li"));a.forEach((r,i)=>{r.classList.toggle("active",i===n)});const s=a[n];s&&s.scrollIntoView({block:"nearest"})}try{Rt(e[n])}catch{}}async function Ie(){await Ft(-1)}async function ve(){await Ft(1)}function Ae(t){const e=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",n=Array.isArray(t?.findings)?t.findings:[],o=Array.isArray(t?.recommendations)?t.recommendations:[],a=Ot(),s=$t(n,a),r=s.length,i=n.length-r,c=(u,m)=>{const g=document.getElementById(u);g&&(g.textContent=m)};c("clauseTypeOut",String(e)),c("resFindingsCount",String(n.length)),c("visibleHiddenOut",`${r} / ${i}`);const l=document.getElementById("findingsList");if(l){l.innerHTML="";for(const u of s){const m=document.createElement("li"),g=u?.title||u?.finding?.title||u?.rule_id||"Issue",h=u?.snippet||u?.evidence?.text||"";m.textContent=h?`${g}: ${h}`:String(g);const b=Array.isArray(u.links)?u.links.filter(y=>y?.type==="conflict"&&y?.targetFindingId):[];if(b.length){const y=document.createElement("div");y.textContent=`Conflicts: ${b.length} `,b.forEach((E,C)=>{const $=document.createElement("a");$.href="#",$.textContent="Jump to",$.addEventListener("click",qe=>{qe.preventDefault(),Ee(E.targetFindingId)}),y.appendChild($),C<b.length-1&&y.append(" ")}),m.appendChild(y)}l.appendChild(m)}}const d=document.getElementById("recsList");if(d){d.innerHTML="";for(const u of o){const m=document.createElement("li");m.textContent=u?.text||u?.advice||u?.message||"Recommendation",d.appendChild(m)}}const f=document.getElementById("resultsBlock");f&&f.style.removeProperty("display")}function Se(t){const e=x("resClauseType","clause-type");e&&(e.textContent=t?.clause_type||"—");const n=Ct(t);window.__findings=n,window.__findingIdx=0;const o=document.getElementById("findingIndex");o&&(o.textContent=n.length?`1/${n.length}`:"0/0");const a=x("findingsList","findings");a&&(a.innerHTML="",n.forEach(l=>{const d=document.createElement("li");d.textContent=typeof l=="string"?l:JSON.stringify(l),a.appendChild(d)}));const s=Array.isArray(t?.recommendations)?t.recommendations:[],r=x("recoList","recommendations");r&&(r.innerHTML="",s.forEach(l=>{const d=document.createElement("li");d.textContent=typeof l=="string"?l:JSON.stringify(l),r.appendChild(d)}));const i=x("resFindingsCount","findings-count");i&&(i.textContent=String(n.length));const c=x("rawJson","raw-json");c&&(c.textContent=JSON.stringify(t??{},null,2))}function Te(){const t=x("toggleRaw","toggle-raw-json"),e=x("rawJson","raw-json");t&&e&&(e.style.display="none",t.addEventListener("click",()=>{e.style.display=e.style.display==="none"?"block":"none"}))}function Dt(t){const e=document.getElementById("connBadge");e&&(e.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`)}function dt(t){const e=document.getElementById("officeBadge");e&&(e.textContent=`Office: ${t??"—"}`)}async function xe(){await Word.run(async t=>{const e=["Heading 1","Heading 2","Heading 3"];for(let n=0;n<e.length;n++){const o=t.document.body.paragraphs.getByStyle(e[n]);o.load("items"),await t.sync();for(const a of o.items)try{a.listFormat.removeNumbers(),a.listFormat.applyNumberedDefault(),a.listItem&&(a.listItem.level=n);const s=36*(n+1);a.paragraphFormat.leftIndent=s,a.paragraphFormat.firstLineIndent=-36,a.paragraphFormat.lineSpacing=240}catch(s){console.warn("fixNumbering",s)}}await t.sync()}).catch(t=>z(t,"fixNumbering"))}function T(t){return document.querySelector(t)}function Ce(){return(T(S.original)?.value||"").trim()}async function ke(){let t=Ce();if(t.length>=20)return t;try{if(t=(await globalThis.getSelectionText()||"").trim(),t.length>=20){const e=T(S.original);if(e){e.value=t;try{e.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}return t}}catch{}return w("Please paste the original clause (min 20 chars) or select text in the document."),null}function Be(){try{return globalThis.detectContractType?.()||"unknown"}catch{return"unknown"}}function Le(){try{const t=window.__findings||[];return Array.isArray(t)?t:[]}catch{return[]}}function Oe(){try{return window.getSelectionOffsets?.()||null}catch{return null}}async function $e(t){const e=await ke();if(!e)return;const n={mode:t,clause:e,context:{law:"UK",language:"en-GB",contractType:Be()},findings:Le().slice(0,10),selection:Oe()};let o;try{o=await fetch("/api/gpt/draft",{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":R()||"","X-Schema-Version":"1.4"},body:JSON.stringify(n)})}catch(c){console.warn("Draft error",c),w("Draft error");return}if(!o.ok){const c=await o.text();console.warn(`Draft failed: ${o.status} ${c}`);return}const a=await o.json(),s=(a?.proposed_text??a?.text??"").toString(),r=T(S.proposed),i=window;if(i.__last=i.__last||{},i.__last["gpt-draft"]={json:a},r){r.id||(r.id="draftText"),r.name||(r.name="proposed"),r.dataset.role="proposed-text",r.value=s,r.dispatchEvent(new Event("input",{bubbles:!0})),L("Draft ready");try{await fe(s,st,a?.meta?.rationale)}catch{}W(s)}else w("Proposed textarea not found"),W("")}async function Ne(){const t=T(S.original),e=await nt(),n=A(e||"");if(t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const o=document.getElementById("originalText");if(o&&o!==t){o.value=n;try{o.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function Re(t){return D(()=>$e(st==="friendly"?"friendly":"strict"))}async function Mt(){try{const t=k(),{resp:e,json:n,ok:o}=await gt({backend:Lt()}),a=e.headers.get("x-schema-version")||n?.schema||null;if(a&&(F(a),a!==t&&console.log(`schema: ${a} (synced)`)),Dt(o),o){console.log("[PANEL] health ok"),pe(),it(a,null);try{G({cid:null,xcache:null,latencyMs:null,schema:a||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}L(`Health: ${n?.status||"ok"}${a?` (schema ${a})`:""}`)}else w("Health failed")}catch(t){Dt(!1),w("Health failed"),console.error(t)}}async function Fe(){const t=document.getElementById("originalText");let e=A(t?.value||"");if(!e){const n=document.getElementById("btnAnalyze");n&&(n.disabled=!0);try{e=A(await globalThis.getWholeDocText()),t&&(t.value=e||"")}catch{e=""}finally{n&&(n.disabled=!1)}}return e?(window.__lastAnalyzed=e,e):(w("Document is empty"),null)}async function De(){await Fe()&&await Me()}async function Me(){return D(async()=>{const t=document.getElementById("btnAnalyze"),e=document.getElementById("busyBar");t&&(t.disabled=!0),e&&(e.style.display="");try{W("");const n=window.__lastAnalyzed;if(!n){yt("В документе нет текста");return}rt();const{resp:o,json:a}=await se({text:n,mode:st});if(!o.ok)throw new Error(`HTTP ${o.status}`);const s=o.headers.get("x-schema-version");s&&F(s),a?.schema&&F(a.schema),ct=o.headers.get("x-cid")||"",it(null,ct),Se(a),Ae(a);try{localStorage.setItem("last_analysis_json",JSON.stringify(a))}catch{}try{const r=globalThis.parseFindings(a),i=Ot(),c=$t(r,i),l=wt(c);window.__findings=l,lt()&&c.length&&await _t(c)}catch(r){console.warn("auto-annotate after analyze failed",r)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:a})),L("Analyze OK")}catch(n){let o="";if(n?.name==="AbortError"){const a=n?.message||"";if(a.startsWith("timeout")){const s=parseInt(a.replace(/[^0-9]/g,""),10)||0;o=`(timeout ${Math.round(s/1e3)} s)`}else a==="pagehide/unload"?o="(aborted by pagehide)":o="(aborted)"}else typeof n?.message=="string"&&(n.message.includes("HTTP 504")?o="(HTTP 504)":n.message.includes("HTTP 413")?o="(payload too large 413)":n.message.includes("HTTP 401")?o="(unauthorized 401)":n.message.includes("HTTP 403")?o="(forbidden 403)":n.message.includes("HTTP 422")&&(o="(schema mismatch 422)"));w(`Analyze failed ${o}`.trim()),console.error(n)}finally{t&&(t.disabled=!1),e&&(e.style.display="none")}})}async function ze(){return D(async()=>{rt();const t=await nt(),{json:e}=await P("/api/qa-recheck",{text:t,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:e})),!e?.error)L("QA recheck OK");else{const o=e?.error||e?.message||"unknown";yt(`QA recheck failed: ${o}`)}})}function _(t,e){const n=document.querySelector(t);n&&(n.addEventListener("click",o=>{o.preventDefault(),e()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function We(){try{const t=window.__lastAnalyzed||"",e=(T(S.proposed)?.value||"").trim();if(!e){w("No draft to diff");return}const n=await ce(t,e),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",a=document.getElementById("diffOutput"),s=document.getElementById("diffContainer");a&&s&&(a.innerHTML=o||"",s.style.display=o?"block":"none")}catch(t){w("Diff failed"),console.error(t)}}async function je(){try{const t=window.__last||{},e=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!e.length){w("No ops to apply");return}await Nt(e),L("Applied ops")}catch(t){w("Insert failed"),console.error(t)}}async function Ue(){try{const e=(T(S.proposed)?.value||"").trim();if(!e){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),a=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async s=>{const r=s.document.getSelection();s.document.trackRevisions=!0,r.insertText(e,Word.InsertLocation.replace);try{await tt(r,`${O} ${a}`)}catch{}await s.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),z(t,"insertDraft"),console.error(t)}}async function Pe(){try{const t=T(S.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),W("")),await Word.run(async e=>{const o=e.document.getSelection().revisions;o.load("items"),await e.sync(),(o.items||[]).forEach(a=>{try{a.reject()}catch{}}),await e.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),z(t,"insertDraft"),console.error(t)}}function zt(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const d=he.filter(f=>!document.getElementById(f));if(d.length){console.error("[PANEL] wireUI missing IDs:",d);const f=`FATAL: panel template mismatch (missing: ${d.join(", ")}). Check build pipeline.`;try{const u=document.createElement?document.createElement("div"):null;u&&(u.textContent=f,u.style.padding="12px",u.style.color="#f66",document.body.innerHTML="",document.body.appendChild(u))}catch{}console.error(f);return}}const t=document.getElementById("loading-book");window.addEventListener("cai:busy",d=>{if(!t)return;!!d?.detail?.busy?t.classList.remove("hidden"):t.classList.add("hidden")});const e=Et(),n=(d,f)=>{const u=document.getElementById(d);if(u&&(u.disabled=!0,u.title=f?`Not supported: ${f}`:"Not supported"),f)try{console.log(`disabled ${d}: ${f}`)}catch{}};_("#btnUseWholeDoc",Ne);const o=document.getElementById("btnUseWholeDoc");if(o&&(o.disabled=!1),_("#btnFixNumbering",xe),xt==="dev")_("#btnTest",Mt);else{const d=document.getElementById("btnTest");d&&(d.style.display="none")}_("#btnQARecheck",ze);const a=document.getElementById("btnSuggestEdit"),s=T(S.original),r=()=>{a&&(a.disabled=!(s&&s.value.trim()))};s?.addEventListener("input",r);try{Office.context.document.addHandlerAsync?.(Office.EventType.DocumentSelectionChanged,async()=>{try{const d=await globalThis.getSelectionText();if(d&&s){s.value=d;try{s.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}}catch{}})}catch{}r(),a?.addEventListener("click",Re),_("#btnApplyTracked",je),_("#btnAcceptAll",Ue),_("#btnRejectAll",Pe),_("#btnPrevIssue",Ie),_("#btnNextIssue",ve),_("#btnPreviewDiff",We),_("#btnClearAnnots",_e),_("#btnSave",be);const i=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");i?(i.checked=lt(),i.addEventListener("change",()=>we(!!i.checked))):lt();const c=document.getElementById("btnAnnotate");c&&(c.addEventListener("click",async()=>{if(!c.disabled){c.disabled=!0;try{const d=window.__last?.analyze?.json||{},f=globalThis.parseFindings(d);try{await globalThis.annotateFindingsIntoWord(f)}catch(u){const m=u?.code||u?.name||"";m==="SearchStringInvalidOrTooLong"||m==="InvalidOrTooLong"||m==="InvalidArgument"?(globalThis.toast2?.("Search failed (long text), skipping some anchors","warn"),console.warn("[annotate run] search error",m)):console.warn("[annotate run] error",u)}}finally{c.disabled=!1}}}),c.classList.remove("js-disable-while-busy"),c.removeAttribute("disabled")),W(""),Te(),console.log("Panel UI wired");const l=document.getElementById("btnAnalyze");if(l&&(l.disabled=!0),rt(),it(),Bt(),e.revisions||(n("btnApplyTracked","revisions"),n("btnAcceptAll","revisions"),n("btnRejectAll","revisions")),e.comments||n("btnAcceptAll",e.commentsReason),e.search||(n("btnPrevIssue","search"),n("btnNextIssue","search"),n("btnQARecheck","search")),e.contentControls||n("btnAnnotate","contentControls"),!e.revisions||!e.comments||!e.search||!e.contentControls)try{dt("Word ⚠")}catch{}}p.wireUI=p.wireUI||zt;function W(t){const e=!!t.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),a=document.getElementById("btnRejectAll"),s=document.getElementById("btnPreviewDiff"),r=document.getElementById("draftPane"),i=document.getElementById("draftText");i&&(i.value=t),r&&(r.style.display=e?"":"none"),n&&(n.disabled=!e),o&&(o.disabled=!e),a&&(a.disabled=!e),s&&(s.disabled=!e)}async function He(t){console.log("[PANEL] bootstrap start"),mt()&&(console.log("reopen clean OK"),Qt()),zt(),Yt();try{await ge(Lt())}catch{}try{await Mt()}catch{}try{dt(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{dt(null)}}let V=0;function Ke(t){if(mt()&&(V=0),V>0){console.log(`bootstrap invoked x${V+1}`);return}V++,console.log("bootstrap invoked x1"),He(t)}if(!globalThis.__CAI_TESTING__){const t=()=>Office.onReady(e=>Ke(e));document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}})();
