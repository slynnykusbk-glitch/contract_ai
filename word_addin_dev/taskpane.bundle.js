(function(){"use strict";const C="cai-comment-on-analyze";function ye(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",""),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version","1.4"),localStorage.getItem(C)===null&&localStorage.setItem(C,"1")}catch{}}ye();function D(){try{return localStorage.getItem("api_key")||""}catch{return""}}function V(e){try{localStorage.setItem("api_key",e)}catch{}}function T(){try{return localStorage.getItem("schema_version")||"1.4"}catch{return"1.4"}}function x(e){try{localStorage.setItem("schema_version",e)}catch{}}function he(){try{const e=localStorage.getItem(C);return e===null?(localStorage.setItem(C,"1"),!0):e!=="0"}catch{return!0}}function be(e){try{localStorage.setItem(C,e?"1":"0")}catch{}}const w=typeof globalThis<"u"?globalThis:window;w.CAI=w.CAI||{},w.CAI.Store=w.CAI.Store||{},w.CAI.Store.setApiKey=V,w.CAI.Store.setSchemaVersion=x,w.CAI.Store.get=()=>({apiKey:D(),schemaVersion:T()}),w.CAI.Store.DEFAULT_BASE=w.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const F=new Set,R=new Set;function _e(e){F.add(e)}function we(e){F.delete(e)}function Ae(e){R.add(e)}function Ee(e){R.delete(e)}function Ie(){F.forEach(e=>{try{e.abort()}catch{}}),F.clear(),R.forEach(e=>{try{clearTimeout(e),clearInterval(e)}catch{}}),R.clear();try{document.querySelectorAll(".progress").forEach(e=>{e.style.display="none"})}catch{}}function ve(){if(globalThis.__pendingUnloadReg)return;globalThis.__pendingUnloadReg=!0;const e=()=>{Ie(),globalThis.__wasUnloaded=!0};window.addEventListener("pagehide",e),window.addEventListener("unload",e),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&e()})}function Q(){return!!globalThis.__wasUnloaded}function Se(){globalThis.__wasUnloaded=!1}let M=null;async function Y(e={}){if(!M){const t=(e.backend||"").replace(/\/+$/,""),n=t?`${t}/health`:"/health",o=new AbortController,s=e.timeoutMs??9e3,c=setTimeout(()=>o.abort(),s);M=fetch(n,{signal:o.signal}).then(async a=>{clearTimeout(c);const r=await a.json().catch(()=>({}));return{ok:a.ok,json:r,resp:a}})}return M}function G(e){const t=e?.analysis?.findings??e?.findings??e?.issues??[];return Array.isArray(t)?t.filter(Boolean):[]}window.parseFindings=G;function X(e){const t=(n,o)=>{const s=document.getElementById(n);s&&(s.textContent=o&&o.length?o:"—")};t("status",e.status),t("cid",e.cid),t("xcache",e.xcache),t("latency",e.latencyMs),t("schema",e.schema),t("provider",e.provider),t("model",e.model),t("mode",e.llm_mode),t("usage",e.usage)}const Z="https://localhost:9443";function Te(){try{return(localStorage.getItem("backendUrl")||Z).replace(/\/+$/,"")}catch{return Z}}async function B(e,t,n=9e3){const o=Te()+e,s={"Content-Type":"application/json"},c=T()||"1.4";s["x-schema-version"]=c;const a=D();a&&(s["x-api-key"]=a);const r=new AbortController,i=setTimeout(()=>r.abort(),n);_e(r),Ae(i);try{const u=await fetch(o,{method:"POST",headers:s,body:JSON.stringify(t||{}),credentials:"include",signal:r.signal}),l=await u.json().catch(()=>({}));return{resp:u,json:l}}finally{clearTimeout(i),Ee(i),we(r)}}window.postJson=B;async function ke(e,t){return B("/api/panel/redlines",{before_text:e,after_text:t})}const Ce={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","officeBadge","connBadge"]};function A(e){return e?e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function N(e){const t=(e||"").toLowerCase();return t==="high"?3:t==="medium"?2:1}function xe(e){const t=new Map;let n=0,o=0;for(const c of e||[]){const a=A(c.snippet||""),r=typeof c.start=="number"?c.start:void 0,i=typeof c.end=="number"?c.end:r!==void 0?r+a.length:void 0;if(typeof r!="number"||typeof i!="number"||i<=r||i-r>1e4){n++;continue}const u=`${c.rule_id||""}|${r}|${i}|${a}`,l=t.get(u);!l||N(c.severity)>N(l.severity)?t.set(u,{...c,snippet:a,start:r,end:i}):o++}const s=Array.from(t.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),s}function Be(){const e=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),t=globalThis.Word||{},n=e&&!!t?.Revision,o=e&&!!t?.Comment,s=e&&!!t?.SearchOptions,c=e&&!!t?.ContentControl;return{revisions:n,comments:o,search:s,contentControls:c}}function ee(){const e=Be();try{console.log("support matrix",e)}catch{}return e}async function Le(e){const t=[];["btnAnalyze","selectRiskThreshold"].forEach(l=>{document.getElementById(l)||t.push(`missingID:${l}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||t.push("req1.4:0");const n=ee(),o={revisions:n.revisions?1:0,comments:n.comments?1:0,search:n.search?1:0,contentControls:n.contentControls?1:0};let s=!1;try{s=(await Y({backend:e})).ok,s||t.push("health")}catch{t.push("health:timeout")}const c="__BUILD_TS__",a=Office?.context?.host||"Word",r=t.length===0,i=r?`Startup OK | build=${c} | host=${a} | req=1.4 | features=${JSON.stringify(o)} | backend=${e}`:`Startup FAIL: ${t.join("; ")}`;console.log(i);const u=document.getElementById("startupBadge");return u&&(u.textContent=r?"OK":"FAIL",u.setAttribute("data-status",r?"ok":"fail")),{ok:r,missing:t,features:o}}function I(e){try{console.log("[OK]",e)}catch{}}function te(e){try{console.error("[ERR]",e)}catch{}}function y(e){try{console.warn("[WARN]",e)}catch{}}async function U(){return await Word.run(async e=>{const t=e.document.body;return t.load("text"),await e.sync(),(t.text||"").trim()})}var ne={};const j=globalThis,H=j.OfficeExtension,oe="__BUILD_TS__";console.log("ContractAI build",oe),oe.includes("__BUILD_TS__")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const e=document.createElement("div");e.textContent="FATAL: stale bundle",e.style.padding="12px",e.style.color="#f66",document.body.innerHTML="",document.body.appendChild(e),document.querySelectorAll("button").forEach(t=>{t.disabled=!0})}catch{}});const se=(()=>{const e=j.ENV_MODE||(typeof process<"u"?ne?.ENV_MODE:void 0);return e?e==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();H&&H.config&&(se==="dev"||j.__ENABLE_EXTENDED_LOGS__)&&(H.config.extendedErrorLogging=!0);function L(e,t="Word"){try{const n=e&&e.debugInfo||{};console.error(`[${t}] RichApi error`,{code:e.code,message:e.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function ae(e){return(G(e)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const g=globalThis;g.parseFindings=g.parseFindings||ae,g.applyMetaToBadges=g.applyMetaToBadges||X,g.getApiKeyFromStore=g.getApiKeyFromStore||D,g.getSchemaFromStore=g.getSchemaFromStore||T,g.logRichError=g.logRichError||L,g.getWholeDocText=g.getWholeDocText||U;const $={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let W="",ce=!1;const $e=Ce.required_ids||[];function P(e,t){const n=document.getElementById("status-chip");if(!n)return;const o=(e??T())||"—",s=(t??W)||"—";n.textContent=`schema: ${o} | cid: ${s}`}function Oe(){if(ce)return;h("#btnAnalyze",Ve);const e=document.getElementById("btnAnalyze");e&&(e.disabled=!1),ce=!0,console.log("[PANEL] analyze enabled")}function ie(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function De(){const t=document.getElementById("backendUrl")?.value?.trim();if(t)try{localStorage.setItem("backend.url",t),localStorage.setItem("backendUrl",t)}catch{}location.reload()}function K(){try{let e=D(),t=T();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",s=o==="localhost"||o==="127.0.0.1";if(s&&(e||(e="local-test-key-123",V(e)),!t)){const c=globalThis?.SCHEMA_VERSION||typeof process<"u"&&ne?.SCHEMA_VERSION||"1.4";t=String(c),x(t)}n&&(!e&&!t&&!s?n.style.display="":n.style.display="none"),(!e||!t)&&console.warn("missing headers",{apiKey:!!e,schema:!!t})}catch{}return!0}function v(e,t){return document.querySelector(`[data-role="${t}"]`)||document.getElementById(e)}function re(){const t=document.getElementById("selectRiskThreshold")?.value?.toLowerCase();return t==="low"||t==="medium"||t==="high"?t:"medium"}function q(){const e=he();try{const t=globalThis.document,n=t?.getElementById("cai-comment-on-analyze")||t?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=e),n?!!n.checked:e}catch{return e}}function Fe(e){be(e)}function Re(){const e=document.getElementById("cai-dry-run-annotate");return e?!!e.checked:!1}function le(e,t){const n=N(t);return(e||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>N(o.severity)>=n)}function Ne(e){if(!e||!e.rule_id||!e.snippet)return console.warn("buildLegalComment: missing required fields",e),"";const t=(e.severity||"info").toUpperCase(),n=e.rule_id,o=e.clause_type?` (${e.clause_type})`:"",s=e.advice||"—",c=Array.isArray(e.law_refs)&&e.law_refs.length?e.law_refs.join("; "):"—",a=Array.isArray(e.conflict_with)&&e.conflict_with.length?e.conflict_with.join("; "):"—",r=e.suggestion?.text||"—",i=Array.isArray(e.citations)&&e.citations.length?`
Citations: ${e.citations.join("; ")}`:"";return`[${t}] ${n}${o}
Reason: ${s}
Law: ${c}
Conflict: ${a}${i}
Suggested fix: ${r}`}function de(e,t,n){if(!t)return 0;let o=-1,s=0;const c=typeof n=="number"?Math.max(0,n):Number.MAX_SAFE_INTEGER;for(;(o=e.indexOf(t,o+1))!==-1&&o<c;)s++;return s}async function Ue(e){const t=A(window.__lastAnalyzed||""),n=xe(e||[]),o=n.slice().sort((l,f)=>(f.end??0)-(l.end??0)),s=[];let c=Number.POSITIVE_INFINITY,a=0;for(const l of o){if(!l||!l.rule_id||!l.snippet){a++;continue}const f=l.snippet,d=typeof l.end=="number"?l.end:typeof l.start=="number"?l.start+f.length:void 0;if(typeof d=="number"&&d>c){a++;continue}s.push(l),typeof l.start=="number"&&(c=l.start)}a&&y(`Skipped ${a} overlaps/invalid`),I(`Will insert: ${s.length}`);const r=s.map(l=>{const f=l.snippet||"",d=A(f),m=de(t,d,l.start);return{raw:f,norm:d,msg:Ne(l),rule_id:l.rule_id,occIdx:m,normalized_fallback:A(l.normalized_snippet||"")}}),i={matchCase:!1,matchWholeWord:!1};let u=0;for(const l of r)await Word.run(async f=>{const d=f.document.body;let m=null;const p=d.search(l.raw,i);p.load("items"),await f.sync();const b=(E,_)=>{const S=E?.items||[];return S.length&&S[Math.min(Math.max(_,0),S.length-1)]||null};if(m=b(p,l.occIdx),!m){const E=l.normalized_fallback&&l.normalized_fallback!==l.norm?l.normalized_fallback:l.norm;if(E&&E.trim()){const _=d.search(E,i);_.load("items"),await f.sync(),m=b(_,l.occIdx)}}if(!m){const E=(()=>{const _=l.raw.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(S=>S.length>=12);return _.length?_.sort((S,nt)=>nt.length-S.length)[0].slice(0,64):null})();if(E){const _=d.search(E,i);_.load("items"),await f.sync(),m=b(_,0)}}if(m){if(Re())try{m.select()}catch{}else l.msg&&m.insertComment(l.msg);u++}else console.warn("[annotate] no match for snippet",{rid:l.rule_id,snippet:l.raw.slice(0,120)});await f.sync()}).catch(f=>{L(f,"annotate"),console.warn("annotate run fail",f?.code,f?.message,f?.debugInfo)});return console.log("panel:annotate",{total:e.length,deduped:n.length,skipped_overlaps:a,will_annotate:s.length,inserted:u}),u}g.annotateFindingsIntoWord=g.annotateFindingsIntoWord||Ue;async function We(){try{await Word.run(async e=>{const t=e.document.body,n=e.document.comments;n.load("items"),await e.sync();for(const o of n.items)try{o.delete()}catch{}try{t.font.highlightColor="NoColor"}catch{}await e.sync()}),I("Annotations cleared")}catch(e){L(e,"annotate"),y("Failed to clear annotations")}}async function ue(e){let t=(e||[]).filter(s=>typeof s.start=="number"&&typeof s.end=="number"&&s.end>s.start).sort((s,c)=>s.start-c.start),n=-1;if(t=t.filter(s=>s.start<n?!1:(n=s.end,!0)),!t.length)return;const o=window.__lastAnalyzed||"";await Word.run(async s=>{const c=s.document.body;s.document.trackRevisions=!0;const a={matchCase:!1,matchWholeWord:!1},r=(i,u)=>{const l=i?.items||[];return l.length&&l[Math.min(Math.max(u,0),l.length-1)]||null};for(const i of t){const u=o.slice(i.start,i.end),l=(()=>{let d=-1,m=0;for(;(d=o.indexOf(u,d+1))!==-1&&d<i.start;)m++;return m})();let f=null;if(i.context_before||i.context_after){const d=`${i.context_before||""}${u}${i.context_after||""}`,m=c.search(d,a);m.load("items"),await s.sync();const p=r(m,l);if(p){const b=p.search(u,a);b.load("items"),await s.sync(),f=r(b,0)}}if(!f){const d=c.search(u,a);d.load("items"),await s.sync(),f=r(d,l)}if(!f){const d=(()=>{const m=u.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(p=>p.length>=12);return m.length?m.sort((p,b)=>b.length-p.length)[0].slice(0,64):null})();if(d){const m=c.search(d,a);m.load("items"),await s.sync(),f=r(m,0)}}if(f){f.insertText(i.replacement,"Replace");const d=i.rationale||i.source||"AI edit";try{f.insertComment(d)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:u,occIdx:l});await s.sync()}})}g.applyOpsTracked=g.applyOpsTracked||ue;async function ze(e){const t=A(window.__lastAnalyzed||""),n=e?.snippet||"",o=A(n),s=de(t,o,e.start),c={matchCase:!1,matchWholeWord:!1};await Word.run(async a=>{const r=a.document.body;let i=null;const u=(f,d)=>{const m=f?.items||[];return m.length&&m[Math.min(Math.max(d,0),m.length-1)]||null},l=r.search(n,c);if(l.load("items"),await a.sync(),i=u(l,s),!i){const f=e.normalized_snippet&&e.normalized_snippet!==o?e.normalized_snippet:o;if(f&&f.trim()){const d=r.search(f,c);d.load("items"),await a.sync(),i=u(d,s)}}if(!i){const f=(()=>{const d=n.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(m=>m.length>=12);return d.length?d.sort((m,p)=>p.length-m.length)[0].slice(0,64):null})();if(f){const d=r.search(f,c);d.load("items"),await a.sync(),i=u(d,0)}}if(i)try{i.select()}catch{}await a.sync()})}async function fe(e){const t=window.__findings||[];if(!t.length)return;const n=window;n.__findingIdx=(n.__findingIdx??0)+e,n.__findingIdx<0&&(n.__findingIdx=t.length-1),n.__findingIdx>=t.length&&(n.__findingIdx=0);const o=document.getElementById("findingsList");if(o){const s=Array.from(o.querySelectorAll("li"));s.forEach((a,r)=>{a.classList.toggle("active",r===n.__findingIdx)});const c=s[n.__findingIdx];c&&c.scrollIntoView({block:"nearest"})}try{await ze(t[n.__findingIdx])}catch{}}function Me(){fe(-1)}function je(){fe(1)}function He(e){const t=e?.summary?.clause_type||e?.meta?.clause_type||e?.doc_type||"—",n=Array.isArray(e?.findings)?e.findings:[],o=Array.isArray(e?.recommendations)?e.recommendations:[],s=re(),a=le(n,s).length,r=n.length-a,i=(d,m)=>{const p=document.getElementById(d);p&&(p.textContent=m)};i("clauseTypeOut",String(t)),i("resFindingsCount",String(n.length)),i("visibleHiddenOut",`${a} / ${r}`);const u=document.getElementById("findingsList");if(u){u.innerHTML="";for(const d of n){const m=document.createElement("li"),p=d?.title||d?.finding?.title||d?.rule_id||"Issue",b=d?.snippet||d?.evidence?.text||"";m.textContent=b?`${p}: ${b}`:String(p),u.appendChild(m)}}const l=document.getElementById("recsList");if(l){l.innerHTML="";for(const d of o){const m=document.createElement("li");m.textContent=d?.text||d?.advice||d?.message||"Recommendation",l.appendChild(m)}}const f=document.getElementById("resultsBlock");f&&f.style.removeProperty("display")}function Pe(e){const t=v("resClauseType","clause-type");t&&(t.textContent=e?.clause_type||"—");const n=ae(e);window.__findings=n,window.__findingIdx=0;const o=v("findingsList","findings");o&&(o.innerHTML="",n.forEach(i=>{const u=document.createElement("li");u.textContent=typeof i=="string"?i:JSON.stringify(i),o.appendChild(u)}));const s=Array.isArray(e?.recommendations)?e.recommendations:[],c=v("recoList","recommendations");c&&(c.innerHTML="",s.forEach(i=>{const u=document.createElement("li");u.textContent=typeof i=="string"?i:JSON.stringify(i),c.appendChild(u)}));const a=v("resFindingsCount","findings-count");a&&(a.textContent=String(n.length));const r=v("rawJson","raw-json");r&&(r.textContent=JSON.stringify(e??{},null,2))}function Ke(){const e=v("toggleRaw","toggle-raw-json"),t=v("rawJson","raw-json");e&&t&&(t.style.display="none",e.addEventListener("click",()=>{t.style.display=t.style.display==="none"?"block":"none"}))}function me(e){const t=document.getElementById("connBadge");t&&(t.textContent=`Conn: ${e===null?"—":e?"✓":"×"}`)}function J(e){const t=document.getElementById("officeBadge");t&&(t.textContent=`Office: ${e??"—"}`)}function O(e){return document.querySelector(e)}async function qe(){const e=O($.original),t=await U(),n=A(t||"");if(e){e.value=n;try{e.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const o=document.getElementById("originalText");if(o&&o!==e){o.value=n;try{o.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function Je(e){try{const t=O($.proposed);if(!(window.__lastAnalyzed||A(await U()))){y("No document text");return}const o=window.__findings||[],s=window.__findingIdx??0,c=o[s];if(!c){y("No active finding");return}const a=c.snippet||"",{json:r}=await B("/api/gpt-draft",{cid:W,clause:a,mode:"friendly"}),i=(r?.proposed_text??r?.text??"").toString(),u=window;u.__last=u.__last||{},u.__last["gpt-draft"]={json:r},t?(t.id||(t.id="draftText"),t.name||(t.name="proposed"),t.dataset.role="proposed-text",t.value=i,t.dispatchEvent(new Event("input",{bubbles:!0})),I("Draft ready"),k(i)):(y("Proposed textarea not found"),k(""))}catch(t){y("Draft error"),console.error(t),k("")}}async function ge(){try{const e=T(),{resp:t,json:n,ok:o}=await Y({backend:ie()}),s=t.headers.get("x-schema-version")||n?.schema||null;if(s&&(x(s),s!==e&&console.log(`schema: ${s} (synced)`)),me(o),o){console.log("[PANEL] health ok"),Oe(),P(s,null);try{X({cid:null,xcache:null,latencyMs:null,schema:s||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}I(`Health: ${n?.status||"ok"}${s?` (schema ${s})`:""}`)}else y("Health failed")}catch(e){me(!1),y("Health failed"),console.error(e)}}async function Ve(){const e=document.getElementById("btnAnalyze"),t=document.getElementById("busyBar");e&&(e.disabled=!0),t&&(t.style.display="");try{k("");const n=window.__lastAnalyzed,o=n&&n.trim()?n:A(await globalThis.getWholeDocText());if(!o){te("В документе нет текста");return}K(),window.__lastAnalyzed=o;const s=document.getElementById("originalText");s&&(s.value=o);const{resp:c,json:a}=await B("/api/analyze",{text:o});if(!c.ok)throw new Error(`HTTP ${c.status}`);const r=c.headers.get("x-schema-version");r&&x(r),a?.schema&&x(a.schema),W=c.headers.get("x-cid")||"",P(null,W),Pe(a),He(a);try{localStorage.setItem("last_analysis_json",JSON.stringify(a))}catch{}try{const i=globalThis.parseFindings(a),u=re(),l=le(i,u);q()&&l.length&&await globalThis.annotateFindingsIntoWord(l)}catch(i){console.warn("auto-annotate after analyze failed",i)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:a})),I("Analyze OK")}catch(n){y("Analyze failed"),console.error(n)}finally{e&&(e.disabled=!1),t&&(t.style.display="none")}}async function Qe(){K();const e=await U(),{json:t}=await B("/api/qa-recheck",{text:e,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:t})),!t?.error)I("QA recheck OK");else{const o=t?.error||t?.message||"unknown";te(`QA recheck failed: ${o}`)}}function h(e,t){const n=document.querySelector(e);n&&(n.addEventListener("click",o=>{o.preventDefault(),t()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function Ye(){try{const e=window.__lastAnalyzed||"",t=(O($.proposed)?.value||"").trim();if(!t){y("No draft to diff");return}const n=await ke(e,t),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",s=document.getElementById("diffOutput"),c=document.getElementById("diffContainer");s&&c&&(s.innerHTML=o||"",c.style.display=o?"block":"none")}catch(e){y("Diff failed"),console.error(e)}}async function Ge(){try{const e=window.__last||{},t=e["gpt-draft"]?.json?.ops||e.suggest?.json?.ops||[];if(!t.length){y("No ops to apply");return}await ue(t),I("Applied ops")}catch(e){y("Insert failed"),console.error(e)}}async function Xe(){try{const t=(O($.proposed)?.value||"").trim();if(!t){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),s=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async c=>{const a=c.document.getSelection();c.document.trackRevisions=!0,a.insertText(t,Word.InsertLocation.replace);try{a.insertComment(s)}catch{}await c.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(e){window.toast?.("Accept failed"),L(e,"insertDraft"),console.error(e)}}async function Ze(){try{const e=O($.proposed);e&&(e.value="",e.dispatchEvent(new Event("input",{bubbles:!0})),k("")),await Word.run(async t=>{const o=t.document.getSelection().revisions;o.load("items"),await t.sync(),(o.items||[]).forEach(s=>{try{s.reject()}catch{}}),await t.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(e){window.toast?.("Reject failed"),L(e,"insertDraft"),console.error(e)}}function pe(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const a=$e.filter(r=>!document.getElementById(r));if(a.length){console.error("[PANEL] wireUI missing IDs:",a);const r=`FATAL: panel template mismatch (missing: ${a.join(", ")}). Check build pipeline.`;try{const i=document.createElement?document.createElement("div"):null;i&&(i.textContent=r,i.style.padding="12px",i.style.color="#f66",document.body.innerHTML="",document.body.appendChild(i))}catch{}console.error(r);return}}const e=ee(),t=a=>{const r=document.getElementById(a);r&&(r.disabled=!0,r.title="Not supported")};h("#btnUseWholeDoc",qe);const n=document.getElementById("btnUseWholeDoc");if(n&&(n.disabled=!1),se==="dev")h("#btnTest",ge);else{const a=document.getElementById("btnTest");a&&(a.style.display="none")}h("#btnQARecheck",Qe),document.getElementById("btnSuggestEdit")?.addEventListener("click",Je),h("#btnApplyTracked",Ge),h("#btnAcceptAll",Xe),h("#btnRejectAll",Ze),h("#btnPrevIssue",Me),h("#btnNextIssue",je),h("#btnPreviewDiff",Ye),h("#btnClearAnnots",We),h("#btnSave",De);const o=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");o?(o.checked=q(),o.addEventListener("change",()=>Fe(!!o.checked))):q();const s=document.getElementById("btnAnnotate");s&&(s.addEventListener("click",async()=>{if(!s.disabled){s.disabled=!0;try{const a=window.__last?.analyze?.json||{},r=globalThis.parseFindings(a);await globalThis.annotateFindingsIntoWord(r)}finally{s.disabled=!1}}}),s.classList.remove("js-disable-while-busy"),s.removeAttribute("disabled")),k(""),Ke(),console.log("Panel UI wired");const c=document.getElementById("btnAnalyze");if(c&&(c.disabled=!0),K(),P(),e.revisions||(t("btnApplyTracked"),t("btnAcceptAll"),t("btnRejectAll")),e.comments||t("btnAcceptAll"),e.search||(t("btnPrevIssue"),t("btnNextIssue"),t("btnQARecheck")),e.contentControls||t("btnAnnotate"),!e.revisions||!e.comments||!e.search||!e.contentControls)try{J("Word ⚠")}catch{}}g.wireUI=g.wireUI||pe;function k(e){const t=!!e.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),s=document.getElementById("btnRejectAll"),c=document.getElementById("btnPreviewDiff"),a=document.getElementById("draftPane"),r=document.getElementById("draftText");r&&(r.value=e),a&&(a.style.display=t?"":"none"),n&&(n.disabled=!t),o&&(o.disabled=!t),s&&(s.disabled=!t),c&&(c.disabled=!t)}async function et(e){console.log("[PANEL] bootstrap start"),Q()&&(console.log("reopen clean OK"),Se()),pe(),ve();try{await Le(ie())}catch{}try{await ge()}catch{}try{J(`${e?.host||Office.context?.host||"Word"} ✓`)}catch{J(null)}}let z=0;function tt(e){if(Q()&&(z=0),z>0){console.log(`bootstrap invoked x${z+1}`);return}z++,console.log("bootstrap invoked x1"),et(e)}if(!globalThis.__CAI_TESTING__){const e=()=>Office.onReady(t=>tt(t));document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()}})();
