(function(){"use strict";const O="cai-comment-on-analyze";function Tt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",""),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version","1.4"),localStorage.getItem(O)===null&&localStorage.setItem(O,"1")}catch{}}Tt();function D(){try{return localStorage.getItem("api_key")||""}catch{return""}}function tt(t){try{localStorage.setItem("api_key",t)}catch{}}function x(){try{return localStorage.getItem("schema_version")||"1.4"}catch{return"1.4"}}function F(t){try{localStorage.setItem("schema_version",t)}catch{}}function kt(){try{const t=localStorage.getItem(O);return t===null?(localStorage.setItem(O,"1"),!0):t!=="0"}catch{return!0}}function Ct(t){try{localStorage.setItem(O,t?"1":"0")}catch{}}const I=typeof globalThis<"u"?globalThis:window;I.CAI=I.CAI||{},I.CAI.Store=I.CAI.Store||{},I.CAI.Store.setApiKey=tt,I.CAI.Store.setSchemaVersion=F,I.CAI.Store.get=()=>({apiKey:D(),schemaVersion:x()}),I.CAI.Store.DEFAULT_BASE=I.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const E=window;E.__cai_pending_fetches=E.__cai_pending_fetches||new Set,E.__cai_pending_timers=E.__cai_pending_timers||new Set;const W=E.__cai_pending_fetches,U=E.__cai_pending_timers,B={count:0};function xt(){B.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:B.count}}))}function Bt(){B.count=Math.max(0,B.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:B.count>0,count:B.count}}))}async function L(t){try{return xt(),await t()}finally{Bt()}}function Lt(t){W.add(t)}function $t(t){W.delete(t)}function Ot(t){U.add(t)}function Ft(t){U.delete(t)}function et(t){W.forEach(e=>{try{e.abort(t)}catch{}}),W.clear(),U.forEach(e=>{try{clearTimeout(e),clearInterval(e)}catch{}}),U.clear();try{document.querySelectorAll(".progress").forEach(e=>{e.style.display="none"})}catch{}}function zt(){if(E.__pendingUnloadReg)return;E.__pendingUnloadReg=!0;const t=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),e=()=>{t&&et("pagehide/unload"),E.__wasUnloaded=!0};window.addEventListener("pagehide",e),window.addEventListener("unload",e),window.addEventListener("beforeunload",e),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&et("visibilitychange")})}function nt(){return!!E.__wasUnloaded}function Nt(){E.__wasUnloaded=!1}let q=null;async function ot(t={}){if(!q){const e=(t.backend||"").replace(/\/+$/,""),n=e?`${e}/health`:"/health",o=new AbortController,s=t.timeoutMs??9e3,i=setTimeout(()=>o.abort("timeout"),s);q=fetch(n,{signal:o.signal}).then(async d=>{clearTimeout(i);const l=await d.json().catch(()=>({}));return{ok:d.ok,json:l,resp:d}})}return q}function st(t){const e=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(e)?e.filter(Boolean):[]}window.parseFindings=st;function at(t){const e=(n,o)=>{const s=document.getElementById(n);s&&(s.textContent=o&&o.length?o:"—")};e("status",t.status),e("cid",t.cid),e("xcache",t.xcache),e("latency",t.latencyMs),e("schema",t.schema),e("provider",t.provider),e("model",t.model),e("mode",t.llm_mode),e("usage",t.usage)}const it="https://localhost:9443";function Mt(){try{return(localStorage.getItem("backendUrl")||it).replace(/\/+$/,"")}catch{return it}}const Y=9e3,Rt=60,Dt=9e4,Wt=1,Ut=3e3;async function z(t,e,n){return L(async()=>{const o=Mt()+t,s={"Content-Type":"application/json"},i=x()||"1.4";s["x-schema-version"]=i;const d=D();d&&(s["x-api-key"]=d);const l=JSON.stringify(e||{}),c=new TextEncoder().encode(l).length;let u=n,m=Wt,g=Ut;if(t==="/api/analyze"){if(u==null){const r=Y+Rt*(c/1024);u=Math.max(Y,Math.min(Dt,Math.floor(r)))}try{for(const r of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const f=localStorage.getItem(r);if(f){const y=parseInt(f,10);if(Number.isFinite(y)){u=y;break}}}}catch{}try{const r=localStorage.getItem("cai.retry.analyze.count");r&&(m=parseInt(r,10))}catch{}try{const r=localStorage.getItem("cai.retry.analyze.backoff.ms");r&&(g=parseInt(r,10))}catch{}try{const r=new URLSearchParams(location.search),f=r.get("ta");f&&(u=parseInt(f,10));const y=r.get("rac");y&&(m=parseInt(y,10));const _=r.get("rb");_&&(g=parseInt(_,10))}catch{}}u=u??Y;async function a(r){const f=new AbortController,y=setTimeout(()=>f.abort(`timeout ${u}ms`),u);Lt(f),Ot(y);try{const _=await fetch(o,{method:"POST",headers:s,body:l,credentials:"include",signal:f.signal}),S=await _.json().catch(()=>({}));return t==="/api/analyze"&&(_.status===504||_.status>=500)&&r<m?(await new Promise(w=>setTimeout(w,g)),a(r+1)):{resp:_,json:S}}catch(_){if(t==="/api/analyze"&&_?.name==="AbortError"){const S=f.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${S}`),r<m&&String(S).startsWith("timeout"))return await new Promise(w=>setTimeout(w,g)),a(r+1);throw new DOMException(S,"AbortError")}throw _}finally{clearTimeout(y),Ft(y),$t(f)}}return a(0)})}window.postJson=z;async function Pt(t,e){return z("/api/panel/redlines",{before_text:t,after_text:e})}const Ht={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function v(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function P(t){const e=(t||"").toLowerCase();return e==="high"?3:e==="medium"?2:1}function jt(t){const e=new Map;let n=0,o=0;for(const i of t||[]){const d=v(i.snippet||""),l=typeof i.start=="number"?i.start:void 0,c=typeof i.end=="number"?i.end:l!==void 0?l+d.length:void 0;if(typeof l!="number"||typeof c!="number"||c<=l||c-l>1e4){n++;continue}const u=`${i.rule_id||""}|${l}|${c}|${d}`,m=e.get(u);!m||P(i.severity)>P(m.severity)?e.set(u,{...i,snippet:d,start:l,end:c}):o++}const s=Array.from(e.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),s}function Kt(){const t=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),e=globalThis.Word||{},n=t&&!!e?.Revision,o=t&&!!e?.Comment,s=t&&!!e?.SearchOptions,i=t&&!!e?.ContentControl;return{revisions:n,comments:o,search:s,contentControls:i}}function ct(){const t=Kt();try{console.log("support matrix",t)}catch{}return t}async function qt(t){const e=[];["btnAnalyze","selectRiskThreshold"].forEach(m=>{document.getElementById(m)||e.push(`missingID:${m}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||e.push("req1.4:0");const n=ct(),o={revisions:n.revisions?1:0,comments:n.comments?1:0,search:n.search?1:0,contentControls:n.contentControls?1:0};let s=!1;try{s=(await ot({backend:t})).ok,s||e.push("health")}catch{e.push("health:timeout")}const i="build-20250914-083340",d=Office?.context?.host||"Word",l=e.length===0,c=l?`Startup OK | build=${i} | host=${d} | req=1.4 | features=${JSON.stringify(o)} | backend=${t}`:`Startup FAIL: ${e.join("; ")}`;console.log(c);const u=document.getElementById("startupBadge");return u&&(u.textContent=l?"OK":"FAIL",u.setAttribute("data-status",l?"ok":"fail")),{ok:l,missing:e,features:o}}function T(t){try{console.log("[OK]",t)}catch{}}function rt(t){try{console.error("[ERR]",t)}catch{}}function h(t){try{console.warn("[WARN]",t)}catch{}}async function H(){return await Word.run(async t=>{const e=t.document.body;return e.load("text"),await t.sync(),(e.text||"").trim()})}var lt={};const J=globalThis,V=J.OfficeExtension,dt="build-20250914-083340";console.log("ContractAI build",dt);let ut=null,ft="1",mt="1";try{ut=localStorage.getItem("cai_timeout_ms:analyze"),ft=localStorage.getItem("cai_abort_on_hidden")||"1",mt=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:ut,abort_on_hidden:ft,abort_on_navigation:mt}),!dt.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const t=document.createElement("div");t.textContent="FATAL: stale bundle",t.style.padding="12px",t.style.color="#f66",document.body.innerHTML="",document.body.appendChild(t),document.querySelectorAll("button").forEach(e=>{e.disabled=!0})}catch{}});const gt=(()=>{const t=J.ENV_MODE||(typeof process<"u"?lt?.ENV_MODE:void 0);return t?t==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();V&&V.config&&(gt==="dev"||J.__ENABLE_EXTENDED_LOGS__)&&(V.config.extendedErrorLogging=!0);function N(t,e="Word"){try{const n=t&&t.debugInfo||{};console.error(`[${e}] RichApi error`,{code:t.code,message:t.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function yt(t){return(st(t)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const p=globalThis;p.parseFindings=p.parseFindings||yt,p.applyMetaToBadges=p.applyMetaToBadges||at,p.getApiKeyFromStore=p.getApiKeyFromStore||D,p.getSchemaFromStore=p.getSchemaFromStore||x,p.logRichError=p.logRichError||N,p.getWholeDocText=p.getWholeDocText||H;const M={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let j="",pt=!1;const Yt=Ht.required_ids||[];function Q(t,e){const n=document.getElementById("status-chip");if(!n)return;const o=(t??x())||"—",s=(e??j)||"—";n.textContent=`schema: ${o} | cid: ${s}`}function Jt(){if(pt)return;b("#btnAnalyze",re);const t=document.getElementById("btnAnalyze");t&&(t.disabled=!1),pt=!0,console.log("[PANEL] analyze enabled")}function ht(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function Vt(){const e=document.getElementById("backendUrl")?.value?.trim();if(e)try{localStorage.setItem("backend.url",e),localStorage.setItem("backendUrl",e)}catch{}location.reload()}function G(){try{let t=D(),e=x();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",s=o==="localhost"||o==="127.0.0.1";if(s&&(t||(t="local-test-key-123",tt(t)),!e)){const i=globalThis?.SCHEMA_VERSION||typeof process<"u"&&lt?.SCHEMA_VERSION||"1.4";e=String(i),F(e)}n&&(!t&&!e&&!s?n.style.display="":n.style.display="none"),(!t||!e)&&console.warn("missing headers",{apiKey:!!t,schema:!!e})}catch{}return!0}function k(t,e){return document.querySelector(`[data-role="${e}"]`)||document.getElementById(t)}function _t(){const e=document.getElementById("selectRiskThreshold")?.value?.toLowerCase();return e==="low"||e==="medium"||e==="high"?e:"medium"}function Z(){const t=kt();try{const e=globalThis.document,n=e?.getElementById("cai-comment-on-analyze")||e?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=t),n?!!n.checked:t}catch{return t}}function Qt(t){Ct(t)}function bt(t,e){const n=P(e);return(t||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>P(o.severity)>=n)}function Gt(t){if(!t||!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const e=(t.severity||"info").toUpperCase(),n=t.rule_id,o=t.clause_type?` (${t.clause_type})`:"",s=t.advice||"—",i=Array.isArray(t.law_refs)&&t.law_refs.length?t.law_refs.join("; "):"—",d=Array.isArray(t.conflict_with)&&t.conflict_with.length?t.conflict_with.join("; "):"—",l=t.suggestion?.text||"—",c=Array.isArray(t.citations)&&t.citations.length?`
Citations: ${t.citations.join("; ")}`:"";return`[${e}] ${n}${o}
Reason: ${s}
Law: ${i}
Conflict: ${d}${c}
Suggested fix: ${l}`}function wt(t,e,n){if(!e)return 0;let o=-1,s=0;const i=typeof n=="number"?Math.max(0,n):Number.MAX_SAFE_INTEGER;for(;(o=t.indexOf(e,o+1))!==-1&&o<i;)s++;return s}async function Zt(t){return L(async()=>{const e=document.getElementById("cai-dry-run-annotate");function n(){return e?!!e.checked:!!document.getElementById("cai-dry-run-annotate")?.checked}const o=v(window.__lastAnalyzed||""),s=jt(t||[]),i=s.slice().sort((a,r)=>(r.end??0)-(a.end??0)),d=[];let l=Number.POSITIVE_INFINITY,c=0;for(const a of i){if(!a||!a.rule_id||!a.snippet){c++;continue}const r=a.snippet,f=typeof a.end=="number"?a.end:typeof a.start=="number"?a.start+r.length:void 0;if(typeof f=="number"&&f>l){c++;continue}d.push(a),typeof a.start=="number"&&(l=a.start)}c&&h(`Skipped ${c} overlaps/invalid`),T(`Will insert: ${d.length}`);const u=d.map(a=>{const r=a.snippet||"",f=v(r),y=wt(o,f,a.start);return{raw:r,norm:f,msg:Gt(a),rule_id:a.rule_id,occIdx:y,normalized_fallback:v(a.normalized_snippet||"")}}),m={matchCase:!1,matchWholeWord:!1};let g=0;for(const a of u)await Word.run(async r=>{const f=r.document.body;let y=null;const _=f.search(a.raw,m);_.load("items"),await r.sync();const S=(w,A)=>{const C=w?.items||[];return C.length&&C[Math.min(Math.max(A,0),C.length-1)]||null};if(y=S(_,a.occIdx),!y){const w=a.normalized_fallback&&a.normalized_fallback!==a.norm?a.normalized_fallback:a.norm;if(w&&w.trim()){const A=f.search(w,m);A.load("items"),await r.sync(),y=S(A,a.occIdx)}}if(!y){const w=(()=>{const A=a.raw.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(C=>C.length>=12);return A.length?A.sort((C,pe)=>pe.length-C.length)[0].slice(0,64):null})();if(w){const A=f.search(w,m);A.load("items"),await r.sync(),y=S(A,0)}}if(y){if(n())try{y.select()}catch{}else a.msg&&y.insertComment(a.msg);g++}else console.warn("[annotate] no match for snippet",{rid:a.rule_id,snippet:a.raw.slice(0,120)});await r.sync()}).catch(r=>{N(r,"annotate"),console.warn("annotate run fail",r?.code,r?.message,r?.debugInfo)});return console.log("panel:annotate",{total:t.length,deduped:s.length,skipped_overlaps:c,will_annotate:d.length,inserted:g}),g})}p.annotateFindingsIntoWord=p.annotateFindingsIntoWord||Zt;async function Xt(){try{await Word.run(async t=>{const e=t.document.body,n=t.document.comments;n.load("items"),await t.sync();for(const o of n.items)try{o.delete()}catch{}try{e.font.highlightColor="NoColor"}catch{}await t.sync()}),T("Annotations cleared")}catch(t){N(t,"annotate"),h("Failed to clear annotations")}}async function Et(t){return L(async()=>{let e=(t||[]).filter(s=>typeof s.start=="number"&&typeof s.end=="number"&&s.end>s.start).sort((s,i)=>s.start-i.start),n=-1;if(e=e.filter(s=>s.start<n?!1:(n=s.end,!0)),!e.length)return;const o=window.__lastAnalyzed||"";await Word.run(async s=>{const i=s.document.body;s.document.trackRevisions=!0;const d={matchCase:!1,matchWholeWord:!1},l=(c,u)=>{const m=c?.items||[];return m.length&&m[Math.min(Math.max(u,0),m.length-1)]||null};for(const c of e){const u=o.slice(c.start,c.end),m=(()=>{let a=-1,r=0;for(;(a=o.indexOf(u,a+1))!==-1&&a<c.start;)r++;return r})();let g=null;if(c.context_before||c.context_after){const a=`${c.context_before||""}${u}${c.context_after||""}`,r=i.search(a,d);r.load("items"),await s.sync();const f=l(r,m);if(f){const y=f.search(u,d);y.load("items"),await s.sync(),g=l(y,0)}}if(!g){const a=i.search(u,d);a.load("items"),await s.sync(),g=l(a,m)}if(!g){const a=(()=>{const r=u.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(f=>f.length>=12);return r.length?r.sort((f,y)=>y.length-f.length)[0].slice(0,64):null})();if(a){const r=i.search(a,d);r.load("items"),await s.sync(),g=l(r,0)}}if(g){g.insertText(c.replacement,"Replace");const a=c.rationale||c.source||"AI edit";try{g.insertComment(a)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:u,occIdx:m});await s.sync()}})})}p.applyOpsTracked=p.applyOpsTracked||Et;async function te(t){const e=v(window.__lastAnalyzed||""),n=t?.snippet||"",o=v(n),s=wt(e,o,t.start),i={matchCase:!1,matchWholeWord:!1};await Word.run(async d=>{const l=d.document.body;let c=null;const u=(g,a)=>{const r=g?.items||[];return r.length&&r[Math.min(Math.max(a,0),r.length-1)]||null},m=l.search(n,i);if(m.load("items"),await d.sync(),c=u(m,s),!c){const g=t.normalized_snippet&&t.normalized_snippet!==o?t.normalized_snippet:o;if(g&&g.trim()){const a=l.search(g,i);a.load("items"),await d.sync(),c=u(a,s)}}if(!c){const g=(()=>{const a=n.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(r=>r.length>=12);return a.length?a.sort((r,f)=>f.length-r.length)[0].slice(0,64):null})();if(g){const a=l.search(g,i);a.load("items"),await d.sync(),c=u(a,0)}}if(c)try{c.select()}catch{}await d.sync()})}async function At(t){const e=window.__findings||[];if(!e.length)return;const n=window;n.__findingIdx=(n.__findingIdx??0)+t,n.__findingIdx<0&&(n.__findingIdx=e.length-1),n.__findingIdx>=e.length&&(n.__findingIdx=0);const o=document.getElementById("findingsList");if(o){const s=Array.from(o.querySelectorAll("li"));s.forEach((d,l)=>{d.classList.toggle("active",l===n.__findingIdx)});const i=s[n.__findingIdx];i&&i.scrollIntoView({block:"nearest"})}try{await te(e[n.__findingIdx])}catch{}}function ee(){At(-1)}function ne(){At(1)}function oe(t){const e=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",n=Array.isArray(t?.findings)?t.findings:[],o=Array.isArray(t?.recommendations)?t.recommendations:[],s=_t(),d=bt(n,s).length,l=n.length-d,c=(a,r)=>{const f=document.getElementById(a);f&&(f.textContent=r)};c("clauseTypeOut",String(e)),c("resFindingsCount",String(n.length)),c("visibleHiddenOut",`${d} / ${l}`);const u=document.getElementById("findingsList");if(u){u.innerHTML="";for(const a of n){const r=document.createElement("li"),f=a?.title||a?.finding?.title||a?.rule_id||"Issue",y=a?.snippet||a?.evidence?.text||"";r.textContent=y?`${f}: ${y}`:String(f),u.appendChild(r)}}const m=document.getElementById("recsList");if(m){m.innerHTML="";for(const a of o){const r=document.createElement("li");r.textContent=a?.text||a?.advice||a?.message||"Recommendation",m.appendChild(r)}}const g=document.getElementById("resultsBlock");g&&g.style.removeProperty("display")}function se(t){const e=k("resClauseType","clause-type");e&&(e.textContent=t?.clause_type||"—");const n=yt(t);window.__findings=n,window.__findingIdx=0;const o=k("findingsList","findings");o&&(o.innerHTML="",n.forEach(c=>{const u=document.createElement("li");u.textContent=typeof c=="string"?c:JSON.stringify(c),o.appendChild(u)}));const s=Array.isArray(t?.recommendations)?t.recommendations:[],i=k("recoList","recommendations");i&&(i.innerHTML="",s.forEach(c=>{const u=document.createElement("li");u.textContent=typeof c=="string"?c:JSON.stringify(c),i.appendChild(u)}));const d=k("resFindingsCount","findings-count");d&&(d.textContent=String(n.length));const l=k("rawJson","raw-json");l&&(l.textContent=JSON.stringify(t??{},null,2))}function ae(){const t=k("toggleRaw","toggle-raw-json"),e=k("rawJson","raw-json");t&&e&&(e.style.display="none",t.addEventListener("click",()=>{e.style.display=e.style.display==="none"?"block":"none"}))}function It(t){const e=document.getElementById("connBadge");e&&(e.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`)}function X(t){const e=document.getElementById("officeBadge");e&&(e.textContent=`Office: ${t??"—"}`)}function R(t){return document.querySelector(t)}async function ie(){const t=R(M.original),e=await H(),n=v(e||"");if(t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const o=document.getElementById("originalText");if(o&&o!==t){o.value=n;try{o.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function ce(t){return L(async()=>{try{const e=R(M.proposed);if(!(window.__lastAnalyzed||v(await H()))){h("No document text");return}const o=window.__findings||[],s=window.__findingIdx??0,i=o[s];if(!i){h("No active finding");return}const d=i.snippet||"",{json:l}=await z("/api/gpt-draft",{cid:j,clause:d,mode:"friendly"}),c=(l?.proposed_text??l?.text??"").toString(),u=window;u.__last=u.__last||{},u.__last["gpt-draft"]={json:l},e?(e.id||(e.id="draftText"),e.name||(e.name="proposed"),e.dataset.role="proposed-text",e.value=c,e.dispatchEvent(new Event("input",{bubbles:!0})),T("Draft ready"),$(c)):(h("Proposed textarea not found"),$(""))}catch(e){h("Draft error"),console.error(e),$("")}})}async function vt(){try{const t=x(),{resp:e,json:n,ok:o}=await ot({backend:ht()}),s=e.headers.get("x-schema-version")||n?.schema||null;if(s&&(F(s),s!==t&&console.log(`schema: ${s} (synced)`)),It(o),o){console.log("[PANEL] health ok"),Jt(),Q(s,null);try{at({cid:null,xcache:null,latencyMs:null,schema:s||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}T(`Health: ${n?.status||"ok"}${s?` (schema ${s})`:""}`)}else h("Health failed")}catch(t){It(!1),h("Health failed"),console.error(t)}}async function re(){return L(async()=>{const t=document.getElementById("btnAnalyze"),e=document.getElementById("busyBar");t&&(t.disabled=!0),e&&(e.style.display="");try{$("");const n=window.__lastAnalyzed,o=n&&n.trim()?n:v(await globalThis.getWholeDocText());if(!o){rt("В документе нет текста");return}G(),window.__lastAnalyzed=o;const s=document.getElementById("originalText");s&&(s.value=o);const{resp:i,json:d}=await z("/api/analyze",{text:o});if(!i.ok)throw new Error(`HTTP ${i.status}`);const l=i.headers.get("x-schema-version");l&&F(l),d?.schema&&F(d.schema),j=i.headers.get("x-cid")||"",Q(null,j),se(d),oe(d);try{localStorage.setItem("last_analysis_json",JSON.stringify(d))}catch{}try{const c=globalThis.parseFindings(d),u=_t(),m=bt(c,u);Z()&&m.length&&await globalThis.annotateFindingsIntoWord(m)}catch(c){console.warn("auto-annotate after analyze failed",c)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:d})),T("Analyze OK")}catch(n){let o="";if(n?.name==="AbortError"){const s=n?.message||"";if(s.startsWith("timeout")){const i=parseInt(s.replace(/[^0-9]/g,""),10)||0;o=`(timeout ${Math.round(i/1e3)} s)`}else s==="pagehide/unload"?o="(aborted by pagehide)":o="(aborted)"}else typeof n?.message=="string"&&(n.message.includes("HTTP 504")?o="(HTTP 504)":n.message.includes("HTTP 413")?o="(payload too large 413)":n.message.includes("HTTP 401")?o="(unauthorized 401)":n.message.includes("HTTP 403")?o="(forbidden 403)":n.message.includes("HTTP 422")&&(o="(schema mismatch 422)"));h(`Analyze failed ${o}`.trim()),console.error(n)}finally{t&&(t.disabled=!1),e&&(e.style.display="none")}})}async function le(){return L(async()=>{G();const t=await H(),{json:e}=await z("/api/qa-recheck",{text:t,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:e})),!e?.error)T("QA recheck OK");else{const o=e?.error||e?.message||"unknown";rt(`QA recheck failed: ${o}`)}})}function b(t,e){const n=document.querySelector(t);n&&(n.addEventListener("click",o=>{o.preventDefault(),e()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function de(){try{const t=window.__lastAnalyzed||"",e=(R(M.proposed)?.value||"").trim();if(!e){h("No draft to diff");return}const n=await Pt(t,e),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",s=document.getElementById("diffOutput"),i=document.getElementById("diffContainer");s&&i&&(s.innerHTML=o||"",i.style.display=o?"block":"none")}catch(t){h("Diff failed"),console.error(t)}}async function ue(){try{const t=window.__last||{},e=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!e.length){h("No ops to apply");return}await Et(e),T("Applied ops")}catch(t){h("Insert failed"),console.error(t)}}async function fe(){try{const e=(R(M.proposed)?.value||"").trim();if(!e){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),s=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async i=>{const d=i.document.getSelection();i.document.trackRevisions=!0,d.insertText(e,Word.InsertLocation.replace);try{d.insertComment(s)}catch{}await i.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),N(t,"insertDraft"),console.error(t)}}async function me(){try{const t=R(M.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),$("")),await Word.run(async e=>{const o=e.document.getSelection().revisions;o.load("items"),await e.sync(),(o.items||[]).forEach(s=>{try{s.reject()}catch{}}),await e.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),N(t,"insertDraft"),console.error(t)}}function St(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const l=Yt.filter(c=>!document.getElementById(c));if(l.length){console.error("[PANEL] wireUI missing IDs:",l);const c=`FATAL: panel template mismatch (missing: ${l.join(", ")}). Check build pipeline.`;try{const u=document.createElement?document.createElement("div"):null;u&&(u.textContent=c,u.style.padding="12px",u.style.color="#f66",document.body.innerHTML="",document.body.appendChild(u))}catch{}console.error(c);return}}const t=document.getElementById("loading-book");window.addEventListener("cai:busy",l=>{if(!t)return;!!l?.detail?.busy?t.classList.remove("hidden"):t.classList.add("hidden")});const e=ct(),n=l=>{const c=document.getElementById(l);c&&(c.disabled=!0,c.title="Not supported")};b("#btnUseWholeDoc",ie);const o=document.getElementById("btnUseWholeDoc");if(o&&(o.disabled=!1),gt==="dev")b("#btnTest",vt);else{const l=document.getElementById("btnTest");l&&(l.style.display="none")}b("#btnQARecheck",le),document.getElementById("btnSuggestEdit")?.addEventListener("click",ce),b("#btnApplyTracked",ue),b("#btnAcceptAll",fe),b("#btnRejectAll",me),b("#btnPrevIssue",ee),b("#btnNextIssue",ne),b("#btnPreviewDiff",de),b("#btnClearAnnots",Xt),b("#btnSave",Vt);const s=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");s?(s.checked=Z(),s.addEventListener("change",()=>Qt(!!s.checked))):Z();const i=document.getElementById("btnAnnotate");i&&(i.addEventListener("click",async()=>{if(!i.disabled){i.disabled=!0;try{const l=window.__last?.analyze?.json||{},c=globalThis.parseFindings(l);await globalThis.annotateFindingsIntoWord(c)}finally{i.disabled=!1}}}),i.classList.remove("js-disable-while-busy"),i.removeAttribute("disabled")),$(""),ae(),console.log("Panel UI wired");const d=document.getElementById("btnAnalyze");if(d&&(d.disabled=!0),G(),Q(),e.revisions||(n("btnApplyTracked"),n("btnAcceptAll"),n("btnRejectAll")),e.comments||n("btnAcceptAll"),e.search||(n("btnPrevIssue"),n("btnNextIssue"),n("btnQARecheck")),e.contentControls||n("btnAnnotate"),!e.revisions||!e.comments||!e.search||!e.contentControls)try{X("Word ⚠")}catch{}}p.wireUI=p.wireUI||St;function $(t){const e=!!t.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),s=document.getElementById("btnRejectAll"),i=document.getElementById("btnPreviewDiff"),d=document.getElementById("draftPane"),l=document.getElementById("draftText");l&&(l.value=t),d&&(d.style.display=e?"":"none"),n&&(n.disabled=!e),o&&(o.disabled=!e),s&&(s.disabled=!e),i&&(i.disabled=!e)}async function ge(t){console.log("[PANEL] bootstrap start"),nt()&&(console.log("reopen clean OK"),Nt()),St(),zt();try{await qt(ht())}catch{}try{await vt()}catch{}try{X(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{X(null)}}let K=0;function ye(t){if(nt()&&(K=0),K>0){console.log(`bootstrap invoked x${K+1}`);return}K++,console.log("bootstrap invoked x1"),ge(t)}if(!globalThis.__CAI_TESTING__){const t=()=>Office.onReady(e=>ye(e));document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}})();
