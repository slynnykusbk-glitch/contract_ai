(function(){"use strict";var K=typeof document<"u"?document.currentScript:null;const q="",V="1.4",C="cai-comment-on-analyze";function Lt(){try{localStorage.getItem("api_key")===null&&localStorage.setItem("api_key",q),localStorage.getItem("schema_version")===null&&localStorage.setItem("schema_version",V),localStorage.getItem(C)===null&&localStorage.setItem(C,"1")}catch{}}Lt();function M(){try{return localStorage.getItem("api_key")||q}catch{return q}}function st(t){try{localStorage.setItem("api_key",t)}catch{}}function S(){try{return localStorage.getItem("schema_version")||V}catch{return V}}function B(t){try{localStorage.setItem("schema_version",t)}catch{}}function Ot(){try{const t=localStorage.getItem(C);return t===null?(localStorage.setItem(C,"1"),!0):t!=="0"}catch{return!0}}function $t(t){try{localStorage.setItem(C,t?"1":"0")}catch{}}const E=typeof globalThis<"u"?globalThis:window;E.CAI=E.CAI||{},E.CAI.Store=E.CAI.Store||{},E.CAI.Store.setApiKey=st,E.CAI.Store.setSchemaVersion=B,E.CAI.Store.get=()=>({apiKey:M(),schemaVersion:S()}),E.CAI.Store.DEFAULT_BASE=E.CAI.Store.DEFAULT_BASE||"https://localhost:9443";const _=window;_.__cai_pending_fetches=_.__cai_pending_fetches||new Set,_.__cai_pending_timers=_.__cai_pending_timers||new Set;const N=_.__cai_pending_fetches,F=_.__cai_pending_timers,T={count:0};function Rt(){T.count++,window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:!0,count:T.count}}))}function zt(){T.count=Math.max(0,T.count-1),window.dispatchEvent(new CustomEvent("cai:busy",{detail:{busy:T.count>0,count:T.count}}))}async function L(t){try{return Rt(),await t()}finally{zt()}}function Mt(t){N.add(t)}function Nt(t){N.delete(t)}function Ft(t){F.add(t)}function Wt(t){F.delete(t)}function at(t){N.forEach(e=>{try{e.abort(t)}catch{}}),N.clear(),F.forEach(e=>{try{clearTimeout(e),clearInterval(e)}catch{}}),F.clear();try{document.querySelectorAll(".progress").forEach(e=>{e.style.display="none"})}catch{}}function Dt(){if(_.__pendingUnloadReg)return;_.__pendingUnloadReg=!0;const t=(()=>{try{return localStorage.getItem("cai_abort_on_navigation")!=="0"}catch{return!0}})(),e=()=>{t&&at("pagehide/unload"),_.__wasUnloaded=!0};window.addEventListener("pagehide",e),window.addEventListener("unload",e),window.addEventListener("beforeunload",e),(()=>{try{return localStorage.getItem("cai_abort_on_hidden")!=="0"}catch{return!0}})()&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&at("visibilitychange")})}function ct(){return!!_.__wasUnloaded}function Ut(){_.__wasUnloaded=!1}let Y=null;async function it(t={}){if(!Y){const e=(t.backend||"").replace(/\/+$/,""),n=e?`${e}/health`:"/health",o=new AbortController,s=t.timeoutMs??9e3,r=setTimeout(()=>o.abort("timeout"),s);Y=fetch(n,{signal:o.signal}).then(async l=>{clearTimeout(r);const c=await l.json().catch(()=>({}));return{ok:l.ok,json:c,resp:l}})}return Y}function x(t){try{console.log("[OK]",t)}catch{}}function rt(t){try{console.error("[ERR]",t)}catch{}}function p(t){try{console.warn("[WARN]",t)}catch{}}function lt(t){const e=t?.analysis?.findings??t?.findings??t?.issues??[];return Array.isArray(e)?e.filter(Boolean):[]}window.parseFindings=lt;function jt(t){const e=t.headers,n=t.json||{},o=n.llm||n;return{cid:e.get("x-cid"),xcache:e.get("x-cache"),latencyMs:e.get("x-latency-ms"),schema:e.get("x-schema-version"),provider:e.get("x-provider")||o.provider||n.provider||null,model:e.get("x-model")||o.model||n.model||null,llm_mode:e.get("x-llm-mode")||o.mode||n.mode||null,usage:e.get("x-usage-total"),status:t.status!=null?String(t.status):null}}function J(t){const e=(n,o)=>{const s=document.getElementById(n);s&&(s.textContent=o&&o.length?o:"—")};e("status",t.status),e("cid",t.cid),e("xcache",t.xcache),e("latency",t.latencyMs),e("schema",t.schema),e("provider",t.provider),e("model",t.model),e("mode",t.llm_mode),e("usage",t.usage)}async function Pt(){const t=new URL(K&&K.tagName.toUpperCase()==="SCRIPT"&&K.src||new URL("taskpane.bundle.js",document.baseURI).href).toString();try{const n=await(await fetch(t)).text(),o=new TextEncoder().encode(n),s=await crypto.subtle.digest("SHA-256",o),r=Array.from(new Uint8Array(s)).slice(0,4).map(l=>l.toString(16).padStart(2,"0")).join("");console.log(`[selftest] api-client.js ${r} ${t}`)}catch{console.log(`[selftest] api-client.js fail ${t}`)}}const dt="https://localhost:9443";function Ht(){try{return(localStorage.getItem("backendUrl")||dt).replace(/\/+$/,"")}catch{return dt}}const Q=9e3,Kt=60,qt=9e4,Vt=1,Yt=3e3;async function O(t,e,n){return L(async()=>{const o=Ht()+t,s={"Content-Type":"application/json"},r=S()||"1.4";s["x-schema-version"]=r;const l=M();l&&(s["x-api-key"]=l);const c=JSON.stringify(e||{}),i=new TextEncoder().encode(c).length;let a=n,d=Vt,m=Yt;if(t==="/api/analyze"){if(a==null){const u=Q+Kt*(i/1024);a=Math.max(Q,Math.min(qt,Math.floor(u)))}try{for(const u of["cai.timeout.analyze.ms","cai_timeout_ms:/api/analyze","cai_timeout_ms:analyze"]){const g=localStorage.getItem(u);if(g){const h=parseInt(g,10);if(Number.isFinite(h)){a=h;break}}}}catch{}try{const u=localStorage.getItem("cai.retry.analyze.count");u&&(d=parseInt(u,10))}catch{}try{const u=localStorage.getItem("cai.retry.analyze.backoff.ms");u&&(m=parseInt(u,10))}catch{}try{const u=new URLSearchParams(location.search),g=u.get("ta");g&&(a=parseInt(g,10));const h=u.get("rac");h&&(d=parseInt(h,10));const w=u.get("rb");w&&(m=parseInt(w,10))}catch{}}a=a??Q;async function f(u){const g=new AbortController,h=setTimeout(()=>g.abort(`timeout ${a}ms`),a);Mt(g),Ft(h);try{const w=await fetch(o,{method:"POST",headers:s,body:c,credentials:"include",signal:g.signal}),A=await w.json().catch(()=>({}));if(w.status===422){console.warn("[analyze] 422",A.detail);const z=Array.isArray(A?.detail)?A.detail.map(ke=>ke.msg).join("; "):A?.detail;try{p(`Validation error: ${z}`)}catch{}}return t==="/api/analyze"&&(w.status===504||w.status>=500)&&u<d?(await new Promise(z=>setTimeout(z,m)),f(u+1)):{resp:w,json:A}}catch(w){if(t==="/api/analyze"&&w?.name==="AbortError"){const A=g.signal.reason||"aborted";if(console.log(`[NET] analyze aborted: ${A}`),u<d&&String(A).startsWith("timeout"))return await new Promise(z=>setTimeout(z,m)),f(u+1);throw new DOMException(A,"AbortError")}throw w}finally{clearTimeout(h),Wt(h),Nt(g)}}return f(0)})}window.postJson=O;async function Jt(t={}){const e={mode:t.mode??"live",schema:t.schema??"1.4"};t.text!=null&&(e.text=t.text);const{resp:n,json:o}=await O("/api/analyze",e),s=jt({headers:n.headers,json:o,status:n.status});try{J(s)}catch{}try{const r=window;r.__last||(r.__last={}),r.__last.analyze={status:n.status,req:{path:"/api/analyze",method:"POST",body:e},json:o}}catch{}return{ok:n.ok,json:o,resp:n,meta:s}}async function Qt(t,e){return O("/api/panel/redlines",{before_text:t,after_text:e})}const Zt={required_ids:["btnUseWholeDoc","btnAnalyze","originalText","results","busyBar","loading-book","officeBadge","connBadge"]};function I(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\u00A0/g," ").replace(/[ \t]+/g," ").trim():""}function W(t){const e=(t||"").toLowerCase();return e==="high"?3:e==="medium"?2:1}function Gt(t){const e=new Map;let n=0,o=0;for(const r of t||[]){const l=I(r.snippet||""),c=typeof r.start=="number"?r.start:void 0,i=typeof r.end=="number"?r.end:c!==void 0?c+l.length:void 0;if(typeof c!="number"||typeof i!="number"||i<=c||i-c>1e4){n++;continue}const a=`${r.rule_id||""}|${c}|${i}|${l}`,d=e.get(a);!d||W(r.severity)>W(d.severity)?e.set(a,{...r,snippet:l,start:c,end:i}):o++}const s=Array.from(e.values());return console.log("panel:annotate",`dedupe dropped ${n} invalid, ${o} duplicates`),s}async function D(t,e){const n=t.context,o={matchCase:!1,matchWholeWord:!1},s=i=>{const a=t.search(i,o);return a&&typeof a.load=="function"&&a.load("items"),a},r=s(e||"");await n.sync();let l=r?.items||[];if(!l.length){const i=I(e||""),a=s(i);await n.sync(),l=a?.items||[]}l.sort((i,a)=>{const d=i.start??0,m=a.start??0;if(d!==m)return d-m;const f=i.end??d,u=a.end??m;return f-u});const c=[];for(const i of l){const a=i.start??0,d=i.end??a,m=c[c.length-1];if(m&&a<(m.end??a)){const f=(m.end??0)-(m.start??0);d-a>f&&(c[c.length-1]=i);continue}c.push(i)}for(const i of c)try{n.trackedObjects?.add?.(i)}catch{}return c}function Xt(t,e,n){if(!t||!e)return 0;let o=-1,s=0;for(;(o=t.indexOf(e,o+1))!==-1&&o<(n??t.length);)s++;return s}function te(){try{return!!document.getElementById("cai-dry-run-annotate")?.checked}catch{return!1}}const ut="AI edit:";function ee(t){if(!t.rule_id||!t.snippet)return console.warn("buildLegalComment: missing required fields",t),"";const e=[t.rule_id];return t.advice&&e.push(t.advice),t.law_refs?.length&&e.push(t.law_refs.join("; ")),`${ut} ${e.join(`
`)}`}const Z=200;function ft(t){const e=I(globalThis.__lastAnalyzed||""),n=Array.isArray(t)?t:[],o=Gt(n),s=o.slice().sort((a,d)=>(a.start??Number.POSITIVE_INFINITY)-(d.start??Number.POSITIVE_INFINITY)),r=[];let l=-1,c=0;for(const a of s){if(!a||!a.rule_id||!a.snippet||typeof a.start!="number"){c++;continue}const d=a.snippet,m=a.start,f=typeof a.end=="number"?a.end:m+d.length;if(m<l){c++;continue}const u=I(d),g=Xt(e,u,m);if(r.push({raw:d,norm:u,occIdx:g,msg:ee(a),rule_id:a.rule_id,normalized_fallback:I(a.normalized_snippet||"")}),l=f,r.length>=Z)break}const i=globalThis;return c&&i.notifyWarn?.(`Skipped ${c} overlaps/invalid`),o.length>Z&&i.notifyWarn?.(`Truncated to first ${Z} findings`),i.notifyOk?.(`Will insert: ${r.length}`),r}async function mt(t){const e=ft(t);return e.length?await globalThis.Word?.run?.(async o=>{const s=o.document.body,r=[];let l=0;for(const c of e){let i=await D(s,c.raw),a=i[Math.min(c.occIdx,i.length-1)]||null;if(!a&&c.normalized_fallback&&c.normalized_fallback!==c.norm&&(i=await D(s,c.normalized_fallback),a=i[Math.min(c.occIdx,i.length-1)]||null),a){a.load?.(["start","end"]),await o.sync();const d=a.start??0,m=a.end??d;if(r.some(f=>Math.max(f.start,d)<Math.min(f.end,m))){console.warn("[annotate] overlapping range",{rid:c.rule_id,start:d,end:m});continue}if(te())try{a.select()}catch{}else c.msg&&a.insertComment(c.msg);r.push({start:d,end:m}),l++}else console.warn("[annotate] no match for snippet",{rid:c.rule_id,snippet:c.raw.slice(0,120)});await o.sync()}return l}).catch(o=>(globalThis.logRichError?.(o,"annotate"),console.warn("annotate run fail",o?.code,o?.message,o?.debugInfo),0)):0}function ne(){const t=!!globalThis.Office?.context?.requirements?.isSetSupported?.("WordApi","1.4"),e=globalThis.Word||{},n=t&&!!e?.Revision,o=t&&!!e?.SearchOptions,s=t&&!!e?.ContentControl,l=globalThis.localStorage?.getItem?.("cai.force.comments")==="1";let c=!1,i="unsupported";return l?(c=!0,i="dev override"):e?.Comment?(c=!0,i="Word.Comment available"):t?(c=!0,i="WordApi 1.4"):(c=!1,i="Word.Comment missing"),{revisions:n,comments:c,search:o,contentControls:s,commentsReason:i}}function gt(){const t=ne();try{console.log("support matrix",{comments:t.comments,reason:t.commentsReason})}catch{}return t}async function oe(t){const e=[];try{await Pt()}catch{}["btnAnalyze","selectRiskThreshold"].forEach(d=>{document.getElementById(d)||e.push(`missingID:${d}`)}),Office?.context?.requirements?.isSetSupported?.("WordApi","1.4")||e.push("req1.4:0");const n=gt(),o={revisions:n.revisions?1:0,comments:n.comments?1:0,search:n.search?1:0,contentControls:n.contentControls?1:0};let s=!1;try{s=(await it({backend:t})).ok,s||e.push("health")}catch{e.push("health:timeout")}const r="__BUILD_TS__",l=Office?.context?.host||"Word",c=e.length===0,i=c?`Startup OK | build=${r} | host=${l} | req=1.4 | features=${JSON.stringify(o)} | backend=${t}`:`Startup FAIL: ${e.join("; ")}`;console.log(i);const a=document.getElementById("startupBadge");return a&&(a.textContent=c?"OK":"FAIL",a.setAttribute("data-status",c?"ok":"fail")),{ok:c,missing:e,features:o}}async function U(){return await Word.run(async t=>{const e=t.document.body;return e.load("text"),await t.sync(),(e.text||"").trim()})}var yt={};const G=globalThis,X=G.OfficeExtension,ht="build-20250912-195756";console.log("ContractAI build",ht);let pt=null,bt="1",_t="1";try{pt=localStorage.getItem("cai_timeout_ms:analyze"),bt=localStorage.getItem("cai_abort_on_hidden")||"1",_t=localStorage.getItem("cai_abort_on_navigation")||"1"}catch{}console.log("[CFG]",{timeout_analyze:pt,abort_on_hidden:bt,abort_on_navigation:_t}),!ht.includes("build-")&&typeof document<"u"&&document.addEventListener&&document.addEventListener("DOMContentLoaded",()=>{try{const t=document.createElement("div");t.textContent="FATAL: stale bundle",t.style.padding="12px",t.style.color="#f66",document.body.innerHTML="",document.body.appendChild(t),document.querySelectorAll("button").forEach(e=>{e.disabled=!0})}catch{}});const wt=(()=>{const t=G.ENV_MODE||(typeof process<"u"?yt?.ENV_MODE:void 0);return t?t==="dev"?"dev":"prod":(typeof process<"u"?"production":void 0)==="development"?"dev":"prod"})();X&&X.config&&(wt==="dev"||G.__ENABLE_EXTENDED_LOGS__)&&(X.config.extendedErrorLogging=!0);function j(t,e="Word"){try{const n=t&&t.debugInfo||{};console.error(`[${e}] RichApi error`,{code:t.code,message:t.message,errorLocation:n.errorLocation,statements:n.statements,traceMessages:n.traceMessages,inner:n.innerError})}catch{}}function Et(t){return(lt(t)||[]).filter(n=>n&&n.rule_id&&n.snippet).map(n=>({...n,clause_type:n.clause_type||"Unknown"})).filter(n=>n.clause_type)}const y=globalThis;y.parseFindings=y.parseFindings||Et,y.applyMetaToBadges=y.applyMetaToBadges||J,y.getApiKeyFromStore=y.getApiKeyFromStore||M,y.getSchemaFromStore=y.getSchemaFromStore||S,y.logRichError=y.logRichError||j,y.getWholeDocText=y.getWholeDocText||U;let se="live";const $={proposed:'textarea#proposedText, textarea#draftText, textarea[name="proposed"], textarea[data-role="proposed-text"]',original:'textarea#originalClause, textarea#originalText, textarea[name="original"], textarea[data-role="original-clause"]'};let P="",It=!1;const ae=Zt.required_ids||[];function tt(t,e){const n=document.getElementById("status-chip");if(!n)return;const o=(t??S())||"—",s=(e??P)||"—";n.textContent=`schema: ${o} | cid: ${s}`}function ce(){if(It)return;b("#btnAnalyze",_e);const t=document.getElementById("btnAnalyze");t&&(t.disabled=!1),It=!0,console.log("[PANEL] analyze enabled")}function At(){try{return(localStorage.getItem("backend.url")||localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}}function ie(){const e=document.getElementById("backendUrl")?.value?.trim();if(e)try{localStorage.setItem("backend.url",e),localStorage.setItem("backendUrl",e)}catch{}location.reload()}function et(){try{let t=M(),e=S();const n=document.getElementById("hdrWarn"),o=globalThis?.location?.hostname??"",s=o==="localhost"||o==="127.0.0.1";if(s&&(t||(t="local-test-key-123",st(t)),!e)){const r=globalThis?.SCHEMA_VERSION||typeof process<"u"&&yt?.SCHEMA_VERSION||"1.4";e=String(r),B(e)}n&&(!t&&!e&&!s?n.style.display="":n.style.display="none"),(!t||!e)&&console.warn("missing headers",{apiKey:!!t,schema:!!e})}catch{}return!0}function v(t,e){return document.querySelector(`[data-role="${e}"]`)||document.getElementById(t)}function vt(){const e=document.getElementById("selectRiskThreshold")?.value?.toLowerCase();return e==="low"||e==="medium"||e==="high"?e:"medium"}function nt(){const t=Ot();try{const e=globalThis.document,n=e?.getElementById("cai-comment-on-analyze")||e?.getElementById("chkAddCommentsOnAnalyze");return n&&(n.checked=t),n?!!n.checked:t}catch{return t}}function re(t){$t(t)}function St(t,e){const n=W(e);return(t||[]).filter(o=>o&&o.rule_id&&o.snippet).map(o=>({...o,clause_type:o.clause_type||"Unknown"})).filter(o=>W(o.severity)>=n)}y.annotateFindingsIntoWord=y.annotateFindingsIntoWord||mt;async function le(){try{await Word.run(async t=>{const e=t.document.body,n=t.document.comments;n.load("items"),await t.sync();for(const o of n.items)try{(o.text||"").startsWith(ut)&&o.delete()}catch{}try{e.font.highlightColor="NoColor"}catch{}await t.sync()}),x("Annotations cleared")}catch(t){j(t,"annotate"),p("Failed to clear annotations")}}async function Tt(t){return L(async()=>{let e=(t||[]).filter(s=>typeof s.start=="number"&&typeof s.end=="number"&&s.end>s.start).sort((s,r)=>s.start-r.start),n=-1;if(e=e.filter(s=>s.start<n?!1:(n=s.end,!0)),!e.length)return;const o=window.__lastAnalyzed||"";await Word.run(async s=>{const r=s.document.body;s.document.trackRevisions=!0;const l={matchCase:!1,matchWholeWord:!1},c=(i,a)=>{const d=i?.items||[];return d.length&&d[Math.min(Math.max(a,0),d.length-1)]||null};for(const i of e){const a=o.slice(i.start,i.end),d=(()=>{let f=-1,u=0;for(;(f=o.indexOf(a,f+1))!==-1&&f<i.start;)u++;return u})();let m=null;if(i.context_before||i.context_after){const f=`${i.context_before||""}${a}${i.context_after||""}`,u=r.search(f,l);u.load("items"),await s.sync();const g=c(u,d);if(g){const h=g.search(a,l);h.load("items"),await s.sync(),m=c(h,0)}}if(!m){const f=r.search(a,l);f.load("items"),await s.sync(),m=c(f,d)}if(!m){const f=(()=>{const u=a.replace(/[^\p{L}\p{N} ]/gu," ").split(" ").filter(g=>g.length>=12);return u.length?u.sort((g,h)=>h.length-g.length)[0].slice(0,64):null})();if(f){const u=r.search(f,l);u.load("items"),await s.sync(),m=c(u,0)}}if(m){m.insertText(i.replacement,"Replace");const f=i.rationale||i.source||"AI edit";try{m.insertComment(f)}catch{}}else console.warn("[applyOpsTracked] match not found",{snippet:a,occIdx:d});await s.sync()}})})}y.applyOpsTracked=y.applyOpsTracked||Tt;async function de(t){await Word.run(async e=>{const n=e.document.body;let o=await D(n,t.raw),s=o[Math.min(t.occIdx,o.length-1)]||null;if(!s&&t.normalized_fallback&&t.normalized_fallback!==t.norm&&(o=await D(n,t.normalized_fallback),s=o[Math.min(t.occIdx,o.length-1)]||null),s)try{s.select()}catch{}await e.sync()})}async function xt(t){const e=window.__findings||[];if(!e.length)return;const n=window;n.__findingIdx=(n.__findingIdx??0)+t,n.__findingIdx<0&&(n.__findingIdx=e.length-1),n.__findingIdx>=e.length&&(n.__findingIdx=0);const o=document.getElementById("findingsList");if(o){const s=Array.from(o.querySelectorAll("li"));s.forEach((l,c)=>{l.classList.toggle("active",c===n.__findingIdx)});const r=s[n.__findingIdx];r&&r.scrollIntoView({block:"nearest"})}try{await de(e[n.__findingIdx])}catch{}}function ue(){xt(-1)}function fe(){xt(1)}function me(t){const e=t?.summary?.clause_type||t?.meta?.clause_type||t?.doc_type||"—",n=Array.isArray(t?.findings)?t.findings:[],o=Array.isArray(t?.recommendations)?t.recommendations:[],s=vt(),l=St(n,s).length,c=n.length-l,i=(f,u)=>{const g=document.getElementById(f);g&&(g.textContent=u)};i("clauseTypeOut",String(e)),i("resFindingsCount",String(n.length)),i("visibleHiddenOut",`${l} / ${c}`);const a=document.getElementById("findingsList");if(a){a.innerHTML="";for(const f of n){const u=document.createElement("li"),g=f?.title||f?.finding?.title||f?.rule_id||"Issue",h=f?.snippet||f?.evidence?.text||"";u.textContent=h?`${g}: ${h}`:String(g),a.appendChild(u)}}const d=document.getElementById("recsList");if(d){d.innerHTML="";for(const f of o){const u=document.createElement("li");u.textContent=f?.text||f?.advice||f?.message||"Recommendation",d.appendChild(u)}}const m=document.getElementById("resultsBlock");m&&m.style.removeProperty("display")}function ge(t){const e=v("resClauseType","clause-type");e&&(e.textContent=t?.clause_type||"—");const n=Et(t);window.__findings=n,window.__findingIdx=0;const o=v("findingsList","findings");o&&(o.innerHTML="",n.forEach(i=>{const a=document.createElement("li");a.textContent=typeof i=="string"?i:JSON.stringify(i),o.appendChild(a)}));const s=Array.isArray(t?.recommendations)?t.recommendations:[],r=v("recoList","recommendations");r&&(r.innerHTML="",s.forEach(i=>{const a=document.createElement("li");a.textContent=typeof i=="string"?i:JSON.stringify(i),r.appendChild(a)}));const l=v("resFindingsCount","findings-count");l&&(l.textContent=String(n.length));const c=v("rawJson","raw-json");c&&(c.textContent=JSON.stringify(t??{},null,2))}function ye(){const t=v("toggleRaw","toggle-raw-json"),e=v("rawJson","raw-json");t&&e&&(e.style.display="none",t.addEventListener("click",()=>{e.style.display=e.style.display==="none"?"block":"none"}))}function kt(t){const e=document.getElementById("connBadge");e&&(e.textContent=`Conn: ${t===null?"—":t?"✓":"×"}`)}function ot(t){const e=document.getElementById("officeBadge");e&&(e.textContent=`Office: ${t??"—"}`)}function R(t){return document.querySelector(t)}async function he(){const t=R($.original),e=await U(),n=I(e||"");if(t){t.value=n;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}const o=document.getElementById("originalText");if(o&&o!==t){o.value=n;try{o.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}window.__lastAnalyzed=n,window.toast?.("Whole doc loaded")}async function pe(t){return L(async()=>{try{const e=R($.proposed);if(!(window.__lastAnalyzed||I(await U()))){p("No document text");return}const o=window.__findings||[],s=window.__findingIdx??0,r=o[s];if(!r){p("No active finding");return}const l=r.snippet||"",{json:c}=await O("/api/gpt-draft",{cid:P,clause:l,mode:"friendly"}),i=(c?.proposed_text??c?.text??"").toString(),a=window;a.__last=a.__last||{},a.__last["gpt-draft"]={json:c},e?(e.id||(e.id="draftText"),e.name||(e.name="proposed"),e.dataset.role="proposed-text",e.value=i,e.dispatchEvent(new Event("input",{bubbles:!0})),x("Draft ready"),k(i)):(p("Proposed textarea not found"),k(""))}catch(e){p("Draft error"),console.error(e),k("")}})}async function Ct(){try{const t=S(),{resp:e,json:n,ok:o}=await it({backend:At()}),s=e.headers.get("x-schema-version")||n?.schema||null;if(s&&(B(s),s!==t&&console.log(`schema: ${s} (synced)`)),kt(o),o){console.log("[PANEL] health ok"),ce(),tt(s,null);try{J({cid:null,xcache:null,latencyMs:null,schema:s||null,provider:n?.provider||null,model:n?.model||null,llm_mode:null,usage:null,status:n?.status||null})}catch{}x(`Health: ${n?.status||"ok"}${s?` (schema ${s})`:""}`)}else p("Health failed")}catch(t){kt(!1),p("Health failed"),console.error(t)}}async function be(){const t=document.getElementById("originalText");let e=I(t?.value||"");if(!e){const n=document.getElementById("btnAnalyze");n&&(n.disabled=!0);try{e=I(await globalThis.getWholeDocText()),t&&(t.value=e||"")}catch{e=""}finally{n&&(n.disabled=!1)}}return e?(window.__lastAnalyzed=e,e):(p("Document is empty"),null)}async function _e(){await be()&&await we()}async function we(){return L(async()=>{const t=document.getElementById("btnAnalyze"),e=document.getElementById("busyBar");t&&(t.disabled=!0),e&&(e.style.display="");try{k("");const n=window.__lastAnalyzed;if(!n){rt("В документе нет текста");return}et();const{resp:o,json:s}=await Jt({text:n,mode:se});if(!o.ok)throw new Error(`HTTP ${o.status}`);const r=o.headers.get("x-schema-version");r&&B(r),s?.schema&&B(s.schema),P=o.headers.get("x-cid")||"",tt(null,P),ge(s),me(s);try{localStorage.setItem("last_analysis_json",JSON.stringify(s))}catch{}try{const l=globalThis.parseFindings(s),c=vt(),i=St(l,c),a=ft(i);window.__findings=a;const d=document.getElementById("findingsList");d&&(d.innerHTML="",a.forEach(m=>{const f=document.createElement("li");f.textContent=m.rule_id||m.raw.slice(0,64),d.appendChild(f)})),nt()&&i.length&&await mt(i)}catch(l){console.warn("auto-annotate after analyze failed",l)}(document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.results",{detail:s})),x("Analyze OK")}catch(n){let o="";if(n?.name==="AbortError"){const s=n?.message||"";if(s.startsWith("timeout")){const r=parseInt(s.replace(/[^0-9]/g,""),10)||0;o=`(timeout ${Math.round(r/1e3)} s)`}else s==="pagehide/unload"?o="(aborted by pagehide)":o="(aborted)"}else typeof n?.message=="string"&&(n.message.includes("HTTP 504")?o="(HTTP 504)":n.message.includes("HTTP 413")?o="(request too large 413)":n.message.includes("HTTP 401")?o="(unauthorized 401)":n.message.includes("HTTP 403")?o="(forbidden 403)":n.message.includes("HTTP 422")&&(o="(schema mismatch 422)"));p(`Analyze failed ${o}`.trim()),console.error(n)}finally{t&&(t.disabled=!1),e&&(e.style.display="none")}})}async function Ee(){return L(async()=>{et();const t=await U(),{json:e}=await O("/api/qa-recheck",{text:t,rules:{}});if((document.getElementById("results")||document.body).dispatchEvent(new CustomEvent("ca.qa",{detail:e})),!e?.error)x("QA recheck OK");else{const o=e?.error||e?.message||"unknown";rt(`QA recheck failed: ${o}`)}})}function b(t,e){const n=document.querySelector(t);n&&(n.addEventListener("click",o=>{o.preventDefault(),e()}),n.classList.remove("js-disable-while-busy"),n.removeAttribute("disabled"))}async function Ie(){try{const t=window.__lastAnalyzed||"",e=(R($.proposed)?.value||"").trim();if(!e){p("No draft to diff");return}const n=await Qt(t,e),o=n?.json?.html||n?.json?.diff_html||n?.json?.redlines||"",s=document.getElementById("diffOutput"),r=document.getElementById("diffContainer");s&&r&&(s.innerHTML=o||"",r.style.display=o?"block":"none")}catch(t){p("Diff failed"),console.error(t)}}async function Ae(){try{const t=window.__last||{},e=t["gpt-draft"]?.json?.ops||t.suggest?.json?.ops||[];if(!e.length){p("No ops to apply");return}await Tt(e),x("Applied ops")}catch(t){p("Insert failed"),console.error(t)}}async function ve(){try{const e=(R($.proposed)?.value||"").trim();if(!e){window.toast?.("Nothing to accept");return}const n=(document.getElementById("cid")?.textContent||"").trim(),o=(()=>{try{return(localStorage.getItem("backendUrl")||"https://localhost:9443").replace(/\/+$/,"")}catch{return"https://localhost:9443"}})(),s=n&&n!=="—"?`${o}/api/trace/${n}`:"AI draft";await Word.run(async r=>{const l=r.document.getSelection();r.document.trackRevisions=!0,l.insertText(e,Word.InsertLocation.replace);try{l.insertComment(s)}catch{}await r.sync()}),window.toast?.("Accepted into Word"),console.log("[OK] Accepted into Word")}catch(t){window.toast?.("Accept failed"),j(t,"insertDraft"),console.error(t)}}async function Se(){try{const t=R($.proposed);t&&(t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),k("")),await Word.run(async e=>{const o=e.document.getSelection().revisions;o.load("items"),await e.sync(),(o.items||[]).forEach(s=>{try{s.reject()}catch{}}),await e.sync()}),window.toast?.("Rejected"),console.log("[OK] Rejected")}catch(t){window.toast?.("Reject failed"),j(t,"insertDraft"),console.error(t)}}function Bt(){if(console.log("[PANEL] wireUI start"),!globalThis.__CAI_TESTING__){const c=ae.filter(i=>!document.getElementById(i));if(c.length){console.error("[PANEL] wireUI missing IDs:",c);const i=`FATAL: panel template mismatch (missing: ${c.join(", ")}). Check build pipeline.`;try{const a=document.createElement?document.createElement("div"):null;a&&(a.textContent=i,a.style.padding="12px",a.style.color="#f66",document.body.innerHTML="",document.body.appendChild(a))}catch{}console.error(i);return}}const t=document.getElementById("loading-book");window.addEventListener("cai:busy",c=>{if(!t)return;!!c?.detail?.busy?t.classList.remove("hidden"):t.classList.add("hidden")});const e=gt(),n=(c,i)=>{const a=document.getElementById(c);if(a&&(a.disabled=!0,a.title=i?`Not supported: ${i}`:"Not supported"),i)try{console.log(`disabled ${c}: ${i}`)}catch{}};b("#btnUseWholeDoc",he);const o=document.getElementById("btnUseWholeDoc");if(o&&(o.disabled=!1),wt==="dev")b("#btnTest",Ct);else{const c=document.getElementById("btnTest");c&&(c.style.display="none")}b("#btnQARecheck",Ee),document.getElementById("btnSuggestEdit")?.addEventListener("click",pe),b("#btnApplyTracked",Ae),b("#btnAcceptAll",ve),b("#btnRejectAll",Se),b("#btnPrevIssue",ue),b("#btnNextIssue",fe),b("#btnPreviewDiff",Ie),b("#btnClearAnnots",le),b("#btnSave",ie);const s=document.getElementById("cai-comment-on-analyze")||document.getElementById("chkAddCommentsOnAnalyze");s?(s.checked=nt(),s.addEventListener("change",()=>re(!!s.checked))):nt();const r=document.getElementById("btnAnnotate");r&&(r.addEventListener("click",async()=>{if(!r.disabled){r.disabled=!0;try{const c=window.__last?.analyze?.json||{},i=globalThis.parseFindings(c);await globalThis.annotateFindingsIntoWord(i)}finally{r.disabled=!1}}}),r.classList.remove("js-disable-while-busy"),r.removeAttribute("disabled")),k(""),ye(),console.log("Panel UI wired");const l=document.getElementById("btnAnalyze");if(l&&(l.disabled=!0),et(),tt(),e.revisions||(n("btnApplyTracked","revisions"),n("btnAcceptAll","revisions"),n("btnRejectAll","revisions")),e.comments||n("btnAcceptAll",e.commentsReason),e.search||(n("btnPrevIssue","search"),n("btnNextIssue","search"),n("btnQARecheck","search")),e.contentControls||n("btnAnnotate","contentControls"),!e.revisions||!e.comments||!e.search||!e.contentControls)try{ot("Word ⚠")}catch{}}y.wireUI=y.wireUI||Bt;function k(t){const e=!!t.trim(),n=document.getElementById("btnApplyTracked"),o=document.getElementById("btnAcceptAll"),s=document.getElementById("btnRejectAll"),r=document.getElementById("btnPreviewDiff"),l=document.getElementById("draftPane"),c=document.getElementById("draftText");c&&(c.value=t),l&&(l.style.display=e?"":"none"),n&&(n.disabled=!e),o&&(o.disabled=!e),s&&(s.disabled=!e),r&&(r.disabled=!e)}async function Te(t){console.log("[PANEL] bootstrap start"),ct()&&(console.log("reopen clean OK"),Ut()),Bt(),Dt();try{await oe(At())}catch{}try{await Ct()}catch{}try{ot(`${t?.host||Office.context?.host||"Word"} ✓`)}catch{ot(null)}}let H=0;function xe(t){if(ct()&&(H=0),H>0){console.log(`bootstrap invoked x${H+1}`);return}H++,console.log("bootstrap invoked x1"),Te(t)}if(!globalThis.__CAI_TESTING__){const t=()=>Office.onReady(e=>xe(e));document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}})();
